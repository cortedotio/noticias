<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clipping de Notícias - Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fallback automático caso o CDN do Tailwind não carregue (ex.: CSP/Proxy bloqueando scripts externos) -->
    <script>
      (function () {
        function ensureTailwindLoaded() {
          try {
            var test = document.createElement('div');
            test.className = 'hidden';
            document.body.appendChild(test);
            var hasTailwind = window.getComputedStyle(test).display === 'none';
            test.remove();
            if (!hasTailwind) {
              var link = document.createElement('link');
              link.rel = 'stylesheet';
              link.href = 'https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css';
              document.head.appendChild(link);
              console.warn('Tailwind CDN não carregou. CSS fallback (v2.2.19) aplicado.');
            }
          } catch (e) {
            var link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css';
            document.head.appendChild(link);
          }
        }
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', ensureTailwindLoaded);
        } else {
          ensureTailwindLoaded();
        }
      })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- CHAVE DA API DO GOOGLE MAPS -->
    <script>window.initMap = window.initMap || function(){ try { /* stub para evitar erro antes da definição real */ } catch(e){} };</script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBlgBbnbhALORtuoTwy6xjjUqtoMI4wlL8&callback=initMap"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        body {
            padding-top: 80px;
            /* Altura do header */
        }

        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes blinking-bell {
            0% {
                background-color: transparent;
                color: #4B5563;
            }

            50% {
                background-color: #10B981;
                color: white;
            }

            100% {
                background-color: transparent;
                color: #4B5563;
            }
        }

        .animate-blinking-bell {
            animation: blinking-bell 1.5s infinite;
            border-radius: 9999px;
        }

        .keyword-filter.active {
            background-color: #4F46E5 !important;
            color: white !important;
        }

        #notification-badge {
            min-width: 1.25rem;
            height: 1.25rem;
            padding: 0 0.25rem;
            line-height: 1.25rem;
        }

        .sentiment-menu {
            display: none;
            position: absolute;
            z-index: 10;
            right: 0;
            background-color: white;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border: 1px solid #e5e7eb;
        }

        .sentiment-container:hover .sentiment-menu {
            display: block;
        }

        .media-menu {
            display: none;
            position: absolute;
            z-index: 10;
            right: 0;
            background-color: white;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border: 1px solid #e5e7eb;
        }

        .media-container:hover .media-menu {
            display: block;
        }

        .directness-menu {
            display: none;
            position: absolute;
            z-index: 10;
            right: 0;
            background-color: white;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border: 1px solid #e5e7eb;
        }

        .directness-container:hover .directness-menu {
            display: block;
        }

        #report-keyword-filter-container,
        #manual-alert-keyword {
            height: 100px;
        }

        .alert-body-clickable {
            cursor: pointer;
        }

        .company-report-row {
            cursor: pointer;
        }

        .ai-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            line-height: 1.2;
            margin: 2px;
        }

        #map {
            height: 70vh;
            width: 100%;
            border-radius: 0.5rem;
        }

        @media print {
            body {
                padding-top: 0;
            }

            body * {
                visibility: hidden;
            }

            #article-detail-page,
            #article-detail-page * {
                visibility: visible;
            }

            #article-detail-page {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
            }

            main {
                padding-top: 0;
            }

            header,
            #back-from-detail,
            #share-buttons-container {
                display: none !important;
            }

            #report-content {
                box-shadow: none;
                border: 1px solid #ccc;
            }
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800">

    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
            <a href="#" id="logo-link" class="cursor-pointer">
                <div id="global-logo-area" class="text-xl sm:text-2xl font-bold text-indigo-600 flex items-center">
                </div>
            </a>
            <div class="flex items-center">
                <div id="nav-logged-in" class="hidden items-center flex-wrap justify-end">
                    <a href="#" id="nav-inicio"
                        class="text-gray-600 hover:text-indigo-600 px-2 py-1 sm:px-3 sm:py-2 rounded-md text-sm font-medium">Início</a>
                    <a href="#" id="nav-relatorio"
                        class="hidden text-gray-600 hover:text-indigo-600 px-2 py-1 sm:px-3 sm:py-2 rounded-md text-sm font-medium">Relatório</a>
                    <a href="#" id="nav-mapa"
                        class="hidden text-gray-600 hover:text-indigo-600 px-2 py-1 sm:px-3 sm:py-2 rounded-md text-sm font-medium">Mapa
                        de Notícias</a>
                    <a href="#" id="nav-pesquisa"
                        class="text-gray-600 hover:text-indigo-600 px-2 py-1 sm:px-3 sm:py-2 rounded-md text-sm font-medium">Pesquisa</a>
                    <a href="#" id="nav-atividade"
                        class="text-gray-600 hover:text-indigo-600 px-2 py-1 sm:px-3 sm:py-2 rounded-md text-sm font-medium">Atividade</a>
                    <a href="#" id="nav-super-admin"
                        class="hidden text-red-600 hover:text-red-800 px-2 py-1 sm:px-3 sm:py-2 rounded-md text-sm font-bold">Super
                        Admin</a>
                    <a href="#" id="nav-configuracoes-admin"
                        class="hidden text-gray-600 hover:text-indigo-600 px-2 py-1 sm:px-3 sm:py-2 rounded-md text-sm font-medium">Configurações</a>
                    <div id="notification-bell-container" class="relative cursor-pointer ml-2 sm:ml-4 p-1">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                            </path>
                        </svg>
                        <span id="notification-badge"
                            class="hidden absolute -top-1 -right-1 text-white text-xs font-bold text-center rounded-full bg-red-500"></span>
                    </div>
                    <a href="#" id="nav-logout"
                        class="ml-2 sm:ml-4 bg-indigo-600 text-white hover:bg-indigo-700 px-3 py-2 rounded-md text-sm font-medium">Sair</a>
                </div>
                <div id="header-logo-container" class="ml-4 h-10 w-auto"></div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-4 sm:p-6">
        <div id="global-alert" class="mb-6"></div>

        <section id="login-page" class="page-section active fade-in">
            <div class="max-w-md mx-auto bg-gray-50 p-4 sm:p-8 rounded-lg shadow-lg mt-10 relative">
                <div id="login-logo-container" class="absolute top-4 right-4 h-12 w-auto"></div>
                <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-800">Bem-Vindo</h1>
                <p class="text-center text-gray-500 mt-2 mb-6">Informe os seus dados de acesso</p>
                <form id="login-form">
                    <div id="login-company-wrapper" class="mb-4"><label for="login-company"
                            class="block text-sm font-medium text-gray-700 mb-1">Empresa</label><input type="text"
                            id="login-company" class="w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                    <div class="mb-4"><label for="login-user"
                            class="block text-sm font-medium text-gray-700 mb-1">Usuário</label><input type="text"
                            id="login-user" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <div class="mb-6"><label for="login-password"
                            class="block text-sm font-medium text-gray-700 mb-1">Palavra-passe</label><input
                            type="password" id="login-password"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <button type="submit"
                        class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Entrar</button>
                </form>
            </div>
        </section>

        <section id="dashboard-page" class="page-section fade-in">
            <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 bg-white p-4 rounded-lg shadow-md">
                <h2 id="dashboard-title" class="text-xl sm:text-2xl font-bold text-gray-800 mb-2 md:mb-0">Notícias do Dia
                </h2>
                <p id="current-datetime" class="text-base sm:text-lg text-indigo-600 font-medium"></p>
            </div>
            <div id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1 bg-white p-4 sm:p-6 rounded-lg shadow-lg">
                    <h3 class="text-lg sm:text-xl font-semibold mb-3 text-gray-700">Palavras-Chave Monitorizadas</h3>
                    <ul id="dashboard-keyword-list" class="space-y-2"></ul>
                </div>
                <div id="news-alerts-container" class="md:col-span-2">
                    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                            <h3 class="text-lg sm:text-xl font-semibold text-gray-700">Relatório de Alertas</h3>
                            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 w-full sm:w-auto">
                                <button id="show-all-alerts-btn"
                                    class="hidden bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-sm hover:bg-gray-300">Mostrar
                                    Todos</button>
                                <div class="flex items-center gap-2">
                                    <label for="alert-date-filter" class="text-sm font-medium">Filtrar por
                                        data:</label>
                                    <input type="date" id="alert-date-filter"
                                        class="px-2 py-1 border border-gray-300 rounded-md text-sm">
                                </div>
                            </div>
                        </div>
                        <div id="news-alerts" class="space-y-4 max-h-[70vh] overflow-y-auto"></div>
                    </div>
                </div>
            </div>
            <div id="super-admin-dashboard-message" class="hidden bg-white p-4 sm:p-8 rounded-lg shadow-lg text-center">
                <h3 class="text-xl sm:text-2xl font-bold">Bem-vindo, Super Admin!</h3>
                <p class="mt-4 text-gray-600">Use o menu "Super Admin" no topo da página para gerir as opções.</p>
                <div class="mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <button id="btn-manual-alert"
                        class="bg-white p-6 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow">
                        <h3 class="text-lg sm:text-xl font-semibold text-gray-700">Inserir Alerta Manual</h3>
                    </button>
                    <button id="btn-pending-alerts"
                        class="bg-white p-6 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow relative">
                        <h3 class="text-lg sm:text-xl font-semibold text-gray-700">Fila de Aprovação</h3>
                        <span id="pending-alerts-badge"
                            class="hidden absolute top-2 right-2 text-white text-xs font-bold w-5 h-5 text-center rounded-full bg-red-500"></span>
                    </button>
                    <button id="btn-deletion-requests"
                        class="bg-white p-6 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow relative">
                        <h3 class="text-lg sm:text-xl font-semibold text-gray-700">Pedidos de Exclusão</h3>
                        <span id="deletion-requests-badge"
                            class="hidden absolute top-2 right-2 text-white text-xs font-bold w-5 h-5 text-center rounded-full bg-red-500"></span>
                    </button>
                    <button id="btn-super-admin-report"
                        class="bg-white p-6 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow">
                        <h3 class="text-lg sm:text-xl font-semibold text-gray-700">Relatório Geral</h3>
                    </button>
                    <button id="btn-critical-report"
                        class="bg-white p-6 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow">
                        <h3 class="text-lg sm:text-xl font-semibold text-gray-700">Relatório de Análise Crítica</h3>
                    </button>
                    <!-- Novo botão Monitoramento de Mídia -->
                    <button id="btn-media-monitoring"
                        class="bg-white p-6 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow">
                        <h3 class="text-lg sm:text-xl font-semibold text-gray-700">Monitoramento de mídia</h3>
                    </button>
                </div>
                <div class="mt-6 p-4 bg-blue-100 border-l-4 border-blue-500 text-blue-800 rounded-md text-left">
                    <p class="font-bold">Execução Manual do Robô</p>
                    <p class="mt-2 text-sm">A busca automática já está configurada para ser executada a cada 30 minutos.
                        Utilize o botão abaixo apenas se necessitar de uma atualização imediata.</p>
                    <button id="manual-trigger-btn"
                        class="mt-4 w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:bg-blue-300">Executar
                        Robô Manualmente</button>
                </div>
            </div>
        </section>

        <section id="map-page" class="page-section fade-in">
            <div class="bg-white p-4 sm:p-6 md:p-8 rounded-lg shadow-lg">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-xl sm:text-2xl md:text-3xl font-bold">Mapa de Notícias</h2>
                    <div class="flex items-center gap-2">
                        <label for="map-start-date" class="text-sm font-medium">De:</label>
                        <input type="date" id="map-start-date"
                            class="px-2 py-1 border border-gray-300 rounded-md text-sm">
                        <label for="map-end-date" class="text-sm font-medium">Até:</label>
                        <input type="date" id="map-end-date"
                            class="px-2 py-1 border border-gray-300 rounded-md text-sm">
                        <button id="map-filter-btn"
                            class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 text-sm">Filtrar</button>
                    </div>
                </div>
                <p class="text-gray-600 mb-4">Veja onde as notícias estão acontecendo. Passe o mouse sobre um pino para
                    ver o título e clique para ver os detalhes.</p>
                <div id="map"></div>
            </div>
        </section>

        <section id="super-admin-page" class="page-section fade-in">
            <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-red-600">Painel de Super-Administrador</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold mb-4">Adicionar Nova Empresa</h3>
                    <form id="company-form" class="space-y-4">
                        <div><label for="company-name-input">Nome da Empresa</label><input type="text"
                                id="company-name-input" class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                required></div>
                        <button type="submit"
                            class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700">Adicionar
                            Empresa</button>
                    </form>
                </div>
                <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold mb-4">Empresas Registadas</h3>
<input type="text" id="company-search-input" placeholder="Pesquisar empresas..." class="w-full px-3 py-2 border border-gray-300 rounded-md mb-3">
<ul id="company-list" class="space-y-2 max-h-96 overflow-y-auto"></ul>
                </div>
            </div>
        </section>

        <section id="activity-page" class="page-section fade-in">
            <div class="bg-white p-4 sm:p-6 md:p-8 rounded-lg shadow-lg">
                <h2 class="text-xl sm:text-2xl md:text-3xl font-bold mb-6">Atividade</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Empresa</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sites</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">YouTube</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Revistas</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rádio</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TV</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total a Aprovar</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aguardando Exclusão</th>
                            </tr>
                        </thead>
                        <tbody id="activity-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Linhas geradas dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="configuracoes-admin-page" class="page-section fade-in">
            <h2 class="text-2xl sm:text-3xl font-bold mb-6">Configurações do Super Admin</h2>
            <div class="max-w-6xl mx-auto grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6">
                <button id="btn-change-password"
                    class="bg-white p-6 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow">
                    <h3 class="text-lg sm:text-xl font-semibold">Alterar Palavra-passe</h3>
                </button>
                <button id="btn-global-keys"
                    class="bg-white p-6 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow">
                    <h3 class="text-lg sm:text-xl font-semibold">Chaves de API</h3>
                </button>
                <button id="btn-news-sources"
                    class="bg-white p-6 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow">
                    <h3 class="text-lg sm:text-xl font-semibold">Fontes de Notícias</h3>
                </button>
                <button id="btn-radio-sources"
                    class="bg-white p-6 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow">
                    <h3 class="text-lg sm:text-xl font-semibold">Fontes de Rádio</h3>
                </button>
                <button id="btn-global-logo"
                    class="bg-white p-6 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow">
                    <h3 class="text-lg sm:text-xl font-semibold">Logótipo Global</h3>
                </button>
                <!-- Novo botão Usuario-Admin -->
                <button id="btn-usuario-admin"
                    class="bg-white p-6 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow">
                    <h3 class="text-lg sm:text-xl font-semibold">Usuario-Admin</h3>
                </button>
                <!-- Novo botão Fontes de TV -->
                <button id="btn-tv-sources"
                    class="bg-white p-6 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow">
                    <h3 class="text-lg sm:text-xl font-semibold">Fontes de TV</h3>
                </button>
                <!-- Novo botão Corrigir Artigos -->
                <button id="btn-fix-articles"
                    class="bg-white p-6 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow">
                    <h3 class="text-lg sm:text-xl font-semibold">Corrigir Artigos</h3>
                </button>
            </div>
        </section>
        <!-- Nova página Usuario-Admin -->
        <section id="usuario-admin-page" class="page-section fade-in">
            <button id="back-to-admin-config-6" class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar</button>
            <h2 class="text-2xl sm:text-3xl font-bold mb-6">Usuario-Admin</h2>
            <div class="w-full max-w-none bg-white p-4 sm:p-6 rounded-lg shadow-lg">
                <form id="usuario-admin-form" class="space-y-4">
                    <div>
                        <label for="usuario-admin-username" class="block text-sm font-medium text-gray-700 mb-1">Usuário</label>
                        <input type="text" id="usuario-admin-username" class="w-full px-3 py-2 border border-gray-300 rounded-md" required />
                    </div>
                    <div>
                        <label for="usuario-admin-password" class="block text-sm font-medium text-gray-700 mb-1">Palavra-passe</label>
                        <input type="password" id="usuario-admin-password" class="w-full px-3 py-2 border border-gray-300 rounded-md" required />
                    </div>
                    <div>
                        <label for="usuario-admin-companies-list" class="block text-sm font-medium text-gray-700 mb-1">Empresas Ativas</label>
                        <div id="usuario-admin-companies-list" class="w-full px-3 py-2 border border-gray-300 rounded-md h-40 overflow-y-auto"></div>
                        <p class="text-xs text-gray-500 mt-1">Selecione uma ou mais empresas às quais este usuário terá acesso.</p>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Criar Usuário Restrito</button>
                </form>
                <div class="mt-6">
                    <h3 class="text-lg font-semibold mb-2">Usuários Criados</h3>
                    <ul id="restricted-user-list" class="space-y-2"></ul>
                </div>
            </div>
        </section>

        <section id="change-password-page" class="page-section fade-in">
            <button id="back-to-admin-config-1"
                class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar</button>
            <h2 class="text-2xl sm:text-3xl font-bold mb-6">Alterar Palavra-passe de Acesso</h2>
            <div class="w-full max-w-none bg-white p-4 sm:p-6 rounded-lg shadow-lg">
                <form id="change-password-form" class="space-y-4">
                    <div><label for="current-password" class="block text-sm font-medium text-gray-700">Palavra-passe
                            Atual</label><input type="password" id="current-password"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <div><label for="new-password" class="block text-sm font-medium text-gray-700">Nova
                            Palavra-passe</label><input type="password" id="new-password"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <button type="submit"
                        class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Alterar
                        Palavra-passe</button>
                </form>
            </div>
        </section>

        <section id="global-keys-page" class="page-section fade-in">
            <button id="back-to-admin-config-2"
                class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar</button>
            <h2 class="text-2xl sm:text-3xl font-bold mb-6">Chaves de API Globais</h2>
            <div class="w-full max-w-none bg-white p-4 sm:p-6 rounded-lg shadow-lg">
                <div class="space-y-4">
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="apiKeyNewsApi" class="block text-sm font-medium text-gray-700 mb-1">Chave da API
                            (NewsAPI.org)</label>
                        <input type="text" id="apiKeyNewsApi"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="apiKeyFirebaseNews" class="block text-sm font-medium text-gray-700 mb-1">Chave da
                            API (Geocoding - Google Maps)</label>
                        <input type="text" id="apiKeyFirebaseNews"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="apiKeyGoogleMaps" class="block text-sm font-medium text-gray-700 mb-1">Chave da API (Google Maps - Geocoding)</label>
                        <input type="text" id="apiKeyGoogleMaps" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="apiKeyGNews1" class="block text-sm font-medium text-gray-700 mb-1">Chave GNews
                            (00:00 - 05:59)</label>
                        <input type="text" id="apiKeyGNews1"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="apiKeyGNews2" class="block text-sm font-medium text-gray-700 mb-1">Chave GNews
                            (06:00 - 11:59)</label>
                        <input type="text" id="apiKeyGNews2"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="apiKeyGNews3" class="block text-sm font-medium text-gray-700 mb-1">Chave GNews
                            (12:00 - 17:59)</label>
                        <input type="text" id="apiKeyGNews3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="apiKeyGNews4" class="block text-sm font-medium text-gray-700 mb-1">Chave GNews
                            (18:00 - 23:59)</label>
                        <input type="text" id="apiKeyGNews4"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="apiKeyYoutube" class="block text-sm font-medium text-gray-700 mb-1">Chave da API
                            (YouTube Data API v3)</label>
                        <input type="text" id="apiKeyYoutube"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="apiKeyBlogger" class="block text-sm font-medium text-gray-700 mb-1">Chave da API
                            (Blogger API)</label>
                        <input type="text" id="apiKeyBlogger"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="apiKeyVision" class="block text-sm font-medium text-gray-700 mb-1">Chave da API
                            (Cloud Vision)</label>
                        <input type="text" id="apiKeyVision"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div class="flex items-center">
                                <input type="checkbox" id="visionEnabled" class="mr-2">
                                <label for="visionEnabled" class="text-sm text-gray-700">Ativar Cloud Vision</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="visionRelevantOnly" class="mr-2">
                                <label for="visionRelevantOnly" class="text-sm text-gray-700">Somente imagens relevantes</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="visionLogoDetection" class="mr-2">
                                <label for="visionLogoDetection" class="text-sm text-gray-700">Detectar logótipos</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="visionOcrText" class="mr-2">
                                <label for="visionOcrText" class="text-sm text-gray-700">OCR de texto em imagens</label>
                            </div>
                        </div>
                        <p class="mt-2 text-xs text-gray-500">Configure como o Cloud Vision será usado no robô: habilitar/desabilitar, aplicar apenas a imagens relevantes, e escolher entre detecção de logótipos e OCR de texto.</p>
                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="apiKeyVideoIntelligence" class="block text-sm font-medium text-gray-700 mb-1">Chave
                            da API (Video Intelligence)</label>
                        <input type="text" id="apiKeyVideoIntelligence"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="apiKeySpeechToText" class="block text-sm font-medium text-gray-700 mb-1">Chave da API (Cloud Speech-to-Text)</label>
                        <input type="text" id="apiKeySpeechToText" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                </div>
            </div>
        </section>

        <section id="global-sources-page" class="page-section fade-in">
            <button id="back-to-admin-config-3"
                class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar</button>
            <h2 class="text-2xl sm:text-3xl font-bold mb-6">Fontes de Notícias Globais</h2>
            <div class="w-full max-w-none bg-white p-4 sm:p-6 rounded-lg shadow-lg">
                <div class="space-y-4">
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="bloggerId" class="block text-sm font-medium text-gray-700 mb-1">IDs de Blogs
                            (Blogger) - um por linha</label>
                        <textarea id="bloggerId" rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="rssUrl" class="block text-sm font-medium text-gray-700 mb-1">Monitorizar Sites por
                            RSS - um por linha</label>
                        <textarea id="rssUrl" rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md"
                            placeholder="https://site.com/feed"></textarea>
                        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div>
                                <label for="rssFrequencyMinutes" class="block text-sm font-medium text-gray-700 mb-1">Frequência do monitoramento por RSS (em minutos)</label>
                                <input type="number" id="rssFrequencyMinutes" min="5" step="5" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="10">
                                <p class="mt-2 text-xs text-gray-500">Ex.: 10 minutos. O robô só buscará RSS quando o tempo configurado tiver passado desde a última execução.</p>
                            </div>
                            <div>
                                <label for="gnewsFrequencyHours" class="block text-sm font-medium text-gray-700 mb-1">Frequência da busca no GNews (em horas)</label>
                                <input type="number" id="gnewsFrequencyHours" min="1" step="1" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="2">
                                <p class="mt-2 text-xs text-gray-500">Ex.: 2 horas. Controla o intervalo mínimo entre execuções do GNews.</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div>
                                <label for="youtubeChannels" class="block text-sm font-medium text-gray-700 mb-1">IDs de Canais (YouTube) - um por linha</label>
                                <textarea id="youtubeChannels" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="UC_x5XG1OV2P6uZZ5FSM9Ttw"></textarea>
                            </div>
                            <div>
                                <label for="youtubeChannelNames" class="block text-sm font-medium text-gray-700 mb-1">Nome do Canal (YouTube) - um por linha</label>
                                <textarea id="youtubeChannelNames" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Google Developers"></textarea>
                            </div>
                        </div>

                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="youtubeChannelsFrequencyMinutes" class="block text-sm font-medium text-gray-700 mb-1">Frequência do monitoramento para IDs de Canais (YouTube) (em minutos)</label>
                        <input type="number" id="youtubeChannelsFrequencyMinutes" min="1" step="1" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="10">
                        <p class="mt-2 text-xs text-gray-500">Ex.: 10 minutos. Controla o intervalo mínimo entre execuções de busca por canais do YouTube.</p>
                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="youtubeFrequencyHours" class="block text-sm font-medium text-gray-700 mb-1">Frequência da busca no YouTube (em horas)</label>
                        <input type="number" id="youtubeFrequencyHours" min="1" step="1" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="6">
                        <p class="mt-2 text-xs text-gray-500">Ex.: 6 horas. O robô só buscará no YouTube quando o tempo configurado tiver passado desde a última execução.</p>
                        <div class="mt-3">
                            <label for="youtubeFrequencyTime" class="block text-sm font-medium text-gray-700 mb-1">Horário desejado para realizar a busca (HH:MM)</label>
<input type="time" id="youtubeFrequencyTime" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="08:00">
                            <p class="mt-2 text-xs text-gray-500">Opcional: se definido, a busca gated por frequência só ocorrerá no horário desejado do dia.</p>
                        </div>
                    </div>

                    <div class="bg-gray-100 p-3 rounded-md">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Janela permitida para buscar notícias</label>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div>
                                <label for="fetchWindowStart" class="block text-sm font-medium text-gray-700 mb-1">Janela permitida para buscar notícias (início)</label>
                                <input type="time" id="fetchWindowStart" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="08:00">
                            </div>
                            <div>
                                <label for="fetchWindowEnd" class="block text-sm font-medium text-gray-700 mb-1">Janela permitida para buscar notícias (fim)</label>
                                <input type="time" id="fetchWindowEnd" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="18:00">
                            </div>
                        </div>
                        <p class="mt-2 text-xs text-gray-500">Se definidos, o robô só poderá buscar notícias dentro desta janela diária.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="global-radio-sources-page" class="page-section fade-in">
            <button id="back-to-admin-config-5"
                class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar</button>
            <h2 class="text-xl sm:text-2xl font-bold mb-4">Fontes de Rádio Globais</h2>
            <div class="w-full max-w-none bg-white p-4 sm:p-6 rounded-lg shadow-lg">
                <div class="bg-gray-50 p-3 rounded-md">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Campos por rádio</label>
                    <p class="text-xs text-gray-500 mb-2">Edite o nome da rádio, o URL do stream e o horário de monitoramento (início e fim). Sempre haverá um campo vazio extra no final para adicionar a próxima rádio.</p>
                    <textarea id="radioSources" class="hidden"></textarea>
                    <div id="radioTimesList" class="space-y-2 border border-gray-200 rounded-md p-2 w-full overflow-x-auto"></div>
                </div>
            </div>
        </section>

        <!-- Nova página: Fontes de TV Globais -->
        <section id="global-tv-sources-page" class="page-section fade-in">
            <button id="back-to-admin-config-7" onclick="updateView('configuracoes-admin')"
                class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar</button>
            <h2 class="text-2xl sm:text-3xl font-bold mb-6">Fontes de TV Globais</h2>
            <div class="w-full max-w-none bg-white p-4 sm:p-6 rounded-lg shadow-lg">
                <div class="bg-gray-50 p-3 rounded-md mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Campos por TV</label>
                    <p class="text-xs text-gray-500 mb-2">Edite o nome da emissora, o URL do stream de TV e o horário de monitoramento (início e fim). Sempre haverá um campo vazio extra no final para adicionar a próxima fonte de TV.</p>
                    <textarea id="tvSources" class="hidden"></textarea>
                    <div id="tvIntervalsList" class="space-y-2 max-h-96 overflow-auto border border-gray-200 rounded-md p-2 w-full overflow-x-auto"></div>
                </div>
                
                <div class="bg-gray-50 p-3 rounded-md">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status das TVs</label>
                    <div class="flex flex-wrap gap-2">
                        <button id="btn-status-aguardando" class="status-btn bg-yellow-500 text-white px-3 py-1 rounded-md text-sm hover:bg-yellow-600" data-status="aguardando">Aguardando</button>
                        <button id="btn-status-off" class="status-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600" data-status="off">OFF</button>
                        <button id="btn-status-noar" class="status-btn bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600" data-status="noar">NO AR</button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Clique em um status para filtrar as TVs por situação atual.</p>
                </div>
            </div>
        </section>

        <section id="global-logo-page" class="page-section fade-in">
            <button id="back-to-admin-config-4"
                class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar</button>
            <h2 class="text-2xl sm:text-3xl font-bold mb-6">Logótipo Global da Aplicação</h2>
            <div class="w-full max-w-none bg-white p-4 sm:p-6 rounded-lg shadow-lg">
                <p class="text-gray-600 mb-4">Faça o upload do logótipo que aparecerá no cabeçalho de todas as páginas,
                    substituindo o nome "Aurora clipping".</p>
                <div>
                    <h4 class="text-lg font-semibold mb-2">Logótipo da Aplicação</h4>
                    <input type="file" id="global-logo-upload" accept="image/*"
                        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                </div>
            </div>
        </section>

        <section id="company-user-admin-page" class="page-section fade-in">
            <button id="back-to-super-admin-users"
                class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar para Super
                Admin</button>
            <h2 id="company-user-admin-title" class="text-2xl sm:text-3xl font-bold mb-6">Gerir Usuários</h2>
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg">
                <form id="user-form" class="flex flex-col sm:flex-row gap-2 mb-4">
                    <input type="text" id="user-input" placeholder="Nome do usuário"
                        class="flex-grow px-3 py-2 border border-gray-300 rounded-md">
                    <input type="text" id="user-password-input" placeholder="Palavra-passe"
                        class="flex-grow px-3 py-2 border border-gray-300 rounded-md">
                    <input type="hidden" id="user-id">
                    <button type="submit"
                        class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Guardar</button>
                </form>
                <ul id="admin-user-list" class="space-y-2 max-h-96 overflow-y-auto"></ul>
            </div>
        </section>

        <section id="company-keyword-admin-page" class="page-section fade-in">
            <button id="back-to-super-admin-kw"
                class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar para Super
                Admin</button>
            <h2 id="company-keyword-admin-title" class="text-2xl sm:text-3xl font-bold mb-6">Gerir Palavras-Chave</h2>
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg">
                <form id="keyword-form" class="flex gap-2 mb-4">
                    <input type="text" id="keyword-input" placeholder="Adicionar ou editar palavra"
                        class="flex-grow px-3 py-2 border border-gray-300 rounded-md">
                    <input type="hidden" id="keyword-id">
                    <button type="submit"
                        class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Guardar</button>
                </form>
                <ul id="admin-keyword-list" class="space-y-2 max-h-96 overflow-y-auto"></ul>
            </div>
        </section>

        <section id="company-settings-admin-page" class="page-section fade-in">
            <button id="back-to-super-admin-settings"
                class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar para Super
                Admin</button>
            <h2 id="company-settings-admin-title" class="text-2xl sm:text-3xl font-bold mb-6">Opções da Empresa</h2>
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg">
                <div class="space-y-6">
                    <div class="flex items-center"><input type="checkbox" id="report-access-toggle"
                            class="h-4 w-4 text-indigo-600 border-gray-300 rounded"><label for="report-access-toggle"
                            class="ml-2 block text-sm text-gray-900">Permitir o acesso ao relatório.</label></div>
                    <div class="flex items-center"><input type="checkbox" id="map-access-toggle"
                            class="h-4 w-4 text-indigo-600 border-gray-300 rounded"><label for="map-access-toggle"
                            class="ml-2 block text-sm text-gray-900">Permitir o acesso ao Mapa de Notícias.</label>
                    </div>
                    <div class="flex items-center"><input type="checkbox" id="fetch-only-new-toggle"
                            class="h-4 w-4 text-indigo-600 border-gray-300 rounded"><label for="fetch-only-new-toggle"
                            class="ml-2 block text-sm text-gray-900">Capturar apenas notícias novas (evita
                            duplicados).</label></div>
                    <div class="flex items-center"><input type="checkbox" id="deletion-access-toggle"
                            class="h-4 w-4 text-indigo-600 border-gray-300 rounded"><label
                            for="deletion-access-toggle" class="ml-2 block text-sm text-gray-900">Permitir que os
                            usuários solicitem a exclusão de alertas.</label></div>
                    <div>
                        <h4 class="text-lg font-semibold mb-2">Logótipo da Empresa</h4><input type="file"
                            id="logo-upload" accept="image/*"
                            class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold mb-2">Âmbito das Notícias</h4>
                        <div id="news-scope-container" class="space-y-2">
                            <div class="flex items-center"><input type="radio" id="scope-nacional" name="news-scope"
                                    value="br" class="h-4 w-4 text-indigo-600 border-gray-300"><label
                                    for="scope-nacional" class="ml-2 block text-sm text-gray-900">Nacionais
                                    (Brasil)</label></div>
                            <div class="flex items-center"><input type="radio" id="scope-internacional"
                                    name="news-scope" value="international"
                                    class="h-4 w-4 text-indigo-600 border-gray-300"><label
                                    for="scope-internacional"
                                    class="ml-2 block text-sm text-gray-900">Internacionais</label></div>
                            <div class="flex items-center"><input type="radio" id="scope-estadual" name="news-scope"
                                    value="state" class="h-4 w-4 text-indigo-600 border-gray-300"><label
                                    for="scope-estadual"
                                    class="ml-2 block text-sm text-gray-900">Estaduais</label></div>
                        </div>
                        <div id="state-select-container" class="hidden mt-2">
                            <label for="state-select" class="block text-sm font-medium text-gray-700 mb-1">Selecione o
                                Estado:</label>
                            <select id="state-select" class="w-full p-2 border border-gray-300 rounded-md"></select>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold mb-2">Captura de Notícias</h4>
                        <div id="capture-channels-container" class="space-y-2">
                            <div class="flex items-center"><input type="checkbox" class="capture-channel h-4 w-4 text-indigo-600 border-gray-300 rounded" id="capture-sites" value="Sites"><label class="ml-2 block text-sm text-gray-900" for="capture-sites">Sites</label></div>
                            <div class="flex items-center"><input type="checkbox" class="capture-channel h-4 w-4 text-indigo-600 border-gray-300 rounded" id="capture-youtube" value="YouTube"><label class="ml-2 block text-sm text-gray-900" for="capture-youtube">YouTube</label></div>
                            <div class="flex items-center"><input type="checkbox" class="capture-channel h-4 w-4 text-indigo-600 border-gray-300 rounded" id="capture-revistas" value="Revistas"><label class="ml-2 block text-sm text-gray-900" for="capture-revistas">Revistas</label></div>
                            <div class="flex items-center"><input type="checkbox" class="capture-channel h-4 w-4 text-indigo-600 border-gray-300 rounded" id="capture-radios" value="Rádios"><label class="ml-2 block text-sm text-gray-900" for="capture-radios">Rádios</label></div>
                            <div class="flex items-center"><input type="checkbox" class="capture-channel h-4 w-4 text-indigo-600 border-gray-300 rounded" id="capture-tv" value="TV"><label class="ml-2 block text-sm text-gray-900" for="capture-tv">TV</label></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="report-page" class="page-section fade-in">
            <div class="bg-white p-4 sm:p-8 rounded-lg shadow-lg">
                <div class="flex flex-col sm:flex-row justify-between items-start mb-6 gap-4">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-700 mb-4 sm:mb-0">Relatórios Gráficos</h2>
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 w-full sm:w-auto">
                        <div class="w-full sm:w-auto">
                            <label class="text-sm font-medium">Filtrar por Palavra-Chave:</label>
                            <div id="report-keyword-filter-container"
                                class="w-full p-2 border border-gray-300 rounded-md text-sm bg-white overflow-y-auto space-y-1">
                            </div>
                        </div>
                        <div class="w-full sm:w-auto">
                            <label class="text-sm font-medium">Filtrar por Período:</label>
                            <div class="flex items-center gap-2">
                                <input type="date" id="start-date" class="w-full px-2 py-1 border rounded-md">
                                <span class="text-gray-500">até</span>
                                <input type="date" id="end-date" class="w-full px-2 py-1 border rounded-md">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="p-4 border rounded-lg">
                        <h3 class="text-xl font-semibold mb-4 text-center">Notícias por Fonte</h3>
                        <div class="relative h-[420px]">
                            <canvas id="source-chart" class="w-full h-full"></canvas>
                        </div>
                    </div>
                    <div class="p-4 border rounded-lg">
                        <h3 class="text-xl font-semibold mb-4 text-center">Notícias por Canal</h3>
                        <div class="relative h-[420px]">
                            <canvas id="channel-chart" class="w-full h-full"></canvas>
                        </div>
                    </div>
                    <div class="p-4 border rounded-lg">
                        <h3 class="text-xl font-semibold mb-4 text-center">Notícias por Período</h3>
                        <div class="relative h-[420px]">
                            <canvas id="date-chart" class="w-full h-full"></canvas>
                        </div>
                    </div>
                    <div class="p-4 border rounded-lg">
                        <h3 class="text-xl font-semibold mb-4 text-center">Análise de Sentimento</h3>
                        <div class="relative h-[420px]">
                            <canvas id="sentiment-chart" class="w-full h-full"></canvas>
                        </div>
                    </div>
                    <div class="p-4 border rounded-lg">
                        <h3 class="text-xl font-semibold mb-4 text-center">Direta/Indireta</h3>
                        <div class="relative h-[420px]">
                            <canvas id="directness-chart" class="w-full h-full"></canvas>
                        </div>
                    </div>
                    <div class="p-4 border rounded-lg">
                        <h3 class="text-xl font-semibold mb-4 text-center">Espontânea/Provocada</h3>
                        <div class="relative h-[420px]">
                            <canvas id="media-type-chart" class="w-full h-full"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="search-page" class="page-section fade-in">
            <div class="bg-white p-4 sm:p-6 md:p-8 rounded-lg shadow-lg">
                <h2 class="text-xl sm:text-2xl md:text-3xl font-bold mb-6">Pesquisar nos Alertas Guardados</h2>
                <div id="filter-container" class="mb-8 p-4 border border-gray-200 rounded-lg bg-gray-50">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label for="search-source-filter" class="block text-sm font-medium text-gray-700">Notícias
                                por Fonte</label>
                            <select id="search-source-filter"
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div>
                            <label for="search-channel-filter" class="block text-sm font-medium text-gray-700">Notícias
                                por Canal</label>
                            <select id="search-channel-filter"
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="">Todos</option>
                                <option value="YouTube">YouTube</option>
                                <option value="Sites">Sites</option>
                                <option value="Revistas">Revistas</option>
                                <option value="Rádios">Rádios</option>
                                <option value="TV">TV</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Notícias por Período</label>
                            <div class="flex items-center gap-2 mt-1">
                                <input type="date" id="search-start-date"
                                    class="w-full px-2 py-1 border rounded-md text-sm">
                                <span class="text-gray-500 text-sm">até</span>
                                <input type="date" id="search-end-date"
                                    class="w-full px-2 py-1 border rounded-md text-sm">
                            </div>
                        </div>
                        <div>
                            <label for="search-sentiment-filter"
                                class="block text-sm font-medium text-gray-700">Análise de Sentimento</label>
                            <select id="search-sentiment-filter"
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="">Todos</option>
                                <option value="positive">Positivo</option>
                                <option value="neutral">Neutro</option>
                                <option value="negative">Negativo</option>
                            </select>
                        </div>
                    </div>
                    <div id="keyword-filter-buttons"></div>
                </div>
                <input type="text" id="search-input" placeholder="Digite para pesquisar em títulos ou descrições..."
                    class="w-full p-3 border border-gray-300 rounded-md mb-6">
                <div id="search-results" class="space-y-4 max-h-[60vh] overflow-y-auto">
                    <p class="text-gray-500">Digite algo para começar a pesquisar ou use os filtros.</p>
                </div>
            </div>
        </section>

        <section id="manual-alert-page" class="page-section fade-in">
            <button id="back-to-dashboard-1"
                class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar</button>
            <h2 class="text-2xl sm:text-3xl font-bold mb-6">Inserir Alerta Manualmente</h2>
            <div class="max-w-2xl mx-auto bg-white p-4 sm:p-6 rounded-lg shadow-lg">
                <form id="manual-alert-form" class="space-y-4">
                    <div>
                        <label for="manual-alert-company"
                            class="block text-sm font-medium text-gray-700">Empresa</label>
                        <select id="manual-alert-company" class="w-full px-3 py-2 border border-gray-300 rounded-md"></select>
                    </div>
                    <div class="hidden"><label for="manual-alert-title"
                            class="block text-sm font-medium text-gray-700">Título</label><input type="text"
                            id="manual-alert-title" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="hidden"><label for="manual-alert-desc"
                            class="block text-sm font-medium text-gray-700">Descrição</label><textarea
                            id="manual-alert-desc" rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea></div>
                    <div><label for="manual-alert-url"
                            class="block text-sm font-medium text-gray-700">URL</label><input type="url"
                            id="manual-alert-url" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div class="hidden"><label for="manual-alert-source" class="block text-sm font-medium text-gray-700">Fonte
                            (Veículo)</label><input type="text" id="manual-alert-source"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                    <!-- Novo: Data da Publicação -->
                    <div class="hidden">
                        <label for="manual-alert-publishedAt" class="block text-sm font-medium text-gray-700">Data da Publicação</label>
                        <input type="datetime-local" id="manual-alert-publishedAt" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <!-- Novo: Autor da Matéria -->
                    <div class="hidden">
                        <label for="manual-alert-author" class="block text-sm font-medium text-gray-700">Autor</label>
                        <input type="text" id="manual-alert-author" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Nome do autor (opcional)">
                    </div>
                    <!-- Novo: Canal (mídia) -->
                    <div class="hidden">
                        <label for="manual-alert-channel" class="block text-sm font-medium text-gray-700">Canal</label>
                        <select id="manual-alert-channel" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="Sites">Sites</option>
                            <option value="YouTube">YouTube</option>
                            <option value="Rádios">Rádios</option>
                            <option value="Revistas">Revistas</option>
                            <option value="TV">TV</option>
                        </select>
                    </div>
                    <div>
                        <label for="manual-alert-keyword" class="block text-sm font-medium text-gray-700 mb-1">Palavras-Chave</label>
                        <div class="flex items-center gap-2 mb-2">
                            <input type="checkbox" id="manual-alert-select-all" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <span class="text-sm text-gray-700">Selecionar todas</span>
                        </div>
                        <div id="manual-alert-keywords" class="space-y-1">
                            <p class="text-gray-500 text-sm">Selecione uma empresa primeiro</p>
                        </div>
                    </div>
                    <button type="submit"
                        class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Adicionar
                        Alerta</button>
                </form>
            </div>
        </section>

        <section id="deletion-requests-page" class="page-section fade-in">
            <button id="back-to-dashboard-2"
                class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar</button>
            <h2 class="text-2xl sm:text-3xl font-bold mb-6">Pedidos de Exclusão de Alertas</h2>
            <div id="deletion-requests-list" class="space-y-4">
                <p class="text-gray-500">A carregar pedidos...</p>
            </div>
        </section>

        <section id="super-admin-queue-page" class="page-section fade-in">
            <button id="back-to-dashboard-4"
                class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar</button>
            <h2 class="text-2xl sm:text-3xl font-bold mb-6">Fila de Aprovação de Alertas</h2>
            <div id="super-admin-pending-alerts-list" class="space-y-4">
                <p class="text-gray-500">A carregar alertas pendentes...</p>
            </div>
        </section>

        <section id="super-admin-report-page" class="page-section fade-in">
            <button id="back-to-dashboard-3"
                class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar</button>
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg">
                <div class="flex flex-col sm:flex-row justify-between items-start mb-6 gap-4">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-700 mb-4 sm:mb-0">Relatório Geral de Empresas
                    </h2>
                    <div class="flex items-center gap-2">
                        <label for="report-start-date" class="text-sm font-medium">De:</label>
                        <input type="date" id="report-start-date"
                            class="px-2 py-1 border border-gray-300 rounded-md text-sm">
                        <label for="report-end-date" class="text-sm font-medium">Até:</label>
                        <input type="date" id="report-end-date"
                            class="px-2 py-1 border border-gray-300 rounded-md text-sm">
                    </div>
                </div>
                <div class="mb-8">
                    <h3 class="text-xl font-semibold text-center mb-4">Total de Alertas por Empresa</h3>
                    <div class="relative h-[420px]">
                        <canvas id="company-summary-chart" class="w-full h-full"></canvas>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Empresa</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Total de Alertas</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Sentimento (%)</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Sentimento Predominante</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Canal Principal</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Fonte Principal</th>
                            </tr>
                        </thead>
                        <tbody id="super-admin-report-body" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="6" class="text-center py-4">Gerando relatório...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="company-keyword-report-page" class="page-section fade-in">
            <button id="back-to-super-admin-report"
                class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">← Voltar para Relatório
                Geral</button>
            <h2 id="company-keyword-report-title" class="text-2xl sm:text-3xl font-bold mb-6">Análise por Palavra-Chave
            </h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="p-4 bg-white rounded-lg shadow-lg h-[420px]">
                    <h3 class="text-xl font-semibold mb-4 text-center">Total de Alertas por Palavra-Chave</h3>
                    <canvas id="keyword-total-chart" class="w-full h-full"></canvas>
                </div>
                <div class="p-4 bg-white rounded-lg shadow-lg h-[420px]">
                    <h3 class="text-xl font-semibold mb-4 text-center">Sentimento por Palavra-Chave</h3>
                    <canvas id="keyword-sentiment-chart" class="w-full h-full"></canvas>
                </div>
            </div>
        </section>

        <section id="critical-report-page" class="page-section fade-in">
            <button id="back-to-super-admin-critical"
                class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">← Voltar para Painel
                de Super-Administrador</button>
            <h2 class="text-2xl sm:text-3xl font-bold mb-6">Relatório de Análise Crítica</h2>

            <div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                <div id="critical-company-container" class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1" for="critical-company-select">Empresa</label>
                    <select id="critical-company-select" class="w-full border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" for="critical-start-date">Período Inicial</label>
                    <input id="critical-start-date" type="date" class="w-full border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" for="critical-end-date">Período Final</label>
                    <input id="critical-end-date" type="date" class="w-full border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" />
                </div>
            </div>
            <button id="critical-generate-btn" class="mb-6 w-full bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Gerar Relatório</button>

            <div id="critical-summary" class="mb-6 p-4 bg-gray-50 rounded-md text-gray-800"></div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="p-4 bg-white rounded-lg shadow-lg h-[420px]">
                    <h3 class="text-xl font-semibold mb-4 text-center">Distribuição da Mídia</h3>
                    <canvas id="critical-channel-chart" class="w-full h-full"></canvas>
                </div>
                <div class="p-4 bg-white rounded-lg shadow-lg h-[420px]">
                    <h3 class="text-xl font-semibold mb-4 text-center">Notícias por tipo de texto</h3>
                    <canvas id="critical-space-chart" class="w-full h-full"></canvas>
                </div>
                <div class="p-4 bg-white rounded-lg shadow-lg h-[420px]">
                    <h3 class="text-xl font-semibold mb-4 text-center">Direta/Indireta</h3>
                    <canvas id="critical-space-qual-chart" class="w-full h-full"></canvas>
                </div>
                <div class="p-4 bg-white rounded-lg shadow-lg h-[420px]">
                    <h3 class="text-xl font-semibold mb-4 text-center">Mídia Provocada/Espontânea</h3>
                    <canvas id="critical-spontaneity-chart" class="w-full h-full"></canvas>
                </div>
                <div class="p-4 bg-white rounded-lg shadow-lg h-[420px]">
                    <h3 class="text-xl font-semibold mb-4 text-center">Notícias por Fonte</h3>
                    <canvas id="critical-vehicle-chart" class="w-full h-full"></canvas>
                </div>
                <div class="p-4 bg-white rounded-lg shadow-lg h-[420px]">
                    <h3 class="text-xl font-semibold mb-4 text-center">Gráfico de Sentimento</h3>
                    <canvas id="critical-valuation-chart" class="w-full h-full"></canvas>
                </div>
                <div class="p-4 bg-white rounded-lg shadow-lg h-[420px] lg:col-span-2">
                    <h3 class="text-xl font-semibold mb-4 text-center">Notícias por Data de Publicação</h3>
                    <canvas id="critical-date-chart" class="w-full h-full"></canvas>
                </div>
                <div class="p-4 bg-white rounded-lg shadow-lg h-[420px] lg:col-span-2">
                    <h3 class="text-xl font-semibold mb-4 text-center">Assunto (Nuvem de Palavras)</h3>
                    <div id="critical-wordcloud" class="w-full h-full overflow-auto flex flex-wrap items-start content-start gap-2"></div>
                </div>
                <div class="p-4 bg-white rounded-lg shadow-lg min-h-[300px] lg:col-span-2">
                    <h3 class="text-xl font-semibold mb-4 text-center">Espaço ocupado na mídia</h3>
                    <div id="critical-media-space" class="grid grid-cols-2 gap-4 text-center">
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <h4 class="text-lg font-medium text-blue-700">Tempo em TV</h4>
                            <p id="tv-time" class="text-2xl font-bold text-blue-900">0 min</p>
                        </div>
                        <div class="p-4 bg-green-50 rounded-lg">
                            <h4 class="text-lg font-medium text-green-700">Tempo em Rádio</h4>
                            <p id="radio-time" class="text-2xl font-bold text-green-900">0 min</p>
                        </div>
                        <div class="p-4 bg-purple-50 rounded-lg">
                            <h4 class="text-lg font-medium text-purple-700">Tamanho Web</h4>
                            <p id="web-size" class="text-2xl font-bold text-purple-900">0 cm</p>
                        </div>
                        <div class="p-4 bg-red-50 rounded-lg">
                            <h4 class="text-lg font-medium text-red-700">Tempo YouTube</h4>
                            <p id="youtube-time" class="text-2xl font-bold text-red-900">0 min</p>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-white rounded-lg shadow-lg min-h-[300px] lg:col-span-2">
                    <h3 class="text-xl font-semibold mb-4 text-center">Análise de Sentimento por Tipo de Mídia</h3>
                    <div id="critical-sentiment-by-channel" class="w-full h-[300px]">
                        <canvas id="sentiment-by-channel-chart"></canvas>
                    </div>
                </div>
                <div class="p-4 bg-white rounded-lg shadow-lg min-h-[300px] sm:min-h-[400px] lg:col-span-2">
                    <h3 class="text-xl font-semibold mb-4 text-center">Mapa de Notícias</h3>
                    <div id="critical-report-map" class="w-full h-[400px] rounded-md border border-gray-200"></div>
                </div>
            </div>
        </section>

        <section id="article-detail-page" class="page-section fade-in">
            <div class="flex justify-between items-center mb-4">
                <button id="back-from-detail"
                    class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">← Voltar</button>
                <div id="share-buttons-container" class="flex items-center gap-2">
                    <button id="print-btn" title="Imprimir Relatório"
                        class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                        <svg class="w-5 h-5 text-gray-700" fill="currentColor" viewBox="0 0 20 20"
                            xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd"
                                d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v3a2 2 0 002 2h6a2 2 0 002-2v-3h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm3 0h4v3H8V4zm6 8V9H6v3h8zm-8-5h8v1a1 1 0 01-1 1H7a1 1 0 01-1-1V7z"
                                clip-rule="evenodd"></path>
                        </svg>
                    </button>
                    <button id="share-whatsapp-btn" title="Compartilhar no WhatsApp"
                        class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                        <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M16.75 13.96c.25.13.43.2.5.33.07.13.07.66 0 1.14-.07.48-.83 1-1.25 1.13-.42.13-1.14.2-3.13-.62-2-.82-3.5-2.25-4.63-3.8-1.13-1.55-1.7-3.13-1.63-3.6.07-.48.5-1 .63-1.14.13-.13.3-.13.42-.13h.5c.13 0 .25.07.38.38.13.25.43.98.5 1.05.07.07.07.13 0 .25-.07.13-.13.25-.25.38-.13.13-.25.25-.38.38-.07.07-.07.13.07.38.2.13.83.82 1.63 1.55.8.73 1.5 1 1.63 1.13.13.13.25.2.38.07.13-.13.38-.5.5-.63.13-.13.25-.25.38-.25s.33.07.43.13c.1.13.58.57.68.68.1.1.18.2.2.3.03.17.03.25.03.38v.12Z M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Zm0 18.13a8.13 8.13 0 1 1 0-16.26 8.13 8.13 0 0 1 0 16.26Z"
                                clip-rule="evenodd" fill-rule="evenodd"></path>
                        </svg>
                    </button>
                    <button id="share-email-btn" title="Compartilhar por E-mail"
                        class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                        <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M2.25 5.63a2.5 2.5 0 0 1 2.5-2.5h14.5a2.5 2.5 0 0 1 2.5 2.5v12.5a2.5 2.5 0 0 1-2.5-2.5H4.75a2.5 2.5 0 0 1-2.5-2.5V5.63Zm3.12 1.88 5.63 4.25a2 2 0 0 0 2.5 0l5.63-4.25a.5.5 0 0 0-.63-.75L12 10.13 5.9 6.75a.5.5 0 0 0-.5.88Z"
                                clip-rule="evenodd" fill-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <div id="report-content" class="bg-white p-8 md:p-12 rounded-lg shadow-lg">
                <div class="flex justify-between items-start border-b-2 pb-4 mb-4">
                    <div id="aurora-clipping-logo" class="flex items-center text-gray-500">
                    </div>
                    <div id="report-logo-container" class="h-16 flex-grow flex justify-center items-center">
                    </div>
                    <div class="text-right">
                        <h2 class="text-2xl font-bold text-gray-800">Relatório de Notícia</h2>
                        <p id="report-date" class="text-sm text-gray-500"></p>
                    </div>
                </div>

                <div id="report-meta-grid"
                    class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-6 p-4 bg-gray-50 rounded-md"></div>
                <h1 id="detail-title" class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6"></h1>
                <div id="detail-content" class="prose max-w-none text-gray-700 leading-relaxed mb-8"></div>
                <div id="detail-ai-insights"></div>

                <div class="border-t-2 pt-4 mt-8 text-center">
                    <p class="text-sm text-gray-500">Para ler a matéria completa, acesse o link original:</p>
                    <a id="detail-original-link" href="#" target="_blank" rel="noopener noreferrer"
                        class="text-indigo-600 hover:underline font-semibold break-all"></a>
                </div>
            </div>
        </section>

        <!-- Nova página Monitoramento de Mídia -->
        <section id="media-monitoring-page" class="page-section fade-in">
            <button id="back-to-admin-config-7" class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar</button>
            <h2 class="text-2xl sm:text-3xl font-bold mb-2 text-blue-600">Relatório de monitoramento de mídia</h2>
            <p class="text-gray-600 mb-6">Relatório das últimas 24 horas</p>
            
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg mb-6">
                <h3 class="text-lg sm:text-xl font-semibold mb-4">Selecionar Empresa</h3>
                <select id="media-monitoring-company" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <option value="">Selecione uma empresa...</option>
                </select>
            </div>

            <div id="media-monitoring-report" class="hidden bg-white p-6 rounded-lg shadow-lg">
                <!-- Conteúdo do relatório será carregado aqui -->
            </div>

            <div id="media-monitoring-empty" class="hidden bg-white p-8 rounded-lg shadow-lg text-center">
                <p class="text-gray-600">Selecione uma empresa para gerar o relatório.</p>
            </div>
        </section>

    </main>

    <!-- Modais -->
    <div id="justification-modal"
        class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-none shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Justificar Exclusão</h3>
                <div class="mt-2 py-3">
                    <p class="text-sm text-gray-500 mb-2">Por favor, informe o motivo pelo qual deseja excluir este
                        alerta. O seu pedido será enviado para aprovação.</p>
                    <textarea id="justification-text" rows="4"
                        class="w-full p-2 border border-gray-300 rounded-md" required></textarea>
                </div>
                <div class="items-center px-4 py-3 flex gap-2">
                    <button id="submit-justification-btn"
                        class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700 disabled:bg-red-300"
                        disabled>Enviar Pedido</button>
                    <button id="cancel-justification-btn"
                        class="px-4 py-2 bg-gray-200 text-gray-900 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="delete-modal"
        class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" stroke="currentColor" fill="none" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Excluir Empresa</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">Tem a certeza que deseja excluir a empresa <strong
                            id="company-name-to-delete"></strong>?<br><br><span
                            class="font-bold text-red-600">Esta ação é permanente e irá remover todos os dados
                            associados.</span></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirm-delete-btn"
                        class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700">Sim,
                        excluir</button>
                    <button id="cancel-delete-btn"
                        class="mt-3 px-4 py-2 bg-gray-200 text-gray-900 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="link-modal"
        class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">Link de Acesso Exclusivo</h3>
                <div class="mt-4 px-7 py-3">
                    <p class="text-sm text-gray-500 mb-2">Utilize este link para dar acesso direto à página de login
                        desta empresa:</p>
                    <input type="text" id="access-link-input" readonly
                        class="w-full bg-gray-100 p-2 border rounded-md text-sm">
                </div>
                <div class="items-center px-4 py-3 flex gap-2">
                    <button id="copy-link-btn"
                        class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700">Copiar</button>
                    <button id="close-link-modal-btn"
                        class="px-4 py-2 bg-gray-200 text-gray-900 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="confirm-delete-keyword-modal"
        class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" stroke="currentColor" fill="none" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Excluir Palavra-Chave</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">Tem a certeza que deseja excluir a palavra-chave "<strong
                            id="keyword-to-delete-name"></strong>"?<br><br><span
                            class="font-bold text-red-600">Esta ação também irá remover todos os alertas associados a
                            ela.</span></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirm-delete-keyword-btn"
                        class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700">Sim,
                        excluir</button>
                    <button id="cancel-delete-keyword-btn"
                        class="mt-3 px-4 py-2 bg-gray-200 text-gray-900 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="transfer-keyword-modal"
        class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Transferir Palavra-Chave</h3>
                <div class="mt-2 px-2 py-3">
                    <p class="text-sm text-gray-700">Selecione a empresa de destino para transferir a palavra-chave "<strong id="keyword-to-transfer-name"></strong>" e todo o histórico de alertas associados.</p>
                    <label class="block text-sm font-medium text-gray-700 mt-3">Empresa de destino</label>
                    <select id="transfer-company-select" class="mt-1 w-full bg-gray-100 p-2 border rounded-md text-sm"></select>
                </div>
                <div class="items-center px-2 py-3">
                    <button id="confirm-transfer-keyword-btn"
                        class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700">Transferir</button>
                    <button id="cancel-transfer-keyword-btn"
                        class="mt-3 px-4 py-2 bg-gray-200 text-gray-900 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Função de callback global para a API do Google Maps
        function initMap() {
            try {
                const map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 4,
                    center: { lat: -14.235, lng: -51.925 }, // Centro do Brasil
                });
                const mapReadyEvent = new CustomEvent('mapReady', { detail: map });
                window.dispatchEvent(mapReadyEvent);
            } catch (e) {
                console.error("Erro ao inicializar o mapa do Google:", e);
            }
        }
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, connectFirestoreEmulator, collection, getDocs, doc, getDoc, setDoc, addDoc, deleteDoc, updateDoc, query, where, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getFunctions, httpsCallable, connectFunctionsEmulator } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js";

        const firebaseConfig = { apiKey: "AIzaSyDC4vQ3PiAAy0WYIrLUTKZGb6WejSVdLrE", authDomain: "noticias-6e952.firebaseapp.com", projectId: "noticias-6e952", storageBucket: "noticias-6e952.appspot.com", messagingSenderId: "788555331572", appId: "1:788555331572:web:328cc3967fad0155352ba1" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const functions = getFunctions(app, 'southamerica-east1');
        // Conectar emuladores localmente via flags separadas (?functions=true, ?firestore=true)
        const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
        const params = new URLSearchParams(location.search);
        const useFunctionsEmu = isLocal && params.get('functions') === 'true';
        const useFirestoreEmu = isLocal && params.get('firestore') === 'true';
        if (useFunctionsEmu) {
            try { connectFunctionsEmulator(functions, '127.0.0.1', 5003); } catch (e) { console.warn('Falha ao conectar ao Functions Emulator:', e); }
        }
        if (useFirestoreEmu) {
            try { connectFirestoreEmulator(db, '127.0.0.1', 8080); } catch (e) { console.warn('Falha ao conectar ao Firestore Emulator:', e); }
        }

        // Exibir erros globais para diagnosticar tela branca
        window.addEventListener('error', (e) => {
            const el = document.getElementById('global-alert');
            const msg = `Erro de script: ${e.message || (e.error && e.error.message) || 'desconhecido'}`;
            if (el) {
                el.innerHTML = `<div class="bg-red-100 border-red-500 text-red-700 border-l-4 p-4 rounded-md" role="alert"><p>${msg}</p></div>`;
            }
            console.error('Captured window error:', e);
        });
        window.addEventListener('unhandledrejection', (e) => {
            const el = document.getElementById('global-alert');
            const reason = e.reason && (e.reason.message || e.reason) || 'desconhecido';
            const msg = `Erro inesperado: ${reason}`;
            if (el) {
                el.innerHTML = `<div class="bg-red-100 border-red-500 text-red-700 border-l-4 p-4 rounded-md" role="alert"><p>${msg}</p></div>`;
            }
            console.error('Captured unhandledrejection:', e);
        });

        const appId = firebaseConfig.projectId;
        let currentUser = null, clockInterval = null, selectedCompanyForManagement = null, allCompanyArticles = [], companyIdToDelete = null, articleToDeleteInfo = null, mediaMonitoringPage = null;
let companyCaptureChannels = null;
        let sourceChartInstance = null, dateChartInstance = null, sentimentChartInstance = null, directnessChartInstance = null, channelChartInstance = null, mediaTypeChartInstance = null, companySummaryChartInstance = null, keywordTotalChartInstance = null, keywordSentimentChartInstance = null, criticalChannelChartInstance = null, criticalSpaceChartInstance = null, criticalSpaceQualChartInstance = null, criticalVehicleChartInstance = null, criticalValuationChartInstance = null, criticalDateChartInstance = null, criticalSpontaneityChartInstance = null;
        let superAdminCredentials = { user: 'ulysses', pass: 'adminqwert' };
        let notificationListener = null, companiesListener = null, deletionRequestsListener = null, pendingAlertsListener = null, activityCompaniesListener = null, activityPendingListener = null, activityDeletionListener = null;
        let keywordToDeleteInfo = null;
let keywordToTransferInfo = null;
        let currentDetailArticle = null;
        let mapInstance = null;
        let mapMarkers = [];

        let pageSections, navLoggedIn, navInicio, navRelatorio, navMapa, navPesquisa, navAtividade, navSuperAdmin, navLogout, navConfiguracoesAdmin, globalAlert, loginPage, dashboardPage, mapPage, searchPage, activityPage, superAdminPage, companyKeywordAdminPage, companySettingsAdminPage, reportPage, companyUserAdminPage, configuracoesAdminPage, loginForm, dashboardTitle, currentDateTimeEl, dashboardKeywordList, newsAlertsContainer, newsAlerts, alertDateFilter, reportAccessToggle, mapAccessToggle, logoUploadInput, headerLogoContainer, loginLogoContainer, filterContainer, searchInput, searchResults, companyForm, companyList, backToSuperAdminKwBtn, backToSuperAdminSettingsBtn, backToSuperAdminUsersBtn, companyKeywordAdminTitle, companySettingsAdminTitle, companyUserAdminTitle, keywordForm, keywordInput, keywordIdInput, adminKeywordList, userForm, userInput, userPasswordInput, userIdInput, adminUserList, notificationBell, notificationBadge, manualTriggerBtn, deleteModal, confirmDeleteBtn, cancelDeleteBtn, companyNameToDeleteEl, newsScopeContainer, startDateInput, endDateInput, linkModal, accessLinkInput, copyLinkBtn, closeLinkModalBtn, reportKeywordFilterContainer, stateSelectContainer, stateSelect, captureChannelsContainer, changePasswordForm, apiKeyNewsApiInput, apiKeyFirebaseNewsInput, apiKeyGoogleMapsInput, apiKeyGNewsInput1, apiKeyGNewsInput2, apiKeyGNewsInput3, apiKeyGNewsInput4, apiKeyYoutubeInput, apiKeyBloggerInput, apiKeyVisionInput, apiKeyVideoIntelligenceInput, apiKeySpeechToTextInput, showAllAlertsBtn, deletionAccessToggle, justificationModal, justificationText, submitJustificationBtn, cancelJustificationBtn, btnManualAlert, btnDeletionRequests, btnSuperAdminReport, manualAlertPage, deletionRequestsPage, superAdminReportPage, backToDashboard1, backToDashboard2, backToDashboard3, manualAlertForm, deletionRequestsList, superAdminReportBody, deletionRequestsBadge, pendingAlertsPage, pendingAlertsList, btnPendingAlerts, backToDashboard4, confirmDeleteKeywordBtn, cancelDeleteKeywordBtn, confirmDeleteKeywordModal, keywordToDeleteNameEl, bloggerIdInput, rssUrlInput, fetchOnlyNewToggle, changePasswordPage, globalKeysPage, globalSourcesPage, btnChangePassword, btnGlobalKeys, btnNewsSources, backToAdminConfig1, backToAdminConfig2, backToAdminConfig3, globalLogoPage, btnGlobalLogo, backToAdminConfig4, globalLogoUpload, globalLogoArea, logoLink, btnRadioSources, globalRadioSourcesPage, backToAdminConfig5, radioSourcesInput, youtubeChannelsInput, youtubeChannelsFrequencyInput, youtubeFrequencyInput, youtubeFrequencyTimeInput, articleDetailPage, backFromDetail, detailTitle, detailMeta, detailContent, shareWhatsappBtn, shareEmailBtn, companyKeywordReportPage, backToSuperAdminReportBtn, companyKeywordReportTitle, detailAiInsights, printBtn, shareButtonsContainer, mapStartDateInput, mapEndDateInput, mapFilterBtn, reportStartDateInput, reportEndDateInput, criticalReportPage, backToSuperAdminCriticalBtn, criticalCompanySelect, criticalStartDateInput, criticalEndDateInput, criticalGenerateBtn, criticalSummary, rssFrequencyInput, gnewsFrequencyInput, globalTvSourcesPage, btnTvSources, backToAdminConfig7, tvSourcesInput, transferKeywordModal, transferCompanySelect, confirmTransferKeywordBtn, cancelTransferKeywordBtn, keywordToTransferNameEl, companySearchInput;

        function showAlert(message, type = 'success') {
            // Suprimir diagnóstico nas páginas das empresas (usuários não-super-admin)
            try {
                const isDiagnostic = typeof message === 'string' && message.trim().toLowerCase().startsWith('diagnóstico:');
                if (isDiagnostic && currentUser && !currentUser.isSuperAdmin) {
                    return; // não exibir diagnóstico para empresas
                }
            } catch (_) { /* noop */ }

            const el = globalAlert || document.getElementById('global-alert');
            if (!el) { console.warn('global-alert element not found. Message:', message); return; }
            const c = type === 'success' ? 'bg-green-100 border-green-500 text-green-700' : 'bg-red-100 border-red-500 text-red-700';
            el.innerHTML = `<div class="${c} border-l-4 p-4 rounded-md fade-in" role="alert"><p>${message}</p></div>`;
            setTimeout(() => { if (el) el.innerHTML = ''; }, 4000);
        }
        function getChannelCategory(sourceName) {
            const name = (sourceName || "").toLowerCase();
            if (name.includes('youtube')) return 'YouTube';
            if (name.includes('globo') || name.includes('g1') || name.includes('uol') || name.includes('terra') || name.includes('r7')) return 'Sites';
            if (name.includes('veja') || name.includes('istoé') || name.includes('exame')) return 'Revistas';
            if (name.includes('cbn') || name.includes('bandeirantes')) return 'Rádios';
            return 'Sites';
        }
        function getDisplaySourceName(item) {
            try {
                const srcNameLower = String(item?.source?.name || '').toLowerCase();
                const urlCandidate = String(item?.source?.url || item?.url || '');
                const isYouTube = srcNameLower.includes('youtube') || urlCandidate.includes('youtube.com') || urlCandidate.includes('youtu.be');
                
                // SEMPRE priorizar o nome da fonte/veículo sobre o autor
                // Preferir nome normalizado da fonte quando disponível
                const normalizedName = (item?.source?.displayName ?? item?.source?.name ?? '').toString().trim();
                if (normalizedName.length > 0) return normalizedName;
                
                if (isYouTube) {
                    const channelTitle = (item && (item.author || item.channelTitle || item.source?.channelTitle)) || '';
                    if (channelTitle && channelTitle.trim().length > 0) return channelTitle.trim();
                    try {
                        const candidate = urlCandidate.startsWith('http') ? urlCandidate : `https://${urlCandidate}`;
                        const u = new URL(candidate);
                        const parts = u.pathname.split('/').filter(Boolean);
                        const handle = parts.find(p => p.startsWith('@'));
                        if (handle) return handle.replace(/^@/, '');
                    } catch {}
                    return 'YouTube';
                }
                // Fallback para domínio do URL quando não houver nome
                let host = '';
                try {
                    const candidate = urlCandidate.startsWith('http') ? urlCandidate : `https://${urlCandidate}`;
                    const u = new URL(candidate);
                    host = u.hostname.replace(/^www\./, '');
                    if (host === 'google.com' && u.pathname.includes('/search')) {
                        const q = u.searchParams.get('q');
                        if (q) {
                            const decoded = decodeURIComponent(q);
                            const domainMatch = decoded.match(/([a-z0-9.-]+\.[a-z]{2,})/i);
                            if (domainMatch) host = domainMatch[1].replace(/^www\./, '');
                        }
                    }
                } catch (e) {
                    const lower = urlCandidate.toLowerCase();
                    const m = lower.match(/(?:https?:\/\/)?(?:www\.)?([^\/]+)/);
                    if (m && m[1]) host = m[1].replace(/^www\./, '');
                }
                return host || '-';
            } catch {
                return (item?.source?.displayName ?? item?.source?.name ?? '-');
            }
        }
        function updateView(pageName) {
            if (!pageSections || typeof pageSections.forEach !== 'function') {
                pageSections = document.querySelectorAll('.page-section');
            }
            pageSections.forEach(s => s.classList.remove('active'));
            const i = !!currentUser;
            if (navLoggedIn) navLoggedIn.style.display = i ? 'flex' : 'none';
            if (navRelatorio) navRelatorio.classList.toggle('hidden', !currentUser || currentUser.isSuperAdmin || !currentUser.canAccessReport);
            if (navMapa) navMapa.classList.toggle('hidden', !currentUser || currentUser.isSuperAdmin || !currentUser.canAccessMap);
            if (navSuperAdmin) navSuperAdmin.classList.toggle('hidden', !currentUser || !currentUser.isSuperAdmin || (currentUser && currentUser.isRestrictedGlobal));
            if (navConfiguracoesAdmin) navConfiguracoesAdmin.classList.toggle('hidden', !currentUser || !currentUser.isSuperAdmin || (currentUser && currentUser.isRestrictedGlobal));
            if (navPesquisa) navPesquisa.classList.toggle('hidden', !currentUser || (currentUser && currentUser.isSuperAdmin));
            if (navAtividade) navAtividade.classList.toggle('hidden', !currentUser || !currentUser.isSuperAdmin || (currentUser && currentUser.isRestrictedGlobal));
            if (clockInterval) clearInterval(clockInterval);
            loadAndDisplayLogo();
            loadAndDisplayGlobalLogo();
            switch (pageName) {
                case 'login': loginPage.classList.add('active'); break;
                case 'dashboard': dashboardPage.classList.add('active'); renderDashboard(); updateDateTime(); clockInterval = setInterval(updateDateTime, 60000); break;
                case 'map': mapPage.classList.add('active'); renderMapPage(); break;
                case 'search': searchPage.classList.add('active'); if (typeof setupSearchPage === 'function') setupSearchPage(); break;
                case 'super-admin': superAdminPage.classList.add('active'); setupCompaniesListener(); break;
                case 'activity': activityPage.classList.add('active'); setupActivityListeners(); if (typeof renderActivityPage === 'function') renderActivityPage(); break;
                case 'company-keyword-admin': companyKeywordAdminPage.classList.add('active'); renderCompanyKeywordAdminPage(); break;
                case 'company-settings-admin': companySettingsAdminPage.classList.add('active'); renderCompanySettingsAdminPage(); break;
                case 'company-user-admin': companyUserAdminPage.classList.add('active'); renderCompanyUserAdminPage(); break;
                case 'report': reportPage.classList.add('active'); renderReportPage(); break;
                case 'configuracoes-admin': configuracoesAdminPage.classList.add('active'); break;
                case 'change-password': changePasswordPage.classList.add('active'); break;
                case 'global-keys': globalKeysPage.classList.add('active'); renderGlobalKeysPage(); break;
                case 'global-sources': globalSourcesPage.classList.add('active'); renderGlobalSourcesPage();
                // Pós-carregamento: capturar valores atuais como lastValue para evitar apagamentos
                setTimeout(() => { try { const r = document.getElementById('rssFrequencyMinutes'); const g = document.getElementById('gnewsFrequencyHours'); if (r) r.dataset.lastValue = r.value || ''; if (g) g.dataset.lastValue = g.value || ''; } catch (_) {} }, 0);
                break;
                case 'global-radio-sources': globalRadioSourcesPage.classList.add('active'); renderGlobalRadioSourcesPage(); break;
                case 'global-tv-sources': globalTvSourcesPage.classList.add('active'); if (typeof renderGlobalTvSourcesPage === 'function') renderGlobalTvSourcesPage(); break;
                case 'global-logo': globalLogoPage.classList.add('active'); break;
                case 'usuario-admin': {
                    const page = document.getElementById('usuario-admin-page');
                    if (page) page.classList.add('active');
                    const list = document.getElementById('usuario-admin-companies-list');
                    if (list) {
                        list.innerHTML = '';
                        try {
                            const q = query(collection(db, "artifacts", appId, "public", "data", "companies"), where("status", "==", "active"));
                            getDocs(q).then((snap) => {
                                snap.docs.forEach(docSnap => {
                                    const c = { id: docSnap.id, ...docSnap.data() };
                                    const wrapper = document.createElement('label');
                                    wrapper.className = 'flex items-center gap-2 py-1';
                                    const cb = document.createElement('input');
                                    cb.type = 'checkbox';
                                    cb.value = c.id;
                                    cb.className = 'form-checkbox h-4 w-4';
                                    const span = document.createElement('span');
                                    span.textContent = c.name;
                                    wrapper.appendChild(cb);
                                    wrapper.appendChild(span);
                                    list.appendChild(wrapper);
                                });
                            }).catch((error) => {
                                console.error("Erro ao carregar empresas ativas:", error);
                                showAlert("Erro ao carregar empresas ativas.", "error");
                            });
                        } catch (error) {
                            console.error("Erro ao carregar empresas ativas:", error);
                            showAlert("Erro ao carregar empresas ativas.", "error");
                        }
                    }
                    // Renderizar lista de usuários restritos
                    renderRestrictedUsers();
                    break;
                }
                case 'manual-alert': manualAlertPage.classList.add('active'); renderManualAlertPage(); break;
                case 'deletion-requests': deletionRequestsPage.classList.add('active'); setupDeletionRequestsListener(); break;
                case 'super-admin-report': superAdminReportPage.classList.add('active'); renderSuperAdminReport(); break;
                case 'critical-report': criticalReportPage.classList.add('active'); renderCriticalReportPage(); break;
                case 'media-monitoring': mediaMonitoringPage.classList.add('active'); renderMediaMonitoringPage(); break;
                case 'super-admin-queue': pendingAlertsPage.classList.add('active'); setupPendingAlertsListener(); break;
                case 'article-detail': articleDetailPage.classList.add('active'); break;
                case 'company-keyword-report': companyKeywordReportPage.classList.add('active'); break;
            }
            // Fallback: if nothing activated, ensure login is visible
            try {
                const sections = pageSections || document.querySelectorAll('.page-section');
                const anyActive = Array.from(sections).some(s => s.classList.contains('active'));
                if (!anyActive && loginPage) loginPage.classList.add('active');
            } catch (err) { console.warn('Fallback activation failed', err); }
        }
        function getStorage(key, defaultValue) { try { const d = localStorage.getItem(key); return d ? JSON.parse(d) : defaultValue; } catch (e) { console.error(e); return defaultValue; } }
        function setStorage(key, value) { localStorage.setItem(key, JSON.stringify(value)); }
        function updateDateTime() { if (!currentDateTimeEl) return; const n = new Date(), f = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }; currentDateTimeEl.textContent = `Data: ${n.toLocaleDateString('pt-BR', f).replace(',', ' -')}`; }

        function clearMarkers() {
            mapMarkers.forEach(marker => marker.setMap(null));
            mapMarkers = [];
        }

        async function renderMapPage() {
            if (!currentUser) return;
            if (!mapInstance) {
                window.addEventListener('mapReady', () => renderMapPage(), { once: true });
                return;
            }

            clearMarkers();

            const startDate = mapStartDateInput.value ? new Date(mapStartDateInput.value + 'T00:00:00') : null;
            const endDate = mapEndDateInput.value ? new Date(mapEndDateInput.value + 'T23:59:59') : null;

            try {
                const baseCollection = collection(db, "artifacts", appId, "users", currentUser.companyId, "articles");

                const queryConstraints = [
                    where("geolocation", "!=", null)
                ];

                if (startDate) {
                    queryConstraints.push(where("publishedAt", ">=", startDate));
                }
                if (endDate) {
                    queryConstraints.push(where("publishedAt", "<=", endDate));
                }

                if (startDate || endDate) {
                    queryConstraints.push(orderBy("publishedAt", "desc"));
                } else {
                    queryConstraints.push(orderBy("publishedAt", "desc"));
                }

                queryConstraints.push(limit(200));

                const articlesQuery = query(baseCollection, ...queryConstraints);
                const articlesSnapshot = await getDocs(articlesQuery);
                const infoWindow = new google.maps.InfoWindow();

                if (articlesSnapshot.empty) {
                    showAlert("Nenhuma notícia com geolocalização encontrada para o período selecionado.", "success");
                    return;
                }

                articlesSnapshot.forEach(doc => {
                    const article = { id: doc.id, ...doc.data() };
                    const marker = new google.maps.Marker({
                        position: article.geolocation,
                        map: mapInstance,
                        title: article.title,
                        animation: google.maps.Animation.DROP,
                    });
                    mapMarkers.push(marker);

                    marker.addListener('mouseover', () => {
                        const safeInfoTitle = (() => { try { return /[ÃÂâ]/.test(article.title) ? decodeURIComponent(escape(article.title)) : article.title; } catch(_) { return article.title; } })();
                infoWindow.setContent(`                        <div class="font-sans p-1">                            <p class="font-bold text-sm">${safeInfoTitle}</p>                            <p class="text-xs text-gray-500">${getDisplaySourceName(article)}</p>                        </div>                        `);
                        infoWindow.open({
                            anchor: marker,
                            map: mapInstance,
                        });
                    });

                    marker.addListener('click', () => {
                        currentDetailArticle = article;
                        renderArticleDetailPage(article);
                        updateView('article-detail');
                    });
                });

            } catch (error) {
                console.error("Erro ao carregar notícias para o mapa:", error);
                showAlert("Não foi possível carregar as notícias no mapa. Pode ser necessário criar um índice no Firestore.", "error");
            }
        }

        async function handleManualTrigger() {
            if (!manualTriggerBtn) return;
            manualTriggerBtn.disabled = true;
            manualTriggerBtn.textContent = 'A executar...';
            showAlert('A recolha manual de notícias foi iniciada. Isto pode demorar alguns minutos.', 'success');
            const manualFetch = httpsCallable(functions, 'manualFetch', { timeout: 540000 });
            try {
                const result = await manualFetch({ appId });
                showAlert(`Robô executado com sucesso! ${result.data.totalSaved} novos alertas foram para a fila de aprovação.`, 'success');
            } catch (error) {
                console.error("Erro ao acionar o robô manual:", error);
                showAlert(`Erro ao acionar o robô: ${error.message}`, 'error');
            } finally {
                manualTriggerBtn.disabled = false;
                manualTriggerBtn.textContent = 'Executar Robô Manualmente';
            }
        }

        async function handleLogoUpload(e) { const file = e.target.files[0]; if (!file) return; const companyId = currentUser.isSuperAdmin ? selectedCompanyForManagement.id : currentUser.companyId; if (!companyId) return; const reader = new FileReader(); reader.onloadend = async () => { try { const settingsRef = doc(db, "artifacts", appId, "public", "data", "settings", companyId); await setDoc(settingsRef, { logo: reader.result }, { merge: true }); loadAndDisplayLogo(); showAlert('Logótipo atualizado com sucesso!'); } catch (error) { console.error("Erro ao guardar o logótipo:", error); showAlert("Erro ao guardar o logótipo.", "error"); } }; reader.readAsDataURL(file); }
        async function loadAndDisplayLogo() { const companyId = currentUser ? currentUser.companyId : null; if (!companyId) { if (headerLogoContainer) headerLogoContainer.innerHTML = ''; if (loginLogoContainer) loginLogoContainer.innerHTML = ''; return; } const settingsRef = doc(db, "artifacts", appId, "public", "data", "settings", companyId); try { const docSnap = await getDoc(settingsRef); const logoData = docSnap.exists() ? docSnap.data().logo : null; const logoHtml = logoData ? `<img src="${logoData}" alt="Logótipo da Empresa" class="h-full w-auto object-contain">` : ''; if (headerLogoContainer) headerLogoContainer.innerHTML = logoHtml; if (loginLogoContainer) loginLogoContainer.innerHTML = logoHtml; } catch (error) { console.error("Erro ao carregar o logótipo:", error); } }
        async function loadCompanyCaptureChannels(companyId) { try { const settingsRef = doc(db, "artifacts", appId, "public", "data", "settings", companyId); const docSnap = await getDoc(settingsRef); const caps = docSnap.exists() ? docSnap.data().captureChannels : null; companyCaptureChannels = Array.isArray(caps) && caps.length > 0 ? caps : ['Sites','YouTube','Revistas','Rádios','TV']; } catch (error) { console.error("Erro ao carregar canais de captura:", error); companyCaptureChannels = ['Sites','YouTube','Revistas','Rádios','TV']; } }
        async function handleGlobalLogoUpload(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onloadend = async () => { try { const settingsRef = doc(db, "artifacts", appId, "public", "data", "settings", "global"); await setDoc(settingsRef, { appLogo: reader.result }, { merge: true }); loadAndDisplayGlobalLogo(); showAlert('Logótipo global atualizado com sucesso!'); } catch (error) { console.error("Erro ao guardar o logótipo global:", error); showAlert("Erro ao guardar o logótipo global.", "error"); } }; reader.readAsDataURL(file); }
        async function loadAndDisplayGlobalLogo() {
            const settingsRef = doc(db, "artifacts", appId, "public", "data", "settings", "global");
            try {
                const docSnap = await getDoc(settingsRef);
                const logoData = docSnap.exists() ? docSnap.data().appLogo : null;
                if (logoData && globalLogoArea) {
                    globalLogoArea.innerHTML = `<img src="${logoData}" alt="Logótipo da Aplicação" class="h-10 w-auto object-contain">`;
                } else if (globalLogoArea) {
                    globalLogoArea.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2 h-7 w-7 sm:h-8 sm:w-8"><path d="M2.5 17a2.4 2.4 0 0 1 3 0L12 23l6.5-6.5a2.4 2.4 0 0 1 3 0Z"/><path d="M5 11.5a2.5 2.5 0 0 1 0-5c1.5 0 2.8 1.3 2.8 2.8V13c0 1.4-1.3 2.8-2.8 2.8-1.5 0-2.8-1.3-2.8-2.8V8.5"/><path d="M19 11.5a2.5 2.5 0 0 0 0-5c-1.5 0-2.8 1.3-2.8 2.8V13c0 1.4 1.3 2.8 2.8 2.8 1.5 0-2.8-1.3-2.8-2.8V8.5"/></svg> Aurora clipping`;
                }
            } catch (error) {
                console.error("Erro ao carregar o logótipo global:", error);
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const companyName = document.getElementById('login-company').value.trim();
            const user = document.getElementById('login-user').value.trim();
            const pass = document.getElementById('login-password').value.trim();

            // Super Admin total
            if (companyName.toLowerCase() === 'newsclip' && user.toLowerCase() === superAdminCredentials.user && pass === superAdminCredentials.pass) {
                currentUser = { username: 'Ulysses', isSuperAdmin: true, isRestrictedGlobal: false, allowedCompanies: [], companyId: 'super', companyName: 'Super Admin' };
                setStorage('clipping_currentUser', currentUser);
                companyCaptureChannels = ['Sites','YouTube','Revistas','Rádios','TV'];
                updateView('dashboard');
                return;
            }

            // Usuário Global Restrito (coleção dedicada)
            if (companyName.toLowerCase() === 'newsclip') {
                try {
                    const restrictedQuery = query(collection(db, "artifacts", appId, "public", "data", "restrictedUsers"), where("username", "==", user), where("password", "==", pass));
                    const restrictedSnap = await getDocs(restrictedQuery);
                    if (!restrictedSnap.empty) {
                        const ru = restrictedSnap.docs[0].data();
                        const allowedCompanies = Array.isArray(ru.allowedCompanies) ? ru.allowedCompanies.filter(Boolean) : [];
                        currentUser = { username: user, isSuperAdmin: true, isRestrictedGlobal: true, allowedCompanies, companyId: 'super', companyName: 'Super Admin (Restrito)' };
                        setStorage('clipping_currentUser', currentUser);
                        companyCaptureChannels = ['Sites','YouTube','Revistas','Rádios','TV'];
                        updateView('dashboard');
                        return;
                    }
                } catch (err) {
                    console.error('Erro ao verificar usuário restrito:', err);
                }
            }

            // Usuário de empresa
            try {
                const companiesQuery = query(collection(db, "artifacts", appId, "public", "data", "companies"), where("name", "==", companyName.toUpperCase()));
                const companiesSnapshot = await getDocs(companiesQuery);
                if (companiesSnapshot.empty) {
                    showAlert('Empresa não encontrada.', 'error');
                    return;
                }
                const companyDoc = companiesSnapshot.docs[0];
                const company = { id: companyDoc.id, ...companyDoc.data() };
                if (company.status === 'inactive') {
                    showAlert('Esta empresa está inativa e não pode ser acedida.', 'error');
                    return;
                }
                const usersQuery = query(collection(db, "artifacts", appId, "users", company.id, "users"), where("username", "==", user), where("password", "==", pass));
                const usersSnapshot = await getDocs(usersQuery);
                if (!usersSnapshot.empty) {
                    const settingsDoc = await getDoc(doc(db, "artifacts", appId, "public", "data", "settings", company.id));
                    const canRequestDeletion = settingsDoc.exists() ? settingsDoc.data().canRequestDeletion : false;
                    const canAccessReport = settingsDoc.exists() ? settingsDoc.data().reportAccess !== false : true;
                    const canAccessMap = settingsDoc.exists() ? settingsDoc.data().mapAccess !== false : true;
                    currentUser = { username: user, companyId: company.id, companyName: company.name, isSuperAdmin: false, canRequestDeletion, canAccessReport, canAccessMap };
                    setStorage('clipping_currentUser', currentUser);
                    await loadCompanyCaptureChannels(company.id);
                    updateView('dashboard');
                } else {
                    showAlert('Usuário ou palavra-passe inválidos para esta empresa.', 'error');
                }
            } catch (error) {
                console.error("Erro de login:", error);
                showAlert("Ocorreu um erro durante o login.", "error");
            }
        }
        function handleLogout() {
            if (notificationListener) notificationListener();
            if (companiesListener) companiesListener();
            if (deletionRequestsListener) deletionRequestsListener();
            if (pendingAlertsListener) pendingAlertsListener();
            if (activityCompaniesListener) activityCompaniesListener();
            if (activityPendingListener) activityPendingListener();
            if (activityDeletionListener) activityDeletionListener();
            currentUser = null;
            selectedCompanyForManagement = null;
            localStorage.removeItem('clipping_currentUser');
            if (clockInterval) clearInterval(clockInterval);
            if (headerLogoContainer) headerLogoContainer.innerHTML = '';
            updateView('login');
        }
        function handleChangePassword(e) { e.preventDefault(); const currentPass = document.getElementById('current-password').value; const newPass = document.getElementById('new-password').value; if (currentPass === superAdminCredentials.pass) { superAdminCredentials.pass = newPass; showAlert('Palavra-passe alterada com sucesso para esta sessão.', 'success'); if (changePasswordForm) changePasswordForm.reset(); } else { showAlert('Palavra-passe atual incorreta.', 'error'); } }

        async function renderDashboard() {
            if (!currentUser) return;
            if (currentUser.isSuperAdmin) {
                if (document.getElementById('dashboard-grid')) document.getElementById('dashboard-grid').style.display = 'none';
                if (document.getElementById('super-admin-dashboard-message')) document.getElementById('super-admin-dashboard-message').style.display = 'block';
                // Ajuste de visibilidade de ações para usuários globais restritos
                (function(){
                    const reportBtnEl = document.getElementById('btn-super-admin-report');
                    const criticalBtnEl = document.getElementById('btn-critical-report');
                    const manualAlertBtnEl = document.getElementById('btn-manual-alert');
                    const pendingAlertsBtnEl = document.getElementById('btn-pending-alerts');
                    const deletionRequestsBtnEl = document.getElementById('btn-deletion-requests');
                    const manualBtnEl = document.getElementById('manual-trigger-btn');
                    if (currentUser && currentUser.isRestrictedGlobal) {
                        if (reportBtnEl) reportBtnEl.style.display = 'none';
                        if (criticalBtnEl) criticalBtnEl.style.display = 'none';
                        if (manualBtnEl) { manualBtnEl.style.display = 'none'; if (manualBtnEl.parentElement) manualBtnEl.parentElement.style.display = 'none'; }
                        if (manualAlertBtnEl) manualAlertBtnEl.style.display = 'block';
                        if (pendingAlertsBtnEl) pendingAlertsBtnEl.style.display = 'block';
                        if (deletionRequestsBtnEl) deletionRequestsBtnEl.style.display = 'block';
                    } else {
                        if (reportBtnEl) reportBtnEl.style.display = 'block';
                        if (criticalBtnEl) criticalBtnEl.style.display = 'block';
                        if (manualBtnEl) { manualBtnEl.style.display = 'block'; if (manualBtnEl.parentElement) manualBtnEl.parentElement.style.display = 'block'; }
                        if (manualAlertBtnEl) manualAlertBtnEl.style.display = 'block';
                        if (pendingAlertsBtnEl) pendingAlertsBtnEl.style.display = 'block';
                        if (deletionRequestsBtnEl) deletionRequestsBtnEl.style.display = 'block';
                    }
                })();
                setupPendingAlertsListener();
                setupDeletionRequestsListener();
            } else {
                if (document.getElementById('dashboard-grid')) document.getElementById('dashboard-grid').style.display = 'grid';
                if (document.getElementById('super-admin-dashboard-message')) document.getElementById('super-admin-dashboard-message').style.display = 'none';
                renderVerticalKeywordList();
                const settingsRef = doc(db, "artifacts", appId, "public", "data", "settings", currentUser.companyId);
                try {
                    const docSnap = await getDoc(settingsRef);
                    const hasReportAccess = docSnap.exists() ? docSnap.data().reportAccess !== false : true;
                    if (newsAlertsContainer) newsAlertsContainer.style.display = hasReportAccess ? 'block' : 'none';
                    if (navRelatorio) navRelatorio.classList.toggle('hidden', !hasReportAccess);
                    populateInitialAlerts();
                    setupNotificationListener();
                } catch (error) {
                    console.error("Erro ao renderizar o painel de controlo:", error);
                }
            }
            if (dashboardTitle) dashboardTitle.textContent = currentUser.isSuperAdmin ? 'Painel Super Admin' : `Notícias do Dia - ${currentUser.companyName}`;
        }
        async function renderVerticalKeywordList() { if (!currentUser || !dashboardKeywordList) return; try { const q = query(collection(db, "artifacts", appId, "users", currentUser.companyId, "keywords")); const querySnapshot = await getDocs(q); const keywords = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); // Ordenar palavras-chave por palavra em ordem alfabética
                keywords.sort((a, b) => a.word.localeCompare(b.word)); dashboardKeywordList.innerHTML = ''; const showAllLi = document.createElement('li'); showAllLi.className = 'keyword-filter active bg-indigo-100 text-indigo-800 text-md font-medium px-3 py-2 rounded-md flex justify-between items-center cursor-pointer hover:bg-indigo-200'; showAllLi.dataset.keyword = "all"; showAllLi.innerHTML = `<span>Mostrar Todas</span>`; dashboardKeywordList.appendChild(showAllLi); if (keywords.length === 0) { dashboardKeywordList.insertAdjacentHTML('beforeend', `<p class="text-gray-500 text-sm mt-2">Nenhuma palavra-chave.</p>`); } else { keywords.forEach(kw => { const li = document.createElement('li'); li.className = 'keyword-filter bg-indigo-100 text-indigo-800 text-md font-medium px-3 py-2 rounded-md flex justify-content-between items-center cursor-pointer hover:bg-indigo-200'; li.dataset.keyword = kw.word; li.innerHTML = `<span>${kw.word}</span>`; dashboardKeywordList.appendChild(li); }); } } catch (error) { console.error("Erro ao buscar palavras-chave:", error); } }

        function setupCompaniesListener() {
            if (companiesListener) companiesListener();
            const companiesQuery = query(collection(db, "artifacts", appId, "public", "data", "companies"));
            companiesListener = onSnapshot(companiesQuery, (querySnapshot) => {
                const companies = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Ordenar empresas por nome em ordem alfabética
                companies.sort((a, b) => a.name.localeCompare(b.name));
                if (!companyList) return;
                companyList.innerHTML = '';
                companies.forEach(c => {
                    const li = document.createElement('li');
                    li.className = 'flex flex-col sm:flex-row justify-between items-start sm:items-center bg-gray-100 p-3 rounded-md';
                    const statusClass = c.status === 'inactive' ? 'text-orange-500' : 'text-green-500';
                    const statusText = c.status === 'inactive' ? 'Inativa' : 'Ativa';
                    let actionButtons;
                    if (c.status === 'inactive') {
                        actionButtons = `<button data-id="${c.id}" class="reactivate-company-btn bg-yellow-500 text-white px-3 py-1 rounded-md text-sm hover:bg-yellow-600">Reativar</button>`;
                    } else {
                        actionButtons = `<button data-id="${c.id}" class="deactivate-company-btn bg-gray-500 text-white px-3 py-1 rounded-md text-sm hover:bg-gray-600">Inativar</button>`;
                    }

                    li.innerHTML = `                        <div class="flex-grow">                            <div data-company-id="${c.id}" class="company-name-view">                                <span class="font-bold">${c.name}</span>                                 <span class="text-sm ${statusClass}">(${statusText})</span>                                <button data-id="${c.id}" data-name="${c.name}" class="edit-company-name-btn text-blue-500 hover:text-blue-700 ml-2 text-sm">(Editar Nome)</button>                            </div>                            <div data-company-id="${c.id}" class="company-name-edit hidden">                                <input type="text" value="${c.name}" class="px-2 py-1 border border-gray-300 rounded-md">                                <button data-id="${c.id}" class="save-company-name-btn bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600 ml-2">Salvar</button>                                <button data-id="${c.id}" class="cancel-edit-company-name-btn bg-gray-400 text-white px-3 py-1 rounded-md text-sm hover:bg-gray-500 ml-1">Cancelar</button>                            </div>                        </div>                        <div class="mt-2 sm:mt-0 flex flex-wrap gap-2">                            <button data-company-name="${c.name}" class="view-access-link-btn bg-teal-500 text-white px-3 py-1 rounded-md text-sm hover:bg-teal-600">Link</button>                            <button data-company-id="${c.id}" data-company-name="${c.name}" class="manage-company-users-btn bg-purple-500 text-white px-3 py-1 rounded-md text-sm hover:bg-purple-600">Usuários</button>                            <button data-company-id="${c.id}" data-company-name="${c.name}" class="manage-company-keywords-btn bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600">Palavras-Chave</button>                            <button data-company-id="${c.id}" data-company-name="${c.name}" class="manage-company-settings-btn bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600">Opções</button>                            ${actionButtons}                            <button data-company-id="${c.id}" data-company-name="${c.name}" class="delete-company-btn bg-red-600 text-white px-3 py-1 rounded-md text-sm hover:bg-red-800">Excluir</button>                        </div>`;
                    companyList.appendChild(li);
                });
            }, (error) => {
                console.error("Erro ao escutar a coleção de empresas:", error);
                showAlert("Erro ao carregar a lista de empresas.", "error");
            });
        }
        async function handleCompanySubmit(e) { e.preventDefault(); const name = document.getElementById('company-name-input').value.trim(); if (!name) { showAlert('O nome da empresa é obrigatório.', 'error'); return; } try { const q = query(collection(db, "artifacts", appId, "public", "data", "companies"), where("name", "==", name.toUpperCase())); const querySnapshot = await getDocs(q); if (!querySnapshot.empty) { showAlert('Este nome de empresa já existe.', 'error'); return; } await addDoc(collection(db, "artifacts", appId, "public", "data", "companies"), { name: name.toUpperCase(), status: 'active' }); showAlert('Empresa adicionada com sucesso!'); if (companyForm) companyForm.reset(); } catch (error) { console.error("Erro ao adicionar empresa:", error); showAlert("Erro ao adicionar empresa.", "error"); } }
        async function handleCompanyActions(e) {
            const target = e.target;
            const companyId = target.dataset.id || target.dataset.companyId;

            if (target.classList.contains('edit-company-name-btn')) {
                document.querySelector(`.company-name-view[data-company-id="${companyId}"]`).classList.add('hidden');
                document.querySelector(`.company-name-edit[data-company-id="${companyId}"]`).classList.remove('hidden');
                return;
            }
            if (target.classList.contains('cancel-edit-company-name-btn')) {
                document.querySelector(`.company-name-view[data-company-id="${companyId}"]`).classList.remove('hidden');
                document.querySelector(`.company-name-edit[data-company-id="${companyId}"]`).classList.add('hidden');
                return;
            }
            if (target.classList.contains('save-company-name-btn')) {
                const input = document.querySelector(`.company-name-edit[data-company-id="${companyId}"] input`);
                const newName = input.value.trim().toUpperCase();
                if (newName) {
                    try {
                        const companyRef = doc(db, "artifacts", appId, "public", "data", "companies", companyId);
                        await updateDoc(companyRef, { name: newName });
                        showAlert('Nome da empresa atualizado com sucesso!', 'success');
                    } catch (error) {
                        console.error("Erro ao atualizar o nome da empresa:", error);
                        showAlert("Erro ao atualizar o nome.", "error");
                    }
                } else {
                    showAlert("O nome da empresa não pode ficar em branco.", "error");
                }
                return;
            }

            if (target.classList.contains('view-access-link-btn')) { const companyName = target.dataset.companyName; const baseUrl = window.location.origin + window.location.pathname; const accessUrl = `${baseUrl}?company=${encodeURIComponent(companyName)}`; if (accessLinkInput) accessLinkInput.value = accessUrl; if (linkModal) linkModal.classList.remove('hidden'); return; } if (!companyId) return; const companyRef = doc(db, "artifacts", appId, "public", "data", "companies", companyId); try { if (target.classList.contains('deactivate-company-btn')) { await updateDoc(companyRef, { status: 'inactive', deactivationDate: new Date().toISOString() }); } else if (target.classList.contains('reactivate-company-btn')) { await updateDoc(companyRef, { status: 'active', deactivationDate: null }); } else if (target.classList.contains('delete-company-btn')) { companyIdToDelete = companyId; if (companyNameToDeleteEl) companyNameToDeleteEl.textContent = target.dataset.companyName; if (deleteModal) deleteModal.classList.remove('hidden'); } else if (target.classList.contains('manage-company-keywords-btn')) { selectedCompanyForManagement = { id: target.dataset.companyId, name: target.dataset.companyName }; updateView('company-keyword-admin'); } else if (target.classList.contains('manage-company-settings-btn')) { selectedCompanyForManagement = { id: target.dataset.companyId, name: target.dataset.companyName }; updateView('company-settings-admin'); } else if (target.classList.contains('manage-company-users-btn')) { selectedCompanyForManagement = { id: target.dataset.companyId, name: target.dataset.companyName }; updateView('company-user-admin'); } } catch (error) { console.error("Erro ao lidar com a ação da empresa:", error); showAlert("Ocorreu um erro.", "error"); }
        }

        async function handleConfirmDelete() {
            if (!companyIdToDelete || !confirmDeleteBtn || !deleteModal) return;
            confirmDeleteBtn.disabled = true;
            confirmDeleteBtn.textContent = 'A excluir...';
            try {
                const deleteCompany = httpsCallable(functions, 'deleteCompany');
                await deleteCompany({ appId, companyId: companyIdToDelete });
                showAlert('Empresa e todos os dados associados foram excluídos.');
            } catch (error) {
                console.error("Erro ao excluir empresa:", error);
                showAlert(`Erro: ${error.message}`, 'error');
            } finally {
                deleteModal.classList.add('hidden');
                confirmDeleteBtn.disabled = false;
                confirmDeleteBtn.textContent = 'Sim, excluir';
                companyIdToDelete = null;
            }
        }

        async function renderCompanyUserAdminPage() { if (!selectedCompanyForManagement || !companyUserAdminTitle) return; companyUserAdminTitle.textContent = `Gerir Usuários para: ${selectedCompanyForManagement.name}`; renderUsersForSelectedCompany(); }
        async function renderUsersForSelectedCompany() { try { const usersRef = collection(db, "artifacts", appId, "users", selectedCompanyForManagement.id, "users"); const querySnapshot = await getDocs(usersRef); const companyUsers = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); if (!adminUserList) return; adminUserList.innerHTML = ''; companyUsers.forEach(user => { const li = document.createElement('li'); li.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-md'; li.innerHTML = `<span>${user.username}</span><div><button data-id="${user.id}" class="edit-user-btn text-blue-500 hover:text-blue-700 mr-2">Editar</button><button data-id="${user.id}" class="delete-user-btn text-red-500 hover:text-red-700">Excluir</button></div>`; adminUserList.appendChild(li); }); } catch (error) { console.error("Erro ao renderizar usuários:", error); } }
        async function handleUserSubmit(e) { e.preventDefault(); const username = userInput.value.trim(), password = userPasswordInput.value.trim(), id = userIdInput.value; if (!username || !password || !selectedCompanyForManagement) return; try { const usersRef = collection(db, "artifacts", appId, "users", selectedCompanyForManagement.id, "users"); const q = query(usersRef, where("username", "==", username)); const querySnapshot = await getDocs(q); if (!querySnapshot.empty && querySnapshot.docs[0].id !== id) { showAlert('Este nome de usuário já está em uso nesta empresa.', 'error'); return; } if (id) { await updateDoc(doc(db, "artifacts", appId, "users", selectedCompanyForManagement.id, "users", id), { username, password }); } else { await addDoc(usersRef, { username, password }); } if (userInput) userInput.value = ''; if (userPasswordInput) userPasswordInput.value = ''; if (userIdInput) userIdInput.value = ''; renderUsersForSelectedCompany(); } catch (error) { console.error("Erro ao guardar o usuário:", error); showAlert("Erro ao guardar o usuário.", "error"); } }
        async function handleUserActions(e) { if (!selectedCompanyForManagement) return; const id = e.target.dataset.id; if (!id) return; try { if (e.target.classList.contains('edit-user-btn')) { const userDoc = await getDoc(doc(db, "artifacts", appId, "users", selectedCompanyForManagement.id, "users", id)); if (userDoc.exists()) { const user = userDoc.data(); if (userInput) userInput.value = user.username; if (userPasswordInput) userPasswordInput.value = user.password; if (userIdInput) userIdInput.value = id; if (userInput) userInput.focus(); } } if (e.target.classList.contains('delete-user-btn')) { await deleteDoc(doc(db, "artifacts", appId, "users", selectedCompanyForManagement.id, "users", id)); renderUsersForSelectedCompany(); } } catch (error) { console.error("Erro ao lidar com a ação do usuário:", error); } }

        async function renderCompanyKeywordAdminPage() { if (!selectedCompanyForManagement || !companyKeywordAdminTitle) return; companyKeywordAdminTitle.textContent = `Gerir Palavras-Chave para: ${selectedCompanyForManagement.name}`; renderKeywordsForSelectedCompany(); }
        async function renderKeywordsForSelectedCompany() { try { const keywordsRef = collection(db, "artifacts", appId, "users", selectedCompanyForManagement.id, "keywords"); const querySnapshot = await getDocs(keywordsRef); const keywords = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); if (!adminKeywordList) return; adminKeywordList.innerHTML = ''; keywords.sort((a, b) => a.word.localeCompare(b.word)); keywords.forEach(kw => { const li = document.createElement('li'); li.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-md'; li.innerHTML = `<span>${kw.word}</span><div><button data-id="${kw.id}" class="edit-keyword-btn text-blue-500 hover:text-blue-700 mr-2">Editar</button><button data-id="${kw.id}" data-word="${kw.word}" class="transfer-keyword-btn text-indigo-500 hover:text-indigo-700 mr-2">Transferir</button><button data-id="${kw.id}" data-word="${kw.word}" class="delete-keyword-btn text-red-500 hover:text-red-700">Excluir</button></div>`; adminKeywordList.appendChild(li); }); } catch (error) { console.error("Erro ao renderizar palavras-chave:", error); } }
        async function handleKeywordSubmit(e) { e.preventDefault(); const word = keywordInput.value.trim(), id = keywordIdInput.value; if (!word || !selectedCompanyForManagement) return; try { const keywordsRef = collection(db, "artifacts", appId, "users", selectedCompanyForManagement.id, "keywords"); if (id) { await updateDoc(doc(db, "artifacts", appId, "users", selectedCompanyForManagement.id, "keywords", id), { word }); } else { await addDoc(keywordsRef, { word }); } if (keywordInput) keywordInput.value = ''; if (keywordIdInput) keywordIdInput.value = ''; renderKeywordsForSelectedCompany(); } catch (error) { console.error("Erro ao guardar a palavra-chave:", error); } }
        async function handleKeywordActions(e) {
            if (!selectedCompanyForManagement) return;
            const target = e.target.closest('button');
            if (!target) return;
            const id = target.dataset.id;
            if (!id) return;
            try {
                if (target.classList.contains('edit-keyword-btn')) {
                    const kwDoc = await getDoc(doc(db, "artifacts", appId, "users", selectedCompanyForManagement.id, "keywords", id));
                    if (kwDoc.exists()) {
                        const kw = kwDoc.data();
                        if (keywordInput) keywordInput.value = kw.word;
                        if (keywordIdInput) keywordIdInput.value = id;
                        if (keywordInput) keywordInput.focus();
                    }
                }
                if (target.classList.contains('transfer-keyword-btn')) {
                    keywordToTransferInfo = {
                        id: id,
                        word: target.dataset.word
                    };
                    if (keywordToTransferNameEl) keywordToTransferNameEl.textContent = keywordToTransferInfo.word;
                    await populateTransferCompaniesOptions();
                    if (transferKeywordModal) transferKeywordModal.classList.remove('hidden');
                }
                if (target.classList.contains('delete-keyword-btn')) {
                    keywordToDeleteInfo = {
                        id: id,
                        word: target.dataset.word
                    };
                    if (keywordToDeleteNameEl) keywordToDeleteNameEl.textContent = keywordToDeleteInfo.word;
                    if (confirmDeleteKeywordModal) confirmDeleteKeywordModal.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Erro ao lidar com a ação da palavra-chave:", error);
                showAlert(`Erro: ${error.message}`, 'error');
            }
        }

        async function populateTransferCompaniesOptions() {
            if (!transferCompanySelect) return;
            transferCompanySelect.innerHTML = '';
            try {
                const companiesQ = query(collection(db, "artifacts", appId, "public", "data", "companies"), where("status", "==", "active"));
                const snapshot = await getDocs(companiesQ);
                const companies = snapshot.docs.map(d => ({ id: d.id, ...(d.data() || {}) }));
                companies.sort((a, b) => (a.name || a.id).localeCompare(b.name || b.id));
                companies
                    .filter(c => c.id !== (selectedCompanyForManagement ? selectedCompanyForManagement.id : null))
                    .forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.id;
                        opt.textContent = c.name || c.id;
                        transferCompanySelect.appendChild(opt);
                    });
            } catch (e) {
                console.error('Erro ao carregar empresas para transferência:', e);
            }
        }

        async function handleConfirmDeleteKeyword() {
            if (!keywordToDeleteInfo || !confirmDeleteKeywordBtn || !confirmDeleteKeywordModal) return;
            confirmDeleteKeywordBtn.disabled = true;
            confirmDeleteKeywordBtn.textContent = 'A excluir...';
            try {
                const deleteKeyword = httpsCallable(functions, 'deleteKeywordAndArticles');
                await deleteKeyword({ appId, companyId: selectedCompanyForManagement.id, keyword: keywordToDeleteInfo.word });
                showAlert('Palavra-chave e alertas associados foram excluídos.', 'success');
                renderKeywordsForSelectedCompany();
            } catch (error) {
                console.error("Erro ao excluir palavra-chave:", error);
                showAlert(`Erro: ${error.message}`, 'error');
            } finally {
                confirmDeleteKeywordModal.classList.add('hidden');
                confirmDeleteKeywordBtn.disabled = false;
                confirmDeleteKeywordBtn.textContent = 'Sim, excluir';
                keywordToDeleteInfo = null;
            }
        }

        async function handleConfirmTransferKeyword() {
            if (!keywordToTransferInfo || !transferCompanySelect || !confirmTransferKeywordBtn || !transferKeywordModal) return;
            const destCompanyId = transferCompanySelect.value;
            if (!destCompanyId) { showAlert('Selecione a empresa de destino.', 'error'); return; }
            confirmTransferKeywordBtn.disabled = true;
            confirmTransferKeywordBtn.textContent = 'A transferir...';
            try {
                const transferFn = httpsCallable(functions, 'transferKeywordAndHistory');
                await transferFn({ appId, sourceCompanyId: selectedCompanyForManagement.id, destCompanyId, keyword: keywordToTransferInfo.word });
                showAlert('Palavra-chave e histórico transferidos com sucesso!', 'success');
                renderKeywordsForSelectedCompany();
            } catch (error) {
                console.error('Erro ao transferir palavra-chave:', error);
                showAlert(`Erro: ${error.message}`, 'error');
            } finally {
                transferKeywordModal.classList.add('hidden');
                confirmTransferKeywordBtn.disabled = false;
                confirmTransferKeywordBtn.textContent = 'Transferir';
                keywordToTransferInfo = null;
            }
        }

        // Usuario-Admin: listar, excluir, alterar senha e gerenciar empresas por usuário restrito
        async function renderRestrictedUsers() {
            const list = document.getElementById('restricted-user-list');
            if (!list) return;
            list.innerHTML = '';
            try {
                const usersRef = collection(db, "artifacts", appId, "public", "data", "restrictedUsers");
                const companiesQ = query(collection(db, "artifacts", appId, "public", "data", "companies"), where("status", "==", "active")); const [usersSnap, companiesSnap] = await Promise.all([getDocs(usersRef), getDocs(companiesQ)]);
                const users = usersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const companies = companiesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                users.forEach(u => {
                    const li = document.createElement('li');
                    li.className = 'bg-gray-100 p-2 rounded-md mb-2';
                    const companiesHtml = companies.map(c => `
                        <label class="flex items-center gap-2 py-1">
                            <input type="checkbox" class="restricted-company-checkbox form-checkbox h-4 w-4" data-user-id="${u.id}" value="${c.id}" ${Array.isArray(u.allowedCompanies) && u.allowedCompanies.includes(c.id) ? 'checked' : ''}>
                            <span>${c.name}</span>
                        </label>
                    `).join('');
                    li.innerHTML = `
                        <div class="flex justify-between items-center">
                            <span class="font-medium">${u.username}</span>
                            <div>
                                <button data-id="${u.id}" class="change-pass-btn text-blue-600 hover:text-blue-800 mr-2">Alterar Senha</button>
                                <button data-id="${u.id}" class="delete-restricted-user-btn text-red-600 hover:text-red-800">Excluir</button>
                            </div>
                        </div>
                        <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2">${companiesHtml}</div>
                    `;
                    list.appendChild(li);
                });
            } catch (error) {
                console.error('Erro ao listar usuários restritos:', error);
                showAlert('Erro ao listar usuários restritos.', 'error');
            }
        }

        async function handleRestrictedUserActions(e) {
            try {
                const btn = e.target.closest('button');
                if (btn) {
                    const id = btn.dataset.id;
                    if (!id) return;
                    if (btn.classList.contains('delete-restricted-user-btn')) {
                        await deleteDoc(doc(db, "artifacts", appId, "public", "data", "restrictedUsers", id));
                        showAlert('Usuário restrito excluído.', 'success');
                        renderRestrictedUsers();
                        return;
                    }
                    if (btn.classList.contains('change-pass-btn')) {
                        const newPass = prompt('Digite a nova senha para este usuário:');
                        if (!newPass) return;
                        await updateDoc(doc(db, "artifacts", appId, "public", "data", "restrictedUsers", id), { password: newPass });
                        showAlert('Senha atualizada com sucesso.', 'success');
                        renderRestrictedUsers();
                        return;
                    }
                }
                const checkbox = e.target.closest('input.restricted-company-checkbox');
                if (checkbox) {
                    const userId = checkbox.dataset.userId;
                    if (!userId) return;
                    const li = checkbox.closest('li');
                    if (!li) return;
                    const newAllowedCompanies = Array.from(li.querySelectorAll('input.restricted-company-checkbox:checked')).map(cb => cb.value);
                    await updateDoc(doc(db, "artifacts", appId, "public", "data", "restrictedUsers", userId), { allowedCompanies: newAllowedCompanies });
                    showAlert('Empresas atualizadas para o usuário.', 'success');
                    return;
                }
            } catch (error) {
                console.error('Erro ao executar ação do usuário restrito:', error);
                showAlert('Erro ao executar ação.', 'error');
            }
        }

        async function renderCompanySettingsAdminPage() { if (!selectedCompanyForManagement || !companySettingsAdminTitle) return; companySettingsAdminTitle.textContent = `Opções para: ${selectedCompanyForManagement.name}`; try { const settingsRef = doc(db, "artifacts", appId, "public", "data", "settings", selectedCompanyForManagement.id); const docSnap = await getDoc(settingsRef); const defaultChannels = ['Sites','YouTube','Revistas','Rádios','TV']; if (docSnap.exists()) { const settings = docSnap.data(); if (reportAccessToggle) reportAccessToggle.checked = settings.reportAccess !== false; if (mapAccessToggle) mapAccessToggle.checked = settings.mapAccess !== false; if (fetchOnlyNewToggle) fetchOnlyNewToggle.checked = settings.fetchOnlyNew === true; if (deletionAccessToggle) deletionAccessToggle.checked = settings.canRequestDeletion === true; if (document.querySelector(`input[name="news-scope"][value="${settings.searchScope || 'br'}"]`)) document.querySelector(`input[name="news-scope"][value="${settings.searchScope || 'br'}"]`).checked = true; if (stateSelect) stateSelect.value = settings.searchState || ''; const channels = Array.isArray(settings.captureChannels) && settings.captureChannels.length > 0 ? settings.captureChannels : defaultChannels; const chBoxes = document.querySelectorAll('#capture-channels-container .capture-channel'); chBoxes.forEach(cb => { cb.checked = channels.includes(cb.value); }); } else { if (reportAccessToggle) reportAccessToggle.checked = true; if (mapAccessToggle) mapAccessToggle.checked = true; if (fetchOnlyNewToggle) fetchOnlyNewToggle.checked = false; if (deletionAccessToggle) deletionAccessToggle.checked = false; if (document.querySelector('input[name="news-scope"][value="br"]')) document.querySelector('input[name="news-scope"][value="br"]').checked = true; if (stateSelect) stateSelect.value = ''; const chBoxes = document.querySelectorAll('#capture-channels-container .capture-channel'); chBoxes.forEach(cb => { cb.checked = true; }); } handleScopeChange(); } catch (error) { console.error("Erro ao renderizar as configurações:", error); } }
        async function handleSettingsChange(e) { if (!selectedCompanyForManagement) return; const settingsRef = doc(db, "artifacts", appId, "public", "data", "settings", selectedCompanyForManagement.id); let key, value; const defaultChannels = ['Sites','YouTube','Revistas','Rádios','TV']; const target = e.target; if (target && target.classList && target.classList.contains('capture-channel')) { key = 'captureChannels'; value = Array.from(document.querySelectorAll('#capture-channels-container .capture-channel:checked')).map(cb => cb.value); if (!value || value.length === 0) value = defaultChannels; } else { switch (e.target.id) { case 'report-access-toggle': key = 'reportAccess'; value = e.target.checked; break; case 'map-access-toggle': key = 'mapAccess'; value = e.target.checked; break; case 'fetch-only-new-toggle': key = 'fetchOnlyNew'; value = e.target.checked; break; case 'deletion-access-toggle': key = 'canRequestDeletion'; value = e.target.checked; break; case 'state-select': key = 'searchState'; value = e.target.value; break; default: if (e.target.name === 'news-scope') { key = 'searchScope'; value = e.target.value; } else { return; } } } try { await setDoc(settingsRef, { [key]: value }, { merge: true }); showAlert('Opção guardada!', 'success'); } catch (error) { console.error("Erro ao guardar a configuração:", error); } }
        function handleScopeChange() { if (!stateSelectContainer || !document.querySelector('input[name="news-scope"]:checked')) return; const selectedScope = document.querySelector('input[name="news-scope"]:checked').value; stateSelectContainer.classList.toggle('hidden', selectedScope !== 'state'); }
        async function renderGlobalKeysPage() { try { const settingsRef = doc(db, "artifacts", appId, "public", "data", "settings", "global"); const docSnap = await getDoc(settingsRef); if (docSnap.exists()) { const settings = docSnap.data(); if (apiKeyNewsApiInput) apiKeyNewsApiInput.value = settings.apiKeyNewsApi || ''; if (apiKeyFirebaseNewsInput) apiKeyFirebaseNewsInput.value = settings.apiKeyFirebaseNews || ''; if (typeof apiKeyGoogleMapsInput !== 'undefined' && apiKeyGoogleMapsInput) apiKeyGoogleMapsInput.value = settings.apiKeyGoogleMaps || ''; if (apiKeyGNewsInput1) apiKeyGNewsInput1.value = settings.apiKeyGNews1 || ''; if (apiKeyGNewsInput2) apiKeyGNewsInput2.value = settings.apiKeyGNews2 || ''; if (apiKeyGNewsInput3) apiKeyGNewsInput3.value = settings.apiKeyGNews3 || ''; if (apiKeyGNewsInput4) apiKeyGNewsInput4.value = settings.apiKeyGNews4 || ''; if (apiKeyYoutubeInput) apiKeyYoutubeInput.value = settings.apiKeyYoutube || ''; if (apiKeyBloggerInput) apiKeyBloggerInput.value = settings.apiKeyBlogger || ''; if (apiKeyVisionInput) apiKeyVisionInput.value = settings.apiKeyVision || ''; if (typeof visionEnabledToggle !== 'undefined' && visionEnabledToggle) visionEnabledToggle.checked = settings.visionEnabled === true; if (typeof visionRelevantOnlyToggle !== 'undefined' && visionRelevantOnlyToggle) visionRelevantOnlyToggle.checked = settings.visionRelevantOnly === true; if (typeof visionLogoDetectionToggle !== 'undefined' && visionLogoDetectionToggle) visionLogoDetectionToggle.checked = settings.visionLogoDetection !== false; if (typeof visionOcrTextToggle !== 'undefined' && visionOcrTextToggle) visionOcrTextToggle.checked = settings.visionOcrText !== false; if (apiKeyVideoIntelligenceInput) apiKeyVideoIntelligenceInput.value = settings.apiKeyVideoIntelligence || '';
            if (apiKeySpeechToText) apiKeySpeechToText.value = settings.apiKeySpeechToText || ''; } } catch (error) { console.error("Erro ao carregar as chaves de API globais:", error); } }
        async function handleGlobalKeyChange(e) { const settingsRef = doc(db, "artifacts", appId, "public", "data", "settings", "global"); const key = e.target.id; const value = (e.target.type === 'checkbox') ? e.target.checked : e.target.value; try { await setDoc(settingsRef, { [key]: value }, { merge: true }); showAlert('Opção guardada!', 'success'); } catch (error) { console.error("Erro ao guardar a chave/opção global:", error); } }
        async function renderGlobalSourcesPage() {
            try {
                const settingsRef = doc(db, "artifacts", appId, "public", "data", "settings", "global");
                const docSnap = await getDoc(settingsRef);
                if (docSnap.exists()) {
                    const settings = docSnap.data();
                    const bloggerIdEl = document.getElementById('bloggerId');
                    if (bloggerIdEl) bloggerIdEl.value = settings.bloggerId || '';
                    const rssUrlEl = document.getElementById('rssUrl');
                    if (rssUrlEl) rssUrlEl.value = settings.rssUrl || '';
                    const ytChannelsEl = document.getElementById('youtubeChannels');
                    if (ytChannelsEl) ytChannelsEl.value = settings.youtubeChannels || '';
                    const ytChannelNamesEl = document.getElementById('youtubeChannelNames');
                    if (ytChannelNamesEl) ytChannelNamesEl.value = settings.youtubeChannelNames || '';
                    const ytChannelsFreqEl = document.getElementById('youtubeChannelsFrequencyMinutes');
                    if (ytChannelsFreqEl) {
                        ytChannelsFreqEl.value = settings.youtubeChannelsFrequencyMinutes || '';
                        ytChannelsFreqEl.dataset.lastValue = ytChannelsFreqEl.value;
                    }
                    const ytSearchFreqEl = document.getElementById('youtubeFrequencyHours');
                    if (ytSearchFreqEl) {
                        ytSearchFreqEl.value = settings.youtubeFrequencyHours || '';
                        ytSearchFreqEl.dataset.lastValue = ytSearchFreqEl.value;
                    }
                    const ytDesiredTimeEl = document.getElementById('youtubeFrequencyTime');
                    if (ytDesiredTimeEl) ytDesiredTimeEl.value = settings.youtubeFrequencyTime || '';
                    const fetchWindowStartEl = document.getElementById('fetchWindowStart');
                    const fetchWindowEndEl = document.getElementById('fetchWindowEnd');
                    if (fetchWindowStartEl) fetchWindowStartEl.value = settings.fetchWindowStart || '';
                    if (fetchWindowEndEl) fetchWindowEndEl.value = settings.fetchWindowEnd || '';
                    const rssFreqEl = document.getElementById('rssFrequencyMinutes');
                    if (rssFreqEl) {
                        rssFreqEl.value = settings.rssFrequencyMinutes || '';
                        rssFreqEl.dataset.lastValue = rssFreqEl.value;
                    }
                    const gnewsFreqEl = document.getElementById('gnewsFrequencyHours');
                    if (gnewsFreqEl) {
                        gnewsFreqEl.value = settings.gnewsFrequencyHours || '';
                        gnewsFreqEl.dataset.lastValue = gnewsFreqEl.value;
                    }
                }
            } catch (error) {
                console.error("Erro ao carregar as fontes globais:", error);
            }
        }
        async function renderGlobalRadioSourcesPage() { try { const settingsRef = doc(db, "artifacts", appId, "public", "data", "settings", "global"); const docSnap = await getDoc(settingsRef); if (docSnap.exists()) { const settings = docSnap.data(); if (radioSourcesInput) radioSourcesInput.value = settings.radioSources || ''; }
        if (typeof renderRadioTimesList === 'function') renderRadioTimesList();
    } catch (error) { console.error("Erro ao carregar as fontes de rádio:", error); } }

        // Renderização auxiliar: lista de horários por rádio baseada no conteúdo do textarea
        function renderRadioTimesList() {
            try {
                const listEl = document.getElementById('radioTimesList');
                const srcEl = document.getElementById('radioSources');
                if (!listEl || !srcEl) return;
                const lines = (srcEl.value || '').split('\n').map(l => l.trim()).filter(l => l.length > 0);
                listEl.innerHTML = '';
                lines.forEach((line, idx) => {
                    const parts = line.split('|').map(p => p.trim());
                    const name = parts[0] || `Rádio ${idx+1}`;
                    let program = '';
                    let site = '';
                    let url = '';
                    let timeRaw = '';
                    let timeIndex = -1;

                    const isTime = (s) => /^\d{2}:\d{2}(?:\s*-\s*\d{2}:\d{2})?$/.test(s || '');
                    const isStreamURL = (s) => /^(https?:\/\/)/.test(s || '') && /m3u8|\.mp3|\.aac|\.ogg|icecast|shoutcast|stream|live|playlist/i.test(s);
                    const isWebsite = (s) => /^(https?:\/\/)/.test(s || '') && !isStreamURL(s);

                    if (parts.length >= 5) {
                        program = parts[1] || '';
                        site = parts[2] || '';
                        url = parts[3] || '';
                        timeRaw = parts[4] || '';
                        timeIndex = 4;
                    } else if (parts.length === 4) {
                        // pode ser [name, program, site, url] OU formato antigo [name, url, time, dias]
                        if (isTime(parts[2])) {
                            program = '';
                            site = '';
                            url = parts[1] || '';
                            timeRaw = parts[2] || '';
                            timeIndex = 2;
                        } else {
                            program = parts[1] || '';
                            site = parts[2] || '';
                            url = parts[3] || '';
                            timeRaw = '';
                            timeIndex = 3;
                        }
                    } else if (parts.length === 3) {
                        const p2 = parts[2] || '';
                        if (isTime(p2)) {
                            program = '';
                            site = '';
                            url = parts[1] || '';
                            timeRaw = p2;
                            timeIndex = 2;
                        } else if (isWebsite(p2)) {
                            // name | program | site (sem url)
                            program = parts[1] || '';
                            site = parts[2] || '';
                            url = '';
                            timeRaw = '';
                            timeIndex = 2;
                        } else {
                            // name | program | url
                            program = parts[1] || '';
                            site = '';
                            url = parts[2] || '';
                            timeRaw = '';
                            timeIndex = 2;
                        }
                    } else if (parts.length === 2) {
                        // name | url OU name | program (se não parecer URL de stream)
                        if (isStreamURL(parts[1])) {
                            program = '';
                            site = '';
                            url = parts[1] || '';
                        } else {
                            program = parts[1] || '';
                            site = '';
                            url = '';
                        }
                        timeRaw = '';
                        timeIndex = 1;
                    }

                    const match = (timeRaw || '').match(/^(\d{2}:\d{2})(\s*-\s*)(\d{2}:\d{2})$/);
                    const startTime = match ? match[1] : (timeRaw || '').split('-')[0]?.trim() || '';
                    const endTime = match ? match[3] : (timeRaw || '').split('-')[1]?.trim() || '';
                    // Dias selecionados (tokens extras após o campo de horário)
                    const weekdayAbbr = ['seg','ter','qua','qui','sex','sab','dom'];
                    const daysTokensCombined = parts.slice(timeIndex + 1).join(' ').toLowerCase();
                    const selectedDays = new Set(daysTokensCombined.split(/\s+/).filter(Boolean));

                    const row = document.createElement('div');
            row.className = 'tv-source-row grid grid-cols-1 sm:grid-cols-13 items-center gap-2 border-b border-gray-100 pb-2 mb-2';

                    const statusBadge = document.createElement('span');
                    statusBadge.className = 'sm:col-span-1 px-2 py-1 text-xs font-bold rounded-md text-white text-center bg-green-600';
                    statusBadge.textContent = 'AGUARDANDO';

                    const nameInput = document.createElement('input');
                    nameInput.type = 'text';
                    nameInput.value = name;
                    nameInput.placeholder = 'Nome da rádio';
                    nameInput.className = 'sm:col-span-3 px-2 py-1 border border-gray-300 rounded-md text-sm';

                    const programInput = document.createElement('input');
                    programInput.type = 'text';
                    programInput.value = program;
                    programInput.placeholder = 'Nome do programa';
                    programInput.className = 'sm:col-span-3 px-2 py-1 border border-gray-300 rounded-md text-sm';

                    const siteInput = document.createElement('input');
                    siteInput.type = 'url';
                    siteInput.value = site;
                    siteInput.placeholder = 'Site onde está a stream';
                    siteInput.className = 'sm:col-span-3 px-2 py-1 border border-gray-300 rounded-md text-sm';

                    const urlInput = document.createElement('input');
                    urlInput.type = 'url';
                    urlInput.value = url;
                    urlInput.placeholder = 'URL do stream (opcional)';
                    urlInput.className = 'sm:col-span-3 px-2 py-1 border border-gray-300 rounded-md text-sm';

                    const inputStart = document.createElement('input');
                    inputStart.type = 'time';
                    inputStart.value = startTime;
                    inputStart.className = 'sm:col-span-1 px-2 py-1 border border-gray-300 rounded-md text-sm';

                    const dash = document.createElement('span');
                    dash.className = 'sm:col-span-1 text-xs text-gray-600 text-center';
                    dash.textContent = '-';

                    const inputEnd = document.createElement('input');
                    inputEnd.type = 'time';
                    inputEnd.value = endTime;
                    inputEnd.className = 'sm:col-span-1 px-2 py-1 border border-gray-300 rounded-md text-sm';

                    // Container de dias da semana (horizontal)
                    const daysContainer = document.createElement('div');
                    daysContainer.className = 'sm:col-span-12 flex items-center flex-wrap gap-2';
                    const dayInputs = {};
                    weekdayAbbr.forEach((abbr) => {
                        const label = document.createElement('label');
                        label.className = 'flex items-center gap-1 text-xs text-gray-700';
                        const cb = document.createElement('input');
                        cb.type = 'checkbox';
                        cb.checked = selectedDays.has(abbr);
                        cb.className = 'h-4 w-4';
                        label.appendChild(cb);
                        const span = document.createElement('span');
                        span.textContent = abbr;
                        label.appendChild(span);
                        daysContainer.appendChild(label);
                        dayInputs[abbr] = cb;
                    });

                    const updateStatus = () => {
                        const todayIdx = new Date().getDay();
                        const map = {0:'dom',1:'seg',2:'ter',3:'qua',4:'qui',5:'sex',6:'sab'};
                        const todayAbbr = map[todayIdx];
                        const hasUrl = Boolean((urlInput.value || '').trim());
                        const start = (inputStart.value || '').trim();
                        const end = (inputEnd.value || '').trim();
                        const isSelectedToday = dayInputs[todayAbbr] ? dayInputs[todayAbbr].checked : false;
                        const nowHHMM = new Date().toTimeString().slice(0,5);
                        const inWindow = start && end ? (start <= nowHHMM && nowHHMM <= end) : false;
                        if (!hasUrl) {
                            statusBadge.textContent = 'OFF';
                            statusBadge.className = 'sm:col-span-1 px-2 py-1 text-xs font-bold rounded-md text-white text-center bg-red-600 animate-blinking-bell';
                            return;
                        }
                        if (isSelectedToday && inWindow) {
                            statusBadge.textContent = 'NO AR';
                            statusBadge.className = 'sm:col-span-1 px-2 py-1 text-xs font-bold rounded-md text-white text-center bg-blue-600';
                        } else {
                            statusBadge.textContent = 'AGUARDANDO';
                            statusBadge.className = 'sm:col-span-1 px-2 py-1 text-xs font-bold rounded-md text-white text-center bg-green-600';
                        }
                    };

                    const tryAutoFetchStream = async () => {
                        const site = (siteInput.value || '').trim();
                        if (!site || (urlInput.value || '').trim()) return;
                        try {
                            const resp = await fetch(site, { method: 'GET' });
                            const html = await resp.text();
                            const rx = /(https?:\/\/[^\s"']+\.(m3u8|mp3|aac))/ig;
                            let m; let found = '';
                            while ((m = rx.exec(html)) && !found) { found = m[1]; }
                            if (found) {
                                urlInput.value = found;
                                persist();
                            }
                        } catch (e) { /* CORS ou falha; ignorar */ }
                    };

                    let originalLine = line;
                    let lastIndex = idx;

                    const persist = () => {
                        const n = (nameInput.value || '').trim();
                        const p = (programInput.value || '').trim();
                        const s = (siteInput.value || '').trim();
                        const u = (urlInput.value || '').trim();

                        // Posições fixas: name | program | site | url | HH:MM - HH:MM | dias
                        const timeToken = (inputStart.value && inputEnd.value)
                            ? `${inputStart.value} - ${inputEnd.value}`
                            : (inputStart.value || '');
                        const selected = weekdayAbbr.filter(d => dayInputs[d]?.checked);
                        const daysToken = selected.length > 0 ? selected.join(' ') : '';

                        const tokens = [n, p, s, u, timeToken, daysToken];
                        const newLine = tokens.join(' | ');

                        const currentLines = (srcEl.value || '').split('\n').map(l => l.trim()).filter(l => l.length > 0);

                        // Selecionar a ocorrência correta entre possíveis duplicatas
                        if (originalLine) {
                            const originalTrim = originalLine.trim();
                            const occurrenceRank = lines.slice(0, idx).filter(l => (l || '').trim() === originalTrim).length;
                            const candidates = [];
                            for (let i = 0; i < currentLines.length; i++) {
                                if (currentLines[i] === originalTrim) candidates.push(i);
                            }
                            const foundIndex = candidates.length > occurrenceRank ? candidates[occurrenceRank] : -1;
                            if (foundIndex !== -1) {
                                lastIndex = foundIndex;
                            }
                        }

                        if (lastIndex < 0 || lastIndex >= currentLines.length) {
                            lastIndex = idx < currentLines.length ? idx : (currentLines.length - 1);
                        }

                        // Verificar se todos os campos estão vazios
                        const allFieldsEmpty = !n && !p && !s && !u && !timeToken && !daysToken;
                        
                        if (allFieldsEmpty) {
                            // Remover a linha completamente se todos os campos estiverem vazios
                            currentLines.splice(lastIndex, 1);
                        } else {
                            // Atualizar a linha com os novos valores
                            currentLines[lastIndex] = newLine;
                        }
                        
                        srcEl.value = currentLines.join('\n');
                        originalLine = newLine;
                        const event = new Event('change');
                        srcEl.dispatchEvent(event);
                        
                        // Se a linha foi removida, re-renderizar a lista para atualizar a UI
                        if (allFieldsEmpty && typeof renderRadioTimesList === 'function') {
                            renderRadioTimesList();
                        }
                    };

                    nameInput.addEventListener('change', () => { persist(); updateStatus(); });
                    programInput.addEventListener('change', () => { persist(); updateStatus(); });
                    siteInput.addEventListener('change', () => { persist(); tryAutoFetchStream(); updateStatus(); });
                    urlInput.addEventListener('change', () => { persist(); updateStatus(); });
                    inputStart.addEventListener('change', () => { persist(); updateStatus(); });
                    inputEnd.addEventListener('change', () => { persist(); updateStatus(); });
                    weekdayAbbr.forEach(d => dayInputs[d].addEventListener('change', () => { persist(); updateStatus(); }));

                    row.appendChild(statusBadge);
                    row.appendChild(nameInput);
                    row.appendChild(programInput);
                    row.appendChild(siteInput);
                    row.appendChild(urlInput);
                    row.appendChild(inputStart);
                    row.appendChild(dash);
                    row.appendChild(inputEnd);
                    row.appendChild(daysContainer);
                    updateStatus();
                    listEl.appendChild(row);
                });

                // Linha extra vazia para novo cadastro de rádio
                const newRow = document.createElement('div');
                newRow.className = 'grid grid-cols-1 sm:grid-cols-12 items-center gap-2 border-b border-gray-100 pb-2 mb-2';

                const newNameInput = document.createElement('input');
                newNameInput.type = 'text';
                newNameInput.placeholder = 'Nome da rádio';
                newNameInput.className = 'sm:col-span-3 px-2 py-1 border border-gray-300 rounded-md text-sm';

                const newProgramInput = document.createElement('input');
                newProgramInput.type = 'text';
                newProgramInput.placeholder = 'Nome do programa';
                newProgramInput.className = 'sm:col-span-3 px-2 py-1 border border-gray-300 rounded-md text-sm';

                const newSiteInput = document.createElement('input');
                newSiteInput.type = 'url';
                newSiteInput.placeholder = 'Site onde está a stream';
                newSiteInput.className = 'sm:col-span-3 px-2 py-1 border border-gray-300 rounded-md text-sm';

                const newUrlInput = document.createElement('input');
                newUrlInput.type = 'url';
                newUrlInput.placeholder = 'URL do stream';
                newUrlInput.className = 'sm:col-span-3 px-2 py-1 border border-gray-300 rounded-md text-sm';

                const newInputStart = document.createElement('input');
                newInputStart.type = 'time';
                newInputStart.className = 'sm:col-span-1 px-2 py-1 border border-gray-300 rounded-md text-sm';

                const newDash = document.createElement('span');
                newDash.className = 'sm:col-span-1 text-xs text-gray-600 text-center';
                newDash.textContent = '-';

                const newInputEnd = document.createElement('input');
                newInputEnd.type = 'time';
                newInputEnd.className = 'sm:col-span-1 px-2 py-1 border border-gray-300 rounded-md text-sm';

                // Dias da semana para nova linha
                const newDaysContainer = document.createElement('div');
                newDaysContainer.className = 'sm:col-span-3 flex items-center justify-between gap-1';
                const newDayInputs = {};
                const weekdayAbbrNew = ['seg','ter','qua','qui','sex','sab','dom'];
                weekdayAbbrNew.forEach((abbr) => {
                    const label = document.createElement('label');
                    label.className = 'flex items-center gap-1 text-xs text-gray-700';
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.className = 'h-4 w-4';
                    label.appendChild(cb);
                    const span = document.createElement('span');
                    span.textContent = abbr;
                    label.appendChild(span);
                    newDaysContainer.appendChild(label);
                    newDayInputs[abbr] = cb;
                });

                const persistNew = () => {
                    const n = (newNameInput.value || '').trim();
                    const p = (newProgramInput.value || '').trim();
                    const s = (newSiteInput.value || '').trim();
                    const u = (newUrlInput.value || '').trim();

                    // Posições fixas: name | program | site | url | HH:MM - HH:MM | dias
                    const timeToken = (newInputStart.value && newInputEnd.value)
                        ? `${newInputStart.value} - ${newInputEnd.value}`
                        : (newInputStart.value || '');
                    const selected = weekdayAbbrNew.filter(d => newDayInputs[d]?.checked);
                    const daysToken = selected.length > 0 ? selected.join(' ') : '';

                    const tokens = [n, p, s, u, timeToken, daysToken];
                    const newLine = tokens.join(' | ');

                    // não persiste se todos campos estiverem vazios
                    if (!tokens.some(t => (t || '').trim().length > 0)) return;

                    const currLines = (srcEl.value || '').split('\n').map(l => l.trim()).filter(l => l.length > 0);
                    currLines.push(newLine);
                    srcEl.value = currLines.join('\n');
                    const event = new Event('change');
                    srcEl.dispatchEvent(event);
                    // re-render apenas quando adiciona nova linha, para exibir o novo cadastro
                    if (typeof renderRadioTimesList === 'function') renderRadioTimesList();

                    // limpar campos após adicionar
                    newNameInput.value = '';
                    newProgramInput.value = '';
                    newSiteInput.value = '';
                    newUrlInput.value = '';
                    newInputStart.value = '';
                    newInputEnd.value = '';
                    weekdayAbbrNew.forEach(d => { if (newDayInputs[d]) newDayInputs[d].checked = false; });
                };

                newNameInput.addEventListener('change', persistNew);
                newProgramInput.addEventListener('change', persistNew);
                newSiteInput.addEventListener('change', persistNew);
                newUrlInput.addEventListener('change', persistNew);
                newInputStart.addEventListener('change', persistNew);
                newInputEnd.addEventListener('change', persistNew);
                weekdayAbbrNew.forEach(d => newDayInputs[d].addEventListener('change', persistNew));

                newRow.appendChild(newNameInput);
                newRow.appendChild(newProgramInput);
                newRow.appendChild(newSiteInput);
                newRow.appendChild(newUrlInput);
                newRow.appendChild(newInputStart);
                newRow.appendChild(newDash);
                newRow.appendChild(newInputEnd);
                newRow.appendChild(newDaysContainer);
                listEl.appendChild(newRow);
            } catch (error) {
                console.error('Erro ao renderizar horários das rádios:', error);
            }
        }

        async function renderGlobalTvSourcesPage() { try { const settingsRef = doc(db, "artifacts", appId, "public/data/settings", "global"); const docSnap = await getDoc(settingsRef); if (docSnap.exists()) { const settings = docSnap.data(); const tvEl = document.getElementById('tvSources'); if (tvEl) tvEl.value = settings.tvSources || ''; } if (typeof renderTvIntervalsList === 'function') renderTvIntervalsList(); } catch (error) { console.error("Erro ao carregar as fontes de TV:", error); } }

        function filterTvSourcesByStatus(status) {
            const listEl = document.getElementById('tvIntervalsList');
            if (!listEl) return;
            
            // Reset all status buttons
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.classList.remove('bg-yellow-600', 'bg-red-600', 'bg-green-600');
                btn.classList.add('bg-yellow-500', 'bg-red-500', 'bg-green-500');
            });
            
            // Highlight selected status button
            const selectedBtn = document.querySelector(`[data-status="${status}"]`);
            if (selectedBtn) {
                selectedBtn.classList.remove('bg-yellow-500', 'bg-red-500', 'bg-green-500');
                selectedBtn.classList.add(status === 'aguardando' ? 'bg-yellow-600' : 
                                       status === 'off' ? 'bg-red-600' : 'bg-green-600');
            }
            
            // Show all rows if no filter
            const rows = listEl.querySelectorAll('.tv-source-row');
            rows.forEach(row => {
                row.style.display = 'block';
            });
            
            // For now, just show a message as we need to implement actual status tracking
            showAlert(`Filtro aplicado: ${status.toUpperCase()}`, 'info');
        }

        function renderTvIntervalsList() { try { const listEl = document.getElementById('tvIntervalsList'); const srcEl = document.getElementById('tvSources'); if (!listEl || !srcEl) return; const lines = (srcEl.value || '').split('\n').map(l => l.trim()).filter(l => l.length > 0); listEl.innerHTML = ''; lines.forEach((line, idx) => { const parts = line.split('|').map(p => p.trim()); const tvName = parts[0] || `TV ${idx+1}`; const programName = parts[1] || ''; const tvSite = parts[2] || ''; const url = parts[3] || ''; const timeRaw = parts[4] || ''; const match = timeRaw.match(/^(\d{2}:\d{2})(\s*-\s*)(\d{2}:\d{2})$/); const startTime = match ? match[1] : (timeRaw || '').split('-')[0]?.trim() || ''; const endTime = match ? match[3] : (timeRaw || '').split('-')[1]?.trim() || ''; const weekdayAbbr = ['seg','ter','qua','qui','sex','sab','dom']; const daysTokensCombined = parts.slice(5).join(' ').toLowerCase(); const selectedDays = new Set(daysTokensCombined.split(/\s+/).filter(Boolean)); const row = document.createElement('div');
            row.className = 'tv-source-row grid grid-cols-1 sm:grid-cols-13 items-center gap-2 border-b border-gray-100 pb-2 mb-2';
            
            // Badge de status automático (seguindo o padrão das fontes de rádio)
            const statusBadge = document.createElement('span');
            statusBadge.className = 'sm:col-span-1 px-2 py-1 text-xs font-bold rounded-md text-white text-center bg-green-600';
            statusBadge.textContent = 'AGUARDANDO';
            
            const tvNameInput = document.createElement('input'); tvNameInput.type = 'text'; tvNameInput.value = tvName; tvNameInput.placeholder = 'Nome da TV'; tvNameInput.className = 'sm:col-span-2 px-2 py-1 border border-gray-300 rounded-md text-sm'; const programNameInput = document.createElement('input'); programNameInput.type = 'text'; programNameInput.value = programName; programNameInput.placeholder = 'Nome do Programa'; programNameInput.className = 'sm:col-span-2 px-2 py-1 border border-gray-300 rounded-md text-sm'; const tvSiteInput = document.createElement('input'); tvSiteInput.type = 'url'; tvSiteInput.value = tvSite; tvSiteInput.placeholder = 'Site da TV'; tvSiteInput.className = 'sm:col-span-2 px-2 py-1 border border-gray-300 rounded-md text-sm'; const urlInput = document.createElement('input'); urlInput.type = 'url'; urlInput.value = url; urlInput.placeholder = 'URL do Stream'; urlInput.className = 'sm:col-span-2 px-2 py-1 border border-gray-300 rounded-md text-sm'; const inputStart = document.createElement('input'); inputStart.type = 'time'; inputStart.value = startTime; inputStart.className = 'sm:col-span-1 px-2 py-1 border border-gray-300 rounded-md text-sm'; const dash = document.createElement('span'); dash.className = 'sm:col-span-1 text-xs text-gray-600 text-center'; dash.textContent = '-'; const inputEnd = document.createElement('input'); inputEnd.type = 'time'; inputEnd.value = endTime; inputEnd.className = 'sm:col-span-1 px-2 py-1 border border-gray-300 rounded-md text-sm'; const daysContainer = document.createElement('div'); daysContainer.className = 'sm:col-span-3 flex items-center justify-between gap-1'; const dayInputs = {}; weekdayAbbr.forEach((abbr) => { const label = document.createElement('label'); label.className = 'flex items-center gap-1 text-xs text-gray-700'; const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = selectedDays.has(abbr); cb.className = 'h-4 w-4'; label.appendChild(cb); const span = document.createElement('span'); span.textContent = abbr; label.appendChild(span); daysContainer.appendChild(label); dayInputs[abbr] = cb; }); const persist = () => { const tv = (tvNameInput.value || '').trim(); const program = (programNameInput.value || '').trim(); const site = (tvSiteInput.value || '').trim(); const u = (urlInput.value || '').trim(); const segments = []; if (tv) segments.push(tv); if (program) segments.push(program); if (site) segments.push(site); if (u) segments.push(u); if (inputStart.value && inputEnd.value) { segments.push(`${inputStart.value} - ${inputEnd.value}`); } else if (inputStart.value) { segments.push(inputStart.value); } const selected = weekdayAbbr.filter(d => dayInputs[d]?.checked); if (selected.length > 0) { segments.push(selected.join(' ')); } const newLine = segments.join(' | ');
                
                // Se a linha ficou vazia (todos os campos foram apagados), remover a linha
                if (!newLine.trim()) {
                    lines.splice(idx, 1);
                } else {
                    lines[idx] = newLine;
                }
                
                srcEl.value = lines.join('\n'); const event = new Event('change'); srcEl.dispatchEvent(event); }; tvNameInput.addEventListener('change', persist); programNameInput.addEventListener('change', persist); tvSiteInput.addEventListener('change', persist); urlInput.addEventListener('change', persist); inputStart.addEventListener('change', persist); inputEnd.addEventListener('change', persist); weekdayAbbr.forEach(d => dayInputs[d].addEventListener('change', persist));
            row.appendChild(statusBadge);
            row.appendChild(tvNameInput); row.appendChild(programNameInput); row.appendChild(tvSiteInput); row.appendChild(urlInput); row.appendChild(inputStart); row.appendChild(dash); row.appendChild(inputEnd); row.appendChild(daysContainer); listEl.appendChild(row); 
            
            // Função para atualizar o status automaticamente (padrão das fontes de rádio)
            const updateStatus = () => {
                const now = new Date();
                const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                const currentDay = ['dom','seg','ter','qua','qui','sex','sab'][now.getDay()];
                
                const hasUrl = urlInput.value.trim().length > 0;
                const hasTime = inputStart.value && inputEnd.value;
                const hasDays = weekdayAbbr.some(d => dayInputs[d]?.checked);
                
                let status = 'AGUARDANDO';
                let bgColor = 'bg-green-600';
                
                if (!hasUrl) {
                    status = 'OFF';
                    bgColor = 'bg-red-600';
                } else if (hasTime && hasDays) {
                    const isWithinTime = currentTime >= inputStart.value && currentTime <= inputEnd.value;
                    const isCorrectDay = dayInputs[currentDay]?.checked;
                    
                    if (isWithinTime && isCorrectDay) {
                        status = 'NO AR';
                        bgColor = 'bg-blue-600';
                    } else {
                        status = 'AGUARDANDO';
                        bgColor = 'bg-green-600';
                    }
                } else if (hasUrl) {
                    status = 'NO AR';
                    bgColor = 'bg-blue-600';
                }
                
                statusBadge.textContent = status;
                statusBadge.className = `sm:col-span-1 px-2 py-1 text-xs font-bold rounded-md text-white text-center ${bgColor}`;
            };
            
            // Atualizar status inicial e configurar intervalos
            updateStatus();
            setInterval(updateStatus, 60000); // Atualizar a cada minuto
            
            // Adicionar event listeners para atualizar status quando campos mudarem
            tvNameInput.addEventListener('change', () => { persist(); updateStatus(); });
            programNameInput.addEventListener('change', () => { persist(); updateStatus(); });
            tvSiteInput.addEventListener('change', () => { persist(); updateStatus(); });
            urlInput.addEventListener('change', () => { persist(); updateStatus(); });
            inputStart.addEventListener('change', () => { persist(); updateStatus(); });
            inputEnd.addEventListener('change', () => { persist(); updateStatus(); });
            weekdayAbbr.forEach(d => dayInputs[d].addEventListener('change', () => { persist(); updateStatus(); }));
            }); const newRow = document.createElement('div'); newRow.className = 'grid grid-cols-1 sm:grid-cols-12 items-center gap-2 border-b border-gray-100 pb-2 mb-2'; const newTvNameInput = document.createElement('input'); newTvNameInput.type = 'text'; newTvNameInput.placeholder = 'Nome da TV'; newTvNameInput.className = 'sm:col-span-2 px-2 py-1 border border-gray-300 rounded-md text-sm'; const newProgramNameInput = document.createElement('input'); newProgramNameInput.type = 'text'; newProgramNameInput.placeholder = 'Nome do Programa'; newProgramNameInput.className = 'sm:col-span-2 px-2 py-1 border border-gray-300 rounded-md text-sm'; const newTvSiteInput = document.createElement('input'); newTvSiteInput.type = 'url'; newTvSiteInput.placeholder = 'Site da TV'; newTvSiteInput.className = 'sm:col-span-2 px-2 py-1 border border-gray-300 rounded-md text-sm'; const newUrlInput = document.createElement('input'); newUrlInput.type = 'url'; newUrlInput.placeholder = 'URL do Stream'; newUrlInput.className = 'sm:col-span-2 px-2 py-1 border border-gray-300 rounded-md text-sm'; const newInputStart = document.createElement('input'); newInputStart.type = 'time'; newInputStart.className = 'sm:col-span-1 px-2 py-1 border border-gray-300 rounded-md text-sm'; const newDash = document.createElement('span'); newDash.className = 'sm:col-span-1 text-xs text-gray-600 text-center'; newDash.textContent = '-'; const newInputEnd = document.createElement('input'); newInputEnd.type = 'time'; newInputEnd.className = 'sm:col-span-1 px-2 py-1 border border-gray-300 rounded-md text-sm'; const newDaysContainer = document.createElement('div'); newDaysContainer.className = 'sm:col-span-3 flex items-center justify-between gap-1'; const newDayInputs = {}; const weekdayAbbrNew = ['seg','ter','qua','qui','sex','sab','dom']; weekdayAbbrNew.forEach((abbr) => { const label = document.createElement('label'); label.className = 'flex items-center gap-1 text-xs text-gray-700'; const cb = document.createElement('input'); cb.type = 'checkbox'; cb.className = 'h-4 w-4'; label.appendChild(cb); const span = document.createElement('span'); span.textContent = abbr; label.appendChild(span); newDaysContainer.appendChild(label); newDayInputs[abbr] = cb; }); const persistNew = () => { const segments = []; const tv = (newTvNameInput.value || '').trim(); const program = (newProgramNameInput.value || '').trim(); const site = (newTvSiteInput.value || '').trim(); const u = (newUrlInput.value || '').trim(); if (tv) segments.push(tv); if (program) segments.push(program); if (site) segments.push(site); if (u) segments.push(u); if (newInputStart.value && newInputEnd.value) { segments.push(`${newInputStart.value} - ${newInputEnd.value}`); } else if (newInputStart.value) { segments.push(newInputStart.value); } const selected = weekdayAbbrNew.filter(d => newDayInputs[d]?.checked); if (selected.length > 0) { segments.push(selected.join(' ')); } const newLine = segments.join(' | '); if (!newLine) return; const currLines = (srcEl.value || '').split('\n').map(l => l.trim()).filter(l => l.length > 0); currLines.push(newLine); srcEl.value = currLines.join('\n'); const event = new Event('change'); srcEl.dispatchEvent(event); newTvNameInput.value = ''; newProgramNameInput.value = ''; newTvSiteInput.value = ''; newUrlInput.value = ''; newInputStart.value = ''; newInputEnd.value = ''; weekdayAbbrNew.forEach(d => { if (newDayInputs[d]) newDayInputs[d].checked = false; }); }; newTvNameInput.addEventListener('change', persistNew); newProgramNameInput.addEventListener('change', persistNew); newTvSiteInput.addEventListener('change', persistNew); newUrlInput.addEventListener('change', persistNew); newInputStart.addEventListener('change', persistNew); newInputEnd.addEventListener('change', persistNew); weekdayAbbrNew.forEach(d => newDayInputs[d].addEventListener('change', persistNew)); newRow.appendChild(newTvNameInput); newRow.appendChild(newProgramNameInput); newRow.appendChild(newTvSiteInput); newRow.appendChild(newUrlInput); newRow.appendChild(newInputStart); newRow.appendChild(newDash); newRow.appendChild(newInputEnd); newRow.appendChild(newDaysContainer); listEl.appendChild(newRow); } catch (error) { console.error('Erro ao renderizar horários de TV:', error); } }

        function cleanAndSaveTextarea(e) {
            const textarea = e.target;
            const lines = textarea.value.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            // Para radioSources, NÃO fazer deduplicação automática para não perder linhas aparentemente iguais
            const shouldDedupe = textarea.id !== 'radioSources';
            const cleanedValue = (shouldDedupe ? [...new Set(lines)] : lines).join('\n');
            textarea.value = cleanedValue;
            return cleanedValue;
        }

        async function handleGlobalSourceChange(e) {
            const cleanedValue = cleanAndSaveTextarea(e);
            const settingsRef = doc(db, "artifacts", appId, "public/data/settings", "global");
            const key = e.target.id;
            try {
                await setDoc(settingsRef, { [key]: cleanedValue }, { merge: true });
                showAlert('Fonte guardada!', 'success');
            } catch (error) {
                console.error("Erro ao guardar a fonte global:", error);
            }
        }


        function setupNotificationListener() {
            if (notificationListener) notificationListener();
            if (!currentUser || currentUser.isSuperAdmin) return;
            const settingsRef = doc(db, "artifacts", appId, "public/data/settings", currentUser.companyId);
            notificationListener = onSnapshot(settingsRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    const count = data.newAlertsCount || 0;
                    if (count > 0) {
                        if (notificationBadge) notificationBadge.textContent = count;
                        if (notificationBadge) notificationBadge.classList.remove('hidden');
                        if (notificationBell) notificationBell.classList.add('animate-blinking-bell');
                    } else {
                        if (notificationBadge) notificationBadge.classList.add('hidden');
                        if (notificationBell) notificationBell.classList.remove('animate-blinking-bell');
                    }
                }
            });
        }

        async function showOnlyNewAlerts() {
            if (!currentUser) return;

            const settingsRef = doc(db, "artifacts", appId, "public/data/settings", currentUser.companyId);
            const docSnap = await getDoc(settingsRef);
            const count = docSnap.exists() ? (docSnap.data().newAlertsCount || 0) : 0;

            if (count === 0) {
                showAlert("Não há novos alertas para mostrar.", "success");
                return;
            }

            if (newsAlerts) newsAlerts.innerHTML = '<p class="text-gray-500">A carregar alertas...</p>';
            try {
                const q = query(collection(db, "artifacts", appId, "users", currentUser.companyId, "articles"), orderBy("publishedAt", "desc"), limit(count));
                const articlesSnapshot = await getDocs(q);
                if (newsAlerts) newsAlerts.innerHTML = '';
                if (articlesSnapshot.empty) {
                    if (newsAlerts) newsAlerts.innerHTML = '<p class="text-gray-500">Nenhum alerta novo encontrado.</p>';
                } else {
                    const articles = articlesSnapshot.docs.map(d => ({ ...d.data(), id: d.id }));
                    articles.forEach(article => displayNewsAlert(article, newsAlerts));
                }
                if (showAllAlertsBtn) showAllAlertsBtn.classList.remove('hidden');

                await setDoc(settingsRef, { newAlerts: false, newAlertsCount: 0 }, { merge: true });
                if (notificationBadge) notificationBadge.classList.add('hidden');
                if (notificationBell) notificationBell.classList.remove('animate-blinking-bell');

            } catch (error) {
                console.error("Erro ao buscar novos alertas:", error);
                if (newsAlerts) newsAlerts.innerHTML = '<p class="text-red-500">Erro ao carregar novos alertas.</p>';
            }
        }

        function displayNewsAlert(article, container) {
            const pubDate = new Date(article.publishedAt.seconds ? article.publishedAt.toDate() : article.publishedAt);
            const formattedDate = pubDate.toLocaleDateString('pt-BR');
            const dateForFilter = pubDate.toISOString().split('T')[0];

            const alertEl = document.createElement('div');
            alertEl.className = 'bg-white p-4 rounded-lg shadow-md border-l-4 border-gray-400 fade-in';
            alertEl.dataset.id = article.id;
            alertEl.dataset.date = dateForFilter;
            alertEl.dataset.keywords = (article.keywords || [article.keyword]).join(',');

            const sentimentScore = article.ai?.sentiment?.score ?? article.sentiment?.score ?? 0;

            const getSentimentHTML = (score) => {
                let emoji = '😐'; let color = 'gray'; let text = 'Neutro';
                if (score > 0.25) { emoji = '😊'; color = 'green'; text = 'Positivo'; }
                else if (score < -0.25) { emoji = '😠'; color = 'red'; text = 'Negativo'; }

                alertEl.classList.remove('border-gray-400', 'border-green-500', 'border-red-500');
                alertEl.classList.add(`border-${color}-500`);

                return `<button class="sentiment-btn text-xs font-semibold text-${color}-600 bg-${color}-100 px-2 py-1 rounded-full">${emoji} ${text}</button>`;
            };

            const sentimentMenuHTML = `                <div class="sentiment-menu p-1 space-y-1">                    <button data-sentiment="0.5" class="sentiment-option w-full text-left text-xs px-2 py-1 rounded hover:bg-gray-100">😊 Positivo</button>                    <button data-sentiment="0.0" class="sentiment-option w-full text-left text-xs px-2 py-1 rounded hover:bg-gray-100">😐 Neutro</button>                    <button data-sentiment="-0.5" class="sentiment-option w-full text-left text-xs px-2 py-1 rounded hover:bg-gray-100">😠 Negativo</button>                </div>`;

            const deleteButtonHTML = currentUser && currentUser.canRequestDeletion ? `<button class="request-delete-btn text-red-500 hover:text-red-700 ml-4" title="Solicitar Exclusão">🗑️</button>` : '';

            const keywordsArray = article.keywords || [article.keyword];
            const keywordsHTML = keywordsArray.map(kw =>
                `<span class="flex-shrink-0 text-xs font-semibold bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full">${kw}</span>`
            ).join('');

            // Direto vs Indireto: usa override salvo em article.directness se existir; senão, heurística por título/descrição
            const direct = (() => {
                try {
                    if (typeof article.directness !== 'undefined' && article.directness !== null) {
                        if (typeof article.directness === 'string') return /direto/i.test(article.directness);
                        if (typeof article.directness === 'boolean') return article.directness;
                    }
                    const allText = `${article.title || ''} ${article.description || ''}`.toLowerCase();
                    return keywordsArray.some(kw => typeof kw === 'string' && allText.includes(kw.toLowerCase()));
                } catch (_) { return false; }
            })();
            const directnessMenuHTML = `                <div class="directness-menu p-1 space-y-1">                    <button data-directness="true" class="global-directness-option w-full text-left text-xs px-2 py-1 rounded hover:bg-gray-100">Direto</button>                    <button data-directness="false" class="global-directness-option w-full text-left text-xs px-2 py-1 rounded hover:bg-gray-100">Indireto</button>                </div>`;
            const directnessHTML = `<div class="directness-container relative"><button class="global-directness-btn text-xs font-semibold ${direct ? 'text-orange-600 bg-orange-100' : 'text-gray-600 bg-gray-100'} px-2 py-1 rounded-full">${direct ? 'Direto' : 'Indireto'}</button>${directnessMenuHTML}</div>`;

            const mediaTypeValue = (() => { const raw = article.mediaType; if (raw && /provocada/i.test(raw)) return 'Provocada'; return 'Espontânea'; })();
            const getMediaTypeHTML = (mt) => { const isProv = mt === 'Provocada'; const color = isProv ? 'amber' : 'teal'; return `<button class="media-btn text-xs font-semibold text-${color}-600 bg-${color}-100 px-2 py-1 rounded-full">${mt}</button>`; };
            const mediaTypeMenuHTML = `                <div class="media-menu p-1 space-y-1">                    <button data-media-type="Espontânea" class="media-option w-full text-left text-xs px-2 py-1 rounded hover:bg-gray-100">Espontânea</button>                    <button data-media-type="Provocada" class="media-option w-full text-left text-xs px-2 py-1 rounded hover:bg-gray-100">Provocada</button>                </div>`;

            let aiInsightsHTML = '';
            if (article.ai && (article.ai.entities?.length > 0 || article.ai.categories?.length > 0)) {
                const entityColors = { PERSON: 'bg-blue-100 text-blue-800', LOCATION: 'bg-green-100 text-green-800', ORGANIZATION: 'bg-purple-100 text-purple-800', EVENT: 'bg-yellow-100 text-yellow-800', WORK_OF_ART: 'bg-pink-100 text-pink-800', CONSUMER_GOOD: 'bg-indigo-100 text-indigo-800' };
                const entitiesHTML = (article.ai.entities || []).slice(0, 5).map(e => `<span class="ai-tag ${entityColors[e.type] || 'bg-gray-100 text-gray-800'}">${e.name}</span>`).join('');
                const categoriesHTML = (article.ai.categories || []).slice(0, 2).map(c => `<span class="ai-tag bg-gray-200 text-gray-900">${c.name.split('/').pop()}</span>`).join('');
                aiInsightsHTML = `<div class="mt-3 pt-3 border-t border-gray-200">${entitiesHTML}${categoriesHTML}</div>`;
            }

            let translationHTML = '';
            if (article.translationInfo?.translated) {
                translationHTML = `<span title="Traduzido do ${article.translationInfo.originalLanguage.toUpperCase()}" class="mr-2">🌐</span>`;
            }

            const isRadio = (article.channel === 'Rádios') || (typeof article.url === 'string' && /(\.mp3|\.m4a|\.aac|\.wav|\.ogg)(\?|$)/i.test(article.url));
const audioTypeMatch = (article.url || '').match(/\.(mp3|m4a|aac|wav|ogg)(\?|$)/i);
const audioType = audioTypeMatch ? audioTypeMatch[1].toLowerCase() : 'mp3';
const mimeMap = { mp3: 'audio/mpeg', m4a: 'audio/mp4', aac: 'audio/aac', wav: 'audio/wav', ogg: 'audio/ogg' };
const audioMime = mimeMap[audioType] || 'audio/mpeg';
const audioSrc = article.segmentUrl || article.url;
const audioHtml = isRadio ? `<audio controls preload=\"none\" class=\"w-full mt-3\"><source src=\"${audioSrc}\" type=\"${audioMime}\">Seu navegador não suporta áudio.</audio>` : '';
alertEl.innerHTML = `                <div class="alert-body-clickable">                    <div class="flex justify-between items-start">                        <h4 class="text-lg font-bold text-gray-800 pr-2">${article.title}</h4>                        <div class="flex items-center gap-2 flex-shrink-0">                            <div class="flex flex-col items-end gap-1">${keywordsHTML}</div>                        </div>                    </div>                    <p class="text-sm text-gray-600 mt-2 line-clamp-2">${article.description || 'Descrição não disponível.'}</p>                </div>                ${audioHtml}                ${aiInsightsHTML}                <div class="text-xs text-gray-500 mt-3 flex justify-between items-center">                    <span>${translationHTML}Fonte: ${getDisplaySourceName(article)} | Publicado: ${formattedDate}</span>                    <div>                        <a href="${article.url}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline font-semibold">Ler no site original →</a>                        ${deleteButtonHTML}                    </div>                </div>`;
            const kwContainer = alertEl.querySelector('.flex.items-center.gap-2.flex-shrink-0')?.querySelector('div');
            if (kwContainer) {
                const sanitizeKey = s => String(s).toLowerCase().trim().replace(/[.#$\[\]/]/g, '_').replace(/\s+/g, '_');
                const allTextLower = `${article.title || ''} ${article.description || ''}`.toLowerCase();
                alertEl._kwAna = {};
                const kwHTML = (article.keywords || [article.keyword]).map(kw => {
                    const sk = sanitizeKey(kw);
                    const isDirectKw = allTextLower.includes(String(kw).toLowerCase());
                    const directBtnClass = isDirectKw ? 'text-orange-600 bg-orange-100' : 'text-gray-600 bg-gray-100';
                    const mediaInit = mediaTypeValue;
                    const mediaColor = mediaInit === 'Provocada' ? 'text-amber-600 bg-amber-100' : 'text-teal-600 bg-teal-100';
                    let emoji = '😐', color = 'gray', text = 'Neutro';
                    if (sentimentScore > 0.25) { emoji = '😊'; color = 'green'; text = 'Positivo'; }
                    else if (sentimentScore < -0.25) { emoji = '😠'; color = 'red'; text = 'Negativo'; }
                    alertEl._kwAna[sk] = { word: kw, sentiment: sentimentScore, mediaType: mediaInit, direct: isDirectKw };
                    return `
                    <div class="keyword-analysis-row flex items-center gap-2" data-keyword="${sk}">
                        <span class="flex-shrink-0 text-xs font-semibold bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full">${kw}</span>
                        <div class="keyword-directness-container directness-container relative">
                            <button class="keyword-directness-btn text-xs font-semibold ${directBtnClass} px-2 py-1 rounded-full">${isDirectKw ? 'Direto' : 'Indireto'}</button>
                            <div class="directness-menu p-1 space-y-1">
                                <button data-directness="true" data-keyword="${sk}" data-word="${kw}" class="directness-option w-full text-left text-xs px-2 py-1 rounded hover:bg-gray-100">Direto</button>
                                <button data-directness="false" data-keyword="${sk}" data-word="${kw}" class="directness-option w-full text-left text-xs px-2 py-1 rounded hover:bg-gray-100">Indireto</button>
                            </div>
                        </div>
                        <div class="keyword-media-container media-container relative">
                            <button class="media-btn text-xs font-semibold ${mediaColor} px-2 py-1 rounded-full">${mediaInit}</button>
                            <div class="keyword-media-menu media-menu p-1 space-y-1">
                                <button data-media-type="Espontânea" data-keyword="${sk}" data-word="${kw}" class="keyword-media-option w-full text-left text-xs px-2 py-1 rounded hover:bg-gray-100">Espontânea</button>
                                <button data-media-type="Provocada" data-keyword="${sk}" data-word="${kw}" class="keyword-media-option w-full text-left text-xs px-2 py-1 rounded hover:bg-gray-100">Provocada</button>
                            </div>
                        </div>
                        <div class="keyword-sentiment-container sentiment-container relative">
                            <button class="keyword-sentiment-btn text-xs font-semibold text-${color}-600 bg-${color}-100 px-2 py-1 rounded-full">${emoji} ${text}</button>
                            <div class="keyword-sentiment-menu sentiment-menu p-1 space-y-1">
                                <button data-sentiment="0.5" data-keyword="${sk}" data-word="${kw}" class="keyword-sentiment-option w-full text-left text-xs px-2 py-1 rounded hover:bg-gray-100">😊 Positivo</button>
                                <button data-sentiment="0.0" data-keyword="${sk}" data-word="${kw}" class="keyword-sentiment-option w-full text-left text-xs px-2 py-1 rounded hover:bg-gray-100">😐 Neutro</button>
                                <button data-sentiment="-0.5" data-keyword="${sk}" data-word="${kw}" class="keyword-sentiment-option w-full text-left text-xs px-2 py-1 rounded hover:bg-gray-100">😠 Negativo</button>
                            </div>
                        </div>
                    </div>`;
                }).join('');
                kwContainer.innerHTML = kwHTML;
            }
            container.appendChild(alertEl);
        }

        async function handleSentimentChange(e) {
            const newScore = parseFloat(e.target.dataset.sentiment);
            const alertEl = e.target.closest('.fade-in');
            const articleId = alertEl.dataset.id;
            if (!articleId || !currentUser) return;
            try {
                const articleRef = doc(db, "artifacts", appId, "users", currentUser.companyId, "articles", articleId);
                await updateDoc(articleRef, {
                    "sentiment.score": newScore,
                    "ai.sentiment.score": newScore
                });
                const sentimentContainer = alertEl.querySelector('.sentiment-container');
                let emoji = '😐'; let color = 'gray'; let text = 'Neutro';
                if (newScore > 0.25) { emoji = '😊'; color = 'green'; text = 'Positivo'; }
                else if (newScore < -0.25) { emoji = '😠'; color = 'red'; text = 'Negativo'; }
                alertEl.classList.remove('border-gray-400', 'border-green-500', 'border-red-500');
                alertEl.classList.add(`border-${color}-500`);
                const newButtonHTML = `<button class="sentiment-btn text-xs font-semibold text-${color}-600 bg-${color}-100 px-2 py-1 rounded-full">${emoji} ${text}</button>`;
                sentimentContainer.querySelector('.sentiment-btn').outerHTML = newButtonHTML;
            } catch (error) {
                console.error("Erro ao atualizar o sentimento:", error);
                showAlert("Erro ao atualizar o sentimento.", "error");
            }
        }

        async function handleMediaTypeChange(e) {
            const newType = e.target.dataset.mediaType;
            const alertEl = e.target.closest('.fade-in');
            const articleId = alertEl?.dataset.id;
            if (!articleId || !currentUser || !newType) return;
            try {
                const articleRef = doc(db, "artifacts", appId, "users", currentUser.companyId, "articles", articleId);
                await updateDoc(articleRef, { mediaType: newType });
                const mediaContainer = alertEl.querySelector('.media-container');
                const newButtonHTML = getMediaTypeHTML(newType);
                const oldBtn = mediaContainer.querySelector('.media-btn');
                if (oldBtn) { oldBtn.outerHTML = newButtonHTML; }
                const found = allCompanyArticles.find(a => a.id === articleId);
                if (found) found.mediaType = newType;
            } catch (error) {
                console.error("Erro ao atualizar o tipo de mídia:", error);
                showAlert("Erro ao atualizar o tipo de mídia.", "error");
            }
        }

        async function populateInitialAlerts() {
            if (!currentUser || !newsAlerts) return;
            if (showAllAlertsBtn) showAllAlertsBtn.classList.add('hidden');
            newsAlerts.innerHTML = '<p class="text-gray-500">A carregar alertas...</p>';
            try {
                const q = query(collection(db, "artifacts", appId, "users", currentUser.companyId, "articles"), orderBy("publishedAt", "desc"), limit(100));
                const articlesSnapshot = await getDocs(q);
                newsAlerts.innerHTML = '';
                if (articlesSnapshot.empty) {
                    newsAlerts.innerHTML = '<p class="text-gray-500">Nenhum alerta encontrado.</p>';
                } else {
                    const articles = articlesSnapshot.docs.map(d => ({ ...d.data(), id: d.id }));
                    articles.forEach(article => displayNewsAlert(article, newsAlerts));
                }
                filterAlertsByDate();
            } catch (error) {
                console.error("Erro ao preencher os alertas:", error);
                newsAlerts.innerHTML = '<p class="text-red-500">Erro ao carregar alertas.</p>';
            }
        }

        async function handleGlobalDirectnessChange(e) {
            const isDirect = String(e.target.dataset.directness) === 'true';
            const alertEl = e.target.closest('.fade-in');
            const articleId = alertEl?.dataset.id;
            if (!articleId || !currentUser) return;
            try {
                const articleRef = doc(db, "artifacts", appId, "users", currentUser.companyId, "articles", articleId);
                await updateDoc(articleRef, { directness: isDirect });
                const container = alertEl.querySelector('.directness-container');
                const btn = container?.querySelector('.global-directness-btn');
                if (btn) {
                    const classes = btn.className.split(' ').filter(c => !c.startsWith('text-') && !c.startsWith('bg-'));
                    const newColorText = isDirect ? 'text-orange-600' : 'text-gray-600';
                    const newColorBg = isDirect ? 'bg-orange-100' : 'bg-gray-100';
                    btn.className = [...classes, newColorText, newColorBg].join(' ');
                    btn.textContent = isDirect ? 'Direto' : 'Indireto';
                }
                const found = allCompanyArticles.find(a => a.id === articleId);
                if (found) found.directness = isDirect;
            } catch (error) {
                console.error("Erro ao atualizar Direto/Indireto:", error);
                showAlert("Erro ao atualizar Direto/Indireto.", "error");
            }
        }

        async function handleKeywordSentimentChange(e) {
            const { keyword, word } = e.target.dataset;
            const score = parseFloat(e.target.dataset.sentiment);
            const alertEl = e.target.closest('.fade-in');
            const articleId = alertEl?.dataset.id;
            if (!articleId || !currentUser || !keyword) return;
            try {
                const articleRef = doc(db, "artifacts", appId, "users", currentUser.companyId, "articles", articleId);
                const field = `keywordAnalysesMap.${keyword}`;
                await updateDoc(articleRef, { [field]: { ...(alertEl._kwAna?.[keyword] || {}), sentiment: score, word } });
                const row = alertEl.querySelector(`.keyword-analysis-row[data-keyword='${keyword}']`);
                const btn = row?.querySelector('.keyword-sentiment-btn');
                if (btn) {
                    let emoji = '😐'; let color = 'gray'; let text = 'Neutro';
                    if (score > 0.25) { emoji = '😊'; color = 'green'; text = 'Positivo'; }
                    else if (score < -0.25) { emoji = '😠'; color = 'red'; text = 'Negativo'; }
                    btn.outerHTML = `<button class=\"keyword-sentiment-btn text-xs font-semibold text-${color}-600 bg-${color}-100 px-2 py-1 rounded-full\">${emoji} ${text}</button>`;
                }
            } catch (error) {
                console.error("Erro ao atualizar sentimento por palavra:", error);
                showAlert("Erro ao atualizar sentimento por palavra.", "error");
            }
        }

        async function handleKeywordMediaTypeChange(e) {
            const { keyword, word } = e.target.dataset;
            const mt = e.target.dataset.mediaType;
            const alertEl = e.target.closest('.fade-in');
            const articleId = alertEl?.dataset.id;
            if (!articleId || !currentUser || !keyword || !mt) return;
            try {
                const articleRef = doc(db, "artifacts", appId, "users", currentUser.companyId, "articles", articleId);
                const field = `keywordAnalysesMap.${keyword}`;
                await updateDoc(articleRef, { [field]: { ...(alertEl._kwAna?.[keyword] || {}), mediaType: mt, word } });
                const row = alertEl.querySelector(`.keyword-analysis-row[data-keyword='${keyword}']`);
                const btn = row?.querySelector('.keyword-media-container .media-btn');
                if (btn) {
                    const isProv = mt === 'Provocada';
                    const color = isProv ? 'amber' : 'teal';
                    btn.outerHTML = `<button class=\"media-btn text-xs font-semibold text-${color}-600 bg-${color}-100 px-2 py-1 rounded-full\">${mt}</button>`;
                }
            } catch (error) {
                console.error("Erro ao atualizar Espontânea/Provocada por palavra:", error);
                showAlert("Erro ao atualizar Espontânea/Provocada por palavra.", "error");
            }
        }

        async function handleKeywordDirectnessChange(e) {
            const { keyword, word } = e.target.dataset;
            const isDirect = String(e.target.dataset.directness) === 'true';
            const alertEl = e.target.closest('.fade-in');
            const articleId = alertEl?.dataset.id;
            if (!articleId || !currentUser || !keyword) return;
            try {
                const articleRef = doc(db, "artifacts", appId, "users", currentUser.companyId, "articles", articleId);
                const field = `keywordAnalysesMap.${keyword}`;
                await updateDoc(articleRef, { [field]: { ...(alertEl._kwAna?.[keyword] || {}), direct: isDirect, word } });
                const row = alertEl.querySelector(`.keyword-analysis-row[data-keyword='${keyword}']`);
                const btn = row?.querySelector('.keyword-directness-btn');
                if (btn) {
                    const newColorText = isDirect ? 'text-orange-600' : 'text-gray-600';
                    const newColorBg = isDirect ? 'bg-orange-100' : 'bg-gray-100';
                    btn.className = `keyword-directness-btn text-xs font-semibold ${newColorText} ${newColorBg} px-2 py-1 rounded-full`;
                    btn.textContent = isDirect ? 'Direto' : 'Indireto';
                }
            } catch (error) {
                console.error("Erro ao atualizar Direto/Indireto por palavra:", error);
                showAlert("Erro ao atualizar Direto/Indireto por palavra.", "error");
            }
        }

        function filterAlertsByDate() { if (!newsAlerts || !alertDateFilter) return; const selectedDate = alertDateFilter.value; const allAlerts = newsAlerts.querySelectorAll('.fade-in'); let visibleCount = 0; allAlerts.forEach(alert => { const isVisible = !selectedDate || alert.dataset.date === selectedDate; alert.style.display = isVisible ? 'block' : 'none'; if (isVisible) visibleCount++; }); if (visibleCount === 0 && !newsAlerts.querySelector('.text-gray-500')) { newsAlerts.insertAdjacentHTML('beforeend', `<p class=\"text-gray-500\">Nenhum alerta encontrado para a data selecionada.</p>`); } else if (visibleCount > 0) { const noAlertsMsg = newsAlerts.querySelector('.text-gray-500'); if (noAlertsMsg) noAlertsMsg.remove(); } }

        async function renderReportPage() {
            if (!currentUser) return;
            const articlesQuery = query(collection(db, "artifacts", appId, "users", currentUser.companyId, "articles"), orderBy("publishedAt", "desc"));
            const keywordsQuery = query(collection(db, "artifacts", appId, "users", currentUser.companyId, "keywords"));
            const [articlesSnapshot, keywordsSnapshot] = await Promise.all([getDocs(articlesQuery), getDocs(keywordsQuery)]);
            allCompanyArticles = articlesSnapshot.docs.map(doc => doc.data());
            const keywords = keywordsSnapshot.docs.map(doc => doc.data().word);
            if (reportKeywordFilterContainer) {
                reportKeywordFilterContainer.innerHTML = '';
                // Adiciona opção 'Todos' inicialmente marcada
                const allId = 'kw-filter-all';
                const allEl = document.createElement('div');
                allEl.className = 'flex items-center';
                allEl.innerHTML = `<input type="checkbox" id="${allId}" value="Todos" class="report-kw-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" checked><label for="${allId}" class="ml-2 block text-sm text-gray-900">Todos</label>`;
                reportKeywordFilterContainer.appendChild(allEl);
                // Ordenar palavras-chave por nome em ordem alfabética
                keywords.sort((a, b) => a.localeCompare(b));
                // Renderiza demais palavras‑chave
                keywords.forEach(kw => {
                    const id = `kw-filter-${kw.replace(/\s+/g, '-')}`;
                    const filterEl = document.createElement('div');
                    filterEl.className = 'flex items-center';
                    filterEl.innerHTML = `<input type="checkbox" id="${id}" value="${kw}" class="report-kw-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"><label for="${id}" class="ml-2 block text-sm text-gray-900">${kw}</label>`;
                    reportKeywordFilterContainer.appendChild(filterEl);
                });
            }
            const updateCharts = () => {
                const startDate = startDateInput && startDateInput.value ? new Date(startDateInput.value) : null;
                const endDate = endDateInput && endDateInput.value ? new Date(endDateInput.value) : null;
                let selectedKeywords = reportKeywordFilterContainer ? Array.from(reportKeywordFilterContainer.querySelectorAll('.report-kw-checkbox:checked')).map(cb => cb.value).filter(v => v !== 'Todos') : [];
                if (startDate) startDate.setHours(0, 0, 0, 0);
                if (endDate) endDate.setHours(23, 59, 59, 999);
                const allowedChannels = (typeof companyCaptureChannels !== 'undefined' && companyCaptureChannels && companyCaptureChannels.length > 0) ? companyCaptureChannels : ['Sites','YouTube','Revistas','Rádios','TV'];
                let filteredArticles = allCompanyArticles.filter(a => allowedChannels.includes(a.channel || getChannelCategory(a.source?.name)));
                filteredArticles = filteredArticles.filter(article => {
                    const pubDate = article.publishedAt.toDate();
                    const dateMatch = (!startDate || pubDate >= startDate) && (!endDate || pubDate <= endDate);
                    if (!selectedKeywords || selectedKeywords.length === 0) {
                        // Sem palavras‑chave: aplica apenas filtro por período
                        return dateMatch;
                    }
                    const articleKeywords = article.keywords || [article.keyword];
                    const keywordMatch = selectedKeywords.some(sk => articleKeywords.includes(sk));
                    return dateMatch && keywordMatch;
                });
                const keywordsToDisplay = (!selectedKeywords || selectedKeywords.length === 0) ? ['Todos'] : selectedKeywords;
                renderSourceChart(filteredArticles, keywordsToDisplay);
                renderDateChart(filteredArticles, keywordsToDisplay);
                renderSentimentChart(filteredArticles, keywordsToDisplay);
                renderChannelChart(filteredArticles, keywordsToDisplay);
                renderDirectnessChart(filteredArticles, keywordsToDisplay);
                renderMediaTypeChart(filteredArticles, keywordsToDisplay);
            };
            if (startDateInput) startDateInput.addEventListener('change', updateCharts);
            if (endDateInput) endDateInput.addEventListener('change', updateCharts);
            if (reportKeywordFilterContainer) reportKeywordFilterContainer.addEventListener('change', (e) => {
                const target = e.target;
                if (!target || !target.classList.contains('report-kw-checkbox')) { updateCharts(); return; }
                const isAll = target.value === 'Todos';
                if (isAll) {
                    const nonAllCheckboxes = Array.from(reportKeywordFilterContainer.querySelectorAll('.report-kw-checkbox')).filter(cb => cb.value !== 'Todos');
                    if (target.checked) {
                        // Ao marcar 'Todos', marcar todas as demais palavras‑chave
                        nonAllCheckboxes.forEach(cb => { cb.checked = true; });
                    } else {
                        // Ao desmarcar 'Todos', desmarcar todas as demais palavras‑chave
                        nonAllCheckboxes.forEach(cb => { cb.checked = false; });
                    }
                } else {
                    // Ajusta o estado de 'Todos' conforme seleção das específicas
                    const allCb = reportKeywordFilterContainer.querySelector('.report-kw-checkbox[value="Todos"]');
                    const nonAllCheckboxes = Array.from(reportKeywordFilterContainer.querySelectorAll('.report-kw-checkbox')).filter(cb => cb.value !== 'Todos');
                    const allChecked = nonAllCheckboxes.every(cb => cb.checked);
                    if (allCb) allCb.checked = allChecked;
                }
                updateCharts();
            });
            updateCharts();
        }

        const chartColors = ['#4F46E5', '#06B6D4', '#F59E0B', '#10B981', '#EF4444', '#8B5CF6', '#EC4899'];
        function createChart(canvasId, instanceVar, type, data, customOptions = {}) {
            const canvasEl = document.getElementById(canvasId);
            if (!canvasEl) return;
            if (instanceVar) instanceVar.destroy();
            const ctx = canvasEl.getContext('2d');
            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            };
            const options = { ...defaultOptions, ...customOptions };
            return new Chart(ctx, { type, data, options });
        }
        function renderSourceChart(articles, selectedKeywords) {
            const datasets = [];
            const allSources = [...new Set(articles.map(a => getDisplaySourceName(a)))].sort();
            selectedKeywords.forEach((keyword, index) => {
                const isTodos = keyword === 'Todos';
                const sourceCounts = allSources.map(source => articles.filter(a => (isTodos || (a.keywords || [a.keyword]).includes(keyword)) && getDisplaySourceName(a) === source).length);
                datasets.push({ label: isTodos ? 'Todos' : keyword, data: sourceCounts, borderColor: chartColors[index % chartColors.length], borderWidth: 2, fill: false });
            });
            sourceChartInstance = createChart('source-chart', sourceChartInstance, 'line', { labels: allSources, datasets });
        }
        function renderChannelChart(articles, selectedKeywords) {
            const allChannels = ['YouTube', 'Sites', 'Revistas', 'Rádios', 'TV'];
            const hasTodos = selectedKeywords && selectedKeywords.includes('Todos');
            const selectedList = (selectedKeywords || []).filter(k => k !== 'Todos');
            
            // Quando "Todos" está selecionado, consolidar dados por canal sem distinção por palavra-chave
            if (hasTodos || selectedList.length === 0) {
                const totalCounts = allChannels.map(channel => 
                    articles.filter(a => {
                        const ch = (a.channel || getChannelCategory(a.source?.name));
                        return ch === channel;
                    }).length
                );
                
                const datasets = [{
                    label: 'Total',
                    data: totalCounts,
                    borderColor: chartColors[0],
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3
                }];
                
                channelChartInstance = createChart('channel-chart', channelChartInstance, 'line', { labels: allChannels, datasets }, { plugins: { legend: { position: 'bottom' } } });
            } else {
                // Quando palavras-chave específicas estão selecionadas, mostrar dados por palavra-chave
                const keywordsToPlot = selectedList;
                const datasets = keywordsToPlot.map((keyword, index) => {
                    const counts = allChannels.map(channel => articles.filter(a => {
                        const ch = (a.channel || getChannelCategory(a.source?.name));
                        const kws = a.keywords || [a.keyword];
                        return ch === channel && kws && kws.includes(keyword);
                    }).length);
                    return { label: keyword, data: counts, borderColor: chartColors[index % chartColors.length], borderWidth: 2, fill: false, tension: 0.3 };
                });
                
                channelChartInstance = createChart('channel-chart', channelChartInstance, 'line', { labels: allChannels, datasets }, { plugins: { legend: { position: 'bottom' } } });
            }
        }
        function renderDateChart(articles, selectedKeywords) {
            const datasets = [];
            const allDates = [...new Set(articles.map(a => a.publishedAt.toDate().toLocaleDateString('pt-BR')))].sort((a, b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
            selectedKeywords.forEach((keyword, index) => {
                const isTodos = keyword === 'Todos';
                const dateCounts = allDates.map(date => articles.filter(a => ((isTodos || (a.keywords || [a.keyword]).includes(keyword)) && a.publishedAt.toDate().toLocaleDateString('pt-BR') === date)).length);
                datasets.push({ label: isTodos ? 'Todos' : keyword, data: dateCounts, borderColor: chartColors[index % chartColors.length], borderWidth: 2, fill: false, tension: 0.1 });
            });
            dateChartInstance = createChart('date-chart', dateChartInstance, 'line', { labels: allDates, datasets });
        }
        function renderSentimentChart(articles, selectedKeywords) {
            const datasets = [];
            const allSentiments = ['Positivo', 'Neutro', 'Negativo'];
            selectedKeywords.forEach((keyword, index) => {
                const isTodos = keyword === 'Todos';
                const keywordArticles = isTodos ? articles : articles.filter(a => (a.keywords || [a.keyword]).includes(keyword));
                const sentimentCounts = { positive: 0, neutral: 0, negative: 0 };
                keywordArticles.forEach(article => {
                    const score = article.ai?.sentiment?.score ?? article.sentiment?.score ?? 0;
                    if (score > 0.25) sentimentCounts.positive++;
                    else if (score < -0.25) sentimentCounts.negative++;
                    else sentimentCounts.neutral++;
                });
                const totalSentiments = sentimentCounts.positive + sentimentCounts.neutral + sentimentCounts.negative;
                const dataInPercentage = totalSentiments > 0 ? [(sentimentCounts.positive / totalSentiments) * 100, (sentimentCounts.neutral / totalSentiments) * 100, (sentimentCounts.negative / totalSentiments) * 100] : [0, 0, 0];
                datasets.push({ label: isTodos ? 'Todos' : keyword, data: dataInPercentage, borderColor: chartColors[index % chartColors.length], borderWidth: 2, fill: false });
            });
            const sentimentChartOptions = { scales: { y: { ticks: { callback: function (value) { return value + '%'; } }, min: 0, max: 100 } }, plugins: { tooltip: { callbacks: { label: function (context) { let label = context.dataset.label || ''; if (label) { label += ': '; } if (context.parsed.y !== null) { label += context.parsed.y.toFixed(2) + '%'; } return label; } } } } };
            sentimentChartInstance = createChart('sentiment-chart', sentimentChartInstance, 'line', { labels: allSentiments, datasets }, sentimentChartOptions);
        }
        function renderDirectnessChart(articles, selectedKeywords) {
            const labels = (selectedKeywords && selectedKeywords.length) ? selectedKeywords : ['Todos'];
            const directData = [];
            const indirectData = [];
            labels.forEach((keyword) => {
                const isTodos = keyword === 'Todos';
                const keywordArticles = isTodos ? articles : articles.filter(a => (a.keywords || [a.keyword]).includes(keyword));
                let directCount = 0, indirectCount = 0;
                keywordArticles.forEach(article => {
                    const title = (article.title || '').toLowerCase();
                    const desc = (article.description || '').toLowerCase();
                    const kws = (article.keywords || [article.keyword]).map(k => (k || '').toLowerCase());
                    const direct = kws.some(k => k && (title.includes(k) || desc.includes(k)));
                    if (direct) directCount++; else indirectCount++;
                });
                directData.push(directCount);
                indirectData.push(indirectCount);
            });
            const datasets = [
                { label: 'Direto', data: directData, backgroundColor: chartColors[0], stack: 'total' },
                { label: 'Indireto', data: indirectData, backgroundColor: chartColors[1], stack: 'total' }
            ];
            directnessChartInstance = createChart('directness-chart', directnessChartInstance, 'bar', { labels, datasets }, { scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }, plugins: { legend: { position: 'bottom' } } });
        }
        function renderMediaTypeChart(articles, selectedKeywords) {
            const labels = (selectedKeywords && selectedKeywords.length) ? selectedKeywords : ['Todos'];
            const espontaneaData = [];
            const provocadaData = [];
            labels.forEach((keyword) => {
                const isTodos = keyword === 'Todos';
                const keywordArticles = isTodos ? articles : articles.filter(a => (a.keywords || [a.keyword]).includes(keyword));
                let espontanea = 0, provocada = 0;
                keywordArticles.forEach(article => {
                    const raw = article.mediaType;
                    if (raw && /provocada/i.test(raw)) provocada++; else espontanea++;
                });
                espontaneaData.push(espontanea);
                provocadaData.push(provocada);
            });
            const datasets = [
                { label: 'Espontânea', data: espontaneaData, backgroundColor: chartColors[2], stack: 'total' },
                { label: 'Provocada', data: provocadaData, backgroundColor: chartColors[3], stack: 'total' }
            ];
            mediaTypeChartInstance = createChart('media-type-chart', mediaTypeChartInstance, 'bar', { labels, datasets }, { scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }, plugins: { legend: { position: 'bottom' } } });
        }

        async function setupSearchPage() { if (!currentUser) return; if (searchInput) searchInput.value = ''; if (searchResults) searchResults.innerHTML = '<p class="text-gray-500">A carregar todos os artigos para pesquisa...</p>'; try { const q = query(collection(db, "artifacts", appId, "users", currentUser.companyId, "articles"), orderBy("publishedAt", "desc")); const articlesSnapshot = await getDocs(q); allCompanyArticles = articlesSnapshot.docs.map(d => ({ ...d.data(), id: d.id })); if (searchResults) searchResults.innerHTML = `<p class="text-gray-500">Pronto para pesquisar em ${allCompanyArticles.length} artigos. Digite um termo ou utilize os filtros.</p>`; setupFilters(); } catch (error) { console.error("Erro ao buscar artigos para pesquisa:", error); if (searchResults) searchResults.innerHTML = '<p class="text-red-500">Não foi possível carregar os artigos para pesquisa.</p>'; } }

        function setupFilters() {
            if (!filterContainer) return;
            const keywordButtonsContainer = document.getElementById('keyword-filter-buttons');
            if (keywordButtonsContainer) {
                keywordButtonsContainer.innerHTML = '';
                const keywords = [...new Set(allCompanyArticles.flatMap(a => a.keywords || [a.keyword]))];
                if (keywords.length > 0) {
                    let keywordButtons = keywords.map(kw => `<button class="filter-btn bg-gray-200 hover:bg-indigo-200 text-gray-800 text-sm font-medium px-3 py-1 rounded-full" data-keyword="${kw}">${kw}</button>`).join('');
                    keywordButtonsContainer.innerHTML = `<div class="flex flex-wrap gap-2"><span class="font-semibold self-center">Filtrar por Palavra-Chave:</span>${keywordButtons}</div>`;
                }
            }
            const sourceFilter = document.getElementById('search-source-filter');
            if (sourceFilter) {
                const sources = [...new Set(allCompanyArticles.map(a => getDisplaySourceName(a)))].sort();
                sourceFilter.innerHTML = '<option value="">Todos</option>';
                sources.forEach(source => {
                    const option = document.createElement('option');
                    option.value = source;
                    option.textContent = source;
                    sourceFilter.appendChild(option);
                });
            }
            document.getElementById('search-source-filter')?.addEventListener('change', handleSearch);
            document.getElementById('search-channel-filter')?.addEventListener('change', handleSearch);
            document.getElementById('search-start-date')?.addEventListener('change', handleSearch);
            document.getElementById('search-end-date')?.addEventListener('change', handleSearch);
            document.getElementById('search-sentiment-filter')?.addEventListener('change', handleSearch);
        }
        function handleSearch() {
            if (!searchInput || !searchResults || !filterContainer) return;
            const searchTerm = searchInput.value.toLowerCase().trim();
            const activeKeywordFilter = filterContainer.querySelector('.filter-btn.bg-indigo-500');
            const keywordFilter = activeKeywordFilter ? activeKeywordFilter.dataset.keyword : null;
            const sourceFilterValue = document.getElementById('search-source-filter')?.value;
            const channelFilterValue = document.getElementById('search-channel-filter')?.value;
            const startDateValue = document.getElementById('search-start-date')?.value;
            const endDateValue = document.getElementById('search-end-date')?.value;
            const sentimentFilterValue = document.getElementById('search-sentiment-filter')?.value;
            const hasActiveFilters = keywordFilter || sourceFilterValue || channelFilterValue || startDateValue || endDateValue || sentimentFilterValue;
            if (!searchTerm && !hasActiveFilters) {
                searchResults.innerHTML = `<p class="text-gray-500">Digite algo para começar a pesquisar ou use os filtros.</p>`;
                return;
            }
            const allowedChannels = (typeof companyCaptureChannels !== 'undefined' && companyCaptureChannels && companyCaptureChannels.length > 0) ? companyCaptureChannels : ['Sites','YouTube','Revistas','Rádios','TV'];
            let filteredArticles = allCompanyArticles.filter(a => allowedChannels.includes(a.channel || getChannelCategory(a.source?.name)));
            if (keywordFilter) { filteredArticles = filteredArticles.filter(a => (a.keywords || [a.keyword]).includes(keywordFilter)); }
            if (sourceFilterValue) { filteredArticles = filteredArticles.filter(a => getDisplaySourceName(a) === sourceFilterValue); }
            if (channelFilterValue) { filteredArticles = filteredArticles.filter(a => (a.channel || getChannelCategory(a.source?.name)) === channelFilterValue); }
            if (startDateValue) { const startDate = new Date(startDateValue); startDate.setHours(0, 0, 0, 0); filteredArticles = filteredArticles.filter(a => a.publishedAt.toDate() >= startDate); }
            if (endDateValue) { const endDate = new Date(endDateValue); endDate.setHours(23, 59, 59, 999); filteredArticles = filteredArticles.filter(a => a.publishedAt.toDate() <= endDate); }
            if (sentimentFilterValue) {
                filteredArticles = filteredArticles.filter(a => {
                    const score = a.ai?.sentiment?.score ?? a.sentiment?.score ?? 0;
                    if (sentimentFilterValue === 'positive') return score > 0.25;
                    if (sentimentFilterValue === 'negative') return score < -0.25;
                    if (sentimentFilterValue === 'neutral') return score >= -0.25 && score <= 0.25;
                    return false;
                });
            }
            if (searchTerm) { filteredArticles = filteredArticles.filter(a => a.title.toLowerCase().includes(searchTerm) || (a.description && a.description.toLowerCase().includes(searchTerm))); }
            renderSearchResults(filteredArticles);
        }
        function renderSearchResults(articles) { if (!searchResults) return; searchResults.innerHTML = ''; if (articles.length === 0) { searchResults.innerHTML = '<p class="text-gray-500">Nenhum resultado encontrado.</p>'; return; } articles.forEach(article => displayNewsAlert(article, searchResults)); }

        function handleDashboardKeywordFilter(e) {
            const target = e.target.closest('.keyword-filter');
            if (!target) return;
            const isAlreadyActive = target.classList.contains('active');
            const keywordToFilter = target.dataset.keyword;
            document.querySelectorAll('.keyword-filter').forEach(el => el.classList.remove('active'));
            if (isAlreadyActive && keywordToFilter !== 'all') {
                document.querySelector('.keyword-filter[data-keyword="all"]').classList.add('active');
            } else { target.classList.add('active'); }
            filterDashboardAlerts();
        }
        function filterDashboardAlerts() {
            if (!dashboardKeywordList || !newsAlerts) return;
            const activeKeywordEl = dashboardKeywordList.querySelector('.keyword-filter.active');
            const selectedKeyword = activeKeywordEl ? activeKeywordEl.dataset.keyword : 'all';
            const allAlerts = newsAlerts.querySelectorAll('.fade-in');
            allAlerts.forEach(alert => {
                const alertKeywords = alert.dataset.keywords.split(',');
                const keywordMatch = selectedKeyword === 'all' || alertKeywords.includes(selectedKeyword);
                alert.style.display = keywordMatch ? 'block' : 'none';
            });
        }

        async function handleAlertCardActions(e) {
            const target = e.target;
            if (!target) return;
            // Per-keyword toggles
            if (target.closest('.keyword-sentiment-btn')) {
                const container = target.closest('.keyword-sentiment-container');
                const menu = container?.querySelector('.keyword-sentiment-menu');
                if (menu) { menu.style.display = (menu.style.display === 'block') ? 'none' : 'block'; }
                return;
            }
            if (target.closest('.keyword-media-container') && target.closest('.media-btn')) {
                const container = target.closest('.keyword-media-container');
                const menu = container?.querySelector('.keyword-media-menu');
                if (menu) { menu.style.display = (menu.style.display === 'block') ? 'none' : 'block'; }
                return;
            }
            if (target.closest('.keyword-directness-btn')) {
                const container = target.closest('.keyword-directness-container');
                const menu = container?.querySelector('.directness-menu');
                if (menu) { menu.style.display = (menu.style.display === 'block') ? 'none' : 'block'; }
                return;
            }
            if (target.closest('.keyword-sentiment-option')) { handleKeywordSentimentChange(e); return; }
            if (target.closest('.keyword-media-option')) { handleKeywordMediaTypeChange(e); return; }
            if (target.closest('.directness-option')) { handleKeywordDirectnessChange(e); return; }

            // Global directness toggle
            if (target.closest('.global-directness-btn')) {
                const container = target.closest('.directness-container');
                const menu = container?.querySelector('.directness-menu');
                if (menu) { menu.style.display = (menu.style.display === 'block') ? 'none' : 'block'; }
                return;
            }
            if (target.closest('.global-directness-option')) { handleGlobalDirectnessChange(e); return; }

            // Existing global handlers
            if (target.closest('.sentiment-option')) { handleSentimentChange(e); return; }
            if (target.closest('.media-option')) { handleMediaTypeChange(e); return; }
            if (target.closest('.request-delete-btn')) {
                const alertEl = target.closest('.fade-in');
                if (!alertEl) return;
                articleToDeleteInfo = { id: alertEl.dataset.id, title: alertEl.querySelector('h4').textContent };
                if (justificationText) justificationText.value = '';
                if (submitJustificationBtn) submitJustificationBtn.disabled = true;
                if (justificationModal) justificationModal.classList.remove('hidden');
                return;
            }
            const alertBody = target.closest('.alert-body-clickable');
            if (alertBody) {
                const alertEl = alertBody.closest('.fade-in');
                const articleId = alertEl.dataset.id;
                if (!articleId || !currentUser) return;
                try {
                    const articleRef = doc(db, "artifacts", appId, "users", currentUser.companyId, "articles", articleId);
                    const docSnap = await getDoc(articleRef);
                    if (docSnap.exists()) {
                        currentDetailArticle = { id: docSnap.id, ...docSnap.data() };
                        renderArticleDetailPage(currentDetailArticle);
                        updateView('article-detail');
                    } else { showAlert('Não foi possível encontrar os detalhes deste alerta.', 'error'); }
                } catch (error) { console.error("Erro ao buscar detalhes do artigo:", error); showAlert('Erro ao carregar os detalhes do alerta.', 'error'); }
            }
        }

        async function renderArticleDetailPage(article) {
            if (!detailTitle || !detailContent || !detailAiInsights) return;

            const auroraLogoEl = document.getElementById('aurora-clipping-logo');
            const globalLogoArea = document.getElementById('global-logo-area');
            if (auroraLogoEl && globalLogoArea) {
                auroraLogoEl.innerHTML = globalLogoArea.innerHTML;
            }

            const reportMetaGrid = document.getElementById('report-meta-grid');
            const detailAiInsightsEl = document.getElementById('detail-ai-insights');
            const reportDateEl = document.getElementById('report-date');
            const detailTitleEl = document.getElementById('detail-title');
            const detailContentEl = document.getElementById('detail-content');
            const reportLogoContainer = document.getElementById('report-logo-container');
            const originalLinkEl = document.getElementById('detail-original-link');

            reportMetaGrid.innerHTML = '';
            detailAiInsightsEl.innerHTML = '';

            const pubDate = new Date(article.publishedAt.seconds ? article.publishedAt.toDate() : article.publishedAt);
            reportDateEl.textContent = `Gerado em: ${new Date().toLocaleDateString('pt-BR')}`;
            detailTitleEl.textContent = article.title;
            
            // Verificar se estamos no contexto de Relatório de Notícias (não permite edição de análises)
            const isNewsReport = detailTitleEl.closest('#report-content')?.querySelector('h2')?.textContent === 'Relatório de Notícia';
            
            const fullContent = article.content || article.description || 'Conteúdo completo não disponível.';
            const initialParagraphs = fullContent.split('\n').filter(p => p.trim() !== '').map(p => `<p class="mb-4">${p}</p>`).join('');
            // Sempre tentar carregar o conteúdo completo da notícia via /extract-article quando houver URL
            detailContentEl.innerHTML = '<p class="text-gray-500">A carregar conteúdo completo da notícia...</p>';
            if (article.url) {
                try {
                    const resp = await fetch('/extract-article', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url: article.url })
                    });
                    const data = await resp.json();
                    if (data && data.ok && data.content) {
                        const paragraphs = String(data.content).split(/\n{1,}/).filter(p => p.trim() !== '');
                        detailContentEl.innerHTML = paragraphs.map(p => `<p class="mb-4">${p}</p>`).join('');
                    } else {
                        detailContentEl.innerHTML = initialParagraphs;
                    }
                } catch (e) {
                    console.error('Falha ao extrair conteúdo completo:', e);
                    detailContentEl.innerHTML = initialParagraphs;
                }
            } else {
                detailContentEl.innerHTML = initialParagraphs;
            }

            const companyLogo = document.querySelector('#header-logo-container img');
            if (companyLogo) {
                reportLogoContainer.innerHTML = `<img src="${companyLogo.src}" alt="Logótipo da Empresa" class="h-full w-auto object-contain">`;
            } else {
                reportLogoContainer.innerHTML = `<h3 class="text-lg font-bold">${currentUser.companyName}</h3>`;
            }

            if (originalLinkEl) {
                originalLinkEl.href = article.url;
                originalLinkEl.textContent = article.url;

                // Botão para transferir arquivo completo da notícia
                let downloadBtn = document.getElementById('download-full-btn');
                if (!downloadBtn) {
                    downloadBtn = document.createElement('button');
                    downloadBtn.id = 'download-full-btn';
                    downloadBtn.className = 'ml-3 inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50';
                    downloadBtn.textContent = 'Transferir arquivo completo';
                    originalLinkEl.insertAdjacentElement('afterend', downloadBtn);
                }
                downloadBtn.onclick = () => {
                    try {
                        const safeTitle = (article.title || 'noticia').replace(/[^\w\-]+/g, '_').slice(0, 80);
                        const pubDateStr = new Date(article.publishedAt.seconds ? article.publishedAt.toDate() : article.publishedAt).toLocaleDateString('pt-BR');
                        const detailContentEl = document.getElementById('detail-content');
                        const fileHtml = `<!doctype html><html lang="pt-BR"><head><meta charset="utf-8"><title>${article.title || ''}</title></head><body><h1>${article.title || ''}</h1>${detailContentEl ? detailContentEl.innerHTML : ''}<hr><p>Fonte: ${getDisplaySourceName(article)} | Publicado: ${pubDateStr} | Link original: ${article.url || ''}</p></body></html>`;
                        const blob = new Blob([fileHtml], { type: 'text/html;charset=utf-8' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${safeTitle}.html`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        setTimeout(() => URL.revokeObjectURL(url), 1000);
                    } catch (e) {
                        console.error('Falha ao gerar arquivo da notícia:', e);
                        showAlert('Falha ao gerar o arquivo completo da notícia.', 'error');
                    }
                };
            }

            const createMetaItem = (label, value) => `<div class="flex flex-col"><span class="font-semibold text-gray-800">${label}</span><span class="text-gray-600">${value || 'N/A'}</span></div>`;

            // Ordem solicitada
            reportMetaGrid.innerHTML += createMetaItem('Data da Publicação', pubDate.toLocaleDateString('pt-BR'));
            reportMetaGrid.innerHTML += createMetaItem('Fonte', getDisplaySourceName(article));
            if (article.author) {
                reportMetaGrid.innerHTML += createMetaItem('Autor', article.author);
            }

            const keywordsText = (article.keywords || []).join(', ');
            reportMetaGrid.innerHTML += createMetaItem('Palavras-Chave', keywordsText);

            // Análises por palavra‑chave (detalhe) logo após “Palavras‑Chave”
            (function () {
                const detailSection = document.getElementById('article-detail-page');
                if (detailSection) { detailSection.dataset.id = article.id; }
                const sanitizeKey = s => String(s).toLowerCase().trim().replace(/[.#$\[\]/]/g, '_').replace(/\s+/g, '_');
                const allTextLower = `${article.title || ''} ${article.description || ''}`.toLowerCase();
                const mediaInit = (() => { const raw = article.mediaType; return raw && /provocada/i.test(raw) ? 'Provocada' : 'Espontânea'; })();
                const baseSentiment = article.ai?.sentiment?.score ?? article.sentiment?.score ?? 0;
                if (detailSection) detailSection._kwAna = {};
                const kwList = (article.keywords && article.keywords.length > 0) ? article.keywords : [article.keyword].filter(Boolean);
                if (!kwList || kwList.length === 0) return;
                const kwHTMLDetail = kwList.map(kw => {
                    const sk = sanitizeKey(kw);
                    const isDirectKw = allTextLower.includes(String(kw).toLowerCase());
                    const directBtnClass = isDirectKw ? 'text-orange-600 bg-orange-100' : 'text-gray-600 bg-gray-100';
                    const mediaColor = mediaInit === 'Provocada' ? 'text-amber-600 bg-amber-100' : 'text-teal-600 bg-teal-100';
                    let emoji = '😐', color = 'gray', text = 'Neutro';
                    if (baseSentiment > 0.25) { emoji = '😊'; color = 'green'; text = 'Positivo'; }
                    else if (baseSentiment < -0.25) { emoji = '😠'; color = 'red'; text = 'Negativo'; }
                    if (detailSection) detailSection._kwAna[sk] = { word: kw, sentiment: baseSentiment, mediaType: mediaInit, direct: isDirectKw };
                    return `
                    <div class="keyword-analysis-row flex items-center gap-2" data-keyword="${sk}">
                      <span class="flex-shrink-0 text-xs font-semibold bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full">${kw}</span>
                      <div class="keyword-directness-container directness-container relative">
                        <button class="keyword-directness-btn text-xs font-semibold ${directBtnClass} px-2 py-1 rounded-full hover:opacity-80 transition-opacity">${isDirectKw ? 'Direto' : 'Indireto'}</button>
                        <div class="directness-menu p-1 space-y-1">
                          <button data-directness="true" data-keyword="${sk}" data-word="${kw}" class="directness-option w-full text-left text-xs px-2 py-1 rounded hover:bg-gray-100">Direto</button>
                          <button data-directness="false" data-keyword="${sk}" data-word="${kw}" class="directness-option w-full text-left text-xs px-2 py-1 rounded hover:bg-gray-100">Indireto</button>
                        </div>
                      </div>
                      <div class="keyword-media-container media-container relative">
                        <button class="media-btn text-xs font-semibold ${mediaColor} px-2 py-1 rounded-full hover:opacity-80 transition-opacity">${mediaInit}</button>
                        <div class="keyword-media-menu media-menu p-1 space-y-1">
                          <button data-media-type="Espontânea" data-keyword="${sk}" data-word="${kw}" class="keyword-media-option w-full text-left text-xs px-2 py-1 rounded hover:bg-gray-100">Espontânea</button>
                          <button data-media-type="Provocada" data-keyword="${sk}" data-word="${kw}" class="keyword-media-option w-full text-left text-xs px-2 py-1 rounded hover:bg-gray-100">Provocada</button>
                        </div>
                      </div>
                      <div class="keyword-sentiment-container sentiment-container relative">
                        <button class="keyword-sentiment-btn text-xs font-semibold text-${color}-600 bg-${color}-100 px-2 py-1 rounded-full hover:opacity-80 transition-opacity">${emoji} ${text}</button>
                        <div class="keyword-sentiment-menu sentiment-menu p-1 space-y-1">
                          <button data-sentiment="0.5" data-keyword="${sk}" data-word="${kw}" class="keyword-sentiment-option w-full text-left text-xs px-2 py-1 rounded hover:bg-gray-100">😊 Positivo</button>
                          <button data-sentiment="0.0" data-keyword="${sk}" data-word="${kw}" class="keyword-sentiment-option w-full text-left text-xs px-2 py-1 rounded hover:bg-gray-100">😐 Neutro</button>
                          <button data-sentiment="-0.5" data-keyword="${sk}" data-word="${kw}" class="keyword-sentiment-option w-full text-left text-xs px-2 py-1 rounded hover:bg-gray-100">😠 Negativo</button>
                        </div>
                      </div>
                    </div>`;
                }).join('');
                const fullRow = `<div class=\"md:col-span-4 col-span-2\"><div id=\"detail-keyword-analyses\" class=\"flex flex-col gap-2\">${kwHTMLDetail}</div></div>`;
                reportMetaGrid.innerHTML += fullRow;
            })();

            const sentimentScore = article.ai?.sentiment?.score ?? article.sentiment?.score ?? 0;
            let sentimentText = 'Neutro';
            if (sentimentScore > 0.25) { sentimentText = 'Positivo'; }
            else if (sentimentScore < -0.25) { sentimentText = 'Negativo'; }
            const sentimentHTML = createMetaItem('Sentimento', sentimentText);

            // Badges: Direta/Indireta
            const titleLower = (article.title || '').toLowerCase();
            const descLower = (article.description || '').toLowerCase();
            const kwsLower = (article.keywords || [article.keyword]).map(k => (k || '').toLowerCase());
            const isDirect = kwsLower.some(k => k && (titleLower.includes(k) || descLower.includes(k)));
            const directBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${isDirect ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${isDirect ? 'Direta' : 'Indireta'}</span>`;
            reportMetaGrid.innerHTML += `<div class="flex flex-col"><span class="font-semibold text-gray-800">Direta/Indireta</span><span>${directBadge}</span></div>`;

            // Badges: Tipo de Mídia
            const mediaRaw = article.mediaType;
            const isProvocada = mediaRaw && /provocada/i.test(mediaRaw);
            const mediaBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${isProvocada ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}">${isProvocada ? 'Provocada' : 'Espontânea'}</span>`;
            reportMetaGrid.innerHTML += `<div class="flex flex-col"><span class="font-semibold text-gray-800">Tipo de Mídia</span><span>${mediaBadge}</span></div>`;
            reportMetaGrid.innerHTML += sentimentHTML;

            if (article.author) {
                reportMetaGrid.innerHTML += createMetaItem('Autor', article.author);
            }

            let aiInsightsHTML = '';
            if (article.ai) {
                if (article.ai.entities?.length > 0) {
                    const entityColors = { PERSON: 'bg-blue-100 text-blue-800', LOCATION: 'bg-green-100 text-green-800', ORGANIZATION: 'bg-purple-100 text-purple-800', EVENT: 'bg-yellow-100 text-yellow-800' };
                    const entitiesHTML = article.ai.entities.map(e => `<span class="ai-tag ${entityColors[e.type] || 'bg-gray-100 text-gray-800'}">${e.name}</span>`).join('');
                    aiInsightsHTML += `<div class="mb-6"><h3 class="text-lg font-semibold text-gray-700 mb-2 border-b pb-2">Entidades Mencionadas</h3><div class="flex flex-wrap">${entitiesHTML}</div></div>`;
                }
                if (article.ai.logos?.length > 0) {
                    const logosHTML = article.ai.logos.map(l => `<span class="ai-tag bg-gray-200 text-gray-900">${l.description}</span>`).join('');
                    aiInsightsHTML += `<div class="mb-6"><h3 class="text-lg font-semibold text-gray-700 mb-2 border-b pb-2">Logotipos Detectados</h3><div class="flex flex-wrap">${logosHTML}</div></div>`;
                }
                if (article.ai.ocrText) {
                    aiInsightsHTML += `<div class="mb-6"><h3 class="text-lg font-semibold text-gray-700 mb-2 border-b pb-2">Texto Extraído da Imagem (OCR)</h3><p class="text-sm text-gray-600 bg-gray-50 p-3 rounded-md">${article.ai.ocrText}</p></div>`;
                }
            }
            detailAiInsightsEl.innerHTML = aiInsightsHTML;
        }

        function handleShareActions(e) {
            if (!currentDetailArticle) return;
            const title = encodeURIComponent(`[Clipping] ${currentDetailArticle.title}`);
            const url = encodeURIComponent(currentDetailArticle.url);
            if (e.currentTarget.id === 'share-whatsapp-btn') { window.open(`https://api.whatsapp.com/send?text=${title}%0A${url}`, '_blank'); }
            else if (e.currentTarget.id === 'share-email-btn') { window.location.href = `mailto:?subject=${title}&body=Leia a notícia completa em:%0A${url}`; }
        }

        function setupPendingAlertsListener() {
            if (pendingAlertsListener) pendingAlertsListener();
            const q = query(collection(db, "artifacts", appId, "public/data/pendingAlerts"), orderBy("publishedAt", "desc"));
            pendingAlertsListener = onSnapshot(q, (snapshot) => {
                let docs = snapshot.docs;
                if (currentUser && currentUser.isRestrictedGlobal && Array.isArray(currentUser.allowedCompanies) && currentUser.allowedCompanies.length > 0) {
                    docs = docs.filter(d => currentUser.allowedCompanies.includes(d.data().companyId));
                }
                renderPendingAlerts(docs);
                const pendingCount = docs.length;
                if (btnPendingAlerts && btnPendingAlerts.querySelector('#pending-alerts-badge')) {
                    btnPendingAlerts.querySelector('#pending-alerts-badge').textContent = pendingCount;
                    btnPendingAlerts.querySelector('#pending-alerts-badge').classList.toggle('hidden', pendingCount === 0);
                }
            }, (error) => {
                console.error("Erro ao escutar alertas pendentes:", error);
                if (pendingAlertsList) { pendingAlertsList.innerHTML = '<p class="text-red-500">Erro ao carregar alertas.</p>'; }
            });
        }

        async function runDiagnosticsAndManual() {
            try {
                // Validar empresas ativas e palavras‑chave
                const companiesSnapshot = await getDocs(query(collection(db, "artifacts", appId, "public/data/companies"), where("status", "==", "active")));
                const activeCompaniesCount = companiesSnapshot.size;
                const companiesMissingKeywords = [];
                let totalKeywords = 0;
                for (const docSnap of companiesSnapshot.docs) {
                    const companyId = docSnap.id;
                    const companyName = docSnap.data().name || companyId;
                    const kwSnap = await getDocs(collection(db, "artifacts", appId, "users", companyId, "keywords"));
                    const kwCount = kwSnap.size;
                    totalKeywords += kwCount;
                    if (kwCount === 0) companiesMissingKeywords.push(companyName);
                }

                // Conferir chaves globais
                const settingsRef = doc(db, "artifacts", appId, "public/data/settings", "global");
                const settingsSnap = await getDoc(settingsRef);
                const s = settingsSnap.exists() ? settingsSnap.data() : {};
                const keysStatus = {
                    apiKeyNewsApi: !!s.apiKeyNewsApi,
                    apiKeyGNews1: !!s.apiKeyGNews1,
                    apiKeyGNews2: !!s.apiKeyGNews2,
                    apiKeyGNews3: !!s.apiKeyGNews3,
                    apiKeyGNews4: !!s.apiKeyGNews4,
                    rssUrl: !!s.rssUrl,
                    bloggerId: !!s.bloggerId,
                };

                console.log('[Diagnóstico] Empresas ativas:', activeCompaniesCount, 'Total palavras‑chave:', totalKeywords, 'Empresas sem palavras‑chave:', companiesMissingKeywords);
                console.log('[Diagnóstico] Chaves globais:', keysStatus);
                // [Oculto] Diagnóstico desativado — não exibir alertas ao usuário
                // showAlert(`Diagnóstico: ${activeCompaniesCount} empresa(s) ativa(s), ${totalKeywords} palavra(s)‑chave no total. ${companiesMissingKeywords.length ? 'Sem keywords em: ' + companiesMissingKeywords.join(', ') : 'Todas com keywords.'}`, 'success');

                // Rodar robô manual
                const manualFetch = httpsCallable(functions, 'manualFetch', { timeout: 540000 });
                const result = await manualFetch({ appId });
                const totalSaved = (result?.data?.totalSaved) || 0;
                // [Oculto] Mensagem de robô manual desativada
                // showAlert(`Robô manual executado: ${totalSaved} alertas novos enviados para a fila em artifacts/${appId}/public/data/pendingAlerts.`, 'success');

                // Abrir Fila de Aprovação e confirmar listener
                updateView('super-admin-queue');
                setupPendingAlertsListener();

                // Logar amostra de pendentes
                const pendingSnap = await getDocs(collection(db, "artifacts", appId, "public/data/pendingAlerts"));
                const sample = pendingSnap.docs.slice(0,3).map(d => ({ id: d.id, title: d.data().title, companyId: d.data().companyId }));
                // [Oculto] Log de diagnóstico desativado
                // console.log('[Diagnóstico] Total na coleção pendingAlerts:', pendingSnap.size, 'Exemplos:', sample);
            } catch (e) {
                console.error('Erro no diagnóstico/robô manual:', e);
                // [Oculto] Alerta de erro desativado para diagnóstico/robô manual
                // showAlert(`Erro no diagnóstico/robô: ${e.message || e}`, 'error');
            }
        }

        function renderPendingAlerts(docs) {
            if (!pendingAlertsList) return;
            pendingAlertsList.innerHTML = '';
            if (docs.length === 0) {
                pendingAlertsList.innerHTML = '<p class="text-gray-500">Nenhum alerta pendente para aprovação.</p>';
                return;
            }
            docs.forEach(doc => {
                const alert = { id: doc.id, ...doc.data() };
                displayPendingAlert(alert, pendingAlertsList);
            });
        }

        async function handlePendingAlertAction(e) {
            const target = e.target;
            const alertEl = target.closest('.fade-in');
            if (!alertEl) return;
            const alertId = alertEl.dataset.id;
            const companyId = alertEl.dataset.companyId;
            if (currentUser && currentUser.isRestrictedGlobal && companyId && Array.isArray(currentUser.allowedCompanies) && currentUser.allowedCompanies.length > 0 && !currentUser.allowedCompanies.includes(companyId)) {
                showAlert('Sem permissão para agir neste alerta.', 'error');
                return;
            }
            if (target.classList.contains('approve-alert-btn')) {
                const approveAlert = httpsCallable(functions, 'approveAlert');
                try {
                    await approveAlert({ appId, alertId });
                    showAlert('Alerta aprovado e enviado para a empresa com sucesso!', 'success');
                    // Remover imediatamente o card aprovado da lista
                    if (alertEl && alertEl.parentElement) {
                        alertEl.remove();
                        if (pendingAlertsList && pendingAlertsList.children.length === 0) {
                            pendingAlertsList.innerHTML = '<p class="text-gray-500">Nenhum alerta pendente para aprovação.</p>';
                        }
                    }
                } catch (error) {
                    console.error("Erro ao aprovar alerta:", error);
                    showAlert(`Erro ao aprovar alerta: ${error.message}`, 'error');
                }
            } else if (target.classList.contains('reject-alert-btn')) {
                const rejectAlert = httpsCallable(functions, 'rejectAlert');
                try {
                    await rejectAlert({ appId, alertId });
                    showAlert('Alerta rejeitado com sucesso!', 'success');
                    // Remover imediatamente o card rejeitado da lista
                    if (alertEl && alertEl.parentElement) {
                        alertEl.remove();
                        if (pendingAlertsList && pendingAlertsList.children.length === 0) {
                            pendingAlertsList.innerHTML = '<p class="text-gray-500">Nenhum alerta pendente para aprovação.</p>';
                        }
                    }
                } catch (error) {
                    console.error("Erro ao rejeitar alerta:", error);
                    showAlert(`Erro ao rejeitar alerta: ${error.message}`, 'error');
                }
            }
        }

        function displayPendingAlert(alert, container) {
            const pubDate = new Date(alert.publishedAt.seconds ? alert.publishedAt.toDate() : alert.publishedAt);
            const formattedDate = pubDate.toLocaleDateString('pt-BR');
            const alertEl = document.createElement('div');
            alertEl.className = 'bg-white p-4 rounded-lg shadow-md border-l-4 border-yellow-500 fade-in';
            alertEl.dataset.id = alert.id;
            alertEl.dataset.companyId = alert.companyId;
            const companyLabel = alert.companyName || alert.companyId || '(sem empresa)';
            const kwArray = Array.isArray(alert.keywords) ? alert.keywords.filter(Boolean) : [];
            const keywordsString = kwArray.length ? kwArray.join(', ') : (alert.keyword || '(sem keywords)');
            const sourceName = getDisplaySourceName(alert);
            const safeTitle = (() => { try { return /[ÃÂâ]/.test(alert.title) ? decodeURIComponent(escape(alert.title)) : alert.title; } catch(_) { return alert.title; } })();
            const safeDesc = (() => { const d = alert.description || 'Descrição não disponível.'; try { return /[ÃÂâ]/.test(d) ? decodeURIComponent(escape(d)) : d; } catch(_) { return d; } })();
            const isRadio = alert.channel === 'Rádios' || (typeof alert.url === 'string' && /\.(mp3|m4a|aac|wav|ogg)(\?|$)/i.test(alert.url));
            const audioTypeMatch = (alert.url || '').match(/\.(mp3|m4a|aac|wav|ogg)(\?|$)/i);
            const audioType = audioTypeMatch ? audioTypeMatch[1].toLowerCase() : 'mp3';
            const mimeMap = { mp3: 'audio/mpeg', m4a: 'audio/mp4', aac: 'audio/aac', wav: 'audio/wav', ogg: 'audio/ogg' };
            const audioMime = mimeMap[audioType] || 'audio/mpeg';
            const audioSrc = alert.segmentUrl || alert.url;
            const audioHtml = isRadio ? `<audio controls preload=\"none\" class=\"w-full mt-3\"><source src=\"${audioSrc}\" type=\"${audioMime}\">Seu navegador não suporta áudio.</audio>` : '';
            alertEl.innerHTML = `<div class="flex justify-between items-start"><h4 class="text-lg font-bold text-gray-800 pr-2">${safeTitle}</h4><span class="flex-shrink-0 text-xs font-semibold bg-gray-100 text-gray-800 px-2 py-1 rounded-full">${companyLabel} - ${keywordsString}</span></div><p class="text-sm text-gray-600 mt-2">${safeDesc}</p>${audioHtml}<div class="text-xs text-gray-500 mt-3 flex justify-between items-center"><span>Fonte: ${getDisplaySourceName(alert)} | Publicado: ${formattedDate}</span><div class="flex gap-2"><a href="${alert.url}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline">Abrir artigo</a><button class="approve-alert-btn bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600">Aprovar</button><button class="reject-alert-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600">Rejeitar</button></div></div>`;
            container.appendChild(alertEl);
        }

        async function renderManualAlertPage() {
            const companySelect = document.getElementById('manual-alert-company');
            const keywordsContainer = document.getElementById('manual-alert-keywords');
            const selectAllCheckbox = document.getElementById('manual-alert-select-all');
            if (!companySelect || !keywordsContainer) return;
            companySelect.innerHTML = '<option value="">Selecione uma empresa</option>';
            keywordsContainer.innerHTML = '<p class="text-gray-500 text-sm">Selecione uma empresa primeiro</p>';
            const companiesSnapshot = await getDocs(query(collection(db, "artifacts", appId, "public/data/companies"), where("status", "==", "active")));
            const companies = [];
            companiesSnapshot.forEach(doc => {
                const companyId = doc.id;
                if (currentUser && currentUser.isRestrictedGlobal && Array.isArray(currentUser.allowedCompanies) && currentUser.allowedCompanies.length > 0 && !currentUser.allowedCompanies.includes(companyId)) {
                    return; // pular empresas não permitidas
                }
                companies.push({ id: companyId, name: doc.data().name });
            });
            // Ordenar empresas por nome em ordem alfabética
            companies.sort((a, b) => a.name.localeCompare(b.name));
            companies.forEach(company => {
                const option = document.createElement('option');
                option.value = company.id;
                option.textContent = company.name;
                companySelect.appendChild(option);
            });
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', (e) => {
                    const checked = e.target.checked;
                    const boxes = keywordsContainer.querySelectorAll('input[type=checkbox][data-kw]');
                    boxes.forEach(b => { b.checked = checked; });
                });
            }
        }

        async function populateManualAlertKeywords() {
            const companySelect = document.getElementById('manual-alert-company');
            const keywordsContainer = document.getElementById('manual-alert-keywords');
            const selectAllCheckbox = document.getElementById('manual-alert-select-all');
            const companyId = companySelect.value;
            keywordsContainer.innerHTML = '';
            if (!companyId) {
                keywordsContainer.innerHTML = '<p class="text-gray-500 text-sm">Selecione uma empresa primeiro</p>';
                return;
            }
            try {
                const keywordsSnapshot = await getDocs(query(collection(db, "artifacts", appId, "users", companyId, "keywords")));
                if (keywordsSnapshot.empty) {
                    keywordsContainer.innerHTML = '<p class="text-gray-500 text-sm">Nenhuma palavra-chave encontrada</p>';
                    return;
                }
                const fragment = document.createDocumentFragment();
                const keywords = [];
                keywordsSnapshot.forEach(doc => {
                    keywords.push(doc.data().word);
                });
                // Ordenar palavras-chave por nome em ordem alfabética
                keywords.sort((a, b) => a.localeCompare(b));
                keywords.forEach(word => {
                    const row = document.createElement('div');
                    row.className = 'flex items-center gap-2';
                    const box = document.createElement('input');
                    box.type = 'checkbox';
                    box.className = 'h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500';
                    box.dataset.kw = word;
                    const label = document.createElement('span');
                    label.textContent = word;
                    label.className = 'text-sm text-gray-800';
                    row.appendChild(box);
                    row.appendChild(label);
                    fragment.appendChild(row);
                });
                keywordsContainer.appendChild(fragment);
                if (selectAllCheckbox && selectAllCheckbox.checked) {
                    const boxes = keywordsContainer.querySelectorAll('input[type=checkbox][data-kw]');
                    boxes.forEach(b => { b.checked = true; });
                }
            } catch (error) {
                console.error("Erro ao buscar palavras-chave para alerta manual:", error);
                keywordsContainer.innerHTML = '<p class="text-red-500 text-sm">Erro ao carregar palavras-chave</p>';
            }
        }

        async function handleManualAlertSubmit(e) {
            e.preventDefault();
            const url = document.getElementById('manual-alert-url').value;
            // Determinar empresa a partir do formulário, com fallback para contexto do usuário/super admin
            const companySelectEl = document.getElementById('manual-alert-company');
            const selectedCompanyId = companySelectEl ? companySelectEl.value : '';
            const companyId = selectedCompanyId || (
                (currentUser && currentUser.companyId) ||
                ((currentUser && currentUser.isSuperAdmin && selectedCompanyForManagement && selectedCompanyForManagement.id) ? selectedCompanyForManagement.id : null)
            );
            if (!companyId) {
                showAlert('Selecione a empresa no formulário de alerta manual.', 'error');
                return;
            }
            if (!url) {
                showAlert('Informe a URL do artigo.', 'error');
                return;
            }
            try {
                const manualAddAlert = httpsCallable(functions, 'manualAddAlert');
                await manualAddAlert({ appId, companyId, url });
                showAlert('Alerta manual enviado para a fila de aprovação!', 'success');
                if (manualAlertForm) manualAlertForm.reset();
            } catch (error) {
                console.error('Erro ao adicionar alerta manual:', error);
                showAlert(`Erro: ${error.message}`, 'error');
            }
        }

        function setupDeletionRequestsListener() {
            if (deletionRequestsListener) deletionRequestsListener();
            const q = query(collection(db, "artifacts", appId, "public", "data", "deletionRequests"), orderBy("requestedAt", "desc"));
            deletionRequestsListener = onSnapshot(q, (snapshot) => {
                let docs = snapshot.docs;
                if (currentUser && currentUser.isRestrictedGlobal && Array.isArray(currentUser.allowedCompanies) && currentUser.allowedCompanies.length > 0) {
                    docs = docs.filter(d => currentUser.allowedCompanies.includes(d.data().companyId));
                }
                renderDeletionRequests(docs);
                const pendingCount = docs.filter(doc => doc.data().status === 'pending').length;
                if (deletionRequestsBadge) {
                    deletionRequestsBadge.textContent = pendingCount;
                    deletionRequestsBadge.classList.toggle('hidden', pendingCount === 0);
                }
            }, (error) => {
                console.error("Erro ao escutar pedidos de exclusão:", error);
                if (deletionRequestsList) {
                    deletionRequestsList.innerHTML = '<p class="text-red-500">Erro ao carregar pedidos.</p>';
                }
            });
        }

        function renderDeletionRequests(docs) {
            if (!deletionRequestsList) return;
            deletionRequestsList.innerHTML = '';
            if (!docs || docs.length === 0) {
                deletionRequestsList.innerHTML = '<p class="text-gray-500">Nenhum pedido de exclusão encontrado.</p>';
                return;
            }
            docs.forEach(doc => {
                const request = doc.data();
                const reqEl = document.createElement('div');
                reqEl.className = 'bg-white p-4 rounded-lg shadow';
                reqEl.dataset.companyId = request.companyId;
                const statusColor = request.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : (request.status === 'approved' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800');
                let buttonsHTML = '';
                if (request.status === 'pending') {
                    buttonsHTML = `<div class="mt-4 flex gap-2"><button data-id="${doc.id}" class="approve-request-btn bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">Aprovar</button><button data-id="${doc.id}" class="deny-request-btn bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">Negar</button></div>`;
                }
                reqEl.innerHTML = `<div class="flex justify-between items-center"><h4 class="font-bold text-gray-800">${request.companyName}</h4><span class="text-xs font-medium px-2 py-1 rounded-full ${statusColor}">${request.status}</span></div><p class="text-sm text-gray-600 mt-2"><strong>Alerta:</strong> ${request.articleTitle}</p><p class="text-sm text-gray-500 mt-2 bg-gray-50 p-2 rounded"><strong>Justificação:</strong> ${request.justification}</p>${buttonsHTML}`;
                deletionRequestsList.appendChild(reqEl);
            });
        }

        async function renderActivityPage() {
            const tbody = document.getElementById('activity-table-body');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-sm text-gray-500">Carregando atividade...</td></tr>';
            try {
                // Empresas ativas
                const companiesSnap = await getDocs(query(collection(db, "artifacts", appId, "public", "data", "companies"), where("status", "==", "active")));
                let companies = companiesSnap.docs.map(doc => ({ id: doc.id, name: doc.data().name || doc.id }));
                if (currentUser && currentUser.isRestrictedGlobal && Array.isArray(currentUser.allowedCompanies) && currentUser.allowedCompanies.length > 0) {
                    companies = companies.filter(c => currentUser.allowedCompanies.includes(c.id));
                }

                // Mapa de contagens por empresa
                const countsByCompany = {};
                companies.forEach(c => {
                    countsByCompany[c.id] = { Sites: 0, YouTube: 0, Revistas: 0, Rádio: 0, TV: 0, totalApprove: 0, pendingDeletion: 0, name: c.name };
                });

                // Alertas pendentes
                const pendingSnap = await getDocs(collection(db, "artifacts", appId, "public", "data", "pendingAlerts"));
                pendingSnap.forEach(doc => {
                    const alert = doc.data();
                    const cid = alert.companyId;
                    if (!cid || !countsByCompany[cid]) return;
                    const channelRaw = alert.channel || getChannelCategory(alert.source?.name);
                    const channelNorm = channelRaw === 'Rádios' ? 'Rádio' : channelRaw;
                    const channel = ['Sites', 'YouTube', 'Revistas', 'Rádio', 'TV'].includes(channelNorm) ? channelNorm : 'Sites';
                    countsByCompany[cid][channel] += 1;
                    countsByCompany[cid].totalApprove += 1;
                });

                // Pedidos de exclusão pendentes
                const delSnap = await getDocs(collection(db, "artifacts", appId, "public", "data", "deletionRequests"));
                delSnap.forEach(doc => {
                    const req = doc.data();
                    const cid = req.companyId;
                    if (!cid || !countsByCompany[cid]) return;
                    if (req.status === 'pending') countsByCompany[cid].pendingDeletion += 1;
                });

                // Renderização da tabela
                tbody.innerHTML = '';
                if (companies.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-sm text-gray-500">Nenhuma empresa ativa encontrada.</td></tr>';
                    return;
                }
                companies.sort((a, b) => a.name.localeCompare(b.name));
                companies.forEach(c => {
                    const cnt = countsByCompany[c.id] || { Sites: 0, YouTube: 0, Revistas: 0, Rádio: 0, TV: 0, totalApprove: 0, pendingDeletion: 0 };
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-6 py-4 text-sm text-gray-700 font-medium">${c.name}</td>
                        <td class="px-6 py-4 text-sm text-gray-700">${cnt.Sites}</td>
                        <td class="px-6 py-4 text-sm text-gray-700">${cnt.YouTube}</td>
                        <td class="px-6 py-4 text-sm text-gray-700">${cnt.Revistas}</td>
                        <td class="px-6 py-4 text-sm text-gray-700">${cnt.Rádio}</td>
                        <td class="px-6 py-4 text-sm text-gray-700">${cnt.TV}</td>
                        <td class="px-6 py-4 text-sm text-gray-700">${cnt.totalApprove}</td>
                        <td class="px-6 py-4 text-sm text-gray-700">${cnt.pendingDeletion}</td>
                    `;
                    tbody.appendChild(tr);
                });

                // Linha de totais
                const totals = Object.values(countsByCompany).reduce((acc, v) => {
                    acc.Sites += v.Sites;
                    acc.YouTube += v.YouTube;
                    acc.Revistas += v.Revistas;
                    acc.Rádio += v.Rádio;
                    acc.TV += v.TV;
                    acc.totalApprove += v.totalApprove;
                    acc.pendingDeletion += v.pendingDeletion;
                    return acc;
                }, { Sites: 0, YouTube: 0, Revistas: 0, Rádio: 0, TV: 0, totalApprove: 0, pendingDeletion: 0 });
                const trTotal = document.createElement('tr');
                trTotal.innerHTML = `
                    <td class="px-6 py-4 text-sm text-gray-800 font-semibold">Total</td>
                    <td class="px-6 py-4 text-sm text-gray-800 font-semibold">${totals.Sites}</td>
                    <td class="px-6 py-4 text-sm text-gray-800 font-semibold">${totals.YouTube}</td>
                    <td class="px-6 py-4 text-sm text-gray-800 font-semibold">${totals.Revistas}</td>
                    <td class="px-6 py-4 text-sm text-gray-800 font-semibold">${totals.Rádio}</td>
                    <td class="px-6 py-4 text-sm text-gray-800 font-semibold">${totals.TV}</td>
                    <td class="px-6 py-4 text-sm text-gray-800 font-semibold">${totals.totalApprove}</td>
                    <td class="px-6 py-4 text-sm text-gray-800 font-semibold">${totals.pendingDeletion}</td>
                `;
                tbody.appendChild(trTotal);

            } catch (e) {
                console.error('Erro ao renderizar atividade:', e);
                tbody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 text-sm text-red-600">Erro ao carregar atividade.</td></tr>`;
            }
        }

        function setupActivityListeners() {
            try {
                if (activityCompaniesListener) activityCompaniesListener();
                const qComp = query(collection(db, "artifacts", appId, "public/data/companies"), where("status", "==", "active"));
                activityCompaniesListener = onSnapshot(qComp, () => {
                    const isActive = !!activityPage && activityPage.classList.contains('active');
                    if (isActive && typeof renderActivityPage === 'function') renderActivityPage();
                });
            } catch (e) { console.error('Erro listener empresas atividade:', e); }
            try {
                if (activityPendingListener) activityPendingListener();
                const qPend = query(collection(db, "artifacts", appId, "public/data/pendingAlerts"), orderBy("publishedAt", "desc"));
                activityPendingListener = onSnapshot(qPend, () => {
                    const isActive = !!activityPage && activityPage.classList.contains('active');
                    if (isActive && typeof renderActivityPage === 'function') renderActivityPage();
                });
            } catch (e) { console.error('Erro listener pendingAlerts atividade:', e); }
            try {
                if (activityDeletionListener) activityDeletionListener();
                const qDel = query(collection(db, "artifacts", appId, "public/data/deletionRequests"), orderBy("requestedAt", "desc"));
                activityDeletionListener = onSnapshot(qDel, () => {
                    const isActive = !!activityPage && activityPage.classList.contains('active');
                    if (isActive && typeof renderActivityPage === 'function') renderActivityPage();
                });
            } catch (e) { console.error('Erro listener deletionRequests atividade:', e); }
        }

        async function handleDeletionRequestAction(e) {
            const target = e.target.closest('button');
            if (!target) return;
            const reqEl = target.closest('.bg-white');
            const companyId = reqEl ? reqEl.dataset.companyId : null;
            if (currentUser && currentUser.isRestrictedGlobal && companyId && Array.isArray(currentUser.allowedCompanies) && currentUser.allowedCompanies.length > 0 && !currentUser.allowedCompanies.includes(companyId)) {
                showAlert('Sem permissão para agir neste pedido.', 'error');
                return;
            }
            const requestId = target.dataset.id;
            const approve = target.classList.contains('approve-request-btn');
            try {
                const manageDeletionRequest = httpsCallable(functions, 'manageDeletionRequest');
                await manageDeletionRequest({ appId, requestId, approve });
                showAlert(`Pedido ${approve ? 'aprovado' : 'negado'} com sucesso.`, 'success');
            } catch (error) {
                console.error("Erro ao gerir o pedido:", error);
                showAlert(`Erro: ${error.message}`, 'error');
            }
        }

        async function handleSubmitJustification() {
            if (!justificationText) return;
            const justification = justificationText.value.trim();
            if (!justification) {
                showAlert('Por favor, forneça uma justificação.', 'error');
                return;
            }
            try {
                const requestAlertDeletion = httpsCallable(functions, 'requestAlertDeletion');
                await requestAlertDeletion({ appId, companyId: currentUser.companyId, companyName: currentUser.companyName, articleId: articleToDeleteInfo.id, articleTitle: articleToDeleteInfo.title, justification: justification });
                showAlert('Pedido de exclusão enviado com sucesso!', 'success');
                if (justificationModal) justificationModal.classList.add('hidden');
                articleToDeleteInfo = null;
            } catch (error) {
                console.error("Erro ao enviar o pedido:", error);
                showAlert(`Erro: ${error.message}`, 'error');
            }
        }

        async function renderSuperAdminReport() {
            if (!superAdminReportBody) return;
            superAdminReportBody.innerHTML = '<tr><td colspan="6" class="text-center py-4">Gerando relatório...</td></tr>';
            if (companySummaryChartInstance) {
                companySummaryChartInstance.destroy();
            }
            try {
                const generateReport = httpsCallable(functions, 'generateSuperAdminReport');
                const result = await generateReport({
                    appId,
                    startDate: reportStartDateInput.value || null,
                    endDate: reportEndDateInput.value || null
                });
                const reportData = result.data;
                superAdminReportBody.innerHTML = '';
                if (reportData.length === 0) {
                    superAdminReportBody.innerHTML = '<tr><td colspan="6" class="text-center py-4">Nenhum dado para exibir.</td></tr>';
                    if(document.getElementById('company-summary-chart')) document.getElementById('company-summary-chart').style.display = 'none';
                    return;
                }
                if(document.getElementById('company-summary-chart')) document.getElementById('company-summary-chart').style.display = 'block';
                reportData.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 company-report-row';
                    row.dataset.companyId = item.companyId;
                    row.dataset.companyName = item.companyName;
                    let sentimentClass = 'text-gray-600';
                    if (item.predominantSentiment === 'Positivo') sentimentClass = 'text-green-600 font-semibold';
                    if (item.predominantSentiment === 'Negativo') sentimentClass = 'text-red-600 font-semibold';
                    row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${item.companyName}</td><td class="px-6 py-4 whitespace-nowrap text-gray-500">${item.totalAlerts}</td><td class="px-6 py-4 whitespace-nowrap text-xs"><span class="text-green-600">P: ${item.sentimentPercentage.positive}%</span>, <span class="text-gray-600">N: ${item.sentimentPercentage.neutral}%</span>, <span class="text-red-600">Ng: ${item.sentimentPercentage.negative}%</span></td><td class="px-6 py-4 whitespace-nowrap ${sentimentClass}">${item.predominantSentiment}</td><td class="px-6 py-4 whitespace-nowrap text-gray-500">${item.topChannel}</td><td class="px-6 py-4 whitespace-nowrap text-gray-500">${item.topVehicle}</td>`;
                    superAdminReportBody.appendChild(row);
                });
                const chartLabels = reportData.map(d => d.companyName);
                const chartValues = reportData.map(d => d.totalAlerts);
                companySummaryChartInstance = createChart('company-summary-chart', companySummaryChartInstance, 'line', {
                    labels: chartLabels,
                    datasets: [{ label: 'Total de Alertas', data: chartValues, borderColor: '#4F46E5', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true, tension: 0.1, borderWidth: 2 }]
                }, { plugins: { legend: { display: false } } });
            } catch (error) {
                console.error("Erro ao gerar relatório:", error);
                superAdminReportBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Erro ao gerar relatório: ${error.message}</td></tr>`;
            }
        }

        // Funções do Relatório de Análise Crítica
        async function renderCriticalReportPage() {
            if (!criticalReportPage) return;
            try {
                if (criticalCompanySelect) {
                    criticalCompanySelect.innerHTML = '<option value="">Selecione uma empresa</option>';
                    const companiesSnapshot = await getDocs(query(collection(db, "artifacts", appId, "public/data/companies"), where("status", "==", "active")));
                    const companies = [];
                    companiesSnapshot.forEach(docSnap => {
                        const data = docSnap.data();
                        companies.push({ id: docSnap.id, name: data.name || 'Sem nome' });
                    });
                    // Ordenar empresas por nome em ordem alfabética
                    companies.sort((a, b) => a.name.localeCompare(b.name));
                    companies.forEach(company => {
                        const opt = document.createElement('option');
                        opt.value = company.id;
                        opt.textContent = company.name;
                        criticalCompanySelect.appendChild(opt);
                    });
                }
            } catch (e) { console.error('Erro ao carregar empresas para relatório crítico:', e); }
            if (criticalSummary) criticalSummary.innerHTML = 'Selecione a empresa e o período, depois clique em Gerar.';
            [criticalChannelChartInstance, criticalSpaceChartInstance, criticalSpaceQualChartInstance, criticalVehicleChartInstance, criticalValuationChartInstance, criticalDateChartInstance].forEach(inst => { if (inst) { try { inst.destroy(); } catch(_){} } });
        }

        async function handleGenerateCriticalReport() {
            if (!criticalCompanySelect) return;
            const companyId = criticalCompanySelect.value;
            const startDate = criticalStartDateInput && criticalStartDateInput.value ? criticalStartDateInput.value : null;
            const endDate = criticalEndDateInput && criticalEndDateInput.value ? criticalEndDateInput.value : null;
            if (!companyId) { showAlert('Selecione uma empresa.', 'error'); return; }
            if (criticalSummary) criticalSummary.innerHTML = 'Gerando relatório...';
            [criticalChannelChartInstance, criticalSpaceChartInstance, criticalSpaceQualChartInstance, criticalVehicleChartInstance, criticalValuationChartInstance, criticalDateChartInstance].forEach(inst => { if (inst) { try { inst.destroy(); } catch(_){} } });
            try {
                const generateCritical = httpsCallable(functions, 'generateCriticalReport');
                const result = await generateCritical({ appId, companyId, startDate, endDate });
                const data = result.data || {};
                const articles = Array.isArray(data.articles) ? data.articles : (Array.isArray(data) ? data : []);
                const channelCounts = data.channelCounts || {};
                const spaceCounts = data.spaceCounts || {};
                const mentionedEntities = data.mentionedEntities || {};
                const vehicleCounts = data.vehicleCounts || {};
                const valuation = data.valuation || {};
                const dateCounts = data.dateCounts || {};
                const keywordCounts = data.keywordCounts || {};
                const spontaneityCounts = data.spontaneityCounts || {};
                const mediaSpace = data.mediaSpace || {};
                const topChannel = data.topChannel || null;
                const topVehicle = data.topVehicle || null;
                if (!Object.keys(channelCounts).length && articles.length) {
                    articles.forEach(a => {
                        const ch = (a.channel || getChannelCategory(a?.source?.name || ''));
                channelCounts[ch] = (channelCounts[ch] || 0) + 1;
                        const veh = (a?.source?.name || 'Desconhecido');
                        vehicleCounts[veh] = (vehicleCounts[veh] || 0) + 1;
                        const pubDate = a?.publishedAt ? new Date(a.publishedAt) : null;
                        if (pubDate) {
                            const key = pubDate.toISOString().slice(0,10);
                            dateCounts[key] = (dateCounts[key] || 0) + 1;
                        }
                        const val = (a?.sentiment?.label || a?.valuation || 'Neutro');
                        valuation[val] = (valuation[val] || 0) + 1;
                    });
                }
                const total = articles.length || (data.totalAlerts || 0) || Object.values(channelCounts).reduce((s,v)=>s+v,0);
                if (criticalSummary) {
                    const topCh = topChannel || (Object.entries(channelCounts).sort((a,b)=>b[1]-a[1])[0]?.[0] || '-');
                    const topVeh = topVehicle || (Object.entries(vehicleCounts).sort((a,b)=>b[1]-a[1])[0]?.[0] || '-');
                    criticalSummary.innerHTML = `
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                            <div class="p-3 bg-white rounded shadow"><div class="text-sm text-gray-500">TOTAL DE NOTÍCIAS</div><div class="text-2xl font-bold">${total}</div></div>
                            <div class="p-3 bg-white rounded shadow"><div class="text-sm text-gray-500">Mídia com maior número de notícias</div><div class="text-lg font-semibold">${topCh}</div></div>
                            <div class="p-3 bg-white rounded shadow"><div class="text-sm text-gray-500">Fonte com maior número de notícias</div><div class="text-lg font-semibold">${topVeh}</div></div>
                        </div>
                    `;
                }
                const channelLabels = Object.keys(channelCounts);
                const channelValues = channelLabels.map(k => channelCounts[k]);
                criticalChannelChartInstance = createChart('critical-channel-chart', criticalChannelChartInstance, 'bar', { labels: channelLabels, datasets: [{ label: 'Distribuição por mídia', data: channelValues, backgroundColor: '#4F46E5', borderRadius: 6, borderSkipped: false }] }, { plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(context) { return context.dataset.label + ': ' + context.parsed.y; } } } }, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { display: true } } } });
                const spaceLabels = Object.keys(spaceCounts);
                const spaceValues = spaceLabels.map(k => spaceCounts[k]);
                if (spaceLabels.length) {
                    criticalSpaceChartInstance = createChart('critical-space-chart', criticalSpaceChartInstance, 'bar', { labels: spaceLabels, datasets: [{ label: 'Tipo de texto', data: spaceValues, backgroundColor: '#10B981', borderRadius: 6, borderSkipped: false }] }, { plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(context) { return context.dataset.label + ': ' + context.parsed.y; } } } }, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { display: true } } } });
                }
                const spaceQualLabels = Object.keys(spaceCounts);
                const spaceQualValues = spaceQualLabels.map(k => spaceCounts[k]);
                if (spaceQualLabels.length) {
                    criticalSpaceQualChartInstance = createChart('critical-space-qual-chart', criticalSpaceQualChartInstance, 'bar', { labels: spaceQualLabels, datasets: [{ label: 'Direta/Indireta', data: spaceQualValues, backgroundColor: '#F59E0B', borderRadius: 6, borderSkipped: false }] }, { plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(context) { return context.label + ': ' + context.parsed.y + ' alertas'; } } } }, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { display: true } } } });
                }
                const spontaneityLabels = Object.keys(spontaneityCounts);
                const spontaneityValues = spontaneityLabels.map(k => spontaneityCounts[k]);
                if (spontaneityLabels.length) {
                    criticalSpontaneityChartInstance = createChart('critical-spontaneity-chart', criticalSpontaneityChartInstance, 'bar', { labels: spontaneityLabels, datasets: [{ label: 'Mídia Provocada/Espontânea', data: spontaneityValues, backgroundColor: '#8B5CF6', borderRadius: 6, borderSkipped: false }] }, { plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(context) { return context.label + ': ' + context.parsed.y + ' artigos'; } } } }, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { display: true } } } });
                }
                const vehicleLabels = Object.keys(vehicleCounts).slice(0,10);
                const vehicleValues = vehicleLabels.map(k => vehicleCounts[k]);
                if (vehicleLabels.length) {
                    criticalVehicleChartInstance = createChart('critical-vehicle-chart', criticalVehicleChartInstance, 'bar', { labels: vehicleLabels, datasets: [{ label: 'Veículos (top 10)', data: vehicleValues, backgroundColor: '#EC4899', borderRadius: 6, borderSkipped: false }] }, { plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(context) { return context.dataset.label + ': ' + context.parsed.y; } } } }, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { display: true } } }, indexAxis: 'y' });
                }
                const valuationLabels = Object.keys(valuation);
                const valuationValues = valuationLabels.map(k => valuation[k]);
                if (valuationLabels.length) {
                    criticalValuationChartInstance = createChart('critical-valuation-chart', criticalValuationChartInstance, 'bar', { labels: valuationLabels, datasets: [{ label: 'Análise qualitativa', data: valuationValues, backgroundColor: ['#22C55E','#F59E0B','#EF4444','#6366F1','#0EA5E9'], borderRadius: 6, borderSkipped: false }] }, { plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(context) { return context.label + ': ' + context.parsed.y + ' artigos'; } } } }, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { display: true } } } });
                }
                const dateLabels = Object.keys(dateCounts).sort();
                const dateValues = dateLabels.map(k => dateCounts[k]);
                if (dateLabels.length) {
                    criticalDateChartInstance = createChart('critical-date-chart', criticalDateChartInstance, 'line', { labels: dateLabels, datasets: [{ label: 'Alertas/dia', data: dateValues, borderColor: '#0EA5E9', backgroundColor: 'rgba(14,165,233,0.1)', fill: true, tension: 0.1, borderWidth: 2 }] }, { plugins: { legend: { display: false } } });
                }
                const wordcloudEl = document.getElementById('critical-wordcloud');
                if (wordcloudEl) {
                    const entries = Object.entries(keywordCounts).sort((a,b)=>b[1]-a[1]).slice(0,50);
                    wordcloudEl.innerHTML = '';
                    entries.forEach(([word,count], idx) => {
                        const weight = Math.min(6, 1 + Math.log(count+1));
                        const span = document.createElement('span');
                        span.textContent = word;
                        span.className = `inline-block px-2 py-1 rounded ${idx<10? 'bg-indigo-50 text-indigo-700':'bg-gray-100 text-gray-700'}`;
                        span.style.fontSize = `${0.75 + weight * 0.25}rem`;
                        wordcloudEl.appendChild(span);
                    });
                }
                
                // Atualizar espaço ocupado na mídia
                const mediaSpaceEl = document.getElementById('critical-media-space');
                if (mediaSpaceEl) {
                    const { tvTime = 0, radioTime = 0, webSize = 0, youtubeTime = 0 } = mediaSpace;
                    mediaSpaceEl.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="p-4 bg-white rounded-lg shadow">
                                <div class="text-sm text-gray-500 mb-1">Tempo em TV</div>
                                <div class="text-xl font-bold text-blue-600">${tvTime.toFixed(1)} min</div>
                            </div>
                            <div class="p-4 bg-white rounded-lg shadow">
                                <div class="text-sm text-gray-500 mb-1">Tempo em Rádio</div>
                                <div class="text-xl font-bold text-green-600">${radioTime.toFixed(1)} min</div>
                            </div>
                            <div class="p-4 bg-white rounded-lg shadow">
                                <div class="text-sm text-gray-500 mb-1">Tamanho Web</div>
                                <div class="text-xl font-bold text-purple-600">${webSize.toFixed(1)} cm</div>
                            </div>
                            <div class="p-4 bg-white rounded-lg shadow">
                                <div class="text-sm text-gray-500 mb-1">Tempo YouTube</div>
                                <div class="text-xl font-bold text-red-600">${youtubeTime.toFixed(1)} min</div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao gerar relatório crítico:', error);
                if (criticalSummary) criticalSummary.innerHTML = `<span class="text-red-600">Erro: ${error.message}</span>`;
            }
        }

        // Função para renderizar a página de Monitoramento de Mídia
        async function renderMediaMonitoringPage() {
            const companySelect = document.getElementById('media-monitoring-company-select');
            const reportContent = document.getElementById('media-monitoring-report-content');
            const loadingMessage = document.getElementById('media-monitoring-loading');
            
            if (!companySelect || !reportContent) return;
            
            const companyId = companySelect.value;
            if (!companyId) {
                reportContent.innerHTML = '<p class="text-gray-500 text-center py-8">Selecione uma empresa para gerar o relatório.</p>';
                return;
            }
            
            // Mostrar mensagem de carregamento
            reportContent.innerHTML = '';
            if (loadingMessage) loadingMessage.style.display = 'block';
            
            try {
                // Buscar artigos das últimas 24 horas
                const getArticles = httpsCallable(functions, 'getArticles');
                const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
                
                const result = await getArticles({ 
                    appId, 
                    companyId, 
                    startDate: twentyFourHoursAgo,
                    limit: 1000
                });
                
                const articles = Array.isArray(result.data) ? result.data : [];
                
                // Classificar artigos por sentimento
                const positiveArticles = articles.filter(article => article.sentiment === 'positive');
                const negativeArticles = articles.filter(article => article.sentiment === 'negative');
                const neutralArticles = articles.filter(article => !article.sentiment || article.sentiment === 'neutral');
                
                // Gerar HTML básico do relatório
                reportContent.innerHTML = `
                    <div class="bg-white rounded-lg shadow p-6 mb-6">
                        <h3 class="text-xl font-bold mb-4 text-blue-800">DESTAQUES RÁPIDOS</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                <div class="text-sm text-green-600 mb-1">Positivas</div>
                                <div class="text-2xl font-bold text-green-700">${positiveArticles.length}</div>
                            </div>
                            <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                                <div class="text-sm text-red-600 mb-1">Negativas</div>
                                <div class="text-2xl font-bold text-red-700">${negativeArticles.length}</div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <div class="text-sm text-gray-600 mb-1">Neutras</div>
                                <div class="text-2xl font-bold text-gray-700">${neutralArticles.length}</div>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <div class="text-sm text-blue-600 mb-1">Total</div>
                                <div class="text-2xl font-bold text-blue-700">${articles.length}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-bold mb-4 text-blue-800">DISTRIBUIÇÃO POR SENTIMENTO</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <div class="text-3xl font-bold text-green-600">${((positiveArticles.length / articles.length) * 100 || 0).toFixed(1)}%</div>
                                <div class="text-sm text-gray-600">Positivas</div>
                            </div>
                            <div class="text-center">
                                <div class="text-3xl font-bold text-red-600">${((negativeArticles.length / articles.length) * 100 || 0).toFixed(1)}%</div>
                                <div class="text-sm text-gray-600">Negativas</div>
                            </div>
                            <div class="text-center">
                                <div class="text-3xl font-bold text-gray-600">${((neutralArticles.length / articles.length) * 100 || 0).toFixed(1)}%</div>
                                <div class="text-sm text-gray-600">Neutras</div>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Erro ao carregar monitoramento de mídia:', error);
                reportContent.innerHTML = '<p class="text-red-600 text-center py-8">Erro ao carregar o relatório. Tente novamente.</p>';
            } finally {
                if (loadingMessage) loadingMessage.style.display = 'none';
            }
        }

        // --- INICIALIZAÇÃO E OUVINTES DE EVENTOS --- 
        document.addEventListener('DOMContentLoaded', () => {
            pageSections = document.querySelectorAll('.page-section');
            navLoggedIn = document.getElementById('nav-logged-in');
            navInicio = document.getElementById('nav-inicio');
            navRelatorio = document.getElementById('nav-relatorio');
            navMapa = document.getElementById('nav-mapa');
            navPesquisa = document.getElementById('nav-pesquisa');
            navAtividade = document.getElementById('nav-atividade');
            navSuperAdmin = document.getElementById('nav-super-admin');
            navLogout = document.getElementById('nav-logout');
            navConfiguracoesAdmin = document.getElementById('nav-configuracoes-admin');
            globalAlert = document.getElementById('global-alert');
            loginPage = document.getElementById('login-page');
            dashboardPage = document.getElementById('dashboard-page');
            mapPage = document.getElementById('map-page');
            searchPage = document.getElementById('search-page');
            activityPage = document.getElementById('activity-page');
            superAdminPage = document.getElementById('super-admin-page');
            companyKeywordAdminPage = document.getElementById('company-keyword-admin-page');
            companySettingsAdminPage = document.getElementById('company-settings-admin-page');
            reportPage = document.getElementById('report-page');
            companyUserAdminPage = document.getElementById('company-user-admin-page');
            configuracoesAdminPage = document.getElementById('configuracoes-admin-page');
            loginForm = document.getElementById('login-form');
            dashboardTitle = document.getElementById('dashboard-title');
            currentDateTimeEl = document.getElementById('current-datetime');
            dashboardKeywordList = document.getElementById('dashboard-keyword-list');
            newsAlertsContainer = document.getElementById('news-alerts-container');
            newsAlerts = document.getElementById('news-alerts');
            alertDateFilter = document.getElementById('alert-date-filter');
            reportAccessToggle = document.getElementById('report-access-toggle');
            mapAccessToggle = document.getElementById('map-access-toggle');
            logoUploadInput = document.getElementById('logo-upload');
            headerLogoContainer = document.getElementById('header-logo-container');
            loginLogoContainer = document.getElementById('login-logo-container');
            filterContainer = document.getElementById('filter-container');
            searchInput = document.getElementById('search-input');
            searchResults = document.getElementById('search-results');
            companyForm = document.getElementById('company-form');
            companyList = document.getElementById('company-list');
            companySearchInput = document.getElementById('company-search-input');
            backToSuperAdminKwBtn = document.getElementById('back-to-super-admin-kw');
            backToSuperAdminSettingsBtn = document.getElementById('back-to-super-admin-settings');
            backToSuperAdminUsersBtn = document.getElementById('back-to-super-admin-users');
            companyKeywordAdminTitle = document.getElementById('company-keyword-admin-title');
            companySettingsAdminTitle = document.getElementById('company-settings-admin-title');
            companyUserAdminTitle = document.getElementById('company-user-admin-title');
            keywordForm = document.getElementById('keyword-form');
            keywordInput = document.getElementById('keyword-input');
            keywordIdInput = document.getElementById('keyword-id');
            adminKeywordList = document.getElementById('admin-keyword-list');
            userForm = document.getElementById('user-form');
            userInput = document.getElementById('user-input');
            userPasswordInput = document.getElementById('user-password-input');
            userIdInput = document.getElementById('user-id');
            adminUserList = document.getElementById('admin-user-list');
            notificationBell = document.getElementById('notification-bell-container');
            notificationBadge = document.getElementById('notification-badge');
            manualTriggerBtn = document.getElementById('manual-trigger-btn');
            deleteModal = document.getElementById('delete-modal');
            confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            companyNameToDeleteEl = document.getElementById('company-name-to-delete');
            newsScopeContainer = document.getElementById('news-scope-container');
            startDateInput = document.getElementById('start-date');
            endDateInput = document.getElementById('end-date');
            linkModal = document.getElementById('link-modal');
            accessLinkInput = document.getElementById('access-link-input');
            copyLinkBtn = document.getElementById('copy-link-btn');
            closeLinkModalBtn = document.getElementById('close-link-modal-btn');
            reportKeywordFilterContainer = document.getElementById('report-keyword-filter-container');
            stateSelectContainer = document.getElementById('state-select-container');
            stateSelect = document.getElementById('state-select');
            captureChannelsContainer = document.getElementById('capture-channels-container');
            changePasswordForm = document.getElementById('change-password-form');
            apiKeyNewsApiInput = document.getElementById('apiKeyNewsApi');
            apiKeyFirebaseNewsInput = document.getElementById('apiKeyFirebaseNews');
            apiKeyGoogleMapsInput = document.getElementById('apiKeyGoogleMaps');
            apiKeyGNewsInput1 = document.getElementById('apiKeyGNews1');
            apiKeyGNewsInput2 = document.getElementById('apiKeyGNews2');
            apiKeyGNewsInput3 = document.getElementById('apiKeyGNews3');
            apiKeyGNewsInput4 = document.getElementById('apiKeyGNews4');
            apiKeyYoutubeInput = document.getElementById('apiKeyYoutube');
            apiKeyBloggerInput = document.getElementById('apiKeyBlogger');
            apiKeyVisionInput = document.getElementById('apiKeyVision');
            const visionEnabledToggle = document.getElementById('visionEnabled');
            const visionRelevantOnlyToggle = document.getElementById('visionRelevantOnly');
            const visionLogoDetectionToggle = document.getElementById('visionLogoDetection');
            const visionOcrTextToggle = document.getElementById('visionOcrText');
            apiKeyVideoIntelligenceInput = document.getElementById('apiKeyVideoIntelligence');
            apiKeySpeechToTextInput = document.getElementById('apiKeySpeechToText');
            bloggerIdInput = document.getElementById('bloggerId');
        rssUrlInput = document.getElementById('rssUrl');
         rssFrequencyInput = document.getElementById('rssFrequencyMinutes');
         gnewsFrequencyInput = document.getElementById('gnewsFrequencyHours');
         // Inicializar lastValue para proteger contra apagamentos por valores vazios
         if (rssFrequencyInput) { rssFrequencyInput.dataset.lastValue = rssFrequencyInput.value || ''; }
         if (gnewsFrequencyInput) { gnewsFrequencyInput.dataset.lastValue = gnewsFrequencyInput.value || ''; }
         radioSourcesInput = document.getElementById('radioSources');
         tvSourcesInput = document.getElementById('tvSources');
         youtubeChannelsInput = document.getElementById('youtubeChannels');
        let youtubeChannelNamesInput = document.getElementById('youtubeChannelNames');
youtubeChannelsFrequencyInput = document.getElementById('youtubeChannelsFrequencyMinutes');
youtubeFrequencyInput = document.getElementById('youtubeFrequencyHours');
youtubeFrequencyTimeInput = document.getElementById('youtubeFrequencyTime');
let fetchWindowStartInput, fetchWindowEndInput;
fetchWindowStartInput = document.getElementById('fetchWindowStart');
fetchWindowEndInput = document.getElementById('fetchWindowEnd');
            fetchOnlyNewToggle = document.getElementById('fetch-only-new-toggle');
            changePasswordPage = document.getElementById('change-password-page');
            globalKeysPage = document.getElementById('global-keys-page');
            globalSourcesPage = document.getElementById('global-sources-page');
            globalRadioSourcesPage = document.getElementById('global-radio-sources-page');
            globalTvSourcesPage = document.getElementById('global-tv-sources-page');
            btnChangePassword = document.getElementById('btn-change-password');
            btnGlobalKeys = document.getElementById('btn-global-keys');
            btnNewsSources = document.getElementById('btn-news-sources');
            btnRadioSources = document.getElementById('btn-radio-sources');
            btnTvSources = document.getElementById('btn-tv-sources');
            btnFixArticles = document.getElementById('btn-fix-articles');
            backToAdminConfig1 = document.getElementById('back-to-admin-config-1');
            backToAdminConfig2 = document.getElementById('back-to-admin-config-2');
            backToAdminConfig3 = document.getElementById('back-to-admin-config-3');
            backToAdminConfig5 = document.getElementById('back-to-admin-config-5');
            backToAdminConfig7 = document.getElementById('back-to-admin-config-7');
            showAllAlertsBtn = document.getElementById('show-all-alerts-btn');
            deletionAccessToggle = document.getElementById('deletion-access-toggle');
            justificationModal = document.getElementById('justification-modal');
            justificationText = document.getElementById('justification-text');
            submitJustificationBtn = document.getElementById('submit-justification-btn');
            cancelJustificationBtn = document.getElementById('cancel-justification-btn');
            btnManualAlert = document.getElementById('btn-manual-alert');
            btnDeletionRequests = document.getElementById('btn-deletion-requests');
            btnSuperAdminReport = document.getElementById('btn-super-admin-report');
            const btnCriticalReport = document.getElementById('btn-critical-report');
            manualAlertPage = document.getElementById('manual-alert-page');
            deletionRequestsPage = document.getElementById('deletion-requests-page');
            superAdminReportPage = document.getElementById('super-admin-report-page');
            backToDashboard1 = document.getElementById('back-to-dashboard-1');
            backToDashboard2 = document.getElementById('back-to-dashboard-2');
            backToDashboard3 = document.getElementById('back-to-dashboard-3');
            manualAlertForm = document.getElementById('manual-alert-form');
            deletionRequestsList = document.getElementById('deletion-requests-list');
            superAdminReportBody = document.getElementById('super-admin-report-body');
            deletionRequestsBadge = document.getElementById('deletion-requests-badge');
            pendingAlertsPage = document.getElementById('super-admin-queue-page');
            pendingAlertsList = document.getElementById('super-admin-pending-alerts-list');
            btnPendingAlerts = document.getElementById('btn-pending-alerts');
            backToDashboard4 = document.getElementById('back-to-dashboard-4');
            confirmDeleteKeywordModal = document.getElementById('confirm-delete-keyword-modal');
            confirmDeleteKeywordBtn = document.getElementById('confirm-delete-keyword-btn');
            cancelDeleteKeywordBtn = document.getElementById('cancel-delete-keyword-btn');
            keywordToDeleteNameEl = document.getElementById('keyword-to-delete-name');
            transferKeywordModal = document.getElementById('transfer-keyword-modal');
            transferCompanySelect = document.getElementById('transfer-company-select');
            confirmTransferKeywordBtn = document.getElementById('confirm-transfer-keyword-btn');
            cancelTransferKeywordBtn = document.getElementById('cancel-transfer-keyword-btn');
            keywordToTransferNameEl = document.getElementById('keyword-to-transfer-name');
            globalLogoPage = document.getElementById('global-logo-page');
            btnGlobalLogo = document.getElementById('btn-global-logo');

            backToAdminConfig4 = document.getElementById('back-to-admin-config-4');
            globalLogoUpload = document.getElementById('global-logo-upload');
            globalLogoArea = document.getElementById('global-logo-area');
            logoLink = document.getElementById('logo-link');
            articleDetailPage = document.getElementById('article-detail-page');
            backFromDetail = document.getElementById('back-from-detail');
            detailTitle = document.getElementById('detail-title');
            detailMeta = document.getElementById('detail-meta');
            detailContent = document.getElementById('detail-content');
            detailAiInsights = document.getElementById('detail-ai-insights');
            shareWhatsappBtn = document.getElementById('share-whatsapp-btn');
            shareEmailBtn = document.getElementById('share-email-btn');
            printBtn = document.getElementById('print-btn');
            shareButtonsContainer = document.getElementById('share-buttons-container');
            companyKeywordReportPage = document.getElementById('company-keyword-report-page');
            backToSuperAdminReportBtn = document.getElementById('back-to-super-admin-report');
            companyKeywordReportTitle = document.getElementById('company-keyword-report-title');
            mapStartDateInput = document.getElementById('map-start-date');
            mapEndDateInput = document.getElementById('map-end-date');
            mapFilterBtn = document.getElementById('map-filter-btn');
            reportStartDateInput = document.getElementById('report-start-date');
            reportEndDateInput = document.getElementById('report-end-date');
            criticalReportPage = document.getElementById('critical-report-page');
            backToSuperAdminCriticalBtn = document.getElementById('back-to-super-admin-critical');
            criticalCompanySelect = document.getElementById('critical-company-select');
            criticalStartDateInput = document.getElementById('critical-start-date');
            criticalEndDateInput = document.getElementById('critical-end-date');
            criticalGenerateBtn = document.getElementById('critical-generate-btn');
            criticalSummary = document.getElementById('critical-summary');
            mediaMonitoringPage = document.getElementById('media-monitoring-page');

            const states = { "AC": "Acre", "AL": "Alagoas", "AP": "Amapá", "AM": "Amazonas", "BA": "Bahia", "CE": "Ceará", "DF": "Distrito Federal", "ES": "Espírito Santo", "GO": "Goiás", "MA": "Maranhão", "MT": "Mato Grosso", "MS": "Mato Grosso do Sul", "MG": "Minas Gerais", "PA": "Pará", "PB": "Paraíba", "PR": "Paraná", "PE": "Pernambuco", "PI": "Piauí", "RJ": "Rio de Janeiro", "RN": "Rio Grande do Norte", "RS": "Rio Grande do Sul", "RO": "Rondônia", "RR": "Roraima", "SC": "Santa Catarina", "SP": "São Paulo", "SE": "Sergipe", "TO": "Tocantins" };
            for (const [uf, name] of Object.entries(states)) {
                const option = document.createElement('option');
                option.value = uf;
                option.textContent = name;
                if (stateSelect) {
                    stateSelect.appendChild(option);
                }
            }

            // Função para corrigir todos os artigos
            async function fixAllArticles() {
                if (!confirm('Tem certeza que deseja corrigir os nomes das fontes e canais de todos os artigos? Esta operação pode demorar alguns minutos.')) {
                    return;
                }

                const btnFixArticles = document.getElementById('btn-fix-articles');
                const originalText = btnFixArticles.innerHTML;
                btnFixArticles.innerHTML = '<h3 class="text-lg sm:text-xl font-semibold">Corrigindo...</h3>';
                btnFixArticles.disabled = true;

                try {
                    // Chamar a função fixAllCompaniesArticles do Firebase Functions
                    const fixAllCompaniesArticles = httpsCallable(functions, 'fixAllCompaniesArticles', { timeout: 600000 });
                    const result = await fixAllCompaniesArticles({ appId });
                    
                    showAlert(`Correção concluída com sucesso! ${result.data.totalFixed || 0} artigos foram corrigidos.`, 'success');
                } catch (error) {
                    console.error("Erro ao corrigir artigos:", error);
                    showAlert(`Erro ao corrigir artigos: ${error.message}`, 'error');
                } finally {
                    btnFixArticles.innerHTML = originalText;
                    btnFixArticles.disabled = false;
                }
            }

            if (btnFixArticles) btnFixArticles.addEventListener('click', fixAllArticles);

            (async () => {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const savedUser = getStorage('clipping_currentUser', null);
                        if (savedUser) {
                            currentUser = savedUser;
                            if (currentUser && !currentUser.isSuperAdmin && currentUser.companyId) { try { await loadCompanyCaptureChannels(currentUser.companyId); } catch (e) { console.warn('loadCompanyCaptureChannels failed', e); } } else { companyCaptureChannels = ['Sites','YouTube','Revistas','Rádios','TV']; }
                            updateView('dashboard');
                        } else {
                            currentUser = null;
                            updateView('login');
                        }
                        // Executar diagnóstico/robô somente para Super Admin, evitando abrir a Fila em páginas de empresas
                        if (!window.__ranDiagnostics && (currentUser && currentUser.isSuperAdmin)) { window.__ranDiagnostics = true; runDiagnosticsAndManual(); }
                    } else {
                        currentUser = null;
                        updateView('login');
                    }
                });

                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Firebase anonymous auth error:", error);
                    showAlert("Erro de autenticação. Tente recarregar a página.", "error");
                }
            })();

            if (logoLink) logoLink.addEventListener('click', (e) => { e.preventDefault(); if (currentUser) updateView('dashboard'); });
            if (loginForm) loginForm.addEventListener('submit', handleLogin);
            if (navInicio) navInicio.addEventListener('click', (e) => { e.preventDefault(); updateView('dashboard'); });
            if (navRelatorio) navRelatorio.addEventListener('click', (e) => { e.preventDefault(); updateView('report'); });
            if (navMapa) navMapa.addEventListener('click', (e) => { e.preventDefault(); updateView('map'); });
            if (navPesquisa) navPesquisa.addEventListener('click', (e) => { e.preventDefault(); updateView('search'); });
            if (navAtividade) navAtividade.addEventListener('click', (e) => { e.preventDefault(); updateView('activity'); });
            if (navSuperAdmin) navSuperAdmin.addEventListener('click', (e) => { e.preventDefault(); updateView('super-admin'); });
            if (navConfiguracoesAdmin) navConfiguracoesAdmin.addEventListener('click', (e) => { e.preventDefault(); updateView('configuracoes-admin'); });
            if (navLogout) navLogout.addEventListener('click', (e) => { e.preventDefault(); handleLogout(); });
            if (manualTriggerBtn) manualTriggerBtn.addEventListener('click', handleManualTrigger);
            if (companyForm) companyForm.addEventListener('submit', handleCompanySubmit);
            if (companyList) companyList.addEventListener('click', handleCompanyActions);
            if (confirmDeleteBtn) confirmDeleteBtn.addEventListener('click', handleConfirmDelete);
            if (cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', () => { if (deleteModal) deleteModal.classList.add('hidden') });
            if (closeLinkModalBtn) closeLinkModalBtn.addEventListener('click', () => { if (linkModal) linkModal.classList.add('hidden') });
            if (copyLinkBtn) copyLinkBtn.addEventListener('click', () => { if (accessLinkInput) accessLinkInput.select(); document.execCommand('copy'); showAlert('Link copiado para a área de transferência!', 'success'); });
            if (newsScopeContainer) newsScopeContainer.addEventListener('change', (e) => { handleSettingsChange(e); handleScopeChange(); });
            if (apiKeyNewsApiInput) apiKeyNewsApiInput.addEventListener('change', handleGlobalKeyChange);
            if (apiKeyFirebaseNewsInput) apiKeyFirebaseNewsInput.addEventListener('change', handleGlobalKeyChange);
            if (apiKeyGoogleMapsInput) apiKeyGoogleMapsInput.addEventListener('change', handleGlobalKeyChange);
            if (apiKeyGNewsInput1) apiKeyGNewsInput1.addEventListener('change', handleGlobalKeyChange);
            if (apiKeyGNewsInput2) apiKeyGNewsInput2.addEventListener('change', handleGlobalKeyChange);
            if (apiKeyGNewsInput3) apiKeyGNewsInput3.addEventListener('change', handleGlobalKeyChange);
            if (apiKeyGNewsInput4) apiKeyGNewsInput4.addEventListener('change', handleGlobalKeyChange);
            if (apiKeyYoutubeInput) apiKeyYoutubeInput.addEventListener('change', handleGlobalKeyChange);
            if (apiKeyBloggerInput) apiKeyBloggerInput.addEventListener('change', handleGlobalKeyChange);
            if (apiKeyVisionInput) apiKeyVisionInput.addEventListener('change', handleGlobalKeyChange);
if (visionEnabledToggle) visionEnabledToggle.addEventListener('change', handleGlobalKeyChange);
if (visionRelevantOnlyToggle) visionRelevantOnlyToggle.addEventListener('change', handleGlobalKeyChange);
if (visionLogoDetectionToggle) visionLogoDetectionToggle.addEventListener('change', handleGlobalKeyChange);
if (visionOcrTextToggle) visionOcrTextToggle.addEventListener('change', handleGlobalKeyChange);
if (apiKeyVideoIntelligenceInput) apiKeyVideoIntelligenceInput.addEventListener('change', handleGlobalKeyChange);
            if (apiKeySpeechToTextInput) apiKeySpeechToTextInput.addEventListener('change', handleGlobalKeyChange);
            if (bloggerIdInput) bloggerIdInput.addEventListener('change', handleGlobalSourceChange);
            if (rssUrlInput) rssUrlInput.addEventListener('change', handleGlobalSourceChange);
            if (rssFrequencyInput) rssFrequencyInput.addEventListener('change', (e) => {
                const settingsRef = doc(db, "artifacts", appId, "public", "data", "settings", "global");
                const value = (e.target.value || '').toString().trim();
                if (value === '' || isNaN(Number(value)) || Number(value) <= 0) {
                    // Restaura último valor conhecido em memória para não apagar
                    if (typeof e.target.dataset.lastValue !== 'undefined') {
                        e.target.value = e.target.dataset.lastValue;
                    }
                    showAlert('Valor inválido. Mantida a última frequência de RSS.', 'error');
                    return;
                }
                e.target.dataset.lastValue = value;
                setDoc(settingsRef, { rssFrequencyMinutes: Number(value) }, { merge: true })
                    .then(() => showAlert('Frequência de RSS guardada!', 'success'))
                    .catch((error) => console.error('Erro ao guardar a frequência de RSS:', error));
            });
// salvar enquanto digita (debounce)
let __rssFrequencyDebounceTimer;
if (rssFrequencyInput) rssFrequencyInput.addEventListener('input', () => {
                clearTimeout(__rssFrequencyDebounceTimer);
                __rssFrequencyDebounceTimer = setTimeout(() => {
                    const ev = new Event('change');
                    rssFrequencyInput.dispatchEvent(ev);
                }, 800);
            });
            if (gnewsFrequencyInput) gnewsFrequencyInput.addEventListener('change', (e) => {
                const settingsRef = doc(db, "artifacts", appId, "public", "data", "settings", "global");
                const value = (e.target.value || '').toString().trim();
                if (value === '' || isNaN(Number(value)) || Number(value) <= 0) {
                    if (typeof e.target.dataset.lastValue !== 'undefined') {
                        e.target.value = e.target.dataset.lastValue;
                    }
                    showAlert('Valor inválido. Mantida a última frequência do GNews.', 'error');
                    return;
                }
                e.target.dataset.lastValue = value;
                setDoc(settingsRef, { gnewsFrequencyHours: Number(value) }, { merge: true })
                    .then(() => showAlert('Frequência do GNews guardada!', 'success'))
                    .catch((error) => console.error('Erro ao guardar a frequência do GNews:', error));
            });
// salvar enquanto digita (debounce)
let __gnewsFrequencyDebounceTimer;
if (gnewsFrequencyInput) gnewsFrequencyInput.addEventListener('input', () => {
                clearTimeout(__gnewsFrequencyDebounceTimer);
                __gnewsFrequencyDebounceTimer = setTimeout(() => {
                    const ev = new Event('change');
                    gnewsFrequencyInput.dispatchEvent(ev);
                }, 800);
            });
            if (radioSourcesInput) radioSourcesInput.addEventListener('change', (e) => { handleGlobalSourceChange(e); });
            // salvar enquanto digita (debounce)
            let __radioSourcesDebounceTimer;
            if (radioSourcesInput) radioSourcesInput.addEventListener('input', () => {
                clearTimeout(__radioSourcesDebounceTimer);
                __radioSourcesDebounceTimer = setTimeout(() => {
                    const ev = new Event('change');
                    radioSourcesInput.dispatchEvent(ev);
                }, 800);
            });
            if (youtubeChannelsInput) { youtubeChannelsInput.addEventListener('change', handleGlobalSourceChange); }
            if (youtubeChannelNamesInput) { youtubeChannelNamesInput.addEventListener('change', handleGlobalSourceChange); }
            { const el = document.getElementById('tvSources'); if (el) el.addEventListener('change', (e) => { handleGlobalSourceChange(e); if (typeof renderTvIntervalsList === 'function') renderTvIntervalsList(); }); }
if (youtubeChannelsFrequencyInput) youtubeChannelsFrequencyInput.addEventListener('change', (e) => {
                const settingsRef = doc(db, "artifacts", appId, "public", "data", "settings", "global");
                const raw = (e.target.value || '').toString().trim();
                const value = Number(raw);
                if (raw === '' || isNaN(value) || value <= 0) {
                    if (typeof e.target.dataset.lastValue !== 'undefined') {
                        e.target.value = e.target.dataset.lastValue;
                    }
                    showAlert('Valor inválido. Mantida a última frequência dos canais do YouTube.', 'error');
                    return;
                }
                e.target.dataset.lastValue = String(value);
                setDoc(settingsRef, { youtubeChannelsFrequencyMinutes: value }, { merge: true })
                    .then(() => showAlert('Frequência dos canais do YouTube guardada!', 'success'))
                    .catch((error) => console.error('Erro ao guardar a frequência dos canais do YouTube:', error));
            });
// salvar enquanto digita (debounce)
let __ytChannelsFrequencyDebounceTimer;
if (youtubeChannelsFrequencyInput) youtubeChannelsFrequencyInput.addEventListener('input', () => {
                clearTimeout(__ytChannelsFrequencyDebounceTimer);
                __ytChannelsFrequencyDebounceTimer = setTimeout(() => {
                    const ev = new Event('change');
                    youtubeChannelsFrequencyInput.dispatchEvent(ev);
                }, 800);
            });
if (youtubeFrequencyInput) youtubeFrequencyInput.addEventListener('change', (e) => {
                const settingsRef = doc(db, "artifacts", appId, "public", "data", "settings", "global");
                const raw = (e.target.value || '').toString().trim();
                const value = Number(raw);
                if (raw === '' || isNaN(value) || value <= 0) {
                    if (typeof e.target.dataset.lastValue !== 'undefined') {
                        e.target.value = e.target.dataset.lastValue;
                    }
                    showAlert('Valor inválido. Mantida a última frequência do YouTube.', 'error');
                    return;
                }
                e.target.dataset.lastValue = String(value);
                setDoc(settingsRef, { youtubeFrequencyHours: value }, { merge: true })
                    .then(() => showAlert('Frequência do YouTube guardada!', 'success'))
                    .catch((error) => console.error('Erro ao guardar a frequência do YouTube:', error));
            });
// salvar enquanto digita (debounce)
let __ytSearchFrequencyDebounceTimer;
if (youtubeFrequencyInput) youtubeFrequencyInput.addEventListener('input', () => {
                clearTimeout(__ytSearchFrequencyDebounceTimer);
                __ytSearchFrequencyDebounceTimer = setTimeout(() => {
                    const ev = new Event('change');
                    youtubeFrequencyInput.dispatchEvent(ev);
                }, 800);
            });
            if (youtubeFrequencyTimeInput) youtubeFrequencyTimeInput.addEventListener('change', (e) => {
                const settingsRef = doc(db, "artifacts", appId, "public", "data", "settings", "global");
                const raw = (e.target.value || '').toString().trim();
                if (raw && !/^\d{2}:\d{2}$/.test(raw)) {
                    if (typeof e.target.dataset.lastValue !== 'undefined') {
                        e.target.value = e.target.dataset.lastValue;
                    }
                    showAlert('Horário inválido. Use o formato HH:MM.', 'error');
                    return;
                }
                e.target.dataset.lastValue = raw;
                setDoc(settingsRef, { youtubeFrequencyTime: raw }, { merge: true })
                    .then(() => showAlert('Horário da busca do YouTube guardado!', 'success'))
                    .catch((error) => console.error('Erro ao guardar o horário do YouTube:', error));
            });
            // Janela permitida para buscar notícias (início)
            if (fetchWindowStartInput) fetchWindowStartInput.addEventListener('change', (e) => {
                const settingsRef = doc(db, "artifacts", appId, "public", "data", "settings", "global");
                const raw = (e.target.value || '').toString().trim();
                if (raw && !/^\d{2}:\d{2}$/.test(raw)) {
                    if (typeof e.target.dataset.lastValue !== 'undefined') {
                        e.target.value = e.target.dataset.lastValue;
                    }
                    showAlert('Horário inválido. Use o formato HH:MM.', 'error');
                    return;
                }
                e.target.dataset.lastValue = raw;
                setDoc(settingsRef, { fetchWindowStart: raw }, { merge: true })
                    .then(() => showAlert('Janela de busca (início) guardada!', 'success'))
                    .catch((error) => console.error('Erro ao guardar janela (início):', error));
            });
            // Janela permitida para buscar notícias (fim)
            if (fetchWindowEndInput) fetchWindowEndInput.addEventListener('change', (e) => {
                const settingsRef = doc(db, "artifacts", appId, "public", "data", "settings", "global");
                const raw = (e.target.value || '').toString().trim();
                if (raw && !/^\d{2}:\d{2}$/.test(raw)) {
                    if (typeof e.target.dataset.lastValue !== 'undefined') {
                        e.target.value = e.target.dataset.lastValue;
                    }
                    showAlert('Horário inválido. Use o formato HH:MM.', 'error');
                    return;
                }
                e.target.dataset.lastValue = raw;
                setDoc(settingsRef, { fetchWindowEnd: raw }, { merge: true })
                    .then(() => showAlert('Janela de busca (fim) guardada!', 'success'))
                    .catch((error) => console.error('Erro ao guardar janela (fim):', error));
            });
            // Debounce enquanto digita
            let __fetchWindowStartDebounceTimer;
            if (fetchWindowStartInput) fetchWindowStartInput.addEventListener('input', () => {
                clearTimeout(__fetchWindowStartDebounceTimer);
                __fetchWindowStartDebounceTimer = setTimeout(() => {
                    const ev = new Event('change');
                    fetchWindowStartInput.dispatchEvent(ev);
                }, 800);
            });
            let __fetchWindowEndDebounceTimer;
            if (fetchWindowEndInput) fetchWindowEndInput.addEventListener('input', () => {
                clearTimeout(__fetchWindowEndDebounceTimer);
                __fetchWindowEndDebounceTimer = setTimeout(() => {
                    const ev = new Event('change');
                    fetchWindowEndInput.dispatchEvent(ev);
                }, 800);
            });
            if (reportAccessToggle) reportAccessToggle.addEventListener('change', handleSettingsChange);
            if (mapAccessToggle) mapAccessToggle.addEventListener('change', handleSettingsChange);
            if (fetchOnlyNewToggle) fetchOnlyNewToggle.addEventListener('change', handleSettingsChange);
            if (deletionAccessToggle) deletionAccessToggle.addEventListener('change', handleSettingsChange);
            if (stateSelect) stateSelect.addEventListener('change', handleSettingsChange);
            if (captureChannelsContainer) captureChannelsContainer.addEventListener('change', handleSettingsChange);
            if (keywordForm) keywordForm.addEventListener('submit', handleKeywordSubmit);
            if (adminKeywordList) adminKeywordList.addEventListener('click', handleKeywordActions);
            if (confirmDeleteKeywordBtn) confirmDeleteKeywordBtn.addEventListener('click', handleConfirmDeleteKeyword);
        if (cancelDeleteKeywordBtn) cancelDeleteKeywordBtn.addEventListener('click', () => { if (confirmDeleteKeywordModal) confirmDeleteKeywordModal.classList.add('hidden') });
        if (confirmTransferKeywordBtn) confirmTransferKeywordBtn.addEventListener('click', handleConfirmTransferKeyword);
        if (cancelTransferKeywordBtn) cancelTransferKeywordBtn.addEventListener('click', () => { if (transferKeywordModal) transferKeywordModal.classList.add('hidden') });
            if (userForm) userForm.addEventListener('submit', handleUserSubmit);
            if (adminUserList) adminUserList.addEventListener('click', handleUserActions);
            if (searchInput) searchInput.addEventListener('input', handleSearch);
            if (filterContainer) {
                filterContainer.addEventListener('click', (e) => {
                    const target = e.target.closest('.filter-btn');
                    if (target) {
                        const wasActive = target.classList.contains('bg-indigo-500');
                        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('bg-indigo-500', 'text-white'));
                        if (!wasActive) {
                            target.classList.add('bg-indigo-500', 'text-white');
                        }
                        handleSearch();
                    }
                });
            }
            if (notificationBell) notificationBell.addEventListener('click', showOnlyNewAlerts);
            if (showAllAlertsBtn) showAllAlertsBtn.addEventListener('click', populateInitialAlerts);
            if (backToSuperAdminKwBtn) backToSuperAdminKwBtn.addEventListener('click', () => updateView('super-admin'));
            if (backToSuperAdminSettingsBtn) backToSuperAdminSettingsBtn.addEventListener('click', () => updateView('super-admin'));
            if (backToSuperAdminUsersBtn) backToSuperAdminUsersBtn.addEventListener('click', () => updateView('super-admin'));
            if (dashboardKeywordList) dashboardKeywordList.addEventListener('click', handleDashboardKeywordFilter);
            if (newsAlerts) newsAlerts.addEventListener('click', handleAlertCardActions);
            if (searchResults) searchResults.addEventListener('click', handleAlertCardActions);
            if (articleDetailPage) articleDetailPage.addEventListener('click', handleAlertCardActions);
            if (alertDateFilter) alertDateFilter.addEventListener('change', filterAlertsByDate);
            if (changePasswordForm) changePasswordForm.addEventListener('submit', handleChangePassword);
            if (btnChangePassword) btnChangePassword.addEventListener('click', () => updateView('change-password'));
            if (btnGlobalKeys) btnGlobalKeys.addEventListener('click', () => updateView('global-keys'));
            if (btnNewsSources) btnNewsSources.addEventListener('click', () => updateView('global-sources'));
            if (btnRadioSources) btnRadioSources.addEventListener('click', () => updateView('global-radio-sources'));
        if (btnTvSources) btnTvSources.addEventListener('click', () => updateView('global-tv-sources'));

        // Event listeners para os botões de status das TVs
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('status-btn')) {
                const status = e.target.dataset.status;
                filterTvSourcesByStatus(status);
            }
        });
            if (btnGlobalLogo) btnGlobalLogo.addEventListener('click', () => updateView('global-logo'));

            if (backToAdminConfig1) backToAdminConfig1.addEventListener('click', () => updateView('configuracoes-admin'));
            if (backToAdminConfig2) backToAdminConfig2.addEventListener('click', () => updateView('configuracoes-admin'));
            if (backToAdminConfig3) backToAdminConfig3.addEventListener('click', () => updateView('configuracoes-admin'));
            if (backToAdminConfig4) backToAdminConfig4.addEventListener('click', () => updateView('configuracoes-admin'));
            if (backToAdminConfig5) backToAdminConfig5.addEventListener('click', () => updateView('configuracoes-admin'));
            const btnUsuarioAdmin = document.getElementById('btn-usuario-admin');
            const usuarioAdminPage = document.getElementById('usuario-admin-page');
            const backToAdminConfig6 = document.getElementById('back-to-admin-config-6');
            if (btnUsuarioAdmin) btnUsuarioAdmin.addEventListener('click', () => updateView('usuario-admin'));
            if (backToAdminConfig6) backToAdminConfig6.addEventListener('click', () => updateView('configuracoes-admin'));
            const usuarioAdminForm = document.getElementById('usuario-admin-form');
            if (usuarioAdminForm) usuarioAdminForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const usernameEl = document.getElementById('usuario-admin-username');
                const passwordEl = document.getElementById('usuario-admin-password');
                const listEl = document.getElementById('usuario-admin-companies-list');
                if (!usernameEl || !passwordEl || !listEl) return;
                const username = usernameEl.value.trim();
                const password = passwordEl.value.trim();
                const allowedCompanies = Array.from(listEl.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value).filter(Boolean);
                if (!username || !password) { showAlert('Usuário e palavra-passe são obrigatórios.', 'error'); return; }
                if (allowedCompanies.length === 0) { showAlert('Selecione ao menos uma empresa ativa.', 'error'); return; }
                try {
                    const existingQ = query(collection(db, "artifacts", appId, "public/data/restrictedUsers"), where("username", "==", username));
                    const existingSnap = await getDocs(existingQ);
                    if (!existingSnap.empty) { showAlert('Este usuário restrito já existe.', 'error'); return; }
                    await addDoc(collection(db, "artifacts", appId, "public/data/restrictedUsers"), { username, password, allowedCompanies });
                    showAlert('Usuário restrito criado com sucesso!', 'success');
                    usuarioAdminForm.reset();
                    Array.from(listEl.querySelectorAll('input[type="checkbox"]')).forEach(cb => cb.checked = false);
                    renderRestrictedUsers();
                } catch (error) {
                    console.error('Erro ao criar usuário restrito:', error);
                    showAlert('Erro ao criar usuário restrito.', 'error');
                }
            });
            const restrictedUserList = document.getElementById('restricted-user-list');
             if (restrictedUserList) {
                 restrictedUserList.addEventListener('click', handleRestrictedUserActions);
                 restrictedUserList.addEventListener('change', handleRestrictedUserActions);
             }
            if (logoUploadInput) logoUploadInput.addEventListener('change', handleLogoUpload);
            if (globalLogoUpload) globalLogoUpload.addEventListener('change', handleGlobalLogoUpload);
            if (btnManualAlert) btnManualAlert.addEventListener('click', () => updateView('manual-alert'));
            if (btnDeletionRequests) btnDeletionRequests.addEventListener('click', () => updateView('deletion-requests'));
            if (btnSuperAdminReport) btnSuperAdminReport.addEventListener('click', () => updateView('super-admin-report'));
            if (btnCriticalReport) btnCriticalReport.addEventListener('click', () => updateView('critical-report'));
            
            // Event listener para o botão de Monitoramento de Mídia
            const btnMediaMonitoring = document.getElementById('btn-media-monitoring');
            if (btnMediaMonitoring) btnMediaMonitoring.addEventListener('click', () => updateView('media-monitoring'));
            if (backToSuperAdminCriticalBtn) backToSuperAdminCriticalBtn.addEventListener('click', () => updateView('super-admin-report'));
            if (criticalGenerateBtn) criticalGenerateBtn.addEventListener('click', handleGenerateCriticalReport);
            if (backToDashboard1) backToDashboard1.addEventListener('click', () => updateView('dashboard'));
            if (backToDashboard2) backToDashboard2.addEventListener('click', () => updateView('dashboard'));
            if (backToDashboard3) backToDashboard3.addEventListener('click', () => updateView('dashboard'));
            if (backFromDetail) backFromDetail.addEventListener('click', () => {
                const lastView = 'dashboard';
                updateView(lastView);
            });
            if (backToSuperAdminReportBtn) backToSuperAdminReportBtn.addEventListener('click', () => updateView('super-admin-report'));
            if (manualAlertForm) manualAlertForm.addEventListener('submit', handleManualAlertSubmit);
            const manualAlertCompanySelect = document.getElementById('manual-alert-company');
            if (manualAlertCompanySelect) manualAlertCompanySelect.addEventListener('change', populateManualAlertKeywords);
            if (cancelJustificationBtn) cancelJustificationBtn.addEventListener('click', () => { if (justificationModal) justificationModal.classList.add('hidden') });
            if (submitJustificationBtn) submitJustificationBtn.addEventListener('click', handleSubmitJustification);
            if (deletionRequestsList) deletionRequestsList.addEventListener('click', handleDeletionRequestAction);
            if (justificationText && submitJustificationBtn) justificationText.addEventListener('input', () => { if (submitJustificationBtn) submitJustificationBtn.disabled = justificationText.value.trim() === ''; });
            if (btnPendingAlerts) btnPendingAlerts.addEventListener('click', () => updateView('super-admin-queue'));
            if (pendingAlertsList) pendingAlertsList.addEventListener('click', handlePendingAlertAction);
            if (backToDashboard4) backToDashboard4.addEventListener('click', () => updateView('dashboard'));
            if (shareWhatsappBtn) shareWhatsappBtn.addEventListener('click', handleShareActions);
            if (shareEmailBtn) shareEmailBtn.addEventListener('click', handleShareActions);
            if (printBtn) printBtn.addEventListener('click', () => window.print());
            if (mapFilterBtn) mapFilterBtn.addEventListener('click', renderMapPage);
            if (reportStartDateInput) reportStartDateInput.addEventListener('change', renderSuperAdminReport);
            if (reportEndDateInput) reportEndDateInput.addEventListener('change', renderSuperAdminReport);


            if (superAdminReportBody) superAdminReportBody.addEventListener('click', async (e) => {
                const row = e.target.closest('.company-report-row');
                if (!row) return;

                const { companyId } = row.dataset;
                const existingDetailsRow = document.getElementById(`details-${companyId}`);

                if (existingDetailsRow) {
                    existingDetailsRow.remove();
                    row.classList.remove('bg-indigo-100');
                    return;
                }

                const allDetailsRows = document.querySelectorAll('.keyword-details-row');
                allDetailsRows.forEach(r => r.remove());
                document.querySelectorAll('.company-report-row').forEach(r => r.classList.remove('bg-indigo-100'));

                row.classList.add('bg-indigo-100');
                const detailsRow = document.createElement('tr');
                detailsRow.id = `details-${companyId}`;
                detailsRow.className = 'keyword-details-row';
                detailsRow.innerHTML = `<td colspan="6" class="p-4 text-center">Carregando detalhes...</td>`;
                row.insertAdjacentElement('afterend', detailsRow);

                try {
                    const getKeywordReport = httpsCallable(functions, 'getCompanyKeywordReport');
                    const startDate = reportStartDateInput?.value || null;
                    const endDate = reportEndDateInput?.value || null;
                    const result = await getKeywordReport({ appId, companyId, startDate, endDate });
                    const keywordsData = result.data;


                    let tableHTML = '<p class="text-center p-4">Nenhuma palavra-chave encontrada para esta empresa.</p>';
                    if (keywordsData.length > 0) {
                        tableHTML = `                        <div class="p-4 bg-gray-50 rounded-lg">                            <h4 class="font-bold mb-2 text-lg text-gray-700">Detalhes por Palavra-Chave</h4>                            <table class="min-w-full divide-y divide-gray-300">                                <thead class="bg-gray-100">                                    <tr>                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase">Palavra-Chave</th>                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase">Total de Alertas</th>                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase">Sentimento (%)</th>                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase">Sent. Predominante</th>                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase">Canal Principal</th>                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase">Veículo Principal</th>                                    </tr>                                </thead>                                <tbody class="bg-white divide-y divide-gray-200">                                    ${keywordsData.map(kw => `                                    <tr>                                        <td class="px-3 py-2 font-medium">${kw.keyword}</td>                                        <td class="px-3 py-2">${kw.totalAlerts}</td>                                        <td class="px-3 py-2 text-xs">                                            <span class="text-green-600">P: ${kw.sentimentPercentage.positive}%</span>,                                             <span class="text-gray-600">N: ${kw.sentimentPercentage.neutral}%</span>,                                             <span class="text-red-600">Ng: ${kw.sentimentPercentage.negative}%</span>                                        </td>                                        <td class="px-3 py-2">${kw.predominantSentiment}</td>                                        <td class="px-3 py-2">${kw.topChannel}</td>                                        <td class="px-3 py-2">${kw.topVehicle}</td>                                    </tr>                                `).join('')}                                </tbody>                            </table>                        </div>`;
                    }

                    detailsRow.querySelector('td').innerHTML = tableHTML;

                } catch (error) {
                    console.error("Erro ao buscar detalhes das palavras-chave:", error);
                    detailsRow.querySelector('td').innerHTML = `<p class="text-red-500 text-center p-4">Erro ao carregar detalhes.</p>`;
                }
            });

            const urlParams = new URLSearchParams(window.location.search);
            const companyParam = urlParams.get('company');
            if (companyParam) {
                const companyInput = document.getElementById('login-company');
                if (companyInput) {
                    companyInput.value = decodeURIComponent(companyParam);
                    const loginCompanyWrapper = document.getElementById('login-company-wrapper');
                    if (loginCompanyWrapper) {
                        loginCompanyWrapper.style.display = 'none';
                    }
                }
            }

            window.addEventListener('mapReady', (e) => {
                mapInstance = e.detail;
            });
        });


    </script>
</body>

</html>

