<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clipping de Notícias - Admin</title>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        header { position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; }
        main { padding-top: 96px; } 
        .page-section { display: none; }
        .page-section.active { display: block; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        @keyframes blinking-bell {
            0% { background-color: transparent; color: #4B5563; }
            50% { background-color: #10B981; color: white; }
            100% { background-color: transparent; color: #4B5563; }
        }
        .animate-blinking-bell {
            animation: blinking-bell 1.5s infinite;
            border-radius: 9999px;
        }

        .keyword-filter.active {
            background-color: #4F46E5 !important;
            color: white !important;
        }
        #notification-badge {
            min-width: 1.25rem;
            height: 1.25rem;
            padding: 0 0.25rem;
            line-height: 1.25rem;
        }
        .sentiment-menu {
            display: none;
            position: absolute;
            z-index: 10;
            right: 0;
            background-color: white;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border: 1px solid #e5e7eb;
        }
        .sentiment-container:hover .sentiment-menu {
            display: block;
        }
        #report-keyword-filter {
            height: 100px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="text-2xl font-bold text-indigo-600 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2 h-8 w-8"><path d="M2.5 17a2.4 2.4 0 0 1 3 0L12 23l6.5-6.5a2.4 2.4 0 0 1 3 0Z"/><path d="M5 11.5a2.5 2.5 0 0 1 0-5c1.5 0 2.8 1.3 2.8 2.8V13c0 1.4-1.3 2.8-2.8 2.8-1.5 0-2.8-1.3-2.8-2.8V8.5"/><path d="M19 11.5a2.5 2.5 0 0 0 0-5c-1.5 0-2.8 1.3-2.8 2.8V13c0 1.4 1.3 2.8 2.8 2.8 1.5 0-2.8-1.3-2.8-2.8V8.5"/></svg>
                Aurora clipping
            </div>
            <div class="flex items-center">
                <div id="nav-logged-in" class="hidden items-center">
                    <a href="#" id="nav-inicio" class="text-gray-600 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-medium">Início</a>
                    <a href="#" id="nav-relatorio" class="hidden text-gray-600 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-medium">Relatório</a>
                    <a href="#" id="nav-pesquisa" class="text-gray-600 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-medium">Pesquisa</a>
                    <a href="#" id="nav-super-admin" class="hidden text-red-600 hover:text-red-800 px-3 py-2 rounded-md text-sm font-bold">Super Admin</a>
                    <a href="#" id="nav-configuracoes-admin" class="hidden text-gray-600 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-medium">Configurações</a>
                    <div id="notification-bell-container" class="relative cursor-pointer ml-4 p-1">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                        <span id="notification-badge" class="hidden absolute -top-1 -right-1 text-white text-xs font-bold text-center rounded-full bg-red-500"></span>
                    </div>
                    <a href="#" id="nav-logout" class="ml-4 bg-indigo-600 text-white hover:bg-indigo-700 px-3 py-2 rounded-md text-sm font-medium">Sair</a>
                </div>
                <div id="header-logo-container" class="ml-4 h-10 w-auto"></div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-6">
        <div id="global-alert" class="mb-6"></div>

        <!-- Login Section -->
        <section id="login-page" class="page-section fade-in">
            <div class="max-w-md mx-auto bg-gray-50 p-8 rounded-lg shadow-lg mt-10 relative">
                <div id="login-logo-container" class="absolute top-4 right-4 h-12 w-auto"></div>
                <h1 class="text-3xl font-bold text-center text-gray-800">Bem-Vindo</h1>
                <p class="text-center text-gray-500 mt-2 mb-6">Informe seus dados de acesso</p>
                <form id="login-form">
                    <div id="login-company-wrapper" class="mb-4"><label for="login-company" class="block text-sm font-medium text-gray-700 mb-1">Empresa</label><input type="text" id="login-company" class="w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                    <div class="mb-4"><label for="login-user" class="block text-sm font-medium text-gray-700 mb-1">Usuário</label><input type="text" id="login-user" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <div class="mb-6"><label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Senha</label><input type="password" id="login-password" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Entrar</button>
                </form>
            </div>
        </section>

        <!-- Dashboard Section -->
        <section id="dashboard-page" class="page-section fade-in">
            <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 bg-white p-4 rounded-lg shadow-md">
                <h2 id="dashboard-title" class="text-2xl font-bold text-gray-800 mb-2 md:mb-0">Notícias do Dia</h2>
                <p id="current-datetime" class="text-lg text-indigo-600 font-medium"></p>
            </div>
            <div id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1 bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold mb-3 text-gray-700">Palavras-Chave Monitoradas</h3>
                    <ul id="dashboard-keyword-list" class="space-y-2"></ul>
                </div>
                <div id="news-alerts-container" class="md:col-span-2">
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-700">Relatório de Alertas</h3>
                            <div class="flex items-center gap-4">
                                <button id="show-all-alerts-btn" class="hidden bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-sm hover:bg-gray-300">Mostrar Todos</button>
                                <div class="flex items-center gap-2">
                                    <label for="alert-date-filter" class="text-sm font-medium">Filtrar por data:</label>
                                    <input type="date" id="alert-date-filter" class="px-2 py-1 border border-gray-300 rounded-md text-sm">
                                </div>
                            </div>
                        </div>
                        <div id="news-alerts" class="space-y-4 max-h-[70vh] overflow-y-auto"></div>
                    </div>
                </div>
            </div>
             <div id="super-admin-dashboard-message" class="hidden bg-white p-8 rounded-lg shadow-lg text-center">
                <h3 class="text-2xl font-bold">Bem-vindo, Super Admin!</h3>
                <p class="mt-4 text-gray-600">Use o menu "Super Admin" no topo da página para gerenciar as opções.</p>
                <div class="mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <button id="btn-manual-alert" class="bg-white p-6 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow">
                        <h3 class="text-xl font-semibold text-gray-700">Inserir Alerta Manual</h3>
                    </button>
                    <button id="btn-pending-alerts" class="bg-white p-6 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow relative">
                        <h3 class="text-xl font-semibold text-gray-700">Fila de Aprovação</h3>
                        <span id="pending-alerts-badge" class="hidden absolute top-2 right-2 text-white text-xs font-bold w-5 h-5 text-center rounded-full bg-red-500"></span>
                    </button>
                     <button id="btn-deletion-requests" class="bg-white p-6 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow relative">
                        <h3 class="text-xl font-semibold text-gray-700">Solicitações de Exclusão</h3>
                        <span id="deletion-requests-badge" class="hidden absolute top-2 right-2 text-white text-xs font-bold w-5 h-5 text-center rounded-full bg-red-500"></span>
                    </button>
                    <button id="btn-super-admin-report" class="bg-white p-6 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow">
                        <h3 class="text-xl font-semibold text-gray-700">Relatório Geral</h3>
                    </button>
                </div>
                <div class="mt-6 p-4 bg-blue-100 border-l-4 border-blue-500 text-blue-800 rounded-md text-left">
                    <p class="font-bold">Execução Manual do Robô</p>
                    <p class="mt-2 text-sm">A busca automática já está configurada para rodar a cada 30 minutos. Use o botão abaixo apenas se precisar de uma atualização imediata.</p>
                    <button id="manual-trigger-btn" class="mt-4 w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:bg-blue-300">Executar Robô Manualmente</button>
                </div>
            </div>
        </section>
        
        <!-- Super Admin Section -->
        <section id="super-admin-page" class="page-section fade-in">
            <h2 class="text-3xl font-bold mb-6 text-red-600">Painel Super-Administrador</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold mb-4">Adicionar Nova Empresa</h3>
                    <form id="company-form" class="space-y-4">
                        <div><label for="company-name-input">Nome da Empresa</label><input type="text" id="company-name-input" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                        <button type="submit" class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700">Adicionar Empresa</button>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold mb-4">Empresas Cadastradas</h3>
                    <ul id="company-list" class="space-y-2 max-h-96 overflow-y-auto"></ul>
                </div>
            </div>
        </section>

        <!-- Super Admin Settings Menu Page -->
        <section id="configuracoes-admin-page" class="page-section fade-in">
            <h2 class="text-3xl font-bold mb-6">Configurações do Super Admin</h2>
            <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6">
                <button id="btn-change-password" class="bg-white p-6 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow">
                    <h3 class="text-xl font-semibold">Alterar Senha</h3>
                </button>
                <button id="btn-global-keys" class="bg-white p-6 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow">
                    <h3 class="text-xl font-semibold">Chaves de API Globais</h3>
                </button>
                <button id="btn-news-sources" class="bg-white p-6 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow">
                    <h3 class="text-xl font-semibold">Fontes de Notícias</h3>
                </button>
            </div>
        </section>
        
        <section id="change-password-page" class="page-section fade-in">
            <button id="back-to-admin-config-1" class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar</button>
            <h2 class="text-3xl font-bold mb-6">Alterar Senha de Acesso</h2>
            <div class="max-w-lg mx-auto bg-white p-6 rounded-lg shadow-lg">
                <form id="change-password-form" class="space-y-4">
                    <div><label for="current-password" class="block text-sm font-medium text-gray-700">Senha Atual</label><input type="password" id="current-password" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <div><label for="new-password" class="block text-sm font-medium text-gray-700">Nova Senha</label><input type="password" id="new-password" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Alterar Senha</button>
                </form>
            </div>
        </section>

        <section id="global-keys-page" class="page-section fade-in">
            <button id="back-to-admin-config-2" class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar</button>
            <h2 class="text-3xl font-bold mb-6">Chaves de API Globais</h2>
            <div class="max-w-lg mx-auto bg-white p-6 rounded-lg shadow-lg">
                <div class="space-y-4">
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="apiKeyNewsApi" class="block text-sm font-medium text-gray-700 mb-1">Chave da API (NewsAPI.org)</label>
                        <input type="text" id="apiKeyNewsApi" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="apiKeyGNews1" class="block text-sm font-medium text-gray-700 mb-1">Chave GNews (00:00 - 05:59)</label>
                        <input type="text" id="apiKeyGNews1" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="apiKeyGNews2" class="block text-sm font-medium text-gray-700 mb-1">Chave GNews (06:00 - 11:59)</label>
                        <input type="text" id="apiKeyGNews2" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="apiKeyGNews3" class="block text-sm font-medium text-gray-700 mb-1">Chave GNews (12:00 - 17:59)</label>
                        <input type="text" id="apiKeyGNews3" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="apiKeyGNews4" class="block text-sm font-medium text-gray-700 mb-1">Chave GNews (18:00 - 23:59)</label>
                        <input type="text" id="apiKeyGNews4" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <!-- NOVO CAMPO DE API -->
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="apiKeyFirebaseNews" class="block text-sm font-medium text-gray-700 mb-1">Chave da API noticias (auto created by Firebase)</label>
                        <input type="text" id="apiKeyFirebaseNews" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="apiKeyYoutube" class="block text-sm font-medium text-gray-700 mb-1">Chave da API (YouTube Data API v3)</label>
                        <input type="text" id="apiKeyYoutube" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="apiKeyBlogger" class="block text-sm font-medium text-gray-700 mb-1">Chave da API (Blogger API)</label>
                        <input type="text" id="apiKeyBlogger" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="apiKeyVision" class="block text-sm font-medium text-gray-700 mb-1">Chave da API (Cloud Vision)</label>
                        <input type="text" id="apiKeyVision" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="apiKeyVideoIntelligence" class="block text-sm font-medium text-gray-700 mb-1">Chave da API (Video Intelligence)</label>
                        <input type="text" id="apiKeyVideoIntelligence" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                </div>
            </div>
        </section>

        <!-- Global Sources Page -->
        <section id="global-sources-page" class="page-section fade-in">
            <button id="back-to-admin-config-3" class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar</button>
            <h2 class="text-3xl font-bold mb-6">Fontes de Notícias Globais</h2>
            <div class="max-w-lg mx-auto bg-white p-6 rounded-lg shadow-lg">
                <div class="space-y-4">
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="bloggerId" class="block text-sm font-medium text-gray-700 mb-1">IDs de Blogs (Blogger) - um por linha</label>
                        <textarea id="bloggerId" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="rssUrl" class="block text-sm font-medium text-gray-700 mb-1">Monitorar Sites por RSS - um por linha</label>
                        <textarea id="rssUrl" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="https://site.com/feed"></textarea>
                    </div>
                </div>
            </div>
        </section>

        <!-- Company User Management Section (by Super Admin) -->
        <section id="company-user-admin-page" class="page-section fade-in">
            <button id="back-to-super-admin-users" class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar para Super Admin</button>
            <h2 id="company-user-admin-title" class="text-3xl font-bold mb-6">Gerenciar Usuários</h2>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <form id="user-form" class="flex flex-col sm:flex-row gap-2 mb-4">
                    <input type="text" id="user-input" placeholder="Nome do usuário" class="flex-grow px-3 py-2 border border-gray-300 rounded-md">
                    <input type="text" id="user-password-input" placeholder="Senha" class="flex-grow px-3 py-2 border border-gray-300 rounded-md">
                    <input type="hidden" id="user-id">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Salvar</button>
                </form>
                <ul id="admin-user-list" class="space-y-2 max-h-96 overflow-y-auto"></ul>
            </div>
        </section>

        <!-- Company Keyword Management Section (by Super Admin) -->
        <section id="company-keyword-admin-page" class="page-section fade-in">
            <button id="back-to-super-admin-kw" class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar para Super Admin</button>
            <h2 id="company-keyword-admin-title" class="text-3xl font-bold mb-6">Gerenciar Palavras-Chave</h2>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <form id="keyword-form" class="flex gap-2 mb-4">
                    <input type="text" id="keyword-input" placeholder="Adicionar ou editar palavra" class="flex-grow px-3 py-2 border border-gray-300 rounded-md">
                    <input type="hidden" id="keyword-id">
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Salvar</button>
                </form>
                <ul id="admin-keyword-list" class="space-y-2 max-h-96 overflow-y-auto"></ul>
            </div>
        </section>

        <!-- Company Settings Management Section (by Super Admin) -->
        <section id="company-settings-admin-page" class="page-section fade-in">
            <button id="back-to-super-admin-settings" class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar para Super Admin</button>
            <h2 id="company-settings-admin-title" class="text-3xl font-bold mb-6">Opções da Empresa</h2>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="space-y-6">
                    <div class="flex items-center"><input type="checkbox" id="report-access-toggle" class="h-4 w-4 text-indigo-600 border-gray-300 rounded"><label for="report-access-toggle" class="ml-2 block text-sm text-gray-900">Liberar acesso ao relatório de alertas na tela inicial.</label></div>
                    <div class="flex items-center"><input type="checkbox" id="fetch-only-new-toggle" class="h-4 w-4 text-indigo-600 border-gray-300 rounded"><label for="fetch-only-new-toggle" class="ml-2 block text-sm text-gray-900">Capturar apenas notícias novas (evita duplicatas).</label></div>
                    <div class="flex items-center"><input type="checkbox" id="deletion-access-toggle" class="h-4 w-4 text-indigo-600 border-gray-300 rounded"><label for="deletion-access-toggle" class="ml-2 block text-sm text-gray-900">Permitir que usuários solicitem a exclusão de alertas.</label></div>
                    <div><h4 class="text-lg font-semibold mb-2">Logo da Empresa</h4><input type="file" id="logo-upload" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"></div>
                    <div>
                        <h4 class="text-lg font-semibold mb-2">Escopo das Notícias</h4>
                        <div id="news-scope-container" class="space-y-2">
                            <div class="flex items-center"><input type="radio" id="scope-nacional" name="news-scope" value="br" class="h-4 w-4 text-indigo-600 border-gray-300"><label for="scope-nacional" class="ml-2 block text-sm text-gray-900">Nacionais (Brasil)</label></div>
                            <div class="flex items-center"><input type="radio" id="scope-internacional" name="news-scope" value="international" class="h-4 w-4 text-indigo-600 border-gray-300"><label for="scope-internacional" class="ml-2 block text-sm text-gray-900">Internacionais</label></div>
                            <div class="flex items-center"><input type="radio" id="scope-estadual" name="news-scope" value="state" class="h-4 w-4 text-indigo-600 border-gray-300"><label for="scope-estadual" class="ml-2 block text-sm text-gray-900">Estaduais</label></div>
                        </div>
                        <div id="state-select-container" class="hidden mt-2">
                            <label for="state-select" class="block text-sm font-medium text-gray-700 mb-1">Selecione o Estado:</label>
                            <select id="state-select" class="w-full p-2 border border-gray-300 rounded-md"></select>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Report Section -->
        <section id="report-page" class="page-section fade-in">
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <div class="flex flex-col sm:flex-row justify-between items-start mb-6 gap-4">
                    <h2 class="text-3xl font-bold text-gray-700 mb-4 sm:mb-0">Relatórios Gráficos</h2>
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 w-full sm:w-auto">
                        <div class="w-full sm:w-auto">
                            <label for="report-keyword-filter" class="text-sm font-medium">Filtrar por Palavra-Chave:</label>
                            <select id="report-keyword-filter" multiple class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm"></select>
                        </div>
                        <div class="w-full sm:w-auto">
                            <label class="text-sm font-medium">Filtrar por Período:</label>
                            <div class="flex items-center gap-2">
                                <input type="date" id="start-date" class="w-full px-2 py-1 border rounded-md">
                                <span class="text-gray-500">até</span>
                                <input type="date" id="end-date" class="w-full px-2 py-1 border rounded-md">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="p-4 border rounded-lg">
                        <h3 class="text-xl font-semibold mb-4 text-center">Notícias por Veículo</h3>
                        <canvas id="source-chart"></canvas>
                    </div>
                    <div class="p-4 border rounded-lg">
                        <h3 class="text-xl font-semibold mb-4 text-center">Notícias por Canal</h3>
                        <canvas id="channel-chart"></canvas>
                    </div>
                    <div class="p-4 border rounded-lg">
                        <h3 class="text-xl font-semibold mb-4 text-center">Notícias por Período</h3>
                         <canvas id="date-chart"></canvas>
                    </div>
                    <div class="p-4 border rounded-lg">
                        <h3 class="text-xl font-semibold mb-4 text-center">Análise de Sentimento</h3>
                        <canvas id="sentiment-chart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Search Section -->
        <section id="search-page" class="page-section fade-in">
             <div class="bg-white p-6 md:p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl md:text-3xl font-bold mb-6">Pesquisar nos Alertas Salvos</h2>
                <div id="filter-container" class="mb-8 p-4 border border-gray-200 rounded-lg bg-gray-50"></div>
                <input type="text" id="search-input" placeholder="Digite para pesquisar em títulos ou descrições..." class="w-full p-3 border border-gray-300 rounded-md mb-6">
                <div id="search-results" class="space-y-4 max-h-[60vh] overflow-y-auto"><p class="text-gray-500">Digite algo para começar a pesquisar ou use os filtros.</p></div>
            </div>
        </section>

        <!-- NEW: Manual Alert Page -->
        <section id="manual-alert-page" class="page-section fade-in">
            <button id="back-to-dashboard-1" class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar</button>
            <h2 class="text-3xl font-bold mb-6">Inserir Alerta Manualmente</h2>
            <div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-lg">
                <form id="manual-alert-form" class="space-y-4">
                    <div>
                        <label for="manual-alert-company" class="block text-sm font-medium text-gray-700">Empresa</label>
                        <select id="manual-alert-company" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></select>
                    </div>
                    <div><label for="manual-alert-title" class="block text-sm font-medium text-gray-700">Título</label><input type="text" id="manual-alert-title" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <div><label for="manual-alert-desc" class="block text-sm font-medium text-gray-700">Descrição</label><textarea id="manual-alert-desc" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea></div>
                    <div><label for="manual-alert-url" class="block text-sm font-medium text-gray-700">URL</label><input type="url" id="manual-alert-url" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <div><label for="manual-alert-source" class="block text-sm font-medium text-gray-700">Fonte (Veículo)</label><input type="text" id="manual-alert-source" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <div><label for="manual-alert-keyword" class="block text-sm font-medium text-gray-700">Palavra-Chave</label><input type="text" id="manual-alert-keyword" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Adicionar Alerta</button>
                </form>
            </div>
        </section>

        <!-- NEW: Deletion Requests Page -->
        <section id="deletion-requests-page" class="page-section fade-in">
            <button id="back-to-dashboard-2" class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar</button>
            <h2 class="text-3xl font-bold mb-6">Solicitações de Exclusão de Alertas</h2>
            <div id="deletion-requests-list" class="space-y-4">
                <p class="text-gray-500">A carregar solicitações...</p>
            </div>
        </section>
        
        <!-- NEW: Super Admin Pending Alerts Queue -->
        <section id="super-admin-queue-page" class="page-section fade-in">
            <button id="back-to-dashboard-4" class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar</button>
            <h2 class="text-3xl font-bold mb-6">Fila de Aprovação de Alertas</h2>
            <div id="super-admin-pending-alerts-list" class="space-y-4">
                <p class="text-gray-500">A carregar alertas pendentes...</p>
            </div>
        </section>


        <!-- NEW: Super Admin Report Page -->
        <section id="super-admin-report-page" class="page-section fade-in">
             <button id="back-to-dashboard-3" class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar</button>
            <h2 class="text-3xl font-bold mb-6">Relatório Geral de Empresas</h2>
            <div class="bg-white p-6 rounded-lg shadow-lg overflow-x-auto">
                <table class="w-full whitespace-nowrap">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Empresa</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total de Alertas</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sentimento (%)</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sentimento Predominante</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Canal Principal</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Veículo Principal</th>
                        </tr>
                    </thead>
                    <tbody id="super-admin-report-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="6" class="text-center py-4">A gerar relatório...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

    </main>

    <!-- Modals -->
    <div id="justification-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Justificar Exclusão</h3>
                <div class="mt-2 py-3">
                    <p class="text-sm text-gray-500 mb-2">Por favor, informe o motivo pelo qual deseja excluir este alerta. A sua solicitação será enviada para aprovação.</p>
                    <textarea id="justification-text" rows="4" class="w-full p-2 border border-gray-300 rounded-md" required></textarea>
                </div>
                <div class="items-center px-4 py-3 flex gap-2">
                    <button id="submit-justification-btn" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700 disabled:bg-red-300" disabled>Enviar Solicitação</button>
                    <button id="cancel-justification-btn" class="px-4 py-2 bg-gray-200 text-gray-900 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="delete-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" stroke="currentColor" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Excluir Empresa</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">Tem certeza que deseja excluir a empresa <strong id="company-name-to-delete"></strong>?<br><br><span class="font-bold text-red-600">Esta ação é permanente e removerá todos os dados associados.</span></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirm-delete-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700">Sim, excluir</button>
                    <button id="cancel-delete-btn" class="mt-3 px-4 py-2 bg-gray-200 text-gray-900 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="link-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">Link de Acesso Exclusivo</h3>
                <div class="mt-4 px-7 py-3">
                    <p class="text-sm text-gray-500 mb-2">Use este link para dar acesso direto à página de login desta empresa:</p>
                    <input type="text" id="access-link-input" readonly class="w-full bg-gray-100 p-2 border rounded-md text-sm">
                </div>
                <div class="items-center px-4 py-3 flex gap-2">
                    <button id="copy-link-btn" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700">Copiar</button>
                    <button id="close-link-modal-btn" class="px-4 py-2 bg-gray-200 text-gray-900 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="confirm-delete-keyword-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" stroke="currentColor" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Excluir Palavra-Chave</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">Tem certeza que deseja excluir a palavra-chave "<strong id="keyword-to-delete-name"></strong>"?<br><br><span class="font-bold text-red-600">Esta ação também removerá todos os alertas associados a ela.</span></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirm-delete-keyword-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700">Sim, excluir</button>
                    <button id="cancel-delete-keyword-btn" class="mt-3 px-4 py-2 bg-gray-200 text-gray-900 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Importação de Módulos do Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, addDoc, deleteDoc, updateDoc, query, where, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js";

        // --- INICIALIZAÇÃO DO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDC4vQ3PiAAy0WYIrLUTKZGb6WejSVdLrE",
            authDomain: "noticias-6e952.firebaseapp.com",
            projectId: "noticias-6e952",
            storageBucket: "noticias-6e952.appspot.com",
            messagingSenderId: "788555331572",
            appId: "1:788555331572:web:328cc3967fad0155352ba1"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const functions = getFunctions(app, 'southamerica-east1');
        
        // --- ESTADO DA APLICAÇÃO ---
        const appId = firebaseConfig.projectId; // Usar o ID do projeto como appId
        let currentUser = null, clockInterval = null, selectedCompanyForManagement = null, allCompanyArticles = [], companyIdToDelete = null, articleToDeleteInfo = null;
        let sourceChartInstance = null, dateChartInstance = null, sentimentChartInstance = null, channelChartInstance = null;
        let superAdminCredentials = { user: 'ulysses', pass: 'adminqwert' };
        let notificationListener = null, companiesListener = null, deletionRequestsListener = null, pendingAlertsListener = null;
        let keywordToDeleteInfo = null;

        // --- ELEMENTOS DO DOM (declarados dentro de DOMContentLoaded) ---
        let pageSections, navLoggedIn, navInicio, navRelatorio, navPesquisa, navSuperAdmin, navLogout, navConfiguracoesAdmin, globalAlert, loginPage, dashboardPage, searchPage, superAdminPage, companyKeywordAdminPage, companySettingsAdminPage, reportPage, companyUserAdminPage, configuracoesAdminPage, loginForm, dashboardTitle, currentDateTimeEl, dashboardKeywordList, newsAlertsContainer, newsAlerts, alertDateFilter, reportAccessToggle, logoUploadInput, headerLogoContainer, loginLogoContainer, filterContainer, searchInput, searchResults, companyForm, companyList, backToSuperAdminKwBtn, backToSuperAdminSettingsBtn, backToSuperAdminUsersBtn, companyKeywordAdminTitle, companySettingsAdminTitle, companyUserAdminTitle, keywordForm, keywordInput, keywordIdInput, adminKeywordList, userForm, userInput, userPasswordInput, userIdInput, adminUserList, notificationBell, notificationBadge, manualTriggerBtn, deleteModal, confirmDeleteBtn, cancelDeleteBtn, companyNameToDeleteEl, newsScopeContainer, startDateInput, endDateInput, linkModal, accessLinkInput, copyLinkBtn, closeLinkModalBtn, reportKeywordFilter, stateSelectContainer, stateSelect, changePasswordForm, apiKeyNewsApiInput, apiKeyGNewsInput1, apiKeyGNewsInput2, apiKeyGNewsInput3, apiKeyGNewsInput4, apiKeyFirebaseNewsInput, apiKeyYoutubeInput, apiKeyBloggerInput, apiKeyVisionInput, apiKeyVideoIntelligenceInput, showAllAlertsBtn, deletionAccessToggle, justificationModal, justificationText, submitJustificationBtn, cancelJustificationBtn, btnManualAlert, btnDeletionRequests, btnSuperAdminReport, manualAlertPage, deletionRequestsPage, superAdminReportPage, backToDashboard1, backToDashboard2, backToDashboard3, manualAlertForm, deletionRequestsList, superAdminReportBody, deletionRequestsBadge, pendingAlertsPage, pendingAlertsList, btnPendingAlerts, backToDashboard4, confirmDeleteKeywordBtn, cancelDeleteKeywordBtn, confirmDeleteKeywordModal, keywordToDeleteNameEl, bloggerIdInput, rssUrlInput, fetchOnlyNewToggle, changePasswordPage, globalKeysPage, globalSourcesPage, btnChangePassword, btnGlobalKeys, btnNewsSources, backToAdminConfig1, backToAdminConfig2, backToAdminConfig3;


        // --- FUNÇÕES DE UTILIDADE ---
        function showAlert(message, type = 'success') { const c = type === 'success' ? 'bg-green-100 border-green-500 text-green-700' : 'bg-red-100 border-red-500 text-red-700'; globalAlert.innerHTML = `<div class="${c} border-l-4 p-4 rounded-md fade-in" role="alert"><p>${message}</p></div>`; setTimeout(() => { globalAlert.innerHTML = ''; }, 4000); }
        function updateView(pageName) { 
            pageSections.forEach(s => s.classList.remove('active')); 
            const i = !!currentUser; 
            if (navLoggedIn) navLoggedIn.style.display = i ? 'flex' : 'none'; 
            if (navRelatorio) navRelatorio.classList.toggle('hidden', !currentUser || currentUser.isSuperAdmin);
            if (navSuperAdmin) navSuperAdmin.classList.toggle('hidden', !currentUser || !currentUser.isSuperAdmin); 
            if (navConfiguracoesAdmin) navConfiguracoesAdmin.classList.toggle('hidden', !currentUser || !currentUser.isSuperAdmin); 
            if (clockInterval) clearInterval(clockInterval); 
            loadAndDisplayLogo(); 
            switch (pageName) { 
                case 'login': loginPage.classList.add('active'); break; 
                case 'dashboard': dashboardPage.classList.add('active'); renderDashboard(); updateDateTime(); clockInterval = setInterval(updateDateTime, 60000); break; 
                case 'super-admin': superAdminPage.classList.add('active'); setupCompaniesListener(); break; 
                case 'search': searchPage.classList.add('active'); setupSearchPage(); break; 
                case 'company-keyword-admin': companyKeywordAdminPage.classList.add('active'); renderCompanyKeywordAdminPage(); break; 
                case 'company-settings-admin': companySettingsAdminPage.classList.add('active'); renderCompanySettingsAdminPage(); break; 
                case 'company-user-admin': companyUserAdminPage.classList.add('active'); renderCompanyUserAdminPage(); break; 
                case 'report': reportPage.classList.add('active'); renderReportPage(); break; 
                case 'configuracoes-admin': configuracoesAdminPage.classList.add('active'); break; 
                case 'change-password': changePasswordPage.classList.add('active'); break; 
                case 'global-keys': globalKeysPage.classList.add('active'); renderGlobalKeysPage(); break; 
                case 'global-sources': globalSourcesPage.classList.add('active'); renderGlobalSourcesPage(); break; 
                case 'manual-alert': manualAlertPage.classList.add('active'); renderManualAlertPage(); break; 
                case 'deletion-requests': deletionRequestsPage.classList.add('active'); setupDeletionRequestsListener(); break; 
                case 'super-admin-report': superAdminReportPage.classList.add('active'); renderSuperAdminReport(); break; 
                case 'super-admin-queue': pendingAlertsPage.classList.add('active'); setupPendingAlertsListener(); break; 
            } 
        }
        function getStorage(key, defaultValue) { try { const d = localStorage.getItem(key); return d ? JSON.parse(d) : defaultValue; } catch (e) { console.error(e); return defaultValue; } }
        function setStorage(key, value) { localStorage.setItem(key, JSON.stringify(value)); }
        function updateDateTime() { if (!currentDateTimeEl) return; const n = new Date(), f = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }; currentDateTimeEl.textContent = `Data: ${n.toLocaleDateString('pt-BR', f).replace(',', ' -')}`; }

        // --- LÓGICA DO ACIONAMENTO MANUAL ---
        async function handleManualTrigger() {
            if (!manualTriggerBtn) return;
            manualTriggerBtn.disabled = true;
            manualTriggerBtn.textContent = 'Executando...';
            showAlert('A coleta manual de notícias foi iniciada. Isto pode levar alguns minutos.', 'success');
            const manualFetch = httpsCallable(functions, 'manualFetch');
            try {
                await manualFetch({ appId });
                showAlert('Robô executado com sucesso! As novas notícias estarão disponíveis em breve.', 'success');
            } catch (error) {
                console.error("Erro ao acionar o robô manual:", error);
                showAlert(`Erro ao acionar o robô: ${error.message}`, 'error');
            } finally {
                manualTriggerBtn.disabled = false;
                manualTriggerBtn.textContent = 'Executar Robô Manualmente';
            }
        }

        // --- LÓGICA DO LOGO ---
        async function handleLogoUpload(e) { const file = e.target.files[0]; if (!file) return; const companyId = currentUser.isSuperAdmin ? selectedCompanyForManagement.id : currentUser.companyId; if (!companyId) return; const reader = new FileReader(); reader.onloadend = async () => { try { const settingsRef = doc(db, "artifacts", appId, "public/data/settings", companyId); await setDoc(settingsRef, { logo: reader.result }, { merge: true }); loadAndDisplayLogo(); showAlert('Logo atualizada com sucesso!'); } catch (error) { console.error("Erro ao salvar logo:", error); showAlert("Erro ao salvar logo.", "error"); } }; reader.readAsDataURL(file); }
        async function loadAndDisplayLogo() { const companyId = currentUser ? currentUser.companyId : null; if (!companyId) { if(headerLogoContainer) headerLogoContainer.innerHTML = ''; if(loginLogoContainer) loginLogoContainer.innerHTML = ''; return; } const settingsRef = doc(db, "artifacts", appId, "public/data/settings", companyId); try { const docSnap = await getDoc(settingsRef); const logoData = docSnap.exists() ? docSnap.data().logo : null; const logoHtml = logoData ? `<img src="${logoData}" alt="Logo da Empresa" class="h-full w-auto object-contain">` : ''; if(headerLogoContainer) headerLogoContainer.innerHTML = logoHtml; if(loginLogoContainer) loginLogoContainer.innerHTML = logoHtml; } catch (error) { console.error("Error loading logo:", error); } }

        // --- LÓGICA DE AUTENTICAÇÃO ---
        async function handleLogin(e) { 
            e.preventDefault(); 
            const companyName = document.getElementById('login-company').value.trim(); 
            const user = document.getElementById('login-user').value.trim(); 
            const pass = document.getElementById('login-password').value.trim(); 
            
            if (companyName.toLowerCase() === 'newsclip' && user.toLowerCase() === superAdminCredentials.user && pass === superAdminCredentials.pass) { 
                currentUser = { username: 'Ulysses', isSuperAdmin: true, companyId: 'super', companyName: 'Super Admin' }; 
                setStorage('clipping_currentUser', currentUser); 
                updateView('dashboard'); 
                return; 
            } 
            
            try { 
                const companiesQuery = query(collection(db, "artifacts", appId, "public/data/companies"), where("name", "==", companyName.toUpperCase())); 
                const companiesSnapshot = await getDocs(companiesQuery); 
                if (companiesSnapshot.empty) { 
                    showAlert('Empresa não encontrada.', 'error'); 
                    return; 
                } 
                const companyDoc = companiesSnapshot.docs[0]; 
                const company = { id: companyDoc.id, ...companyDoc.data() }; 
                if (company.status === 'inactive') { 
                    showAlert('Esta empresa está inativa e não pode ser acessada.', 'error'); 
                    return; 
                } 
                const usersQuery = query(collection(db, "artifacts", appId, "users", company.id, "users"), where("username", "==", user), where("password", "==", pass)); 
                const usersSnapshot = await getDocs(usersQuery); 
                if(!usersSnapshot.empty) { 
                    const settingsDoc = await getDoc(doc(db, "artifacts", appId, "public/data/settings", company.id)); 
                    const canRequestDeletion = settingsDoc.exists() ? settingsDoc.data().canRequestDeletion : false; 
                    currentUser = { username: user, companyId: company.id, companyName: company.name, isSuperAdmin: false, canRequestDeletion }; 
                    setStorage('clipping_currentUser', currentUser); 
                    updateView('dashboard'); 
                } else { 
                    showAlert('Usuário ou senha inválidos para esta empresa.', 'error'); 
                } 
            } catch (error) { 
                console.error("Login error:", error); 
                showAlert("Ocorreu um erro durante o login.", "error"); 
            } 
        }
        function handleLogout() { 
            if (notificationListener) notificationListener(); 
            if (companiesListener) companiesListener(); 
            if (deletionRequestsListener) deletionRequestsListener(); 
            if (pendingAlertsListener) pendingAlertsListener(); 
            currentUser = null; 
            selectedCompanyForManagement = null; 
            localStorage.removeItem('clipping_currentUser'); 
            if (clockInterval) clearInterval(clockInterval); 
            if(headerLogoContainer) headerLogoContainer.innerHTML = ''; 
            updateView('login'); 
        }
        function handleChangePassword(e) { e.preventDefault(); const currentPass = document.getElementById('current-password').value; const newPass = document.getElementById('new-password').value; if (currentPass === superAdminCredentials.pass) { superAdminCredentials.pass = newPass; showAlert('Senha alterada com sucesso para esta sessão.', 'success'); if(changePasswordForm) changePasswordForm.reset(); } else { showAlert('Senha atual incorreta.', 'error'); } }

        // --- LÓGICA DO DASHBOARD ---
        async function renderDashboard() { 
            if (!currentUser) return; 
            if (currentUser.isSuperAdmin) {
                if(document.getElementById('dashboard-grid')) document.getElementById('dashboard-grid').style.display = 'none';
                if(document.getElementById('super-admin-dashboard-message')) document.getElementById('super-admin-dashboard-message').style.display = 'block';
                setupPendingAlertsListener();
                 setupDeletionRequestsListener(); // Adicionado para carregar o badge
            } else {
                if(document.getElementById('dashboard-grid')) document.getElementById('dashboard-grid').style.display = 'grid';
                if(document.getElementById('super-admin-dashboard-message')) document.getElementById('super-admin-dashboard-message').style.display = 'none';
                renderVerticalKeywordList(); 
                const settingsRef = doc(db, "artifacts", appId, "public/data/settings", currentUser.companyId); 
                try { 
                    const docSnap = await getDoc(settingsRef); 
                    const hasReportAccess = docSnap.exists() ? docSnap.data().reportAccess : true; 
                    if(newsAlertsContainer) newsAlertsContainer.style.display = hasReportAccess ? 'block' : 'none'; 
                    if(navRelatorio) navRelatorio.classList.toggle('hidden', !hasReportAccess); 
                    populateInitialAlerts(); 
                    setupNotificationListener(); 
                } catch (error) { 
                    console.error("Error rendering dashboard:", error); 
                }
            }
            if(dashboardTitle) dashboardTitle.textContent = currentUser.isSuperAdmin ? 'Painel Super Admin' : `Notícias do Dia - ${currentUser.companyName}`;
        }
        async function renderVerticalKeywordList() { if (!currentUser || !dashboardKeywordList) return; try { const q = query(collection(db, "artifacts", appId, "users", currentUser.companyId, "keywords")); const querySnapshot = await getDocs(q); const keywords = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); dashboardKeywordList.innerHTML = ''; const showAllLi = document.createElement('li'); showAllLi.className = 'keyword-filter active bg-indigo-100 text-indigo-800 text-md font-medium px-3 py-2 rounded-md flex justify-between items-center cursor-pointer hover:bg-indigo-200'; showAllLi.dataset.keyword = "all"; showAllLi.innerHTML = `<span>Mostrar Todas</span>`; dashboardKeywordList.appendChild(showAllLi); if (keywords.length === 0) { dashboardKeywordList.insertAdjacentHTML('beforeend', `<p class="text-gray-500 text-sm mt-2">Nenhuma palavra-chave.</p>`); } else { keywords.forEach(kw => { const li = document.createElement('li'); li.className = 'keyword-filter bg-indigo-100 text-indigo-800 text-md font-medium px-3 py-2 rounded-md flex justify-content-between items-center cursor-pointer hover:bg-indigo-200'; li.dataset.keyword = kw.word; li.innerHTML = `<span>${kw.word}</span>`; dashboardKeywordList.appendChild(li); }); } } catch (error) { console.error("Error fetching keywords:", error); } }
        
        // --- LÓGICA DO SUPER ADMIN ---
        function setupCompaniesListener() {
            if (companiesListener) companiesListener(); 
            const companiesQuery = query(collection(db, "artifacts", appId, "public/data/companies"));
            companiesListener = onSnapshot(companiesQuery, (querySnapshot) => {
                const companies = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!companyList) return;
                companyList.innerHTML = '';
                companies.forEach(c => {
                    const li = document.createElement('li');
                    li.className = 'flex flex-col sm:flex-row justify-between items-start sm:items-center bg-gray-100 p-3 rounded-md';
                    const statusClass = c.status === 'inactive' ? 'text-orange-500' : 'text-green-500';
                    const statusText = c.status === 'inactive' ? 'Inativa' : 'Ativa';
                    let actionButtons;
                    if (c.status === 'inactive') {
                        actionButtons = `<button data-id="${c.id}" class="reactivate-company-btn bg-yellow-500 text-white px-3 py-1 rounded-md text-sm hover:bg-yellow-600">Reativar</button>`;
                    } else {
                        actionButtons = `<button data-id="${c.id}" class="deactivate-company-btn bg-gray-500 text-white px-3 py-1 rounded-md text-sm hover:bg-gray-600">Inativar</button>`;
                    }
                    li.innerHTML = `<div><span class="font-bold">${c.name}</span> <span class="text-sm ${statusClass}">(${statusText})</span></div><div class="mt-2 sm:mt-0 flex flex-wrap gap-2"><button data-company-name="${c.name}" class="view-access-link-btn bg-teal-500 text-white px-3 py-1 rounded-md text-sm hover:bg-teal-600">Link de Acesso</button><button data-company-id="${c.id}" data-company-name="${c.name}" class="manage-company-users-btn bg-purple-500 text-white px-3 py-1 rounded-md text-sm hover:bg-purple-600">Usuários</button><button data-company-id="${c.id}" data-company-name="${c.name}" class="manage-company-keywords-btn bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600">Palavras-Chave</button><button data-company-id="${c.id}" data-company-name="${c.name}" class="manage-company-settings-btn bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600">Opções</button>${actionButtons}<button data-company-id="${c.id}" data-company-name="${c.name}" class="delete-company-btn bg-red-600 text-white px-3 py-1 rounded-md text-sm hover:bg-red-800">Excluir</button></div>`;
                    companyList.appendChild(li);
                });
            }, (error) => {
                console.error("Error listening to companies collection:", error);
                showAlert("Erro ao carregar lista de empresas.", "error");
            });
        }
        async function handleCompanySubmit(e) { e.preventDefault(); const name = document.getElementById('company-name-input').value.trim(); if(!name) { showAlert('O nome da empresa é obrigatório.', 'error'); return; } try { const q = query(collection(db, "artifacts", appId, "public/data/companies"), where("name", "==", name.toUpperCase())); const querySnapshot = await getDocs(q); if (!querySnapshot.empty) { showAlert('Este nome de empresa já existe.', 'error'); return; } await addDoc(collection(db, "artifacts", appId, "public/data/companies"), { name: name.toUpperCase(), status: 'active' }); showAlert('Empresa adicionada com sucesso!'); if(companyForm) companyForm.reset(); } catch (error) { console.error("Error adding company:", error); showAlert("Erro ao adicionar empresa.", "error"); } }
        async function handleCompanyActions(e) { const target = e.target; const companyId = target.dataset.id || target.dataset.companyId; if (target.classList.contains('view-access-link-btn')) { const companyName = target.dataset.companyName; const baseUrl = window.location.origin + window.location.pathname; const accessUrl = `${baseUrl}?company=${encodeURIComponent(companyName)}`; if(accessLinkInput) accessLinkInput.value = accessUrl; if(linkModal) linkModal.classList.remove('hidden'); return; } if (!companyId) return; const companyRef = doc(db, "artifacts", appId, "public/data/companies", companyId); try { if (target.classList.contains('deactivate-company-btn')) { await updateDoc(companyRef, { status: 'inactive', deactivationDate: new Date().toISOString() }); } else if (target.classList.contains('reactivate-company-btn')) { await updateDoc(companyRef, { status: 'active', deactivationDate: null }); } else if (target.classList.contains('delete-company-btn')) { companyIdToDelete = companyId; if(companyNameToDeleteEl) companyNameToDeleteEl.textContent = target.dataset.companyName; if(deleteModal) deleteModal.classList.remove('hidden'); } else if (target.classList.contains('manage-company-keywords-btn')) { selectedCompanyForManagement = { id: target.dataset.companyId, name: target.dataset.companyName }; updateView('company-keyword-admin'); } else if (target.classList.contains('manage-company-settings-btn')) { selectedCompanyForManagement = { id: target.dataset.companyId, name: target.dataset.companyName }; updateView('company-settings-admin'); } else if (target.classList.contains('manage-company-users-btn')) { selectedCompanyForManagement = { id: target.dataset.companyId, name: target.dataset.companyName }; updateView('company-user-admin'); } } catch (error) { console.error("Error handling company action:", error); showAlert("Ocorreu um erro.", "error"); } }

        // --- LÓGICA DE EXCLUSÃO DE EMPRESA ---
        async function handleConfirmDelete() {
            if (!companyIdToDelete || !confirmDeleteBtn || !deleteModal) return;
            confirmDeleteBtn.disabled = true;
            confirmDeleteBtn.textContent = 'Excluindo...';
            try {
                const deleteCompany = httpsCallable(functions, 'deleteCompany');
                await deleteCompany({ appId, companyId: companyIdToDelete });
                showAlert('Empresa e todos os dados associados foram excluídos.');
            } catch (error) {
                console.error("Erro ao excluir empresa:", error);
                showAlert(`Erro: ${error.message}`, 'error');
            } finally {
                deleteModal.classList.add('hidden');
                confirmDeleteBtn.disabled = false;
                confirmDeleteBtn.textContent = 'Sim, excluir';
                companyIdToDelete = null;
            }
        }

        // --- LÓGICA DE GERENCIAMENTO DE USUÁRIOS (PELO SUPER ADMIN) ---
        async function renderCompanyUserAdminPage() { if (!selectedCompanyForManagement || !companyUserAdminTitle) return; companyUserAdminTitle.textContent = `Gerenciar Usuários para: ${selectedCompanyForManagement.name}`; renderUsersForSelectedCompany(); }
        async function renderUsersForSelectedCompany() { try { const usersRef = collection(db, "artifacts", appId, "users", selectedCompanyForManagement.id, "users"); const querySnapshot = await getDocs(usersRef); const companyUsers = querySnapshot.docs.map(doc => ({id: doc.id, ...doc.data()})); if(!adminUserList) return; adminUserList.innerHTML = ''; companyUsers.forEach(user => { const li = document.createElement('li'); li.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-md'; li.innerHTML = `<span>${user.username}</span><div><button data-id="${user.id}" class="edit-user-btn text-blue-500 hover:text-blue-700 mr-2">Editar</button><button data-id="${user.id}" class="delete-user-btn text-red-500 hover:text-red-700">Excluir</button></div>`; adminUserList.appendChild(li); }); } catch (error) { console.error("Error rendering users:", error); } }
        async function handleUserSubmit(e) { e.preventDefault(); const username = userInput.value.trim(), password = userPasswordInput.value.trim(), id = userIdInput.value; if (!username || !password || !selectedCompanyForManagement) return; try { const usersRef = collection(db, "artifacts", appId, "users", selectedCompanyForManagement.id, "users"); const q = query(usersRef, where("username", "==", username)); const querySnapshot = await getDocs(q); if (!querySnapshot.empty && querySnapshot.docs[0].id !== id) { showAlert('Este nome de usuário já está em uso nesta empresa.', 'error'); return; } if (id) { await updateDoc(doc(db, "artifacts", appId, "users", selectedCompanyForManagement.id, "users", id), { username, password }); } else { await addDoc(usersRef, { username, password }); } if(userInput) userInput.value = ''; if(userPasswordInput) userPasswordInput.value = ''; if(userIdInput) userIdInput.value = ''; renderUsersForSelectedCompany(); } catch (error) { console.error("Error saving user:", error); showAlert("Erro ao salvar usuário.", "error"); } }
        async function handleUserActions(e) { if (!selectedCompanyForManagement) return; const id = e.target.dataset.id; if (!id) return; try { if (e.target.classList.contains('edit-user-btn')) { const userDoc = await getDoc(doc(db, "artifacts", appId, "users", selectedCompanyForManagement.id, "users", id)); if (userDoc.exists()) { const user = userDoc.data(); if(userInput) userInput.value = user.username; if(userPasswordInput) userPasswordInput.value = user.password; if(userIdInput) userIdInput.value = id; if(userInput) userInput.focus(); } } if (e.target.classList.contains('delete-user-btn')) { await deleteDoc(doc(db, "artifacts", appId, "users", selectedCompanyForManagement.id, "users", id)); renderUsersForSelectedCompany(); } } catch (error) { console.error("Error handling user action:", error); } }

        // --- LÓGICA DE GERENCIAMENTO DE PALAVRAS-CHAVE (PELO SUPER ADMIN) ---
        async function renderCompanyKeywordAdminPage() { if (!selectedCompanyForManagement || !companyKeywordAdminTitle) return; companyKeywordAdminTitle.textContent = `Gerenciar Palavras-Chave para: ${selectedCompanyForManagement.name}`; renderKeywordsForSelectedCompany(); }
        async function renderKeywordsForSelectedCompany() { try { const keywordsRef = collection(db, "artifacts", appId, "users", selectedCompanyForManagement.id, "keywords"); const querySnapshot = await getDocs(keywordsRef); const keywords = querySnapshot.docs.map(doc => ({id: doc.id, ...doc.data()})); if(!adminKeywordList) return; adminKeywordList.innerHTML = ''; keywords.forEach(kw => { const li = document.createElement('li'); li.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-md'; li.innerHTML = `<span>${kw.word}</span><div><button data-id="${kw.id}" class="edit-keyword-btn text-blue-500 hover:text-blue-700 mr-2">Editar</button><button data-id="${kw.id}" data-word="${kw.word}" class="delete-keyword-btn text-red-500 hover:text-red-700">Excluir</button></div>`; adminKeywordList.appendChild(li); }); } catch (error) { console.error("Error rendering keywords:", error); } }
        async function handleKeywordSubmit(e) { e.preventDefault(); const word = keywordInput.value.trim(), id = keywordIdInput.value; if (!word || !selectedCompanyForManagement) return; try { const keywordsRef = collection(db, "artifacts", appId, "users", selectedCompanyForManagement.id, "keywords"); if (id) { await updateDoc(doc(db, "artifacts", appId, "users", selectedCompanyForManagement.id, "keywords", id), { word }); } else { await addDoc(keywordsRef, { word }); } if(keywordInput) keywordInput.value = ''; if(keywordIdInput) keywordIdInput.value = ''; renderKeywordsForSelectedCompany(); } catch (error) { console.error("Error saving keyword:", error); } }
        async function handleKeywordActions(e) { 
            if (!selectedCompanyForManagement) return; 
            const target = e.target.closest('button');
            if (!target) return;
            const id = target.dataset.id; 
            if (!id) return; 
            try { 
                if (target.classList.contains('edit-keyword-btn')) { 
                    const kwDoc = await getDoc(doc(db, "artifacts", appId, "users", selectedCompanyForManagement.id, "keywords", id)); 
                    if (kwDoc.exists()) { 
                        const kw = kwDoc.data(); 
                        if(keywordInput) keywordInput.value = kw.word; 
                        if(keywordIdInput) keywordIdInput.value = id; 
                        if(keywordInput) keywordInput.focus(); 
                    } 
                } 
                if (target.classList.contains('delete-keyword-btn')) { 
                    keywordToDeleteInfo = {
                        id: id,
                        word: target.dataset.word
                    };
                    if(keywordToDeleteNameEl) keywordToDeleteNameEl.textContent = keywordToDeleteInfo.word;
                    if(confirmDeleteKeywordModal) confirmDeleteKeywordModal.classList.remove('hidden');
                } 
            } catch (error) { 
                console.error("Error handling keyword action:", error);
                showAlert(`Erro: ${error.message}`, 'error');
            } 
        }

        async function handleConfirmDeleteKeyword() {
            if (!keywordToDeleteInfo || !confirmDeleteKeywordBtn || !confirmDeleteKeywordModal) return;
            confirmDeleteKeywordBtn.disabled = true;
            confirmDeleteBtn.textContent = 'Excluindo...';
            try {
                const deleteKeyword = httpsCallable(functions, 'deleteKeywordAndArticles');
                await deleteKeyword({ appId, companyId: selectedCompanyForManagement.id, keyword: keywordToDeleteInfo.word });
                showAlert('Palavra-chave e alertas associados foram excluídos.', 'success');
                renderKeywordsForSelectedCompany();
            } catch (error) {
                console.error("Erro ao excluir palavra-chave:", error);
                showAlert(`Erro: ${error.message}`, 'error');
            } finally {
                confirmDeleteKeywordModal.classList.add('hidden');
                confirmDeleteKeywordBtn.disabled = false;
                confirmDeleteKeywordBtn.textContent = 'Sim, excluir';
                keywordToDeleteInfo = null;
            }
        }
        
        // --- LÓGICA DE GERENCIAMENTO DE CONFIGURAÇÕES ---
        async function renderCompanySettingsAdminPage() { if (!selectedCompanyForManagement || !companySettingsAdminTitle) return; companySettingsAdminTitle.textContent = `Opções para: ${selectedCompanyForManagement.name}`; try { const settingsRef = doc(db, "artifacts", appId, "public/data/settings", selectedCompanyForManagement.id); const docSnap = await getDoc(settingsRef); if (docSnap.exists()) { const settings = docSnap.data(); if(reportAccessToggle) reportAccessToggle.checked = settings.reportAccess !== false; if(fetchOnlyNewToggle) fetchOnlyNewToggle.checked = settings.fetchOnlyNew === true; if(deletionAccessToggle) deletionAccessToggle.checked = settings.canRequestDeletion === true; if(document.querySelector(`input[name="news-scope"][value="${settings.searchScope || 'br'}"]`)) document.querySelector(`input[name="news-scope"][value="${settings.searchScope || 'br'}"]`).checked = true; if(stateSelect) stateSelect.value = settings.searchState || ''; } else { if(reportAccessToggle) reportAccessToggle.checked = true; if(fetchOnlyNewToggle) fetchOnlyNewToggle.checked = false; if(deletionAccessToggle) deletionAccessToggle.checked = false; if(document.querySelector('input[name="news-scope"][value="br"]')) document.querySelector('input[name="news-scope"][value="br"]').checked = true; if(stateSelect) stateSelect.value = ''; } handleScopeChange(); } catch (error) { console.error("Error rendering settings:", error); } }
        async function handleSettingsChange(e) { if (!selectedCompanyForManagement) return; const settingsRef = doc(db, "artifacts", appId, "public/data/settings", selectedCompanyForManagement.id); let key, value; switch (e.target.id) { case 'report-access-toggle': key = 'reportAccess'; value = e.target.checked; break; case 'fetch-only-new-toggle': key = 'fetchOnlyNew'; value = e.target.checked; break; case 'deletion-access-toggle': key = 'canRequestDeletion'; value = e.target.checked; break; case 'state-select': key = 'searchState'; value = e.target.value; break; default: if (e.target.name === 'news-scope') { key = 'searchScope'; value = e.target.value; } else { return; } } try { await setDoc(settingsRef, { [key]: value }, { merge: true }); showAlert('Opção salva!', 'success'); } catch (error) { console.error("Error saving setting:", error); } }
        function handleScopeChange() { if(!stateSelectContainer || !document.querySelector('input[name="news-scope"]:checked')) return; const selectedScope = document.querySelector('input[name="news-scope"]:checked').value; stateSelectContainer.classList.toggle('hidden', selectedScope !== 'state'); }
        async function renderGlobalKeysPage() { try { const settingsRef = doc(db, "artifacts", appId, "public/data/settings", "global"); const docSnap = await getDoc(settingsRef); if (docSnap.exists()) { const settings = docSnap.data(); if(apiKeyNewsApiInput) apiKeyNewsApiInput.value = settings.apiKeyNewsApi || ''; if(apiKeyGNewsInput1) apiKeyGNewsInput1.value = settings.apiKeyGNews1 || ''; if(apiKeyGNewsInput2) apiKeyGNewsInput2.value = settings.apiKeyGNews2 || ''; if(apiKeyGNewsInput3) apiKeyGNewsInput3.value = settings.apiKeyGNews3 || ''; if(apiKeyGNewsInput4) apiKeyGNewsInput4.value = settings.apiKeyGNews4 || ''; if(apiKeyFirebaseNewsInput) apiKeyFirebaseNewsInput.value = settings.apiKeyFirebaseNews || ''; if(apiKeyYoutubeInput) apiKeyYoutubeInput.value = settings.apiKeyYoutube || ''; if(apiKeyBloggerInput) apiKeyBloggerInput.value = settings.apiKeyBlogger || ''; if(apiKeyVisionInput) apiKeyVisionInput.value = settings.apiKeyVision || ''; if(apiKeyVideoIntelligenceInput) apiKeyVideoIntelligenceInput.value = settings.apiKeyVideoIntelligence || ''; } } catch (error) { console.error("Error loading global API keys:", error); } }
        async function handleGlobalKeyChange(e) { const settingsRef = doc(db, "artifacts", appId, "public/data/settings", "global"); const key = e.target.id; const value = e.target.value; try { await setDoc(settingsRef, { [key]: value }, { merge: true }); showAlert('Chave de API salva!', 'success'); } catch (error) { console.error("Error saving global API key:", error); } }
        async function renderGlobalSourcesPage() { try { const settingsRef = doc(db, "artifacts", appId, "public/data/settings", "global"); const docSnap = await getDoc(settingsRef); if (docSnap.exists()) { const settings = docSnap.data(); if(bloggerIdInput) bloggerIdInput.value = settings.bloggerId || ''; if(rssUrlInput) rssUrlInput.value = settings.rssUrl || ''; } } catch (error) { console.error("Error loading global sources:", error); } }
        
        function cleanAndSaveTextarea(e) {
            const textarea = e.target;
            const lines = textarea.value.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            const uniqueLines = [...new Set(lines)];
            const cleanedValue = uniqueLines.join('\n');
            textarea.value = cleanedValue; // Update UI
            return cleanedValue;
        }

        async function handleGlobalSourceChange(e) {
            const cleanedValue = cleanAndSaveTextarea(e);
            const settingsRef = doc(db, "artifacts", appId, "public/data/settings", "global");
            const key = e.target.id;
            try {
                await setDoc(settingsRef, { [key]: cleanedValue }, { merge: true });
                showAlert('Fonte salva!', 'success');
            } catch (error) {
                console.error("Error saving global source:", error);
            }
        }

        // --- LÓGICA DE NOTIFICAÇÃO ---
        function setupNotificationListener() {
            if (notificationListener) notificationListener();
            if (!currentUser || currentUser.isSuperAdmin) return;
            const settingsRef = doc(db, "artifacts", appId, "public/data/settings", currentUser.companyId);
            notificationListener = onSnapshot(settingsRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    const count = data.newAlertsCount || 0;
                    if (count > 0) {
                        if(notificationBadge) notificationBadge.textContent = count;
                        if(notificationBadge) notificationBadge.classList.remove('hidden');
                        if(notificationBell) notificationBell.classList.add('animate-blinking-bell');
                    } else {
                        if(notificationBadge) notificationBadge.classList.add('hidden');
                        if(notificationBell) notificationBell.classList.remove('animate-blinking-bell');
                    }
                }
            });
        }

        async function showOnlyNewAlerts() {
            if (!currentUser) return;
            
            const settingsRef = doc(db, "artifacts", appId, "public/data/settings", currentUser.companyId);
            const docSnap = await getDoc(settingsRef);
            const count = docSnap.exists() ? (docSnap.data().newAlertsCount || 0) : 0;

            if (count === 0) {
                showAlert("Não há novos alertas para mostrar.", "success");
                return;
            }

            if(newsAlerts) newsAlerts.innerHTML = '<p class="text-gray-500">A carregar novos alertas...</p>';
            try {
                const q = query(collection(db, "artifacts", appId, "users", currentUser.companyId, "articles"), orderBy("publishedAt", "desc"), limit(count));
                const articlesSnapshot = await getDocs(q);
                if(newsAlerts) newsAlerts.innerHTML = '';
                if (articlesSnapshot.empty) {
                    if(newsAlerts) newsAlerts.innerHTML = '<p class="text-gray-500">Nenhum alerta novo encontrado.</p>';
                } else {
                    const articles = articlesSnapshot.docs.map(d => ({...d.data(), id: d.id}));
                    articles.forEach(article => displayNewsAlert(article, newsAlerts));
                }
                if(showAllAlertsBtn) showAllAlertsBtn.classList.remove('hidden');

                await setDoc(settingsRef, { newAlerts: false, newAlertsCount: 0 }, { merge: true });
                if(notificationBadge) notificationBadge.classList.add('hidden');
                if(notificationBell) notificationBell.classList.remove('animate-blinking-bell');

            } catch (error) {
                console.error("Error fetching new alerts:", error);
                if(newsAlerts) newsAlerts.innerHTML = '<p class="text-red-500">Erro ao carregar novos alertas.</p>';
            }
        }

        // --- LÓGICA DE EXIBIÇÃO DE ALERTA E SENTIMENTO ---
        function displayNewsAlert(article, container) {
            const pubDate = new Date(article.publishedAt.seconds ? article.publishedAt.toDate() : article.publishedAt);
            const formattedDate = pubDate.toLocaleDateString('pt-BR');
            const dateForFilter = pubDate.toISOString().split('T')[0];
            
            const alertEl = document.createElement('div');
            alertEl.className = 'bg-white p-4 rounded-lg shadow-md border-l-4 border-green-500 fade-in';
            alertEl.dataset.id = article.id;
            alertEl.dataset.date = dateForFilter;
            alertEl.dataset.keyword = article.keyword;
            alertEl.dataset.title = article.title.toLowerCase();
            alertEl.dataset.description = article.description ? article.description.toLowerCase() : '';

            const getSentimentHTML = (score) => {
                let emoji = '😐'; let color = 'gray'; let text = 'Neutro';
                if (score > 0.2) { emoji = '😊'; color = 'green'; text = 'Positivo'; } 
                else if (score < -0.2) { emoji = '😠'; color = 'red'; text = 'Negativo'; }
                return `<button class="sentiment-btn text-xs font-semibold text-${color}-600 bg-${color}-100 px-2 py-1 rounded-full">${emoji} ${text}</button>`;
            };

            const sentimentMenuHTML = `
                <div class="sentiment-menu p-1 space-y-1">
                    <button data-sentiment="0.5" class="sentiment-option w-full text-left text-xs px-2 py-1 rounded hover:bg-gray-100">😊 Positivo</button>
                    <button data-sentiment="0.0" class="sentiment-option w-full text-left text-xs px-2 py-1 rounded hover:bg-gray-100">😐 Neutro</button>
                    <button data-sentiment="-0.5" class="sentiment-option w-full text-left text-xs px-2 py-1 rounded hover:bg-gray-100">😠 Negativo</button>
                </div>`;

            let entitiesHTML = '';
            if (article.entities && article.entities.length > 0) {
                entitiesHTML = `<div class="mt-2 flex flex-wrap gap-2">${article.entities.map(e => `<span class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-full">${e}</span>`).join('')}</div>`;
            }

            const deleteButtonHTML = currentUser && currentUser.canRequestDeletion ? `<button class="request-delete-btn text-red-500 hover:text-red-700 ml-4" title="Solicitar Exclusão">🗑️</button>` : '';

            alertEl.innerHTML = `
                <div class="flex justify-between items-start">
                    <h4 class="text-lg font-bold text-gray-800 pr-2">${article.title}</h4>
                    <div class="flex items-center gap-2">
                        <span class="flex-shrink-0 text-xs font-semibold bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full">${article.keyword}</span>
                        <div class="sentiment-container relative">
                            ${getSentimentHTML(article.sentiment ? article.sentiment.score : 0)}
                            ${sentimentMenuHTML}
                        </div>
                    </div>
                </div>
                <p class="text-sm text-gray-600 mt-2">${article.description || 'Descrição não disponível.'}</p>
                ${entitiesHTML}
                <div class="text-xs text-gray-500 mt-3 flex justify-between items-center">
                    <span>Fonte: ${article.source.name} | Publicado: ${formattedDate}</span>
                    <div>
                        <a href="${article.url}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline font-semibold">Ler mais &rarr;</a>
                        ${deleteButtonHTML}
                    </div>
                </div>`;
            container.appendChild(alertEl);
        }
        
        async function handleSentimentChange(e) {
            const newScore = parseFloat(e.target.dataset.sentiment);
            const alertEl = e.target.closest('.fade-in');
            const articleId = alertEl.dataset.id;

            if (!articleId || !currentUser) return;

            try {
                const articleRef = doc(db, "artifacts", appId, "users", currentUser.companyId, "articles", articleId);
                await updateDoc(articleRef, {
                    "sentiment.score": newScore
                });

                const sentimentContainer = alertEl.querySelector('.sentiment-container');
                let emoji = '😐'; let color = 'gray'; let text = 'Neutro';
                if (newScore > 0.2) { emoji = '😊'; color = 'green'; text = 'Positivo'; } 
                else if (newScore < -0.2) { emoji = '😠'; color = 'red'; text = 'Negativo'; }
                const newButtonHTML = `<button class="sentiment-btn text-xs font-semibold text-${color}-600 bg-${color}-100 px-2 py-1 rounded-full">${emoji} ${text}</button>`;
                sentimentContainer.querySelector('.sentiment-btn').outerHTML = newButtonHTML;

            } catch (error) {
                console.error("Error updating sentiment:", error);
                showAlert("Erro ao atualizar o sentimento.", "error");
            }
        }

        async function populateInitialAlerts() {
            if (!currentUser || !newsAlerts) return;
            if (showAllAlertsBtn) showAllAlertsBtn.classList.add('hidden');
            newsAlerts.innerHTML = '<p class="text-gray-500">Carregando alertas...</p>';
            try {
                const q = query(collection(db, "artifacts", appId, "users", currentUser.companyId, "articles"), orderBy("publishedAt", "desc"), limit(100));
                const articlesSnapshot = await getDocs(q);
                newsAlerts.innerHTML = '';
                if (articlesSnapshot.empty) {
                    newsAlerts.innerHTML = '<p class="text-gray-500">Nenhum alerta encontrado.</p>';
                } else {
                    const articles = articlesSnapshot.docs.map(d => ({...d.data(), id: d.id}));
                    articles.forEach(article => displayNewsAlert(article, newsAlerts));
                }
                filterAlertsByDate();
            } catch (error) {
                console.error("Error populating alerts:", error);
                newsAlerts.innerHTML = '<p class="text-red-500">Erro ao carregar alertas.</p>';
            }
        }
        function filterAlertsByDate() { if(!newsAlerts || !alertDateFilter) return; const selectedDate = alertDateFilter.value; const allAlerts = newsAlerts.querySelectorAll('.fade-in'); let visibleCount = 0; allAlerts.forEach(alert => { const isVisible = !selectedDate || alert.dataset.date === selectedDate; alert.style.display = isVisible ? 'block' : 'none'; if(isVisible) visibleCount++; }); if(visibleCount === 0 && !newsAlerts.querySelector('.text-gray-500')) { newsAlerts.insertAdjacentHTML('beforeend', `<p class="text-gray-500">Nenhum alerta encontrado para a data selecionada.</p>`); } else if (visibleCount > 0) { const noAlertsMsg = newsAlerts.querySelector('.text-gray-500'); if (noAlertsMsg) noAlertsMsg.remove(); } }
        
        // --- LÓGICA DA PÁGINA DE RELATÓRIO ---
        async function renderReportPage() {
            if (!currentUser) return;
            const articlesQuery = query(collection(db, "artifacts", appId, "users", currentUser.companyId, "articles"), orderBy("publishedAt", "desc"));
            const keywordsQuery = query(collection(db, "artifacts", appId, "users", currentUser.companyId, "keywords"));

            const [articlesSnapshot, keywordsSnapshot] = await Promise.all([getDocs(articlesQuery), getDocs(keywordsQuery)]);
            
            allCompanyArticles = articlesSnapshot.docs.map(doc => doc.data());
            const keywords = keywordsSnapshot.docs.map(doc => doc.data().word);

            if (reportKeywordFilter) {
              reportKeywordFilter.innerHTML = '';
              keywords.forEach(kw => {
                  const option = document.createElement('option');
                  option.value = kw;
                  option.textContent = kw;
                  reportKeywordFilter.appendChild(option);
              });
            }
            
            const updateCharts = () => {
                const startDate = startDateInput && startDateInput.value ? new Date(startDateInput.value) : null;
                const endDate = endDateInput && endDateInput.value ? new Date(endDateInput.value) : null;
                const selectedKeywords = reportKeywordFilter ? Array.from(reportKeywordFilter.selectedOptions).map(option => option.value) : [];

                if (startDate) startDate.setHours(0, 0, 0, 0);
                if (endDate) endDate.setHours(23, 59, 59, 999);

                const filteredArticles = allCompanyArticles.filter(article => {
                    const pubDate = article.publishedAt.toDate();
                    const dateMatch = (!startDate || pubDate >= startDate) && (!endDate || pubDate <= endDate);
                    const keywordMatch = (selectedKeywords.length === 0 || selectedKeywords.includes(article.keyword));
                    return dateMatch && keywordMatch;
                });
                const keywordsToDisplay = selectedKeywords.length > 0 ? selectedKeywords : keywords;
                renderSourceChart(filteredArticles, keywordsToDisplay);
                renderDateChart(filteredArticles, keywordsToDisplay);
                renderSentimentChart(filteredArticles, keywordsToDisplay);
                renderChannelChart(filteredArticles, keywordsToDisplay);
            };
            
            if (startDateInput) startDateInput.addEventListener('change', updateCharts);
            if (endDateInput) endDateInput.addEventListener('change', updateCharts);
            if (reportKeywordFilter) reportKeywordFilter.addEventListener('change', updateCharts);
            updateCharts();
        }
        
        const chartColors = ['#4F46E5', '#06B6D4', '#F59E0B', '#10B981', '#EF4444', '#8B5CF6', '#EC4899'];

        function createChart(canvasId, instanceVar, type, data, customOptions = {}) {
            const canvasEl = document.getElementById(canvasId);
            if (!canvasEl) return;
            if (instanceVar) instanceVar.destroy();
            const ctx = canvasEl.getContext('2d');
            const defaultOptions = { 
                responsive: true, 
                interaction: { mode: 'index', intersect: false }, 
                plugins: { legend: { position: 'top' } } 
            };
            const options = { ...defaultOptions, ...customOptions };
            return new Chart(ctx, { type, data, options });
        }

        function renderSourceChart(articles, selectedKeywords) {
            const datasets = [];
            if (selectedKeywords.length === 0) { if(sourceChartInstance) sourceChartInstance.destroy(); return; }
            const allSources = [...new Set(articles.map(a => a.source.name))].sort();
            
            selectedKeywords.forEach((keyword, index) => {
                const keywordArticles = articles.filter(a => a.keyword === keyword);
                const sourceCounts = allSources.map(source => keywordArticles.filter(a => a.source.name === source).length);
                datasets.push({
                    label: keyword,
                    data: sourceCounts,
                    borderColor: chartColors[index % chartColors.length],
                    fill: false
                });
            });
            sourceChartInstance = createChart('source-chart', sourceChartInstance, 'line', { labels: allSources, datasets });
        }
        
        function getChannelCategory(sourceName) {
            const name = sourceName.toLowerCase();
            if (name.includes('youtube')) return 'YouTube';
            if (name.includes('globo') || name.includes('g1') || name.includes('uol') || name.includes('terra') || name.includes('r7')) return 'Sites';
            if (name.includes('veja') || name.includes('istoé') || name.includes('exame')) return 'Revistas';
            if (name.includes('cbn') || name.includes('bandeirantes')) return 'Rádios';
            return 'Sites';
        }

        function renderChannelChart(articles, selectedKeywords) {
            const datasets = [];
            if (selectedKeywords.length === 0) { if(channelChartInstance) channelChartInstance.destroy(); return; };
            const allChannels = ['YouTube', 'Sites', 'Revistas', 'Rádios'];

            selectedKeywords.forEach((keyword, index) => {
                const keywordArticles = articles.filter(a => a.keyword === keyword);
                const channelCounts = allChannels.map(channel => keywordArticles.filter(a => getChannelCategory(a.source.name) === channel).length);
                datasets.push({
                    label: keyword,
                    data: channelCounts,
                    borderColor: chartColors[index % chartColors.length],
                    fill: false
                });
            });
            channelChartInstance = createChart('channel-chart', channelChartInstance, 'line', { labels: allChannels, datasets });
        }

        function renderDateChart(articles, selectedKeywords) {
            const datasets = [];
            if (selectedKeywords.length === 0) { if(dateChartInstance) dateChartInstance.destroy(); return; };

            const allDates = [...new Set(articles.map(a => a.publishedAt.toDate().toLocaleDateString('pt-BR')))]
                .sort((a, b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));

            selectedKeywords.forEach((keyword, index) => {
                const keywordArticles = articles.filter(a => a.keyword === keyword);
                const dateCounts = allDates.map(date => keywordArticles.filter(a => a.publishedAt.toDate().toLocaleDateString('pt-BR') === date).length);
                datasets.push({
                    label: keyword,
                    data: dateCounts,
                    borderColor: chartColors[index % chartColors.length],
                    fill: false,
                    tension: 0.1
                });
            });
            dateChartInstance = createChart('date-chart', dateChartInstance, 'line', { labels: allDates, datasets });
        }
        
        function renderSentimentChart(articles, selectedKeywords) {
            const datasets = [];
            if (selectedKeywords.length === 0) { if(sentimentChartInstance) sentimentChartInstance.destroy(); return; };
            const allSentiments = ['Positivo', 'Neutro', 'Negativo'];

            selectedKeywords.forEach((keyword, index) => {
                const keywordArticles = articles.filter(a => a.keyword === keyword);
                const sentimentCounts = { positive: 0, neutral: 0, negative: 0 };
                
                keywordArticles.forEach(article => {
                    if (article.sentiment) {
                        const score = article.sentiment.score;
                        if (score > 0.2) sentimentCounts.positive++;
                        else if (score < -0.2) sentimentCounts.negative++;
                        else sentimentCounts.neutral++;
                    } else {
                        sentimentCounts.neutral++;
                    }
                });

                const totalSentiments = sentimentCounts.positive + sentimentCounts.neutral + sentimentCounts.negative;
                
                const dataInPercentage = totalSentiments > 0 ? [
                    (sentimentCounts.positive / totalSentiments) * 100,
                    (sentimentCounts.neutral / totalSentiments) * 100,
                    (sentimentCounts.negative / totalSentiments) * 100
                ] : [0, 0, 0];

                datasets.push({
                    label: keyword,
                    data: dataInPercentage,
                    borderColor: chartColors[index % chartColors.length],
                    fill: false
                });
            });

            const sentimentChartOptions = {
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(2) + '%';
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        ticks: {
                            callback: function(value) { return value + '%'; }
                        },
                        min: 0,
                        max: 100
                    }
                }
            };
            
            sentimentChartInstance = createChart('sentiment-chart', sentimentChartInstance, 'line', { labels: allSentiments, datasets }, sentimentChartOptions);
        }

        // --- LÓGICA DA PÁGINA DE PESQUISA ---
        async function setupSearchPage() { if (!currentUser) return; if(searchInput) searchInput.value = ''; if(searchResults) searchResults.innerHTML = '<p class="text-gray-500">Carregando todos os artigos para pesquisa...</p>'; try { const q = query(collection(db, "artifacts", appId, "users", currentUser.companyId, "articles"), orderBy("publishedAt", "desc")); const articlesSnapshot = await getDocs(q); allCompanyArticles = articlesSnapshot.docs.map(d => ({...d.data(), id: d.id})); if(searchResults) searchResults.innerHTML = `<p class="text-gray-500">Pronto para pesquisar em ${allCompanyArticles.length} artigos. Digite um termo ou use os filtros.</p>`; setupFilters(); } catch (error) { console.error("Error fetching articles for search:", error); if(searchResults) searchResults.innerHTML = '<p class="text-red-500">Não foi possível carregar os artigos para pesquisa.</p>'; } }
        function setupFilters() { if(!filterContainer) return; filterContainer.innerHTML = ''; const keywords = [...new Set(allCompanyArticles.map(a => a.keyword))]; if (keywords.length > 0) { let keywordButtons = keywords.map(kw => `<button class="filter-btn bg-gray-200 hover:bg-indigo-200 text-gray-800 text-sm font-medium px-3 py-1 rounded-full" data-keyword="${kw}">${kw}</button>`).join(''); filterContainer.innerHTML = `<div class="flex flex-wrap gap-2"><span class="font-semibold self-center">Filtar por Palavra-Chave:</span>${keywordButtons}</div>`; } }
        function handleSearch() { if(!searchInput || !searchResults || !filterContainer) return; const searchTerm = searchInput.value.toLowerCase().trim(); const activeFilter = filterContainer.querySelector('.bg-indigo-500'); const keywordFilter = activeFilter ? activeFilter.dataset.keyword : null; if (!searchTerm && !keywordFilter) { searchResults.innerHTML = `<p class="text-gray-500">Digite algo para começar a pesquisar ou use os filtros.</p>`; return; } let filteredArticles = allCompanyArticles; if (keywordFilter) { filteredArticles = filteredArticles.filter(a => a.keyword === keywordFilter); } if (searchTerm) { filteredArticles = filteredArticles.filter(a => a.title.toLowerCase().includes(searchTerm) || (a.description && a.description.toLowerCase().includes(searchTerm))); } renderSearchResults(filteredArticles); }
        function renderSearchResults(articles) { if(!searchResults) return; searchResults.innerHTML = ''; if (articles.length === 0) { searchResults.innerHTML = '<p class="text-gray-500">Nenhum resultado encontrado.</p>'; return; } articles.forEach(article => displayNewsAlert(article, searchResults)); }

        // --- LÓGICA DE FILTRO DO DASHBOARD ---
        function handleDashboardKeywordFilter(e) {
            const target = e.target.closest('.keyword-filter');
            if (!target) return;

            const isAlreadyActive = target.classList.contains('active');
            const keywordToFilter = target.dataset.keyword;
            
            document.querySelectorAll('.keyword-filter').forEach(el => el.classList.remove('active'));

            if (isAlreadyActive && keywordToFilter !== 'all') {
                document.querySelector('.keyword-filter[data-keyword="all"]').classList.add('active');
            } else {
                target.classList.add('active');
            }
            
            filterDashboardAlerts();
        }

        function filterDashboardAlerts() {
            if(!dashboardKeywordList || !newsAlerts) return;
            const activeKeywordEl = dashboardKeywordList.querySelector('.keyword-filter.active');
            const selectedKeyword = activeKeywordEl ? activeKeywordEl.dataset.keyword : 'all';
            const allAlerts = newsAlerts.querySelectorAll('.fade-in');
            
            allAlerts.forEach(alert => {
                const keywordMatch = selectedKeyword === 'all' || alert.dataset.keyword === selectedKeyword;
                alert.style.display = keywordMatch ? 'block' : 'none';
            });
        }

        // --- AÇÕES DO CARTÃO DE ALERTA ---
        function handleAlertCardActions(e) {
            const target = e.target;
            if(!target) return;

            if (target.closest('.sentiment-option')) {
                handleSentimentChange(e);
                return;
            }

            if (target.closest('.request-delete-btn')) {
                const alertEl = target.closest('.fade-in');
                if(!alertEl) return;
                articleToDeleteInfo = {
                    id: alertEl.dataset.id,
                    title: alertEl.querySelector('h4').textContent
                };
                if(justificationText) justificationText.value = '';
                if(submitJustificationBtn) submitJustificationBtn.disabled = true; // Desabilita o botão ao abrir
                if(justificationModal) justificationModal.classList.remove('hidden');
            }
        }
        
        // --- LÓGICA DA FILA DE ALERTA PENDENTE DO SUPER ADMIN ---
        function setupPendingAlertsListener() {
            if (pendingAlertsListener) pendingAlertsListener();
            const q = query(collection(db, "artifacts", appId, "public/data/pendingAlerts"), orderBy("publishedAt", "desc"));
            pendingAlertsListener = onSnapshot(q, (snapshot) => {
                renderPendingAlerts(snapshot.docs);
                const pendingCount = snapshot.docs.length;
                if (btnPendingAlerts && btnPendingAlerts.querySelector('#pending-alerts-badge')) {
                    btnPendingAlerts.querySelector('#pending-alerts-badge').textContent = pendingCount;
                    btnPendingAlerts.querySelector('#pending-alerts-badge').classList.toggle('hidden', pendingCount === 0);
                }
            }, (error) => {
                console.error("Erro ao ouvir alertas pendentes:", error);
                if (pendingAlertsList) {
                    pendingAlertsList.innerHTML = '<p class="text-red-500">Erro ao carregar alertas.</p>';
                }
            });
        }
        
        function renderPendingAlerts(docs) {
            if (!pendingAlertsList) return;
            pendingAlertsList.innerHTML = '';
            if (docs.length === 0) {
                pendingAlertsList.innerHTML = '<p class="text-gray-500">Nenhum alerta pendente para aprovação.</p>';
                return;
            }
            docs.forEach(doc => {
                const alert = { id: doc.id, ...doc.data() };
                displayPendingAlert(alert, pendingAlertsList);
            });
        }
        
        async function handlePendingAlertAction(e) {
            const target = e.target;
            const alertEl = target.closest('.fade-in');
            if (!alertEl) return;
            const alertId = alertEl.dataset.id;
            
            if (target.classList.contains('approve-alert-btn')) {
                const approveAlert = httpsCallable(functions, 'approveAlert');
                try {
                    await approveAlert({ appId, alertId });
                    showAlert('Alerta aprovado e enviado para a empresa com sucesso!', 'success');
                } catch (error) {
                    console.error("Erro ao aprovar alerta:", error);
                    showAlert(`Erro ao aprovar alerta: ${error.message}`, 'error');
                }
            } else if (target.classList.contains('reject-alert-btn')) {
                const rejectAlert = httpsCallable(functions, 'rejectAlert');
                try {
                    await rejectAlert({ appId, alertId });
                    showAlert('Alerta rejeitado com sucesso!', 'success');
                } catch (error) {
                    console.error("Erro ao rejeitar alerta:", error);
                    showAlert(`Erro ao rejeitar alerta: ${error.message}`, 'error');
                }
            }
        }
        
        function displayPendingAlert(alert, container) {
            const pubDate = new Date(alert.publishedAt.seconds ? alert.publishedAt.toDate() : alert.publishedAt);
            const formattedDate = pubDate.toLocaleDateString('pt-BR');
            const alertEl = document.createElement('div');
            alertEl.className = 'bg-white p-4 rounded-lg shadow-md border-l-4 border-yellow-500 fade-in';
            alertEl.dataset.id = alert.id;
            alertEl.dataset.companyId = alert.companyId;
            alertEl.innerHTML = `
                <div class="flex justify-between items-start">
                    <h4 class="text-lg font-bold text-gray-800 pr-2">${alert.title}</h4>
                    <span class="flex-shrink-0 text-xs font-semibold bg-gray-100 text-gray-800 px-2 py-1 rounded-full">${alert.companyName} - ${alert.keyword}</span>
                </div>
                <p class="text-sm text-gray-600 mt-2">${alert.description || 'Descrição não disponível.'}</p>
                <div class="text-xs text-gray-500 mt-3 flex justify-between items-center">
                    <span>Fonte: ${alert.source.name} | Publicado: ${formattedDate}</span>
                    <div class="flex gap-2">
                        <button class="approve-alert-btn bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600">Aprovar</button>
                        <button class="reject-alert-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600">Rejeitar</button>
                    </div>
                </div>`;
            container.appendChild(alertEl);
        }

        // --- NOVAS FUNÇÕES DO SUPER ADMIN ---
        async function renderManualAlertPage() {
            const companySelect = document.getElementById('manual-alert-company');
            if (!companySelect) return;
            companySelect.innerHTML = '<option value="">Selecione uma empresa</option>';
            const companiesSnapshot = await getDocs(query(collection(db, "artifacts", appId, "public/data/companies"), where("status", "==", "active")));
            companiesSnapshot.forEach(doc => {
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = doc.data().name;
                companySelect.appendChild(option);
            });
        }

        async function handleManualAlertSubmit(e) {
            e.preventDefault();
            const companyId = document.getElementById('manual-alert-company').value;
            const title = document.getElementById('manual-alert-title').value;
            const description = document.getElementById('manual-alert-desc').value;
            const url = document.getElementById('manual-alert-url').value;
            const source = document.getElementById('manual-alert-source').value;
            const keyword = document.getElementById('manual-alert-keyword').value;

            if (!companyId) {
                showAlert('Por favor, selecione uma empresa.', 'error');
                return;
            }

            try {
                const manualAddAlert = httpsCallable(functions, 'manualAddAlert');
                await manualAddAlert({ appId, companyId, title, description, url, source, keyword });
                showAlert('Alerta manual adicionado com sucesso!', 'success');
                if (manualAlertForm) manualAlertForm.reset();
            } catch (error) {
                console.error("Erro ao adicionar alerta manual:", error);
                showAlert(`Erro: ${error.message}`, 'error');
            }
        }

        function setupDeletionRequestsListener() {
            if (deletionRequestsListener) deletionRequestsListener();
            const q = query(collection(db, "artifacts", appId, "public/data/deletionRequests"), orderBy("requestedAt", "desc"));
            deletionRequestsListener = onSnapshot(q, (snapshot) => {
                renderDeletionRequests(snapshot.docs);
                const pendingCount = snapshot.docs.filter(doc => doc.data().status === 'pending').length;
                if (deletionRequestsBadge) {
                    deletionRequestsBadge.textContent = pendingCount;
                    deletionRequestsBadge.classList.toggle('hidden', pendingCount === 0);
                }
            }, (error) => {
                console.error("Erro ao ouvir solicitações de exclusão:", error);
                if (deletionRequestsList) {
                    deletionRequestsList.innerHTML = '<p class="text-red-500">Erro ao carregar solicitações.</p>';
                }
            });
        }

        function renderDeletionRequests(docs) {
            if (!deletionRequestsList) return;
            deletionRequestsList.innerHTML = '';
            if (docs.length === 0) { // Alterado de docs.empty para docs.length
                deletionRequestsList.innerHTML = '<p class="text-gray-500">Nenhuma solicitação de exclusão encontrada.</p>';
                return;
            }
            docs.forEach(doc => {
                const request = doc.data();
                const reqEl = document.createElement('div');
                reqEl.className = 'bg-white p-4 rounded-lg shadow';
                const statusColor = request.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : (request.status === 'approved' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800');
                
                let buttonsHTML = '';
                if (request.status === 'pending') {
                    buttonsHTML = `
                        <div class="mt-4 flex gap-2">
                            <button data-id="${doc.id}" class="approve-request-btn bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">Aprovar</button>
                            <button data-id="${doc.id}" class="deny-request-btn bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">Negar</button>
                        </div>`;
                }

                reqEl.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h4 class="font-bold text-gray-800">${request.companyName}</h4>
                        <span class="text-xs font-medium px-2 py-1 rounded-full ${statusColor}">${request.status}</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-2"><strong>Alerta:</strong> ${request.articleTitle}</p>
                    <p class="text-sm text-gray-500 mt-2 bg-gray-50 p-2 rounded"><strong>Justificativa:</strong> ${request.justification}</p>
                    ${buttonsHTML}
                `;
                deletionRequestsList.appendChild(reqEl);
            });
        }

        async function handleDeletionRequestAction(e) {
            const target = e.target.closest('button');
            if (!target) return;

            const requestId = target.dataset.id;
            const approve = target.classList.contains('approve-request-btn');

            try {
                const manageDeletionRequest = httpsCallable(functions, 'manageDeletionRequest');
                await manageDeletionRequest({ appId, requestId, approve });
                showAlert(`Solicitação ${approve ? 'aprovada' : 'negada'} com sucesso.`, 'success');
            } catch (error) {
                console.error("Erro ao gerir solicitação:", error);
                showAlert(`Erro: ${error.message}`, 'error');
            }
        }

        async function handleSubmitJustification() {
            if (!justificationText) return;
            const justification = justificationText.value.trim();
            if (!justification) {
                showAlert('Por favor, forneça uma justificativa.', 'error');
                return;
            }

            try {
                const requestAlertDeletion = httpsCallable(functions, 'requestAlertDeletion');
                await requestAlertDeletion({
                    appId,
                    companyId: currentUser.companyId,
                    companyName: currentUser.companyName,
                    articleId: articleToDeleteInfo.id,
                    articleTitle: articleToDeleteInfo.title,
                    justification: justification
                });
                showAlert('Solicitação de exclusão enviada com sucesso!', 'success');
                if (justificationModal) justificationModal.classList.add('hidden');
                articleToDeleteInfo = null;
            } catch (error) {
                console.error("Erro ao enviar solicitação:", error);
                showAlert(`Erro: ${error.message}`, 'error');
            }
        }

        async function renderSuperAdminReport() {
            if (!superAdminReportBody) return;
            superAdminReportBody.innerHTML = '<tr><td colspan="6" class="text-center py-4">A gerar relatório...</td></tr>';
            try {
                const generateReport = httpsCallable(functions, 'generateSuperAdminReport');
                const result = await generateReport({ appId });
                const reportData = result.data;

                superAdminReportBody.innerHTML = '';
                if (reportData.length === 0) {
                    superAdminReportBody.innerHTML = '<tr><td colspan="6" class="text-center py-4">Nenhum dado para exibir.</td></tr>';
                    return;
                }

                reportData.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-4 py-3 font-medium">${item.companyName}</td>
                        <td class="px-4 py-3">${item.totalAlerts}</td>
                        <td class="px-4 py-3 text-xs">
                            <span class="text-green-600">P: ${item.sentimentPercentage.positive}%</span>, 
                            <span class="text-gray-600">N: ${item.sentimentPercentage.neutral}%</span>, 
                            <span class="text-red-600">Ng: ${item.sentimentPercentage.negative}%</span>
                        </td>
                        <td class="px-4 py-3">${item.predominantSentiment}</td>
                        <td class="px-4 py-3">${item.topChannel}</td>
                        <td class="px-4 py-3">${item.topVehicle}</td>
                    `;
                    superAdminReportBody.appendChild(row);
                });
            } catch (error) {
                console.error("Erro ao gerar relatório:", error);
                superAdminReportBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Erro: ${error.message}</td></tr>`;
            }
        }


        // --- INICIALIZAÇÃO E OUVINTES DE EVENTOS ---
        document.addEventListener('DOMContentLoaded', () => {
            // Atribui os elementos do DOM depois que o DOM é carregado
            pageSections = document.querySelectorAll('.page-section');
            navLoggedIn = document.getElementById('nav-logged-in');
            navInicio = document.getElementById('nav-inicio');
            navRelatorio = document.getElementById('nav-relatorio');
            navPesquisa = document.getElementById('nav-pesquisa');
            navSuperAdmin = document.getElementById('nav-super-admin');
            navLogout = document.getElementById('nav-logout');
            navConfiguracoesAdmin = document.getElementById('nav-configuracoes-admin');
            globalAlert = document.getElementById('global-alert');
            loginPage = document.getElementById('login-page');
            dashboardPage = document.getElementById('dashboard-page');
            searchPage = document.getElementById('search-page');
            superAdminPage = document.getElementById('super-admin-page');
            companyKeywordAdminPage = document.getElementById('company-keyword-admin-page');
            companySettingsAdminPage = document.getElementById('company-settings-admin-page');
            reportPage = document.getElementById('report-page');
            companyUserAdminPage = document.getElementById('company-user-admin-page');
            configuracoesAdminPage = document.getElementById('configuracoes-admin-page');
            loginForm = document.getElementById('login-form');
            dashboardTitle = document.getElementById('dashboard-title');
            currentDateTimeEl = document.getElementById('current-datetime');
            dashboardKeywordList = document.getElementById('dashboard-keyword-list');
            newsAlertsContainer = document.getElementById('news-alerts-container');
            newsAlerts = document.getElementById('news-alerts');
            alertDateFilter = document.getElementById('alert-date-filter');
            reportAccessToggle = document.getElementById('report-access-toggle');
            logoUploadInput = document.getElementById('logo-upload');
            headerLogoContainer = document.getElementById('header-logo-container');
            loginLogoContainer = document.getElementById('login-logo-container');
            filterContainer = document.getElementById('filter-container');
            searchInput = document.getElementById('search-input');
            searchResults = document.getElementById('search-results');
            companyForm = document.getElementById('company-form');
            companyList = document.getElementById('company-list');
            backToSuperAdminKwBtn = document.getElementById('back-to-super-admin-kw');
            backToSuperAdminSettingsBtn = document.getElementById('back-to-super-admin-settings');
            backToSuperAdminUsersBtn = document.getElementById('back-to-super-admin-users');
            companyKeywordAdminTitle = document.getElementById('company-keyword-admin-title');
            companySettingsAdminTitle = document.getElementById('company-settings-admin-title');
            companyUserAdminTitle = document.getElementById('company-user-admin-title');
            keywordForm = document.getElementById('keyword-form');
            keywordInput = document.getElementById('keyword-input');
            keywordIdInput = document.getElementById('keyword-id');
            adminKeywordList = document.getElementById('admin-keyword-list');
            userForm = document.getElementById('user-form');
            userInput = document.getElementById('user-input');
            userPasswordInput = document.getElementById('user-password-input');
            userIdInput = document.getElementById('user-id');
            adminUserList = document.getElementById('admin-user-list');
            notificationBell = document.getElementById('notification-bell-container');
            notificationBadge = document.getElementById('notification-badge');
            manualTriggerBtn = document.getElementById('manual-trigger-btn');
            deleteModal = document.getElementById('delete-modal');
            confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            companyNameToDeleteEl = document.getElementById('company-name-to-delete');
            newsScopeContainer = document.getElementById('news-scope-container');
            startDateInput = document.getElementById('start-date');
            endDateInput = document.getElementById('end-date');
            linkModal = document.getElementById('link-modal');
            accessLinkInput = document.getElementById('access-link-input');
            copyLinkBtn = document.getElementById('copy-link-btn');
            closeLinkModalBtn = document.getElementById('close-link-modal-btn');
            reportKeywordFilter = document.getElementById('report-keyword-filter');
            stateSelectContainer = document.getElementById('state-select-container');
            stateSelect = document.getElementById('state-select');
            changePasswordForm = document.getElementById('change-password-form');
            apiKeyNewsApiInput = document.getElementById('apiKeyNewsApi');
            apiKeyGNewsInput1 = document.getElementById('apiKeyGNews1');
            apiKeyGNewsInput2 = document.getElementById('apiKeyGNews2');
            apiKeyGNewsInput3 = document.getElementById('apiKeyGNews3');
            apiKeyGNewsInput4 = document.getElementById('apiKeyGNews4');
            apiKeyFirebaseNewsInput = document.getElementById('apiKeyFirebaseNews');
            apiKeyYoutubeInput = document.getElementById('apiKeyYoutube');
            apiKeyBloggerInput = document.getElementById('apiKeyBlogger');
            apiKeyVisionInput = document.getElementById('apiKeyVision');
            apiKeyVideoIntelligenceInput = document.getElementById('apiKeyVideoIntelligence');
            bloggerIdInput = document.getElementById('bloggerId');
            rssUrlInput = document.getElementById('rssUrl');
            fetchOnlyNewToggle = document.getElementById('fetch-only-new-toggle');
            changePasswordPage = document.getElementById('change-password-page');
            globalKeysPage = document.getElementById('global-keys-page');
            globalSourcesPage = document.getElementById('global-sources-page');
            btnChangePassword = document.getElementById('btn-change-password');
            btnGlobalKeys = document.getElementById('btn-global-keys');
            btnNewsSources = document.getElementById('btn-news-sources');
            backToAdminConfig1 = document.getElementById('back-to-admin-config-1');
            backToAdminConfig2 = document.getElementById('back-to-admin-config-2');
            backToAdminConfig3 = document.getElementById('back-to-admin-config-3');
            showAllAlertsBtn = document.getElementById('show-all-alerts-btn');
            deletionAccessToggle = document.getElementById('deletion-access-toggle');
            justificationModal = document.getElementById('justification-modal');
            justificationText = document.getElementById('justification-text');
            submitJustificationBtn = document.getElementById('submit-justification-btn');
            cancelJustificationBtn = document.getElementById('cancel-justification-btn');
            btnManualAlert = document.getElementById('btn-manual-alert');
            btnDeletionRequests = document.getElementById('btn-deletion-requests');
            btnSuperAdminReport = document.getElementById('btn-super-admin-report');
            manualAlertPage = document.getElementById('manual-alert-page');
            deletionRequestsPage = document.getElementById('deletion-requests-page');
            superAdminReportPage = document.getElementById('super-admin-report-page');
            backToDashboard1 = document.getElementById('back-to-dashboard-1');
            backToDashboard2 = document.getElementById('back-to-dashboard-2');
            backToDashboard3 = document.getElementById('back-to-dashboard-3');
            manualAlertForm = document.getElementById('manual-alert-form');
            deletionRequestsList = document.getElementById('deletion-requests-list');
            superAdminReportBody = document.getElementById('super-admin-report-body');
            deletionRequestsBadge = document.getElementById('deletion-requests-badge');
            pendingAlertsPage = document.getElementById('super-admin-queue-page');
            pendingAlertsList = document.getElementById('super-admin-pending-alerts-list');
            btnPendingAlerts = document.getElementById('btn-pending-alerts');
            backToDashboard4 = document.getElementById('back-to-dashboard-4');
            confirmDeleteKeywordModal = document.getElementById('confirm-delete-keyword-modal');
            confirmDeleteKeywordBtn = document.getElementById('confirm-delete-keyword-btn');
            cancelDeleteKeywordBtn = document.getElementById('cancel-delete-keyword-btn');
            keywordToDeleteNameEl = document.getElementById('keyword-to-delete-name');


            const states = {"AC": "Acre", "AL": "Alagoas", "AP": "Amapá", "AM": "Amazonas", "BA": "Bahia", "CE": "Ceará", "DF": "Distrito Federal", "ES": "Espírito Santo", "GO": "Goiás", "MA": "Maranhão", "MT": "Mato Grosso", "MS": "Mato Grosso do Sul", "MG": "Minas Gerais", "PA": "Pará", "PB": "Paraíba", "PR": "Paraná", "PE": "Pernambuco", "PI": "Piauí", "RJ": "Rio de Janeiro", "RN": "Rio Grande do Norte", "RS": "Rio Grande do Sul", "RO": "Rondônia", "RR": "Roraima", "SC": "Santa Catarina", "SP": "São Paulo", "SE": "Sergipe", "TO": "Tocantins"};
            for (const [uf, name] of Object.entries(states)) {
                const option = document.createElement('option');
                option.value = uf;
                option.textContent = name;
                if (stateSelect) {
                    stateSelect.appendChild(option);
                }
            }
            
            // This async IIFE will handle the initial authentication logic
            (async () => {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const savedUser = getStorage('clipping_currentUser', null);
                        if (savedUser) {
                            currentUser = savedUser;
                            // For a clean start, remove existing listeners
                            if (notificationListener) notificationListener(); 
                            if (companiesListener) companiesListener(); 
                            if (deletionRequestsListener) deletionRequestsListener(); 
                            if (pendingAlertsListener) pendingAlertsListener(); 
                            updateView('dashboard'); 
                        } else {
                            // User exists in auth but not local storage, force login
                            currentUser = null;
                            updateView('login');
                        }
                    } else {
                        currentUser = null;
                        updateView('login');
                    }
                });

                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Firebase anonymous auth error:", error);
                    showAlert("Erro de autenticação. Tente recarregar a página.", "error");
                }
            })();

            if (loginForm) loginForm.addEventListener('submit', handleLogin);
            if (navInicio) navInicio.addEventListener('click', (e) => { e.preventDefault(); updateView('dashboard'); });
            if (navRelatorio) navRelatorio.addEventListener('click', (e) => { e.preventDefault(); updateView('report'); });
            if (navPesquisa) navPesquisa.addEventListener('click', (e) => { e.preventDefault(); updateView('search'); });
            if (navSuperAdmin) navSuperAdmin.addEventListener('click', (e) => { e.preventDefault(); updateView('super-admin'); });
            if (navConfiguracoesAdmin) navConfiguracoesAdmin.addEventListener('click', (e) => { e.preventDefault(); updateView('configuracoes-admin'); });
            if (navLogout) navLogout.addEventListener('click', (e) => { e.preventDefault(); handleLogout(); });
            if (manualTriggerBtn) manualTriggerBtn.addEventListener('click', handleManualTrigger);
            if (companyForm) companyForm.addEventListener('submit', handleCompanySubmit);
            if (companyList) companyList.addEventListener('click', handleCompanyActions);
            if (confirmDeleteBtn) confirmDeleteBtn.addEventListener('click', handleConfirmDelete);
            if (cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', () => { if(deleteModal) deleteModal.classList.add('hidden')});
            if (closeLinkModalBtn) closeLinkModalBtn.addEventListener('click', () => { if(linkModal) linkModal.classList.add('hidden')});
            if (copyLinkBtn) copyLinkBtn.addEventListener('click', () => {
                if(accessLinkInput) accessLinkInput.select();
                document.execCommand('copy');
                showAlert('Link copiado para a área de transferência!', 'success');
            });
            if (newsScopeContainer) newsScopeContainer.addEventListener('change', (e) => { handleSettingsChange(e); handleScopeChange(); });
            if (apiKeyNewsApiInput) apiKeyNewsApiInput.addEventListener('change', handleGlobalKeyChange);
            if (apiKeyGNewsInput1) apiKeyGNewsInput1.addEventListener('change', handleGlobalKeyChange);
            if (apiKeyGNewsInput2) apiKeyGNewsInput2.addEventListener('change', handleGlobalKeyChange);
            if (apiKeyGNewsInput3) apiKeyGNewsInput3.addEventListener('change', handleGlobalKeyChange);
            if (apiKeyGNewsInput4) apiKeyGNewsInput4.addEventListener('change', handleGlobalKeyChange);
            if (apiKeyFirebaseNewsInput) apiKeyFirebaseNewsInput.addEventListener('change', handleGlobalKeyChange);
            if (apiKeyYoutubeInput) apiKeyYoutubeInput.addEventListener('change', handleGlobalKeyChange);
            if (apiKeyBloggerInput) apiKeyBloggerInput.addEventListener('change', handleGlobalKeyChange);
            if (apiKeyVisionInput) apiKeyVisionInput.addEventListener('change', handleGlobalKeyChange);
            if (apiKeyVideoIntelligenceInput) apiKeyVideoIntelligenceInput.addEventListener('change', handleGlobalKeyChange);
            if (bloggerIdInput) bloggerIdInput.addEventListener('change', handleGlobalSourceChange);
            if (rssUrlInput) rssUrlInput.addEventListener('change', handleGlobalSourceChange);
            if (reportAccessToggle) reportAccessToggle.addEventListener('change', handleSettingsChange);
            if (fetchOnlyNewToggle) fetchOnlyNewToggle.addEventListener('change', handleSettingsChange);
            if (deletionAccessToggle) deletionAccessToggle.addEventListener('change', handleSettingsChange);
            if (stateSelect) stateSelect.addEventListener('change', handleSettingsChange);
            if (keywordForm) keywordForm.addEventListener('submit', handleKeywordSubmit);
            if (adminKeywordList) adminKeywordList.addEventListener('click', handleKeywordActions);
            if (confirmDeleteKeywordBtn) confirmDeleteKeywordBtn.addEventListener('click', handleConfirmDeleteKeyword);
            if (cancelDeleteKeywordBtn) cancelDeleteKeywordBtn.addEventListener('click', () => { if(confirmDeleteKeywordModal) confirmDeleteKeywordModal.classList.add('hidden')});
            if (userForm) userForm.addEventListener('submit', handleUserSubmit);
            if (adminUserList) adminUserList.addEventListener('click', handleUserActions);
            if (searchInput) searchInput.addEventListener('input', handleSearch);
            if (filterContainer) filterContainer.addEventListener('click', (e) => { if (e.target.classList.contains('filter-btn')) { document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('bg-indigo-500', 'text-white')); e.target.classList.add('bg-indigo-500', 'text-white'); handleSearch(); } });
            if (notificationBell) notificationBell.addEventListener('click', showOnlyNewAlerts);
            if (showAllAlertsBtn) showAllAlertsBtn.addEventListener('click', populateInitialAlerts);
            if (backToSuperAdminKwBtn) backToSuperAdminKwBtn.addEventListener('click', () => updateView('super-admin'));
            if (backToSuperAdminSettingsBtn) backToSuperAdminSettingsBtn.addEventListener('click', () => updateView('super-admin'));
            if (backToSuperAdminUsersBtn) backToSuperAdminUsersBtn.addEventListener('click', () => updateView('super-admin'));
            if (dashboardKeywordList) dashboardKeywordList.addEventListener('click', handleDashboardKeywordFilter);
            if (newsAlerts) newsAlerts.addEventListener('click', handleAlertCardActions);
            if (searchResults) searchResults.addEventListener('click', handleAlertCardActions);
            if (alertDateFilter) alertDateFilter.addEventListener('change', filterAlertsByDate);
            if (changePasswordForm) changePasswordForm.addEventListener('submit', handleChangePassword);
            if (btnChangePassword) btnChangePassword.addEventListener('click', () => updateView('change-password'));
            if (btnGlobalKeys) btnGlobalKeys.addEventListener('click', () => updateView('global-keys'));
            if (btnNewsSources) btnNewsSources.addEventListener('click', () => updateView('global-sources'));
            if (backToAdminConfig1) backToAdminConfig1.addEventListener('click', () => updateView('configuracoes-admin'));
            if (backToAdminConfig2) backToAdminConfig2.addEventListener('click', () => updateView('configuracoes-admin'));
            if (backToAdminConfig3) backToAdminConfig3.addEventListener('click', () => updateView('configuracoes-admin'));
            if (logoUploadInput) logoUploadInput.addEventListener('change', handleLogoUpload);
            if (btnManualAlert) btnManualAlert.addEventListener('click', () => updateView('manual-alert'));
            if (btnDeletionRequests) btnDeletionRequests.addEventListener('click', () => updateView('deletion-requests'));
            if (btnSuperAdminReport) btnSuperAdminReport.addEventListener('click', () => updateView('super-admin-report'));
            if (backToDashboard1) backToDashboard1.addEventListener('click', () => updateView('dashboard'));
            if (backToDashboard2) backToDashboard2.addEventListener('click', () => updateView('dashboard'));
            if (backToDashboard3) backToDashboard3.addEventListener('click', () => updateView('dashboard'));
            if (manualAlertForm) manualAlertForm.addEventListener('submit', handleManualAlertSubmit);
            if (cancelJustificationBtn) cancelJustificationBtn.addEventListener('click', () => { if(justificationModal) justificationModal.classList.add('hidden')});
            if (submitJustificationBtn) submitJustificationBtn.addEventListener('click', handleSubmitJustification);
            if (deletionRequestsList) deletionRequestsList.addEventListener('click', handleDeletionRequestAction);
            if (justificationText && submitJustificationBtn) justificationText.addEventListener('input', () => {
                if(submitJustificationBtn) submitJustificationBtn.disabled = justificationText.value.trim() === '';
            });
            if (btnPendingAlerts) btnPendingAlerts.addEventListener('click', () => updateView('super-admin-queue'));
            if (pendingAlertsList) pendingAlertsList.addEventListener('click', handlePendingAlertAction);
            if (backToDashboard4) backToDashboard4.addEventListener('click', () => updateView('dashboard'));
            
            const urlParams = new URLSearchParams(window.location.search);
            const companyParam = urlParams.get('company');
            if (companyParam) {
                const companyInput = document.getElementById('login-company');
                if (companyInput) {
                    companyInput.value = decodeURIComponent(companyParam);
                    const loginCompanyWrapper = document.getElementById('login-company-wrapper');
                    if (loginCompanyWrapper) {
                        loginCompanyWrapper.style.display = 'none';
                    }
                }
            }
        });
    </script>
</body>
</html>

