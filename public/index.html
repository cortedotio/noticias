<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clipping de Notícias - Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        header { position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; }
        main { padding-top: 80px; }
        .page-section { display: none; }
        .page-section.active { display: block; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        @keyframes ring {
            0%, 100% { transform: rotate(0); }
            10%, 30%, 50%, 70%, 90% { transform: rotate(-10deg); }
            20%, 40%, 60%, 80% { transform: rotate(10deg); }
        }
        .animate-ring { animation: ring 1s ease-in-out; }
        .keyword-filter.active {
            background-color: #4F46E5 !important;
            color: white !important;
        }
        #notification-badge {
            min-width: 1.25rem;
            height: 1.25rem;
            padding: 0 0.25rem;
            line-height: 1.25rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="text-2xl font-bold text-indigo-600 flex items-center">
               <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2 h-8 w-8"><path d="M2.5 17a2.4 2.4 0 0 1 3 0L12 23l6.5-6.5a2.4 2.4 0 0 1 3 0Z"/><path d="M5 11.5a2.5 2.5 0 0 1 0-5c1.5 0 2.8 1.3 2.8 2.8V13c0 1.4-1.3 2.8-2.8 2.8-1.5 0-2.8-1.3-2.8-2.8V8.5"/><path d="M19 11.5a2.5 2.5 0 0 0 0-5c-1.5 0-2.8 1.3-2.8 2.8V13c0 1.4 1.3 2.8 2.8 2.8 1.5 0-2.8-1.3-2.8-2.8V8.5"/></svg>
                Aurora clipping
            </div>
            <div class="flex items-center">
                <div id="nav-logged-in" class="hidden items-center">
                    <a href="#" id="nav-inicio" class="text-gray-600 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-medium">Início</a>
                    <a href="#" id="nav-relatorio" class="hidden text-gray-600 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-medium">Relatório</a>
                    <a href="#" id="nav-pesquisa" class="text-gray-600 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-medium">Pesquisa</a>
                    <a href="#" id="nav-super-admin" class="hidden text-red-600 hover:text-red-800 px-3 py-2 rounded-md text-sm font-bold">Super Admin</a>
                    <a href="#" id="nav-configuracoes-admin" class="hidden text-gray-600 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-medium">Configurações</a>
                    <div id="notification-bell-container" class="relative cursor-pointer ml-4">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                        <span id="notification-badge" class="hidden absolute -top-2 -right-2 text-white text-xs font-bold text-center rounded-full bg-red-500"></span>
                    </div>
                    <a href="#" id="nav-logout" class="ml-4 bg-indigo-600 text-white hover:bg-indigo-700 px-3 py-2 rounded-md text-sm font-medium">Sair</a>
                </div>
                <div id="header-logo-container" class="ml-4 h-10 w-auto"></div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-6">
        <div id="global-alert" class="mb-6"></div>

        <section id="login-page" class="page-section fade-in">
            <div class="max-w-md mx-auto bg-gray-50 p-8 rounded-lg shadow-lg mt-10 relative">
                <div id="login-logo-container" class="absolute top-4 right-4 h-12 w-auto"></div>
                <h1 class="text-3xl font-bold text-center text-gray-800">Bem-Vindo</h1>
                <p class="text-center text-gray-500 mt-2 mb-6">Informe seus dados de acesso</p>
                <form id="login-form">
                    <div id="login-company-wrapper" class="mb-4"><label for="login-company" class="block text-sm font-medium text-gray-700 mb-1">Empresa</label><input type="text" id="login-company" class="w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                    <div class="mb-4"><label for="login-user" class="block text-sm font-medium text-gray-700 mb-1">Usuário</label><input type="text" id="login-user" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <div class="mb-6"><label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Senha</label><input type="password" id="login-password" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Entrar</button>
                </form>
            </div>
        </section>

        <section id="dashboard-page" class="page-section fade-in">
            <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 bg-white p-4 rounded-lg shadow-md">
                <h2 id="dashboard-title" class="text-2xl font-bold text-gray-800 mb-2 md:mb-0">Notícias do Dia</h2>
                <p id="current-datetime" class="text-lg text-indigo-600 font-medium"></p>
            </div>
            <div id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1 bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold mb-3 text-gray-700">Palavras-Chave Monitoradas</h3>
                    <ul id="dashboard-keyword-list" class="space-y-2"></ul>
                </div>
                <div id="news-alerts-container" class="md:col-span-2">
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-700">Relatório de Alertas</h3>
                            <div class="flex items-center gap-2">
                                <label for="alert-date-filter" class="text-sm font-medium">Filtrar por data:</label>
                                <input type="date" id="alert-date-filter" class="px-2 py-1 border border-gray-300 rounded-md text-sm">
                            </div>
                        </div>
                        <div id="news-alerts" class="space-y-4 max-h-[70vh] overflow-y-auto"></div>
                    </div>
                </div>
            </div>
             <div id="super-admin-dashboard-message" class="hidden bg-white p-8 rounded-lg shadow-lg text-center">
                <h3 class="text-2xl font-bold">Bem-vindo, Super Admin!</h3>
                <p class="mt-4 text-gray-600">Use o menu "Super Admin" no topo da página para gerenciar empresas e usuários.</p>
                <div class="mt-6 p-4 bg-blue-100 border-l-4 border-blue-500 text-blue-800 rounded-md text-left">
                    <p class="font-bold">Execução Manual do Robô</p>
                    <p class="mt-2 text-sm">Use o botão abaixo para disparar a coleta de notícias imediatamente. Isso é útil para testes e para obter as notícias mais recentes sem esperar pelo agendamento automático de 30 minutos.</p>
                    <button id="manual-trigger-btn" class="mt-4 w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:bg-blue-300">Executar Robô Manualmente</button>
                </div>
            </div>
        </section>
        
        <section id="super-admin-page" class="page-section fade-in">
            <h2 class="text-3xl font-bold mb-6 text-red-600">Painel Super-Administrador</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold mb-4">Adicionar Nova Empresa</h3>
                    <form id="company-form" class="space-y-4">
                        <div><label for="company-name-input">Nome da Empresa</label><input type="text" id="company-name-input" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                        <button type="submit" class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700">Adicionar Empresa</button>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold mb-4">Empresas Cadastradas</h3>
                    <ul id="company-list" class="space-y-2 max-h-96 overflow-y-auto"></ul>
                </div>
            </div>
        </section>

        <section id="configuracoes-admin-page" class="page-section fade-in">
            <h2 class="text-3xl font-bold mb-6">Configurações do Super Admin</h2>
            <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6">
                <button id="btn-change-password" class="bg-white p-6 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow">
                    <h3 class="text-xl font-semibold">Alterar Senha</h3>
                </button>
                <button id="btn-global-keys" class="bg-white p-6 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow">
                    <h3 class="text-xl font-semibold">Chaves de API Globais</h3>
                </button>
                <button id="btn-news-sources" class="bg-white p-6 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow">
                    <h3 class="text-xl font-semibold">Fontes de Notícias</h3>
                </button>
            </div>
        </section>
        
        <section id="change-password-page" class="page-section fade-in">
            <button id="back-to-admin-config-1" class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar</button>
            <h2 class="text-3xl font-bold mb-6">Alterar Senha de Acesso</h2>
            <div class="max-w-lg mx-auto bg-white p-6 rounded-lg shadow-lg">
                <form id="change-password-form" class="space-y-4">
                    <div><label for="current-password" class="block text-sm font-medium text-gray-700">Senha Atual</label><input type="password" id="current-password" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <div><label for="new-password" class="block text-sm font-medium text-gray-700">Nova Senha</label><input type="password" id="new-password" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Alterar Senha</button>
                </form>
            </div>
        </section>

        <section id="global-keys-page" class="page-section fade-in">
            <button id="back-to-admin-config-2" class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar</button>
            <h2 class="text-3xl font-bold mb-6">Chaves de API Globais</h2>
            <div class="max-w-lg mx-auto bg-white p-6 rounded-lg shadow-lg">
                <div class="space-y-4">
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="api-key-newsapi" class="block text-sm font-medium text-gray-700 mb-1">Chave da API (NewsAPI.org)</label>
                        <input type="text" id="api-key-newsapi" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="api-key-gnews" class="block text-sm font-medium text-gray-700 mb-1">Chave da API (GNews.io)</label>
                        <input type="text" id="api-key-gnews" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="api-key-youtube" class="block text-sm font-medium text-gray-700 mb-1">Chave da API (YouTube Data API v3)</label>
                        <input type="text" id="api-key-youtube" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="api-key-blogger" class="block text-sm font-medium text-gray-700 mb-1">Chave da API (Blogger API)</label>
                        <input type="text" id="api-key-blogger" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <button id="save-global-keys-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Salvar Chaves</button>
                </div>
            </div>
        </section>

        <section id="global-sources-page" class="page-section fade-in">
            <button id="back-to-admin-config-3" class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar</button>
            <h2 class="text-3xl font-bold mb-6">Fontes de Notícias Globais</h2>
            <div class="max-w-lg mx-auto bg-white p-6 rounded-lg shadow-lg">
                <div class="space-y-4">
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="blogger-id" class="block text-sm font-medium text-gray-700 mb-1">IDs de Blogs (Blogger) - um por linha</label>
                        <textarea id="blogger-id" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                    </div>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <label for="rss-url" class="block text-sm font-medium text-gray-700 mb-1">Monitorar Sites por RSS - um por linha</label>
                        <textarea id="rss-url" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="https://site.com/feed"></textarea>
                    </div>
                    <button id="save-global-sources-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Salvar Fontes</button>
                </div>
            </div>
        </section>

        <section id="company-user-admin-page" class="page-section fade-in">
            <button id="back-to-super-admin-users" class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar para Super Admin</button>
            <h2 id="company-user-admin-title" class="text-3xl font-bold mb-6">Gerenciar Usuários</h2>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <form id="user-form" class="flex flex-col sm:flex-row gap-2 mb-4">
                    <input type="text" id="user-input" placeholder="Nome do usuário" class="flex-grow px-3 py-2 border border-gray-300 rounded-md">
                    <input type="text" id="user-password-input" placeholder="Senha" class="flex-grow px-3 py-2 border border-gray-300 rounded-md">
                    <input type="hidden" id="user-id">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Salvar</button>
                </form>
                <ul id="admin-user-list" class="space-y-2 max-h-96 overflow-y-auto"></ul>
            </div>
        </section>

        <section id="company-keyword-admin-page" class="page-section fade-in">
            <button id="back-to-super-admin-kw" class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar para Super Admin</button>
            <h2 id="company-keyword-admin-title" class="text-3xl font-bold mb-6">Gerenciar Palavras-Chave</h2>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <form id="keyword-form" class="flex gap-2 mb-4">
                    <input type="text" id="keyword-input" placeholder="Adicionar ou editar palavra" class="flex-grow px-3 py-2 border border-gray-300 rounded-md">
                    <input type="hidden" id="keyword-id">
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Salvar</button>
                </form>
                <ul id="admin-keyword-list" class="space-y-2 max-h-96 overflow-y-auto"></ul>
            </div>
        </section>

        <section id="company-settings-admin-page" class="page-section fade-in">
            <button id="back-to-super-admin-settings" class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar para Super Admin</button>
            <h2 id="company-settings-admin-title" class="text-3xl font-bold mb-6">Opções da Empresa</h2>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="space-y-6">
                    <div class="flex items-center"><input type="checkbox" id="report-access-toggle" class="h-4 w-4 text-indigo-600 border-gray-300 rounded"><label for="report-access-toggle" class="ml-2 block text-sm text-gray-900">Liberar acesso ao relatório de alertas na tela inicial.</label></div>
                    <div class="flex items-center"><input type="checkbox" id="fetch-only-new-toggle" class="h-4 w-4 text-indigo-600 border-gray-300 rounded"><label for="fetch-only-new-toggle" class="ml-2 block text-sm text-gray-900">Capturar apenas notícias novas (evita duplicatas).</label></div>
                    <div><h4 class="text-lg font-semibold mb-2">Logo da Empresa</h4><input type="file" id="logo-upload" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"></div>
                    <div>
                        <h4 class="text-lg font-semibold mb-2">Escopo das Notícias</h4>
                        <div id="news-scope-container" class="space-y-2">
                            <div class="flex items-center"><input type="radio" id="scope-nacional" name="news-scope" value="br" class="h-4 w-4 text-indigo-600 border-gray-300"><label for="scope-nacional" class="ml-2 block text-sm text-gray-900">Nacionais (Brasil)</label></div>
                            <div class="flex items-center"><input type="radio" id="scope-internacional" name="news-scope" value="international" class="h-4 w-4 text-indigo-600 border-gray-300"><label for="scope-internacional" class="ml-2 block text-sm text-gray-900">Internacionais</label></div>
                            <div class="flex items-center"><input type="radio" id="scope-estadual" name="news-scope" value="state" class="h-4 w-4 text-indigo-600 border-gray-300"><label for="scope-estadual" class="ml-2 block text-sm text-gray-900">Estaduais</label></div>
                        </div>
                        <div id="state-select-container" class="hidden mt-2">
                            <label for="state-select" class="block text-sm font-medium text-gray-700 mb-1">Selecione o Estado:</label>
                            <select id="state-select" class="w-full p-2 border border-gray-300 rounded-md"></select>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="report-page" class="page-section fade-in">
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-700 mb-4 sm:mb-0">Relatórios Gráficos</h2>
                    <div class="flex items-center gap-4">
                        <label for="report-keyword-filter" class="text-sm font-medium">Filtrar por Palavra-Chave:</label>
                        <select id="report-keyword-filter" class="px-2 py-1 border border-gray-300 rounded-md text-sm"></select>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="p-4 border rounded-lg">
                        <h3 class="text-xl font-semibold mb-4 text-center">Notícias por Veículo</h3>
                        <canvas id="source-chart"></canvas>
                    </div>
                    <div class="p-4 border rounded-lg">
                        <h3 class="text-xl font-semibold mb-4 text-center">Notícias por Período</h3>
                        <div class="flex justify-center items-center gap-4 mb-4">
                            <div><label for="start-date" class="text-sm">De:</label><input type="date" id="start-date" class="px-2 py-1 border rounded-md"></div>
                            <div><label for="end-date" class="text-sm">Até:</label><input type="date" id="end-date" class="px-2 py-1 border rounded-md"></div>
                        </div>
                         <canvas id="date-chart"></canvas>
                    </div>
                    <div class="p-4 border rounded-lg lg:col-span-2">
                        <h3 class="text-xl font-semibold mb-4 text-center">Análise de Sentimento</h3>
                        <canvas id="sentiment-chart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <section id="search-page" class="page-section fade-in">
             <div class="bg-white p-6 md:p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl md:text-3xl font-bold mb-6">Pesquisar nos Alertas Salvos</h2>
                <div id="filter-container" class="mb-8 p-4 border border-gray-200 rounded-lg bg-gray-50"></div>
                <input type="text" id="search-input" placeholder="Digite para pesquisar em títulos ou descrições..." class="w-full p-3 border border-gray-300 rounded-md mb-6">
                <div id="search-results" class="space-y-4 max-h-[60vh] overflow-y-auto"><p class="text-gray-500">Digite algo para começar a pesquisar ou use os filtros.</p></div>
            </div>
        </section>
    </main>

    <div id="delete-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" stroke="currentColor" fill="none" viewBox="0 0 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Excluir Empresa</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">Tem certeza que deseja excluir a empresa <strong id="company-name-to-delete"></strong>?<br><br><span class="font-bold text-red-600">Esta ação é permanente e removerá todos os dados associados.</span></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirm-delete-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700">Sim, excluir</button>
                    <button id="cancel-delete-btn" class="mt-3 px-4 py-2 bg-gray-200 text-gray-900 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="link-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">Link de Acesso Exclusivo</h3>
                <div class="mt-4 px-7 py-3">
                    <p class="text-sm text-gray-500 mb-2">Use este link para dar acesso direto à página de login desta empresa:</p>
                    <input type="text" id="access-link-input" readonly class="w-full bg-gray-100 p-2 border rounded-md text-sm">
                </div>
                <div class="items-center px-4 py-3 flex gap-2">
                    <button id="copy-link-btn" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700">Copiar</button>
                    <button id="close-link-modal-btn" class="px-4 py-2 bg-gray-200 text-gray-900 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Import Firebase modules ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, addDoc, deleteDoc, updateDoc, query, where, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // --- Your Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCWzQM1SbIgO10GIu4AZ8lVtwmcKPEPAbo",
            authDomain: "noticias-6e952.firebaseapp.com",
            projectId: "noticias-6e952",
            storageBucket: "noticias-6e952.appspot.com",
            messagingSenderId: "788555331572",
            appId: "1:788555331572:web:328cc3967fad0155352ba1"
        };

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const functions = getFunctions(app, 'southamerica-east1');
        const storage = getStorage(app);
        
        // --- APPLICATION STATE ---
        let currentUser = null, clockInterval = null, selectedCompanyForManagement = null, allCompanyArticles = [], companyIdToDelete = null;
        let sourceChartInstance = null, dateChartInstance = null, sentimentChartInstance = null;
        let superAdminCredentials = { user: 'ulysses', pass: 'adminqwert' };
        let notificationListener = null;

        // --- DOM ELEMENTS (declared inside DOMContentLoaded) ---
        let pageSections, navLoggedIn, navInicio, navRelatorio, navPesquisa, navSuperAdmin, navLogout, navConfiguracoesAdmin, globalAlert, loginPage, dashboardPage, searchPage, superAdminPage, companyKeywordAdminPage, companySettingsAdminPage, reportPage, companyUserAdminPage, configuracoesAdminPage, loginForm, dashboardTitle, currentDateTimeEl, dashboardKeywordList, newsAlertsContainer, newsAlerts, alertDateFilter, reportAccessToggle, logoUploadInput, headerLogoContainer, loginLogoContainer, filterContainer, searchInput, searchResults, companyForm, companyList, backToSuperAdminKwBtn, backToSuperAdminSettingsBtn, backToSuperAdminUsersBtn, companyKeywordAdminTitle, companySettingsAdminTitle, companyUserAdminTitle, keywordForm, keywordInput, keywordIdInput, adminKeywordList, userForm, userInput, userPasswordInput, userIdInput, adminUserList, notificationBell, notificationBadge, manualTriggerBtn, deleteModal, confirmDeleteBtn, cancelDeleteBtn, companyNameToDeleteEl, newsScopeContainer, startDateInput, endDateInput, linkModal, accessLinkInput, copyLinkBtn, closeLinkModalBtn, reportKeywordFilter, stateSelectContainer, stateSelect, changePasswordForm, apiKeyNewsApiInput, apiKeyGNewsInput, apiKeyYoutubeInput, apiKeyBloggerInput, bloggerIdInput, rssUrlInput, fetchOnlyNewToggle, changePasswordPage, globalKeysPage, globalSourcesPage, btnChangePassword, btnGlobalKeys, btnNewsSources, backToAdminConfig1, backToAdminConfig2, backToAdminConfig3, saveGlobalKeysBtn, saveGlobalSourcesBtn;

        // --- UTILITY FUNCTIONS ---
        function showAlert(message, type = 'success') { const c = type === 'success' ? 'bg-green-100 border-green-500 text-green-700' : 'bg-red-100 border-red-500 text-red-700'; globalAlert.innerHTML = `<div class="${c} border-l-4 p-4 rounded-md fade-in" role="alert"><p>${message}</p></div>`; setTimeout(() => { globalAlert.innerHTML = ''; }, 4000); }
        function updateView(pageName) { pageSections.forEach(s => s.classList.remove('active')); const i = !!currentUser; navLoggedIn.style.display = i ? 'flex' : 'none'; navSuperAdmin.classList.toggle('hidden', !currentUser || !currentUser.isSuperAdmin); navConfiguracoesAdmin.classList.toggle('hidden', !currentUser || !currentUser.isSuperAdmin); if (clockInterval) clearInterval(clockInterval); loadAndDisplayLogo(); switch (pageName) { case 'login': loginPage.classList.add('active'); break; case 'dashboard': dashboardPage.classList.add('active'); renderDashboard(); updateDateTime(); clockInterval = setInterval(updateDateTime, 60000); break; case 'super-admin': superAdminPage.classList.add('active'); renderSuperAdminPage(); break; case 'search': searchPage.classList.add('active'); setupSearchPage(); break; case 'company-keyword-admin': companyKeywordAdminPage.classList.add('active'); renderCompanyKeywordAdminPage(); break; case 'company-settings-admin': companySettingsAdminPage.classList.add('active'); renderCompanySettingsAdminPage(); break; case 'company-user-admin': companyUserAdminPage.classList.add('active'); renderCompanyUserAdminPage(); break; case 'report': reportPage.classList.add('active'); renderReportPage(); break; case 'configuracoes-admin': configuracoesAdminPage.classList.add('active'); break; case 'change-password': changePasswordPage.classList.add('active'); break; case 'global-keys': globalKeysPage.classList.add('active'); renderGlobalKeysPage(); break; case 'global-sources': globalSourcesPage.classList.add('active'); renderGlobalSourcesPage(); break; } }
        function getStorage(key, defaultValue) { try { const d = localStorage.getItem(key); return d ? JSON.parse(d) : defaultValue; } catch (e) { console.error(e); return defaultValue; } }
        function setStorage(key, value) { localStorage.setItem(key, JSON.stringify(value)); }
        function updateDateTime() { if (!currentDateTimeEl) return; const n = new Date(), f = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }; currentDateTimeEl.textContent = `Data: ${n.toLocaleDateString('pt-BR', f).replace(',', ' -')}`; }
        async function loadAndDisplayLogo() { try { const u = currentUser && currentUser.logoUrl ? currentUser.logoUrl : "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c5/Firebase_Logo.svg/512px-Firebase_Logo.svg.png"; if (headerLogoContainer) headerLogoContainer.innerHTML = `<img src="${u}" alt="Logo" class="h-full w-auto">`; if (loginLogoContainer) loginLogoContainer.innerHTML = `<img src="${u}" alt="Logo" class="h-full w-auto">`; } catch (e) { console.error("Erro ao carregar logo:", e); } }
        
        // --- MANUAL TRIGGER LOGIC ---
        async function manualTrigger() {
            if (!currentUser || !currentUser.isSuperAdmin) {
                showAlert('Você não tem permissão para executar esta ação.', 'error');
                return;
            }
            manualTriggerBtn.disabled = true;
            manualTriggerBtn.textContent = 'Executando...';
            try {
                const triggerRobo = httpsCallable(functions, 'triggerRobo');
                const result = await triggerRobo();
                console.log(result.data.message);
                showAlert('Robô de coleta de notícias executado com sucesso!', 'success');
            } catch (error) {
                console.error("Erro ao executar robô:", error);
                showAlert('Falha ao executar o robô. Verifique o log do console.', 'error');
            } finally {
                manualTriggerBtn.disabled = false;
                manualTriggerBtn.textContent = 'Executar Robô Manualmente';
            }
        }
        
        // --- AUTHENTICATION & SESSION MANAGEMENT ---
        function login(user, pass, companyId = null) {
            if (user === superAdminCredentials.user && pass === superAdminCredentials.pass) {
                currentUser = {
                    id: 'super-admin',
                    name: 'Super Admin',
                    isSuperAdmin: true
                };
                setStorage('currentUser', currentUser);
                updateView('dashboard');
            } else if (companyId) {
                checkUserLogin(companyId, user, pass);
            } else {
                showAlert('Usuário ou senha incorretos.', 'error');
            }
        }
        async function checkUserLogin(companyId, user, pass) {
            try {
                const q = query(collection(db, `companies/${companyId}/users`), where("user", "==", user), where("password", "==", pass), limit(1));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    const userData = querySnapshot.docs[0].data();
                    const companyDoc = await getDoc(doc(db, "companies", companyId));
                    const companyData = companyDoc.data();
                    currentUser = {
                        id: querySnapshot.docs[0].id,
                        companyId: companyId,
                        isSuperAdmin: false,
                        ...userData,
                        ...companyData
                    };
                    setStorage('currentUser', currentUser);
                    updateView('dashboard');
                } else {
                    showAlert('Usuário ou senha incorretos para esta empresa.', 'error');
                }
            } catch (e) {
                console.error("Erro ao fazer login:", e);
                showAlert('Erro ao tentar fazer login. Tente novamente.', 'error');
            }
        }
        function logout() {
            currentUser = null;
            selectedCompanyForManagement = null;
            setStorage('currentUser', null);
            setStorage('selectedCompany', null);
            if (notificationListener) notificationListener();
            updateView('login');
        }
        
        // --- SUPER ADMIN MANAGEMENT (COMPANIES) ---
        async function addCompany(e) {
            e.preventDefault();
            const companyName = companyNameInput.value.trim();
            if (!companyName) { showAlert('Nome da empresa é obrigatório.', 'error'); return; }
            try {
                const docRef = await addDoc(collection(db, "companies"), {
                    name: companyName,
                    keywords: [],
                    users: [],
                    settings: { reportAccess: false, fetchOnlyNew: false, newsScope: 'br', state: '' }
                });
                await setDoc(doc(db, `companies/${docRef.id}/users`, 'default'), { user: 'admin', password: 'password', role: 'admin' });
                showAlert(`Empresa "${companyName}" adicionada com sucesso!`);
                companyNameInput.value = '';
                renderSuperAdminPage();
            } catch (e) {
                console.error("Erro ao adicionar empresa:", e);
                showAlert('Erro ao adicionar empresa.', 'error');
            }
        }
        async function renderSuperAdminPage() {
            try {
                const companies = await getDocs(collection(db, "companies"));
                companyList.innerHTML = '';
                companies.forEach(doc => {
                    const company = doc.data();
                    const li = document.createElement('li');
                    li.classList.add('bg-gray-100', 'p-3', 'rounded-md', 'flex', 'flex-wrap', 'items-center', 'justify-between', 'gap-2');
                    li.innerHTML = `
                        <span class="text-lg font-medium">${company.name}</span>
                        <div class="flex gap-2 text-sm">
                            <button class="view-link-btn text-indigo-600 hover:text-indigo-800" data-id="${doc.id}" data-name="${company.name}">Link</button>
                            <button class="manage-users-btn text-blue-600 hover:text-blue-800" data-id="${doc.id}" data-name="${company.name}">Usuários</button>
                            <button class="manage-keywords-btn text-blue-600 hover:text-blue-800" data-id="${doc.id}" data-name="${company.name}">Palavras-Chave</button>
                            <button class="manage-settings-btn text-blue-600 hover:text-blue-800" data-id="${doc.id}" data-name="${company.name}">Opções</button>
                            <button class="delete-company-btn text-red-600 hover:text-red-800" data-id="${doc.id}" data-name="${company.name}">Excluir</button>
                        </div>
                    `;
                    companyList.appendChild(li);
                });
                document.querySelectorAll('.view-link-btn').forEach(btn => btn.addEventListener('click', showAccessLink));
                document.querySelectorAll('.manage-users-btn').forEach(btn => btn.addEventListener('click', () => { selectedCompanyForManagement = { id: btn.dataset.id, name: btn.dataset.name }; updateView('company-user-admin'); }));
                document.querySelectorAll('.manage-keywords-btn').forEach(btn => btn.addEventListener('click', () => { selectedCompanyForManagement = { id: btn.dataset.id, name: btn.dataset.name }; updateView('company-keyword-admin'); }));
                document.querySelectorAll('.manage-settings-btn').forEach(btn => btn.addEventListener('click', () => { selectedCompanyForManagement = { id: btn.dataset.id, name: btn.dataset.name }; updateView('company-settings-admin'); }));
                document.querySelectorAll('.delete-company-btn').forEach(btn => btn.addEventListener('click', confirmDeleteCompany));
            } catch (e) {
                console.error("Erro ao carregar empresas:", e);
                showAlert('Erro ao carregar empresas.', 'error');
            }
        }
        function showAccessLink(e) {
            const companyId = e.target.dataset.id;
            const link = `${window.location.origin}${window.location.pathname}?companyId=${companyId}`;
            accessLinkInput.value = link;
            linkModal.classList.remove('hidden');
        }
        function confirmDeleteCompany(e) {
            companyIdToDelete = e.target.dataset.id;
            const companyName = e.target.dataset.name;
            companyNameToDeleteEl.textContent = companyName;
            deleteModal.classList.remove('hidden');
        }
        async function deleteCompany() {
            if (!companyIdToDelete) return;
            try {
                // Delete users subcollection
                const users = await getDocs(collection(db, `companies/${companyIdToDelete}/users`));
                for (const u of users.docs) { await deleteDoc(u.ref); }
                // Delete keywords subcollection
                const keywords = await getDocs(collection(db, `companies/${companyIdToDelete}/keywords`));
                for (const k of keywords.docs) { await deleteDoc(k.ref); }
                // Delete articles subcollection
                const articles = await getDocs(collection(db, `companies/${companyIdToDelete}/articles`));
                for (const a of articles.docs) { await deleteDoc(a.ref); }
                // Delete logo from storage
                const logoRef = ref(storage, `logos/${companyIdToDelete}`);
                try { await getDownloadURL(logoRef); await deleteObject(logoRef); } catch (e) { console.log('Logo não existe, continuando.'); }
                // Delete company document
                await deleteDoc(doc(db, "companies", companyIdToDelete));
                showAlert('Empresa e todos os seus dados foram excluídos com sucesso!', 'success');
                deleteModal.classList.add('hidden');
                companyIdToDelete = null;
                renderSuperAdminPage();
            } catch (e) {
                console.error("Erro ao excluir empresa:", e);
                showAlert('Erro ao excluir empresa.', 'error');
            }
        }
        
        // --- COMPANY-SPECIFIC MANAGEMENT (KEYWORDS, USERS, SETTINGS) ---
        async function renderCompanyKeywordAdminPage() {
            if (!selectedCompanyForManagement) { updateView('super-admin'); return; }
            companyKeywordAdminTitle.textContent = `Gerenciar Palavras-Chave para: ${selectedCompanyForManagement.name}`;
            try {
                const keywords = await getDocs(collection(db, `companies/${selectedCompanyForManagement.id}/keywords`));
                adminKeywordList.innerHTML = '';
                keywords.forEach(doc => {
                    const keyword = doc.data();
                    const li = document.createElement('li');
                    li.classList.add('bg-gray-100', 'p-3', 'rounded-md', 'flex', 'items-center', 'justify-between', 'gap-2');
                    li.innerHTML = `
                        <span class="text-lg">${keyword.text}</span>
                        <div class="flex gap-2 text-sm">
                            <button class="edit-btn text-blue-600 hover:text-blue-800" data-id="${doc.id}" data-text="${keyword.text}">Editar</button>
                            <button class="delete-btn text-red-600 hover:text-red-800" data-id="${doc.id}">Excluir</button>
                        </div>
                    `;
                    adminKeywordList.appendChild(li);
                });
                document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', () => {
                    keywordInput.value = btn.dataset.text;
                    keywordIdInput.value = btn.dataset.id;
                }));
                document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', async () => {
                    try {
                        await deleteDoc(doc(db, `companies/${selectedCompanyForManagement.id}/keywords`, btn.dataset.id));
                        showAlert('Palavra-chave excluída com sucesso!', 'success');
                        renderCompanyKeywordAdminPage();
                    } catch (e) {
                        console.error("Erro ao excluir palavra-chave:", e);
                        showAlert('Erro ao excluir palavra-chave.', 'error');
                    }
                }));
            } catch (e) {
                console.error("Erro ao carregar palavras-chave:", e);
                showAlert('Erro ao carregar palavras-chave.', 'error');
            }
        }
        async function saveKeyword(e) {
            e.preventDefault();
            const keywordText = keywordInput.value.trim();
            const keywordId = keywordIdInput.value;
            if (!keywordText) { showAlert('Palavra-chave é obrigatória.', 'error'); return; }
            try {
                if (keywordId) {
                    await updateDoc(doc(db, `companies/${selectedCompanyForManagement.id}/keywords`, keywordId), { text: keywordText });
                    showAlert('Palavra-chave atualizada com sucesso!', 'success');
                } else {
                    await addDoc(collection(db, `companies/${selectedCompanyForManagement.id}/keywords`), { text: keywordText });
                    showAlert('Palavra-chave adicionada com sucesso!', 'success');
                }
                keywordInput.value = '';
                keywordIdInput.value = '';
                renderCompanyKeywordAdminPage();
            } catch (e) {
                console.error("Erro ao salvar palavra-chave:", e);
                showAlert('Erro ao salvar palavra-chave.', 'error');
            }
        }
        async function renderCompanyUserAdminPage() {
            if (!selectedCompanyForManagement) { updateView('super-admin'); return; }
            companyUserAdminTitle.textContent = `Gerenciar Usuários para: ${selectedCompanyForManagement.name}`;
            try {
                const users = await getDocs(collection(db, `companies/${selectedCompanyForManagement.id}/users`));
                adminUserList.innerHTML = '';
                users.forEach(doc => {
                    const user = doc.data();
                    const li = document.createElement('li');
                    li.classList.add('bg-gray-100', 'p-3', 'rounded-md', 'flex', 'items-center', 'justify-between', 'gap-2');
                    li.innerHTML = `
                        <span class="text-lg">${user.user}</span>
                        <div class="flex gap-2 text-sm">
                            <button class="edit-user-btn text-blue-600 hover:text-blue-800" data-id="${doc.id}" data-user="${user.user}" data-pass="${user.password}">Editar</button>
                            <button class="delete-user-btn text-red-600 hover:text-red-800" data-id="${doc.id}">Excluir</button>
                        </div>
                    `;
                    adminUserList.appendChild(li);
                });
                document.querySelectorAll('.edit-user-btn').forEach(btn => btn.addEventListener('click', () => {
                    userInput.value = btn.dataset.user;
                    userPasswordInput.value = btn.dataset.pass;
                    userIdInput.value = btn.dataset.id;
                }));
                document.querySelectorAll('.delete-user-btn').forEach(btn => btn.addEventListener('click', async () => {
                    try {
                        if (btn.dataset.id === 'default') { showAlert('O usuário "admin" não pode ser excluído.', 'error'); return; }
                        await deleteDoc(doc(db, `companies/${selectedCompanyForManagement.id}/users`, btn.dataset.id));
                        showAlert('Usuário excluído com sucesso!', 'success');
                        renderCompanyUserAdminPage();
                    } catch (e) {
                        console.error("Erro ao excluir usuário:", e);
                        showAlert('Erro ao excluir usuário.', 'error');
                    }
                }));
            } catch (e) {
                console.error("Erro ao carregar usuários:", e);
                showAlert('Erro ao carregar usuários.', 'error');
            }
        }
        async function saveUser(e) {
            e.preventDefault();
            const userText = userInput.value.trim();
            const userPassword = userPasswordInput.value.trim();
            const userId = userIdInput.value;
            if (!userText || !userPassword) { showAlert('Usuário e senha são obrigatórios.', 'error'); return; }
            try {
                if (userId) {
                    await updateDoc(doc(db, `companies/${selectedCompanyForManagement.id}/users`, userId), { user: userText, password: userPassword });
                    showAlert('Usuário atualizado com sucesso!', 'success');
                } else {
                    await addDoc(collection(db, `companies/${selectedCompanyForManagement.id}/users`), { user: userText, password: userPassword });
                    showAlert('Usuário adicionado com sucesso!', 'success');
                }
                userInput.value = '';
                userPasswordInput.value = '';
                userIdInput.value = '';
                renderCompanyUserAdminPage();
            } catch (e) {
                console.error("Erro ao salvar usuário:", e);
                showAlert('Erro ao salvar usuário.', 'error');
            }
        }
        async function renderCompanySettingsAdminPage() {
            if (!selectedCompanyForManagement) { updateView('super-admin'); return; }
            companySettingsAdminTitle.textContent = `Opções para: ${selectedCompanyForManagement.name}`;
            try {
                const companyDoc = await getDoc(doc(db, "companies", selectedCompanyForManagement.id));
                const settings = companyDoc.data().settings || {};
                const logoUrl = companyDoc.data().logoUrl;
                
                reportAccessToggle.checked = !!settings.reportAccess;
                fetchOnlyNewToggle.checked = !!settings.fetchOnlyNew;

                if (settings.newsScope === 'br') document.getElementById('scope-nacional').checked = true;
                else if (settings.newsScope === 'international') document.getElementById('scope-internacional').checked = true;
                else if (settings.newsScope === 'state') document.getElementById('scope-estadual').checked = true;
                
                if (settings.newsScope === 'state') stateSelectContainer.classList.remove('hidden');
                else stateSelectContainer.classList.add('hidden');
                
                stateSelect.value = settings.state || '';
            } catch (e) {
                console.error("Erro ao carregar configurações da empresa:", e);
                showAlert('Erro ao carregar configurações da empresa.', 'error');
            }
        }
        async function saveCompanySettings() {
            if (!selectedCompanyForManagement) return;
            const settings = {
                reportAccess: reportAccessToggle.checked,
                fetchOnlyNew: fetchOnlyNewToggle.checked,
                newsScope: document.querySelector('input[name="news-scope"]:checked').value,
                state: stateSelect.value || ''
            };
            try {
                await updateDoc(doc(db, "companies", selectedCompanyForManagement.id), { settings: settings });
                showAlert('Configurações salvas com sucesso!', 'success');
            } catch (e) {
                console.error("Erro ao salvar configurações:", e);
                showAlert('Erro ao salvar configurações.', 'error');
            }
        }
        async function uploadLogo(e) {
            const file = e.target.files[0];
            if (!file || !selectedCompanyForManagement) return;
            const logoRef = ref(storage, `logos/${selectedCompanyForManagement.id}`);
            try {
                await uploadBytes(logoRef, file);
                const url = await getDownloadURL(logoRef);
                await updateDoc(doc(db, "companies", selectedCompanyForManagement.id), { logoUrl: url });
                showAlert('Logo atualizada com sucesso!', 'success');
                await loadAndDisplayLogo();
            } catch (e) {
                console.error("Erro ao fazer upload da logo:", e);
                showAlert('Erro ao fazer upload da logo.', 'error');
            }
        }
        
        // --- GLOBAL ADMIN SETTINGS ---
        async function renderGlobalKeysPage() {
            try {
                const globalKeysDoc = await getDoc(doc(db, "global_settings", "api_keys"));
                if (globalKeysDoc.exists()) {
                    const data = globalKeysDoc.data();
                    apiKeyNewsApiInput.value = data.newsapi || '';
                    apiKeyGNewsInput.value = data.gnews || '';
                    apiKeyYoutubeInput.value = data.youtube || '';
                    apiKeyBloggerInput.value = data.blogger || '';
                }
            } catch (error) {
                console.error("Erro ao carregar chaves globais:", error);
                showAlert('Erro ao carregar chaves de API globais.', 'error');
            }
        }

        async function saveGlobalKeys() {
            try {
                const newsapiKey = apiKeyNewsApiInput.value;
                const gnewsKey = apiKeyGNewsInput.value;
                const youtubeKey = apiKeyYoutubeInput.value;
                const bloggerKey = apiKeyBloggerInput.value;
                await setDoc(doc(db, "global_settings", "api_keys"), {
                    newsapi: newsapiKey,
                    gnews: gnewsKey,
                    youtube: youtubeKey,
                    blogger: bloggerKey
                });
                showAlert('Chaves de API globais salvas com sucesso!', 'success');
            } catch (error) {
                console.error("Erro ao salvar chaves globais:", error);
                showAlert('Erro ao salvar as chaves de API.', 'error');
            }
        }

        async function renderGlobalSourcesPage() {
            try {
                const globalSourcesDoc = await getDoc(doc(db, "global_settings", "news_sources"));
                if (globalSourcesDoc.exists()) {
                    const data = globalSourcesDoc.data();
                    bloggerIdInput.value = (data.bloggerIds || []).join('\n');
                    rssUrlInput.value = (data.rssUrls || []).join('\n');
                }
            } catch (error) {
                console.error("Erro ao carregar fontes globais:", error);
                showAlert('Erro ao carregar fontes de notícias globais.', 'error');
            }
        }
        
        async function saveGlobalSources() {
            try {
                const bloggerIds = bloggerIdInput.value.split('\n').map(id => id.trim()).filter(id => id.length > 0);
                const rssUrls = rssUrlInput.value.split('\n').map(url => url.trim()).filter(url => url.length > 0);
                await setDoc(doc(db, "global_settings", "news_sources"), {
                    bloggerIds: bloggerIds,
                    rssUrls: rssUrls
                });
                showAlert('Fontes globais salvas com sucesso!', 'success');
            } catch (error) {
                console.error("Erro ao salvar fontes globais:", error);
                showAlert('Erro ao salvar fontes de notícias globais.', 'error');
            }
        }

        // --- DASHBOARD & NEWS DISPLAY ---
        async function renderDashboard() {
            newsAlerts.innerHTML = '<div class="text-center text-gray-500 mt-10">Carregando notícias...</div>';
            if (currentUser.isSuperAdmin) {
                dashboardGrid.classList.add('hidden');
                superAdminDashboardMessage.classList.remove('hidden');
                return;
            }
            dashboardGrid.classList.remove('hidden');
            superAdminDashboardMessage.classList.add('hidden');
            const keywords = await getDocs(collection(db, `companies/${currentUser.companyId}/keywords`));
            dashboardKeywordList.innerHTML = keywords.docs.map(doc => `<li class="text-gray-600">${doc.data().text}</li>`).join('');
            
            await fetchArticles();
            if (currentUser.reportAccess) navRelatorio.classList.remove('hidden');
            else navRelatorio.classList.add('hidden');
        }
        async function fetchArticles() {
            try {
                const date = alertDateFilter.value || new Date().toISOString().split('T')[0];
                const startOfDay = new Date(date);
                startOfDay.setHours(0, 0, 0, 0);
                const endOfDay = new Date(date);
                endOfDay.setHours(23, 59, 59, 999);
                const q = query(
                    collection(db, `companies/${currentUser.companyId}/articles`),
                    where("publishedAt", ">=", startOfDay.toISOString()),
                    where("publishedAt", "<=", endOfDay.toISOString()),
                    orderBy("publishedAt", "desc")
                );
                const articlesSnapshot = await getDocs(q);
                allCompanyArticles = articlesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayNews(allCompanyArticles);
            } catch (e) {
                console.error("Erro ao carregar artigos:", e);
                newsAlerts.innerHTML = '<p class="text-center text-red-500 mt-10">Erro ao carregar notícias. Tente novamente.</p>';
            }
        }
        function displayNews(articles) {
            newsAlerts.innerHTML = '';
            if (articles.length === 0) {
                newsAlerts.innerHTML = '<p class="text-center text-gray-500 mt-10">Nenhuma notícia encontrada para a data selecionada.</p>';
                return;
            }
            articles.forEach(article => {
                const articleDate = new Date(article.publishedAt);
                const dateStr = articleDate.toLocaleDateString('pt-BR');
                const timeStr = articleDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const li = document.createElement('div');
                li.classList.add('p-4', 'bg-gray-50', 'rounded-lg', 'shadow-sm', 'border', 'border-gray-200');
                li.innerHTML = `
                    <h4 class="text-lg font-semibold text-indigo-700 hover:underline"><a href="${article.url}" target="_blank">${article.title}</a></h4>
                    <p class="text-gray-500 text-sm mt-1">${article.source} - ${dateStr} ${timeStr}</p>
                    <p class="text-gray-700 mt-2 text-sm">${article.description}</p>
                    <div class="mt-2 text-xs font-medium text-gray-400">Palavras-chave: ${article.keywords.join(', ')}</div>
                `;
                newsAlerts.appendChild(li);
            });
        }
        
        // --- SEARCH FUNCTIONALITY ---
        async function setupSearchPage() {
            filterContainer.innerHTML = '';
            searchResults.innerHTML = '<p class="text-gray-500">Digite algo para começar a pesquisar ou use os filtros.</p>';
            searchInput.value = '';
            if (!currentUser || currentUser.isSuperAdmin) return;
            const keywords = await getDocs(collection(db, `companies/${currentUser.companyId}/keywords`));
            keywords.forEach(doc => {
                const keyword = doc.data().text;
                const btn = document.createElement('button');
                btn.textContent = keyword;
                btn.classList.add('keyword-filter', 'px-3', 'py-1', 'rounded-full', 'text-sm', 'bg-gray-200', 'text-gray-700', 'mr-2', 'mb-2', 'hover:bg-indigo-200');
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.keyword-filter').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    filterArticles(keyword);
                });
                filterContainer.appendChild(btn);
            });
            await fetchAllArticlesForSearch();
        }
        async function fetchAllArticlesForSearch() {
            if (!currentUser || currentUser.isSuperAdmin) return;
            const articles = await getDocs(collection(db, `companies/${currentUser.companyId}/articles`));
            allCompanyArticles = articles.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }
        function filterArticles(keyword = '', searchText = '') {
            const filtered = allCompanyArticles.filter(article => {
                const matchesKeyword = !keyword || (article.keywords && article.keywords.includes(keyword));
                const matchesSearch = !searchText ||
                    article.title.toLowerCase().includes(searchText.toLowerCase()) ||
                    article.description.toLowerCase().includes(searchText.toLowerCase());
                return matchesKeyword && matchesSearch;
            });
            displayNews(filtered);
        }
        
        // --- REPORTING (CHARTS) ---
        async function renderReportPage() {
            if (!currentUser || currentUser.isSuperAdmin) return;
            const keywords = await getDocs(collection(db, `companies/${currentUser.companyId}/keywords`));
            reportKeywordFilter.innerHTML = `<option value="">Todas as palavras-chave</option>` + keywords.docs.map(doc => `<option value="${doc.data().text}">${doc.data().text}</option>`).join('');
            reportKeywordFilter.value = "";
            startDateInput.value = "";
            endDateInput.value = "";
            await fetchAllArticlesForSearch();
            updateCharts();
        }
        function updateCharts() {
            const selectedKeyword = reportKeywordFilter.value;
            const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
            const endDate = endDateInput.value ? new Date(endDateInput.value) : null;
            
            const filteredArticles = allCompanyArticles.filter(article => {
                const articleDate = new Date(article.publishedAt);
                const keywordMatch = !selectedKeyword || (article.keywords && article.keywords.includes(selectedKeyword));
                const dateMatch = (!startDate || articleDate >= startDate) && (!endDate || articleDate <= endDate);
                return keywordMatch && dateMatch;
            });
            
            // Source Chart
            const sources = filteredArticles.reduce((acc, article) => { acc[article.source] = (acc[article.source] || 0) + 1; return acc; }, {});
            if (sourceChartInstance) sourceChartInstance.destroy();
            sourceChartInstance = new Chart(sourceChart, { type: 'pie', data: { labels: Object.keys(sources), datasets: [{ data: Object.values(sources), backgroundColor: ['#4F46E5', '#3B82F6', '#2563EB', '#6366F1', '#818CF8'] }] } });

            // Date Chart
            const dates = filteredArticles.reduce((acc, article) => { const date = new Date(article.publishedAt).toLocaleDateString('pt-BR'); acc[date] = (acc[date] || 0) + 1; return acc; }, {});
            const sortedDates = Object.keys(dates).sort((a, b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
            const sortedData = sortedDates.map(date => dates[date]);
            if (dateChartInstance) dateChartInstance.destroy();
            dateChartInstance = new Chart(dateChart, { type: 'line', data: { labels: sortedDates, datasets: [{ label: 'Notícias por dia', data: sortedData, borderColor: '#4F46E5', fill: false }] } });
            
            // Sentiment Chart
            const sentiments = filteredArticles.reduce((acc, article) => { acc[article.sentiment] = (acc[article.sentiment] || 0) + 1; return acc; }, {});
            if (sentimentChartInstance) sentimentChartInstance.destroy();
            sentimentChartInstance = new Chart(sentimentChart, { type: 'bar', data: { labels: ['Positivo', 'Neutro', 'Negativo'], datasets: [{ label: 'Análise de Sentimento', data: [sentiments.positive || 0, sentiments.neutral || 0, sentiments.negative || 0], backgroundColor: ['#10B981', '#6B7280', '#EF4444'] }] } });
        }
        
        // --- NOTIFICATION BELL ---
        function setupNotificationListener() {
            if (notificationListener) notificationListener();
            if (!currentUser || currentUser.isSuperAdmin) return;
            const q = query(collection(db, `companies/${currentUser.companyId}/articles`), where("isRead", "==", false));
            notificationListener = onSnapshot(q, (snapshot) => {
                const unreadCount = snapshot.size;
                if (unreadCount > 0) {
                    notificationBadge.textContent = unreadCount;
                    notificationBadge.classList.remove('hidden');
                    notificationBell.classList.add('animate-ring');
                } else {
                    notificationBadge.classList.add('hidden');
                    notificationBell.classList.remove('animate-ring');
                }
            });
        }
        async function markAllAsRead() {
            if (!currentUser || currentUser.isSuperAdmin) return;
            const q = query(collection(db, `companies/${currentUser.companyId}/articles`), where("isRead", "==", false));
            const snapshot = await getDocs(q);
            const batch = writeBatch(db);
            snapshot.docs.forEach(doc => {
                batch.update(doc.ref, { isRead: true });
            });
            await batch.commit();
        }
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Get all page sections
            pageSections = document.querySelectorAll('.page-section');

            // --- DOM Element Initialization ---
            navLoggedIn = document.getElementById('nav-logged-in');
            navInicio = document.getElementById('nav-inicio');
            navRelatorio = document.getElementById('nav-relatorio');
            navPesquisa = document.getElementById('nav-pesquisa');
            navSuperAdmin = document.getElementById('nav-super-admin');
            navLogout = document.getElementById('nav-logout');
            navConfiguracoesAdmin = document.getElementById('nav-configuracoes-admin');
            globalAlert = document.getElementById('global-alert');
            loginPage = document.getElementById('login-page');
            dashboardPage = document.getElementById('dashboard-page');
            searchPage = document.getElementById('search-page');
            superAdminPage = document.getElementById('super-admin-page');
            companyKeywordAdminPage = document.getElementById('company-keyword-admin-page');
            companySettingsAdminPage = document.getElementById('company-settings-admin-page');
            reportPage = document.getElementById('report-page');
            companyUserAdminPage = document.getElementById('company-user-admin-page');
            configuracoesAdminPage = document.getElementById('configuracoes-admin-page');
            loginForm = document.getElementById('login-form');
            dashboardTitle = document.getElementById('dashboard-title');
            currentDateTimeEl = document.getElementById('current-datetime');
            dashboardKeywordList = document.getElementById('dashboard-keyword-list');
            newsAlertsContainer = document.getElementById('news-alerts-container');
            newsAlerts = document.getElementById('news-alerts');
            alertDateFilter = document.getElementById('alert-date-filter');
            reportAccessToggle = document.getElementById('report-access-toggle');
            logoUploadInput = document.getElementById('logo-upload');
            headerLogoContainer = document.getElementById('header-logo-container');
            loginLogoContainer = document.getElementById('login-logo-container');
            filterContainer = document.getElementById('filter-container');
            searchInput = document.getElementById('search-input');
            searchResults = document.getElementById('search-results');
            companyForm = document.getElementById('company-form');
            companyList = document.getElementById('company-list');
            backToSuperAdminKwBtn = document.getElementById('back-to-super-admin-kw');
            backToSuperAdminSettingsBtn = document.getElementById('back-to-super-admin-settings');
            backToSuperAdminUsersBtn = document.getElementById('back-to-super-admin-users');
            companyKeywordAdminTitle = document.getElementById('company-keyword-admin-title');
            companySettingsAdminTitle = document.getElementById('company-settings-admin-title');
            companyUserAdminTitle = document.getElementById('company-user-admin-title');
            keywordForm = document.getElementById('keyword-form');
            keywordInput = document.getElementById('keyword-input');
            keywordIdInput = document.getElementById('keyword-id');
            adminKeywordList = document.getElementById('admin-keyword-list');
            userForm = document.getElementById('user-form');
            userInput = document.getElementById('user-input');
            userPasswordInput = document.getElementById('user-password-input');
            userIdInput = document.getElementById('user-id');
            adminUserList = document.getElementById('admin-user-list');
            notificationBell = document.querySelector('#notification-bell-container svg');
            notificationBadge = document.getElementById('notification-badge');
            manualTriggerBtn = document.getElementById('manual-trigger-btn');
            deleteModal = document.getElementById('delete-modal');
            confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            companyNameToDeleteEl = document.getElementById('company-name-to-delete');
            newsScopeContainer = document.getElementById('news-scope-container');
            startDateInput = document.getElementById('start-date');
            endDateInput = document.getElementById('end-date');
            linkModal = document.getElementById('link-modal');
            accessLinkInput = document.getElementById('access-link-input');
            copyLinkBtn = document.getElementById('copy-link-btn');
            closeLinkModalBtn = document.getElementById('close-link-modal-btn');
            reportKeywordFilter = document.getElementById('report-keyword-filter');
            stateSelectContainer = document.getElementById('state-select-container');
            stateSelect = document.getElementById('state-select');
            changePasswordForm = document.getElementById('change-password-form');
            apiKeyNewsApiInput = document.getElementById('api-key-newsapi');
            apiKeyGNewsInput = document.getElementById('api-key-gnews');
            apiKeyYoutubeInput = document.getElementById('api-key-youtube');
            apiKeyBloggerInput = document.getElementById('api-key-blogger');
            bloggerIdInput = document.getElementById('blogger-id');
            rssUrlInput = document.getElementById('rss-url');
            fetchOnlyNewToggle = document.getElementById('fetch-only-new-toggle');
            changePasswordPage = document.getElementById('change-password-page');
            globalKeysPage = document.getElementById('global-keys-page');
            globalSourcesPage = document.getElementById('global-sources-page');
            btnChangePassword = document.getElementById('btn-change-password');
            btnGlobalKeys = document.getElementById('btn-global-keys');
            btnNewsSources = document.getElementById('btn-news-sources');
            backToAdminConfig1 = document.getElementById('back-to-admin-config-1');
            backToAdminConfig2 = document.getElementById('back-to-admin-config-2');
            backToAdminConfig3 = document.getElementById('back-to-admin-config-3');
            saveGlobalKeysBtn = document.getElementById('save-global-keys-btn');
            saveGlobalSourcesBtn = document.getElementById('save-global-sources-btn');
            const dashboardGrid = document.getElementById('dashboard-grid');
            const superAdminDashboardMessage = document.getElementById('super-admin-dashboard-message');
            
            const states = ["AC", "AL", "AP", "AM", "BA", "CE", "DF", "ES", "GO", "MA", "MT", "MS", "MG", "PA", "PB", "PR", "PE", "PI", "RJ", "RN", "RS", "RO", "RR", "SC", "SP", "SE", "TO"];
            stateSelect.innerHTML = states.map(s => `<option value="${s}">${s}</option>`).join('');

            // --- Event Listeners ---
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const user = document.getElementById('login-user').value;
                const pass = document.getElementById('login-password').value;
                const companyId = document.getElementById('login-company').value || null;
                login(user, pass, companyId);
            });
            navInicio.addEventListener('click', (e) => { e.preventDefault(); updateView('dashboard'); });
            navLogout.addEventListener('click', (e) => { e.preventDefault(); logout(); });
            navSuperAdmin.addEventListener('click', (e) => { e.preventDefault(); updateView('super-admin'); });
            navPesquisa.addEventListener('click', (e) => { e.preventDefault(); updateView('search'); });
            navRelatorio.addEventListener('click', (e) => { e.preventDefault(); updateView('report'); });
            navConfiguracoesAdmin.addEventListener('click', (e) => { e.preventDefault(); updateView('configuracoes-admin'); });
            btnChangePassword.addEventListener('click', () => updateView('change-password'));
            btnGlobalKeys.addEventListener('click', () => updateView('global-keys'));
            btnNewsSources.addEventListener('click', () => updateView('global-sources'));
            backToAdminConfig1.addEventListener('click', () => updateView('configuracoes-admin'));
            backToAdminConfig2.addEventListener('click', () => updateView('configuracoes-admin'));
            backToAdminConfig3.addEventListener('click', () => updateView('configuracoes-admin'));
            companyForm.addEventListener('submit', addCompany);
            keywordForm.addEventListener('submit', saveKeyword);
            userForm.addEventListener('submit', saveUser);
            if (saveGlobalKeysBtn) saveGlobalKeysBtn.addEventListener('click', saveGlobalKeys);
            if (saveGlobalSourcesBtn) saveGlobalSourcesBtn.addEventListener('click', saveGlobalSources);
            backToSuperAdminKwBtn.addEventListener('click', () => { selectedCompanyForManagement = null; updateView('super-admin'); });
            backToSuperAdminSettingsBtn.addEventListener('click', () => { selectedCompanyForManagement = null; updateView('super-admin'); });
            backToSuperAdminUsersBtn.addEventListener('click', () => { selectedCompanyForManagement = null; updateView('super-admin'); });
            confirmDeleteBtn.addEventListener('click', deleteCompany);
            cancelDeleteBtn.addEventListener('click', () => { deleteModal.classList.add('hidden'); companyIdToDelete = null; });
            closeLinkModalBtn.addEventListener('click', () => linkModal.classList.add('hidden'));
            copyLinkBtn.addEventListener('click', () => { accessLinkInput.select(); document.execCommand('copy'); showAlert('Link copiado para a área de transferência!', 'success'); });
            logoUploadInput.addEventListener('change', uploadLogo);
            newsScopeContainer.addEventListener('change', () => {
                const selectedScope = document.querySelector('input[name="news-scope"]:checked').value;
                if (selectedScope === 'state') stateSelectContainer.classList.remove('hidden');
                else stateSelectContainer.classList.add('hidden');
                saveCompanySettings();
            });
            reportAccessToggle.addEventListener('change', saveCompanySettings);
            fetchOnlyNewToggle.addEventListener('change', saveCompanySettings);
            alertDateFilter.addEventListener('change', fetchArticles);
            searchInput.addEventListener('input', (e) => filterArticles(document.querySelector('.keyword-filter.active')?.dataset.text, e.target.value));
            reportKeywordFilter.addEventListener('change', updateCharts);
            startDateInput.addEventListener('change', updateCharts);
            endDateInput.addEventListener('change', updateCharts);
            if (notificationBell) notificationBell.addEventListener('click', markAllAsRead);
            if (manualTriggerBtn) manualTriggerBtn.addEventListener('click', manualTrigger);
            
            // Initial load
            currentUser = getStorage('currentUser', null);
            selectedCompanyForManagement = getStorage('selectedCompany', null);
            if (currentUser) {
                if (currentUser.companyId && !currentUser.logoUrl) {
                    const companyIdEl = document.getElementById('login-company-wrapper');
                    if (companyIdEl) companyIdEl.classList.add('hidden');
                }
                updateView('dashboard');
                setupNotificationListener();
            } else {
                updateView('login');
                const urlParams = new URLSearchParams(window.location.search);
                const companyId = urlParams.get('companyId');
                if (companyId) {
                    document.getElementById('login-company').value = companyId;
                    const companyIdEl = document.getElementById('login-company-wrapper');
                    if (companyIdEl) companyIdEl.classList.add('hidden');
                } else {
                    const companyIdEl = document.getElementById('login-company-wrapper');
                    if (companyIdEl) companyIdEl.classList.remove('hidden');
                }
            }
        });
    </script>
</body>
</html>