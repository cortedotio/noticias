<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Corre√ß√£o de Artigos</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button { 
            padding: 15px 30px; 
            font-size: 16px; 
            cursor: pointer; 
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            margin: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .loading { color: #007bff; }
        .info { color: #17a2b8; }
        #result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            background: #f8f9fa;
        }
        .progress {
            margin: 20px 0;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #28a745;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ†Ô∏è Teste de Corre√ß√£o de Artigos</h1>
        <p>Teste a fun√ß√£o de corre√ß√£o de artigos do Firebase Functions:</p>
        
        <button id="test-fix-btn" onclick="testFixArticles()">üöÄ Testar Corre√ß√£o de Artigos</button>
        <button id="test-fix-existing-btn" onclick="testFixExistingArticles()">üîß Testar Corre√ß√£o de Artigos Existentes</button>
        
        <div class="progress" id="progress" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div id="progress-text">0%</div>
        </div>
        
        <div id="result"></div>
        
        <div style="margin-top: 30px; padding: 15px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
            <h4>üìã Regras de Corre√ß√£o:</h4>
            <ul>
                <li><strong>YouTube:</strong> Fonte ‚Üí "Canal", Autor ‚Üí "Reda√ß√£o*"</li>
                <li><strong>Outras fontes:</strong> Fonte ‚Üí dom√≠nio da URL (ex: g1.globo.com)</li>
                <li><strong>Artigos sem fonte:</strong> Ser√£o identificados e corrigidos</li>
            </ul>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Firebase (ser√° carregada dinamicamente)
        let functions;
        let appId = 'test-app-' + Date.now();
        
        // Fun√ß√£o para carregar configura√ß√£o do Firebase
        async function loadFirebaseConfig() {
            try {
                // Tentar carregar configura√ß√£o do projeto
                const response = await fetch('/firebase-config.json');
                if (!response.ok) {
                    throw new Error('Configura√ß√£o n√£o encontrada');
                }
                const config = await response.json();
                
                // Inicializar Firebase
                if (typeof firebase !== 'undefined') {
                    firebase.initializeApp(config);
                    functions = firebase.functions();
                    
                    // Para desenvolvimento, usar emulador se dispon√≠vel
                    try {
                        functions.useFunctionsEmulator('http://localhost:5001');
                        console.log('Usando emulador de fun√ß√µes');
                    } catch (e) {
                        console.log('Emulador n√£o dispon√≠vel, usando produ√ß√£o');
                    }
                    
                    return true;
                } else {
                    throw new Error('Firebase SDK n√£o carregado');
                }
            } catch (error) {
                console.error('Erro ao carregar configura√ß√£o do Firebase:', error);
                return false;
            }
        }
        
        // Fun√ß√£o para mostrar progresso
        function showProgress(percent, text) {
            const progressDiv = document.getElementById('progress');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            progressDiv.style.display = 'block';
            progressFill.style.width = percent + '%';
            progressText.textContent = text || (percent + '%');
        }
        
        // Fun√ß√£o para esconder progresso
        function hideProgress() {
            document.getElementById('progress').style.display = 'none';
        }
        
        // Fun√ß√£o para mostrar resultado
        function showResult(message, type = 'info') {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `<p class="${type}">${message}</p>`;
        }
        
        // Fun√ß√£o para testar fixAllCompaniesArticles
        async function testFixArticles() {
            const btn = document.getElementById('test-fix-btn');
            const originalText = btn.textContent;
            
            if (!functions) {
                const configLoaded = await loadFirebaseConfig();
                if (!configLoaded) {
                    showResult('‚ùå Erro: N√£o foi poss√≠vel carregar a configura√ß√£o do Firebase', 'error');
                    return;
                }
            }
            
            if (!confirm('‚ö†Ô∏è Tem certeza que deseja testar a corre√ß√£o de TODOS os artigos das empresas?')) {
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'üîÑ Corrigindo...';
            showResult('üöÄ Iniciando corre√ß√£o de todos os artigos...', 'loading');
            showProgress(10, 'Preparando...');
            
            try {
                const fixAllCompaniesArticles = functions.httpsCallable('fixAllCompaniesArticles', { 
                    timeout: 600000 // 10 minutos
                });
                
                showProgress(20, 'Chamando fun√ß√£o...');
                const result = await fixAllCompaniesArticles({ appId });
                
                showProgress(100, 'Conclu√≠do!');
                
                const data = result.data;
                let message = `‚úÖ Corre√ß√£o conclu√≠da com sucesso!\\n`;
                message += `üìä Total de artigos processados: ${data.totalProcessed || 0}\\n`;
                message += `‚úèÔ∏è Total de artigos corrigidos: ${data.totalFixed || 0}\\n`;
                message += `‚è±Ô∏è Tempo de execu√ß√£o: ${data.duration || 'N/A'}\\n`;
                
                if (data.companies && data.companies.length > 0) {
                    message += `\\nüìã Empresas processadas: ${data.companies.length}\\n`;
                    data.companies.forEach(company => {
                        message += `  ‚Ä¢ ${company.name}: ${company.articlesProcessed || 0} artigos, ${company.articlesFixed || 0} corrigidos\\n`;
                    });
                }
                
                showResult(message, 'success');
                
            } catch (error) {
                console.error('Erro ao corrigir artigos:', error);
                showResult(`‚ùå Erro ao corrigir artigos: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
                hideProgress();
            }
        }
        
        // Fun√ß√£o para testar fixExistingArticles
        async function testFixExistingArticles() {
            const btn = document.getElementById('test-fix-existing-btn');
            const originalText = btn.textContent;
            
            if (!functions) {
                const configLoaded = await loadFirebaseConfig();
                if (!configLoaded) {
                    showResult('‚ùå Erro: N√£o foi poss√≠vel carregar a configura√ß√£o do Firebase', 'error');
                    return;
                }
            }
            
            if (!confirm('‚ö†Ô∏è Tem certeza que deseja testar a corre√ß√£o de artigos existentes?')) {
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'üîÑ Corrigindo...';
            showResult('üöÄ Iniciando corre√ß√£o de artigos existentes...', 'loading');
            showProgress(10, 'Preparando...');
            
            try {
                const fixExistingArticles = functions.httpsCallable('fixExistingArticles', { 
                    timeout: 600000 // 10 minutos
                });
                
                showProgress(20, 'Chamando fun√ß√£o...');
                const result = await fixExistingArticles({ appId });
                
                showProgress(100, 'Conclu√≠do!');
                
                const data = result.data;
                let message = `‚úÖ Corre√ß√£o conclu√≠da com sucesso!\\n`;
                message += `üìä Total de artigos processados: ${data.totalProcessed || 0}\\n`;
                message += `‚úèÔ∏è Total de artigos corrigidos: ${data.totalFixed || 0}\\n`;
                
                showResult(message, 'success');
                
            } catch (error) {
                console.error('Erro ao corrigir artigos:', error);
                showResult(`‚ùå Erro ao corrigir artigos: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
                hideProgress();
            }
        }
        
        // Carregar configura√ß√£o ao carregar a p√°gina
        window.addEventListener('load', async () => {
            console.log('üìù P√°gina de teste carregada');
            showResult('üì° Aguardando comando...', 'info');
        });
    </script>
</body>
</html>