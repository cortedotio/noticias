<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clipping de Notícias - Admin</title>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        header { position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; }
        main { padding-top: 80px; }
        .page-section { display: none; }
        .page-section.active { display: block; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        @keyframes ring {
            0%, 100% { transform: rotate(0); }
            10%, 30%, 50%, 70%, 90% { transform: rotate(-10deg); }
            20%, 40%, 60%, 80% { transform: rotate(10deg); }
        }
        .animate-ring { animation: ring 1s ease-in-out; }

        #notification-badge {
            min-width: 1.25rem;
            height: 1.25rem;
            padding: 0 0.25rem;
            line-height: 1.25rem;
            font-size: 0.75rem;
            font-weight: bold;
            top: -0.25rem;
            right: -0.5rem;
        }
        .keyword-filter.active {
            background-color: #4F46E5 !important;
            color: white !important;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="text-2xl font-bold text-indigo-600 flex items-center">
               <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2 h-8 w-8"><path d="M2.5 17a2.4 2.4 0 0 1 3 0L12 23l6.5-6.5a2.4 2.4 0 0 1 3 0Z"/><path d="M5 11.5a2.5 2.5 0 0 1 0-5c1.5 0 2.8 1.3 2.8 2.8V13c0 1.4-1.3 2.8-2.8 2.8-1.5 0-2.8-1.3-2.8-2.8V8.5"/><path d="M19 11.5a2.5 2.5 0 0 0 0-5c-1.5 0-2.8 1.3-2.8 2.8V13c0 1.4 1.3 2.8 2.8 2.8 1.5 0-2.8-1.3-2.8-2.8V8.5"/></svg>
               NewsClip
            </div>
            <div class="flex items-center">
                <div id="nav-logged-in" class="hidden items-center">
                    <a href="#" id="nav-inicio" class="text-gray-600 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-medium">Início</a>
                    <a href="#" id="nav-relatorio" class="text-gray-600 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-medium">Relatório</a>
                    <a href="#" id="nav-pesquisa" class="text-gray-600 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-medium">Pesquisa</a>
                    <a href="#" id="nav-super-admin" class="hidden text-red-600 hover:text-red-800 px-3 py-2 rounded-md text-sm font-bold">Super Admin</a>
                    <div id="notification-bell-container" class="relative cursor-pointer ml-4">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                        <span id="notification-badge" class="hidden absolute text-white text-center rounded-full bg-red-500 ring-2 ring-white"></span>
                    </div>
                    <a href="#" id="nav-logout" class="ml-4 bg-indigo-600 text-white hover:bg-indigo-700 px-3 py-2 rounded-md text-sm font-medium">Sair</a>
                </div>
                <div id="header-logo-container" class="ml-4 h-10 w-auto"></div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-6">
        <div id="global-alert" class="mb-6"></div>

        <!-- Login Section -->
        <section id="login-page" class="page-section fade-in">
            <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg mt-10 relative">
                <div id="login-logo-container" class="absolute top-4 right-4 h-12 w-auto"></div>
                <h2 class="text-2xl font-bold text-center mb-6">Acesso ao Sistema</h2>
                <form id="login-form">
                    <div class="mb-4"><label for="login-company" class="block text-sm font-medium text-gray-700 mb-1">Empresa</label><input type="text" id="login-company" class="w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                    <div class="mb-4"><label for="login-user" class="block text-sm font-medium text-gray-700 mb-1">Usuário</label><input type="text" id="login-user" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <div class="mb-6"><label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Senha</label><input type="password" id="login-password" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Entrar</button>
                </form>
            </div>
        </section>

        <!-- Dashboard Section -->
        <section id="dashboard-page" class="page-section fade-in">
            <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 bg-white p-4 rounded-lg shadow-md">
                <h2 id="dashboard-title" class="text-2xl font-bold text-gray-800 mb-2 md:mb-0">Notícias do Dia</h2>
                <p id="current-datetime" class="text-lg text-indigo-600 font-medium"></p>
            </div>
            <div id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1 bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold mb-3 text-gray-700">Palavras-Chave Monitoradas</h3>
                    <ul id="dashboard-keyword-list" class="space-y-2"></ul>
                </div>
                <div id="news-alerts-container" class="md:col-span-2">
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-700">Relatório de Alertas</h3>
                            <div class="flex items-center gap-2">
                                <label for="alert-date-filter" class="text-sm font-medium">Filtrar por data:</label>
                                <input type="date" id="alert-date-filter" class="px-2 py-1 border border-gray-300 rounded-md text-sm">
                            </div>
                        </div>
                        <div id="news-alerts" class="space-y-4 max-h-[70vh] overflow-y-auto"></div>
                    </div>
                </div>
            </div>
             <div id="super-admin-dashboard-message" class="hidden bg-white p-8 rounded-lg shadow-lg text-center">
                <h3 class="text-2xl font-bold">Bem-vindo, Super Admin!</h3>
                <p class="mt-4 text-gray-600">Use o menu "Super Admin" no topo da página para gerenciar empresas e usuários.</p>
            </div>
        </section>
        
        <!-- Super Admin Section -->
        <section id="super-admin-page" class="page-section fade-in">
            <h2 class="text-3xl font-bold mb-6 text-red-600">Painel Super-Administrador</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold mb-4">Adicionar Nova Empresa</h3>
                    <form id="company-form" class="space-y-4">
                        <div><label for="company-name-input">Nome da Empresa</label><input type="text" id="company-name-input" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                        <button type="submit" class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700">Adicionar Empresa</button>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold mb-4">Empresas Cadastradas</h3>
                    <ul id="company-list" class="space-y-2 max-h-96 overflow-y-auto"></ul>
                </div>
            </div>
        </section>

        <!-- Company User Management Section -->
        <section id="company-user-admin-page" class="page-section fade-in">
            <button id="back-to-super-admin-users" class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar para Super Admin</button>
            <h2 id="company-user-admin-title" class="text-3xl font-bold mb-6">Gerenciar Usuários</h2>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <form id="user-form" class="flex flex-col sm:flex-row gap-2 mb-4">
                    <input type="text" id="user-input" placeholder="Nome do usuário" class="flex-grow px-3 py-2 border border-gray-300 rounded-md">
                    <input type="text" id="user-password-input" placeholder="Senha" class="flex-grow px-3 py-2 border border-gray-300 rounded-md">
                    <input type="hidden" id="user-id">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Salvar</button>
                </form>
                <ul id="admin-user-list" class="space-y-2 max-h-96 overflow-y-auto"></ul>
            </div>
        </section>

        <!-- Company Keyword Management Section -->
        <section id="company-keyword-admin-page" class="page-section fade-in">
            <button id="back-to-super-admin-kw" class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar para Super Admin</button>
            <h2 id="company-keyword-admin-title" class="text-3xl font-bold mb-6">Gerenciar Palavras-Chave</h2>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <form id="keyword-form" class="flex gap-2 mb-4">
                    <input type="text" id="keyword-input" placeholder="Adicionar ou editar palavra" class="flex-grow px-3 py-2 border border-gray-300 rounded-md">
                    <input type="hidden" id="keyword-id">
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Salvar</button>
                </form>
                <ul id="admin-keyword-list" class="space-y-2 max-h-96 overflow-y-auto"></ul>
            </div>
        </section>

        <!-- Company Settings Management Section -->
        <section id="company-settings-admin-page" class="page-section fade-in">
            <button id="back-to-super-admin-settings" class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Voltar para Super Admin</button>
            <h2 id="company-settings-admin-title" class="text-3xl font-bold mb-6">Configurações da Empresa</h2>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="space-y-6">
                    <div class="flex items-center"><input type="checkbox" id="report-access-toggle" class="h-4 w-4 text-indigo-600 border-gray-300 rounded"><label for="report-access-toggle" class="ml-2 block text-sm text-gray-900">Liberar acesso ao relatório de alertas na tela inicial.</label></div>
                    <div><h4 class="text-lg font-semibold mb-2">Logo da Empresa</h4><input type="file" id="logo-upload" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"></div>
                    <div>
                        <h4 class="text-lg font-semibold mb-2">Escopo das Notícias</h4>
                        <div id="news-scope-container" class="space-y-2">
                            <div class="flex items-center"><input type="radio" id="scope-nacional" name="news-scope" value="br" class="h-4 w-4 text-indigo-600 border-gray-300"><label for="scope-nacional" class="ml-2 block text-sm text-gray-900">Nacionais (Brasil)</label></div>
                            <div class="flex items-center"><input type="radio" id="scope-internacional" name="news-scope" value="us" class="h-4 w-4 text-indigo-600 border-gray-300"><label for="scope-internacional" class="ml-2 block text-sm text-gray-900">Internacionais (EUA)</label></div>
                            <div class="flex items-center"><input type="radio" id="scope-estaduais" name="news-scope" value="br-state" class="h-4 w-4 text-indigo-600 border-gray-300"><label for="scope-estaduais" class="ml-2 block text-sm text-gray-900">Estaduais (requer configuração adicional)</label></div>
                        </div>
                    </div>
                    <div><h4 class="text-lg font-semibold mb-2">Chave da API GNews</h4><div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md"><p>Insira a chave da API para que o robô possa buscar notícias.</p><input type="text" id="api-key-input" placeholder="Cole a chave da API GNews aqui" class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-md"></div></div>
                </div>
            </div>
        </section>

        <!-- Report Section -->
        <section id="report-page" class="page-section fade-in">
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-3xl font-bold mb-6 text-gray-700">Relatórios Gráficos</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Chart by Source -->
                    <div class="p-4 border rounded-lg">
                        <h3 class="text-xl font-semibold mb-4 text-center">Notícias por Veículo</h3>
                        <canvas id="source-chart"></canvas>
                    </div>
                    <!-- Chart by Date -->
                    <div class="p-4 border rounded-lg">
                        <h3 class="text-xl font-semibold mb-4 text-center">Notícias por Período</h3>
                        <div class="flex justify-center items-center gap-4 mb-4">
                            <div><label for="start-date" class="text-sm">De:</label><input type="date" id="start-date" class="px-2 py-1 border rounded-md"></div>
                            <div><label for="end-date" class="text-sm">Até:</label><input type="date" id="end-date" class="px-2 py-1 border rounded-md"></div>
                        </div>
                         <canvas id="date-chart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Search Section -->
        <section id="search-page" class="page-section fade-in">
             <div class="bg-white p-6 md:p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl md:text-3xl font-bold mb-6">Pesquisar nos Alertas Salvos</h2>
                <div id="filter-container" class="mb-8 p-4 border border-gray-200 rounded-lg bg-gray-50"></div>
                <input type="text" id="search-input" placeholder="Digite para pesquisar em títulos ou descrições..." class="w-full p-3 border border-gray-300 rounded-md mb-6">
                <div id="search-results" class="space-y-4 max-h-[60vh] overflow-y-auto"><p class="text-gray-500">Digite algo para começar a pesquisar ou use os filtros.</p></div>
            </div>
        </section>
    </main>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Excluir Empresa</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">Tem certeza que deseja excluir a empresa <strong id="company-name-to-delete"></strong>?<br><br><span class="font-bold text-red-600">Esta ação é permanente e removerá todos os dados associados.</span></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirm-delete-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700">Sim, excluir</button>
                    <button id="cancel-delete-btn" class="mt-3 px-4 py-2 bg-gray-200 text-gray-900 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, addDoc, deleteDoc, updateDoc, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyCWzQM1SbIgO10GIu4AZ8lVtwmcKPEPAbo",
            authDomain: "noticias-6e952.firebaseapp.com",
            projectId: "noticias-6e952",
            storageBucket: "noticias-6e952.appspot.com",
            messagingSenderId: "788555331572",
            appId: "1:788555331572:web:328cc3967fad0155352ba1"
        };

        // --- Firebase Init ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const functions = getFunctions(app, 'southamerica-east1');

        // --- DOM Elements ---
        const pageSections = document.querySelectorAll('.page-section');
        const navLoggedIn = document.getElementById('nav-logged-in');
        const navInicio = document.getElementById('nav-inicio'), navRelatorio = document.getElementById('nav-relatorio'), navPesquisa = document.getElementById('nav-pesquisa'), navSuperAdmin = document.getElementById('nav-super-admin'), navLogout = document.getElementById('nav-logout');
        const globalAlert = document.getElementById('global-alert');
        const loginPage = document.getElementById('login-page'), dashboardPage = document.getElementById('dashboard-page'), searchPage = document.getElementById('search-page'), superAdminPage = document.getElementById('super-admin-page'), companyKeywordAdminPage = document.getElementById('company-keyword-admin-page'), companySettingsAdminPage = document.getElementById('company-settings-admin-page'), reportPage = document.getElementById('report-page'), companyUserAdminPage = document.getElementById('company-user-admin-page');
        const loginForm = document.getElementById('login-form');
        const dashboardTitle = document.getElementById('dashboard-title'), currentDateTimeEl = document.getElementById('current-datetime'), dashboardKeywordList = document.getElementById('dashboard-keyword-list'), newsAlertsContainer = document.getElementById('news-alerts-container'), newsAlerts = document.getElementById('news-alerts'), alertDateFilter = document.getElementById('alert-date-filter');
        const apiKeyInput = document.getElementById('api-key-input'), reportAccessToggle = document.getElementById('report-access-toggle'), logoUploadInput = document.getElementById('logo-upload');
        const headerLogoContainer = document.getElementById('header-logo-container'), loginLogoContainer = document.getElementById('login-logo-container');
        const filterContainer = document.getElementById('filter-container'), searchInput = document.getElementById('search-input'), searchResults = document.getElementById('search-results');
        const companyForm = document.getElementById('company-form'), companyList = document.getElementById('company-list');
        const backToSuperAdminKwBtn = document.getElementById('back-to-super-admin-kw'), backToSuperAdminSettingsBtn = document.getElementById('back-to-super-admin-settings'), backToSuperAdminUsersBtn = document.getElementById('back-to-super-admin-users'), companyKeywordAdminTitle = document.getElementById('company-keyword-admin-title'), companySettingsAdminTitle = document.getElementById('company-settings-admin-title'), companyUserAdminTitle = document.getElementById('company-user-admin-title'), keywordForm = document.getElementById('keyword-form'), keywordInput = document.getElementById('keyword-input'), keywordIdInput = document.getElementById('keyword-id'), adminKeywordList = document.getElementById('admin-keyword-list');
        const userForm = document.getElementById('user-form'), userInput = document.getElementById('user-input'), userPasswordInput = document.getElementById('user-password-input'), userIdInput = document.getElementById('user-id'), adminUserList = document.getElementById('admin-user-list');
        const notificationBell = document.getElementById('notification-bell-container'), notificationBadge = document.getElementById('notification-badge');
        const deleteModal = document.getElementById('delete-modal'), confirmDeleteBtn = document.getElementById('confirm-delete-btn'), cancelDeleteBtn = document.getElementById('cancel-delete-btn'), companyNameToDeleteEl = document.getElementById('company-name-to-delete');
        const newsScopeContainer = document.getElementById('news-scope-container');
        const startDateInput = document.getElementById('start-date'), endDateInput = document.getElementById('end-date');

        // --- App State ---
        let currentUser = null, clockInterval = null, selectedCompanyForManagement = null, allCompanyArticles = [], companyIdToDelete = null;
        let sourceChartInstance = null, dateChartInstance = null;

        // --- Utils ---
        function showAlert(message, type = 'success') { const c = type === 'success' ? 'bg-green-100 border-green-500 text-green-700' : 'bg-red-100 border-red-500 text-red-700'; globalAlert.innerHTML = `<div class="${c} border-l-4 p-4 rounded-md fade-in" role="alert"><p>${message}</p></div>`; setTimeout(() => { globalAlert.innerHTML = ''; }, 5000); }
        function updateView(pageName) { pageSections.forEach(s => s.classList.remove('active')); const i = !!currentUser; navLoggedIn.style.display = i ? 'flex' : 'none'; navSuperAdmin.classList.toggle('hidden', !currentUser || !currentUser.isSuperAdmin); navRelatorio.classList.toggle('hidden', !currentUser || currentUser.isSuperAdmin); if (clockInterval) clearInterval(clockInterval); loadAndDisplayLogo(); switch (pageName) { case 'login': loginPage.classList.add('active'); break; case 'dashboard': dashboardPage.classList.add('active'); renderDashboard(); updateDateTime(); clockInterval = setInterval(updateDateTime, 60000); break; case 'super-admin': superAdminPage.classList.add('active'); renderSuperAdminPage(); break; case 'search': searchPage.classList.add('active'); setupSearchPage(); break; case 'report': reportPage.classList.add('active'); renderReportPage(); break; case 'company-keyword-admin': companyKeywordAdminPage.classList.add('active'); renderCompanyKeywordAdminPage(); break; case 'company-settings-admin': companySettingsAdminPage.classList.add('active'); renderCompanySettingsAdminPage(); break; case 'company-user-admin': companyUserAdminPage.classList.add('active'); renderCompanyUserAdminPage(); break; } }
        function getStorage(key, defaultValue) { try { const d = localStorage.getItem(key); return d ? JSON.parse(d) : defaultValue; } catch (e) { console.error(e); return defaultValue; } }
        function setStorage(key, value) { localStorage.setItem(key, JSON.stringify(value)); }
        function updateDateTime() { if (!currentDateTimeEl) return; const n = new Date(), f = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }; currentDateTimeEl.textContent = `Data: ${n.toLocaleDateString('pt-BR', f).replace(',', ' -')}`; }

        // --- Auth & Logo ---
        async function handleLogin(e) { e.preventDefault(); const companyName = document.getElementById('login-company').value.trim(); const user = document.getElementById('login-user').value.trim(); const pass = document.getElementById('login-password').value.trim(); if (user.toLowerCase() === 'ulysses' && pass === 'adminqwert') { currentUser = { username: 'Ulysses', isSuperAdmin: true, companyId: 'super', companyName: 'Super Admin' }; setStorage('clipping_currentUser', currentUser); updateView('dashboard'); return; } try { const companiesQuery = query(collection(db, "companies"), where("name", "==", companyName.toUpperCase())); const companiesSnapshot = await getDocs(companiesQuery); if (companiesSnapshot.empty) { showAlert('Empresa não encontrada.', 'error'); return; } const companyDoc = companiesSnapshot.docs[0]; const company = { id: companyDoc.id, ...companyDoc.data() }; if (company.status === 'inactive') { showAlert('Esta empresa está inativa.', 'error'); return; } const usersQuery = query(collection(db, "companies", company.id, "users"), where("username", "==", user), where("password", "==", pass)); const usersSnapshot = await getDocs(usersQuery); if(!usersSnapshot.empty) { currentUser = { username: user, companyId: company.id, companyName: company.name, isSuperAdmin: false }; setStorage('clipping_currentUser', currentUser); updateView('dashboard'); } else { showAlert('Usuário ou senha inválidos.', 'error'); } } catch (error) { console.error("Login error:", error); showAlert("Ocorreu um erro no login.", "error"); } }
        function handleLogout() { currentUser = null; selectedCompanyForManagement = null; localStorage.removeItem('clipping_currentUser'); if (clockInterval) clearInterval(clockInterval); headerLogoContainer.innerHTML = ''; updateView('login'); }
        async function handleLogoUpload(e) { const file = e.target.files[0]; if (!file) return; const companyId = currentUser.isSuperAdmin ? selectedCompanyForManagement.id : currentUser.companyId; if (!companyId) return; const reader = new FileReader(); reader.onloadend = async () => { try { const settingsRef = doc(db, "settings", companyId); await setDoc(settingsRef, { logo: reader.result }, { merge: true }); loadAndDisplayLogo(); showAlert('Logo atualizada!'); } catch (error) { console.error("Erro ao salvar logo:", error); showAlert("Erro ao salvar logo.", "error"); } }; reader.readAsDataURL(file); }
        async function loadAndDisplayLogo() { const companyId = currentUser ? currentUser.companyId : null; if (!companyId) { headerLogoContainer.innerHTML = ''; loginLogoContainer.innerHTML = ''; return; } const settingsRef = doc(db, "settings", companyId); try { const docSnap = await getDoc(settingsRef); const logoData = docSnap.exists() ? docSnap.data().logo : null; const logoHtml = logoData ? `<img src="${logoData}" alt="Logo da Empresa" class="h-full w-auto object-contain">` : ''; headerLogoContainer.innerHTML = logoHtml; loginLogoContainer.innerHTML = logoHtml; } catch (error) { console.error("Error loading logo:", error); } }

        // --- Dashboard ---
        async function renderDashboard() { if (!currentUser) return; document.getElementById('dashboard-grid').style.display = currentUser.isSuperAdmin ? 'none' : 'grid'; document.getElementById('super-admin-dashboard-message').style.display = currentUser.isSuperAdmin ? 'block' : 'none'; dashboardTitle.textContent = currentUser.isSuperAdmin ? 'Painel Super Admin' : `Notícias do Dia - ${currentUser.companyName}`; if (!currentUser.isSuperAdmin) { renderVerticalKeywordList(); const settingsRef = doc(db, "settings", currentUser.companyId); try { const docSnap = await getDoc(settingsRef); const hasReportAccess = docSnap.exists() ? docSnap.data().reportAccess !== false : true; newsAlertsContainer.style.display = hasReportAccess ? 'block' : 'none'; navRelatorio.classList.toggle('hidden', !hasReportAccess || currentUser.isSuperAdmin); populateInitialAlerts(); checkNotificationStatus(); } catch (error) { console.error("Error rendering dashboard:", error); } } }
        async function renderVerticalKeywordList() { if (!currentUser || !dashboardKeywordList) return; try { const settingsRef = doc(db, "settings", currentUser.companyId); const settingsSnap = await getDoc(settingsRef); const newAlerts = settingsSnap.exists() ? (settingsSnap.data().newAlerts || {}) : {}; const q = query(collection(db, "companies", currentUser.companyId, "keywords")); const querySnapshot = await getDocs(q); const keywords = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); dashboardKeywordList.innerHTML = ''; // Add a "Show All" button first const showAllLi = document.createElement('li'); showAllLi.className = 'keyword-filter active bg-indigo-100 text-indigo-800 text-md font-medium px-3 py-2 rounded-md flex justify-between items-center cursor-pointer hover:bg-indigo-200'; showAllLi.dataset.keyword = "all"; showAllLi.innerHTML = `<span>Mostrar Todas</span>`; dashboardKeywordList.appendChild(showAllLi); if (keywords.length === 0) { dashboardKeywordList.insertAdjacentHTML('beforeend', `<p class="text-gray-500 text-sm mt-2">Nenhuma palavra-chave.</p>`); } else { keywords.forEach(kw => { const li = document.createElement('li'); const count = newAlerts.byKeyword ? (newAlerts.byKeyword[kw.word] || 0) : 0; li.className = 'keyword-filter bg-indigo-100 text-indigo-800 text-md font-medium px-3 py-2 rounded-md flex justify-between items-center cursor-pointer hover:bg-indigo-200'; li.dataset.keyword = kw.word; li.innerHTML = `<span>${kw.word}</span> ${count > 0 ? `<span class="bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">${count}</span>` : ''}`; dashboardKeywordList.appendChild(li); }); } } catch (error) { console.error("Error fetching keywords:", error); } }
        
        // --- Super Admin ---
        async function renderSuperAdminPage() { try { const querySnapshot = await getDocs(collection(db, "companies")); const companies = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); companyList.innerHTML = ''; companies.forEach(c => { const li = document.createElement('li'); li.className = 'flex flex-col sm:flex-row justify-between items-start sm:items-center bg-gray-100 p-3 rounded-md'; const statusClass = c.status === 'inactive' ? 'text-orange-500' : 'text-green-500'; const statusText = c.status === 'inactive' ? 'Inativa' : 'Ativa'; let statusButton; if (c.status === 'inactive') { statusButton = `<button data-id="${c.id}" class="reactivate-company-btn bg-yellow-500 text-white px-3 py-1 rounded-md text-sm hover:bg-yellow-600">Reativar</button>`; } else { statusButton = `<button data-id="${c.id}" class="deactivate-company-btn bg-gray-500 text-white px-3 py-1 rounded-md text-sm hover:bg-gray-600">Inativar</button>`; } li.innerHTML = `<div><span class="font-bold">${c.name}</span> <span class="text-sm ${statusClass}">(${statusText})</span></div><div class="mt-2 sm:mt-0 flex flex-wrap gap-2"><button data-company-id="${c.id}" data-company-name="${c.name}" class="manage-company-users-btn bg-purple-500 text-white px-3 py-1 rounded-md text-sm hover:bg-purple-600">Usuários</button><button data-company-id="${c.id}" data-company-name="${c.name}" class="manage-company-keywords-btn bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600">Palavras-Chave</button><button data-company-id="${c.id}" data-company-name="${c.name}" class="manage-company-settings-btn bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600">Config.</button>${statusButton}<button data-company-id="${c.id}" data-company-name="${c.name}" class="delete-company-btn bg-red-600 text-white px-3 py-1 rounded-md text-sm hover:bg-red-800">Excluir</button></div>`; companyList.appendChild(li); }); } catch (error) { console.error("Error rendering super admin page:", error); } }
        async function handleCompanySubmit(e) { e.preventDefault(); const name = document.getElementById('company-name-input').value.trim(); if(!name) { showAlert('O nome da empresa é obrigatório.', 'error'); return; } try { const q = query(collection(db, "companies"), where("name", "==", name.toUpperCase())); const querySnapshot = await getDocs(q); if (!querySnapshot.empty) { showAlert('Este nome de empresa já existe.', 'error'); return; } await addDoc(collection(db, "companies"), { name: name.toUpperCase(), status: 'active' }); showAlert('Empresa adicionada!'); companyForm.reset(); renderSuperAdminPage(); } catch (error) { console.error("Error adding company:", error); showAlert("Erro ao adicionar empresa.", "error"); } }
        async function handleCompanyActions(e) { const target = e.target; const companyId = target.dataset.id || target.dataset.companyId; if (!companyId) return; const companyRef = doc(db, "companies", companyId); try { if (target.classList.contains('deactivate-company-btn')) { await updateDoc(companyRef, { status: 'inactive', deactivationDate: new Date().toISOString() }); } else if (target.classList.contains('reactivate-company-btn')) { await updateDoc(companyRef, { status: 'active', deactivationDate: null }); } else if (target.classList.contains('delete-company-btn')) { companyIdToDelete = target.dataset.companyId; companyNameToDeleteEl.textContent = target.dataset.companyName; deleteModal.classList.remove('hidden'); return; } else if (target.classList.contains('manage-company-keywords-btn')) { selectedCompanyForManagement = { id: target.dataset.companyId, name: target.dataset.companyName }; updateView('company-keyword-admin'); return; } else if (target.classList.contains('manage-company-settings-btn')) { selectedCompanyForManagement = { id: target.dataset.companyId, name: target.dataset.companyName }; updateView('company-settings-admin'); return; } else if (target.classList.contains('manage-company-users-btn')) { selectedCompanyForManagement = { id: target.dataset.companyId, name: target.dataset.companyName }; updateView('company-user-admin'); return; } renderSuperAdminPage(); } catch (error) { console.error("Error handling company action:", error); showAlert("Ocorreu um erro.", "error"); } }
        
        // --- Delete Company ---
        async function handleConfirmDelete() { if (!companyIdToDelete) return; const deleteButton = confirmDeleteBtn; deleteButton.disabled = true; deleteButton.textContent = 'Excluindo...'; const deleteCompanyFunc = httpsCallable(functions, 'deleteCompany'); try { const result = await deleteCompanyFunc({ companyId: companyIdToDelete }); if (result.data.success) { showAlert('Empresa e todos os seus dados foram excluídos.'); } else { throw new Error(result.data.error || 'A função de exclusão falhou.'); } } catch (error) { console.error("Erro ao chamar a função de exclusão:", error); showAlert(`Erro ao excluir empresa: ${error.message}`, 'error'); } finally { deleteModal.classList.add('hidden'); deleteButton.disabled = false; deleteButton.textContent = 'Sim, excluir permanentemente'; companyIdToDelete = null; renderSuperAdminPage(); } }
        
        // --- User/Keyword Management ---
        async function renderCompanyUserAdminPage() { if (!selectedCompanyForManagement) return; companyUserAdminTitle.textContent = `Gerenciar Usuários para: ${selectedCompanyForManagement.name}`; renderUsersForSelectedCompany(); }
        async function renderUsersForSelectedCompany() { try { const usersRef = collection(db, "companies", selectedCompanyForManagement.id, "users"); const querySnapshot = await getDocs(usersRef); const companyUsers = querySnapshot.docs.map(doc => ({id: doc.id, ...doc.data()})); adminUserList.innerHTML = ''; companyUsers.forEach(user => { const li = document.createElement('li'); li.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-md'; li.innerHTML = `<span>${user.username}</span><div><button data-id="${user.id}" class="edit-user-btn text-blue-500 hover:text-blue-700 mr-2">Editar</button><button data-id="${user.id}" class="delete-user-btn text-red-500 hover:text-red-700">Excluir</button></div>`; adminUserList.appendChild(li); }); } catch (error) { console.error("Error rendering users:", error); } }
        async function handleUserSubmit(e) { e.preventDefault(); const username = userInput.value.trim(), password = userPasswordInput.value.trim(), id = userIdInput.value; if (!username || !password || !selectedCompanyForManagement) return; try { const usersRef = collection(db, "companies", selectedCompanyForManagement.id, "users"); const q = query(usersRef, where("username", "==", username)); const querySnapshot = await getDocs(q); if (!querySnapshot.empty && querySnapshot.docs[0].id !== id) { showAlert('Este nome de usuário já existe.', 'error'); return; } if (id) { await updateDoc(doc(db, "companies", selectedCompanyForManagement.id, "users", id), { username, password }); } else { await addDoc(usersRef, { username, password }); } userInput.value = ''; userPasswordInput.value = ''; userIdInput.value = ''; renderUsersForSelectedCompany(); } catch (error) { console.error("Error saving user:", error); showAlert("Erro ao salvar usuário.", "error"); } }
        async function handleUserActions(e) { if (!selectedCompanyForManagement) return; const id = e.target.dataset.id; if (!id) return; try { if (e.target.classList.contains('edit-user-btn')) { const userDoc = await getDoc(doc(db, "companies", selectedCompanyForManagement.id, "users", id)); if (userDoc.exists()) { const user = userDoc.data(); userInput.value = user.username; userPasswordInput.value = user.password; userIdInput.value = id; userInput.focus(); } } if (e.target.classList.contains('delete-user-btn')) { await deleteDoc(doc(db, "companies", selectedCompanyForManagement.id, "users", id)); renderUsersForSelectedCompany(); } } catch (error) { console.error("Error handling user action:", error); } }
        async function renderCompanyKeywordAdminPage() { if (!selectedCompanyForManagement) return; companyKeywordAdminTitle.textContent = `Gerenciar Palavras-Chave para: ${selectedCompanyForManagement.name}`; renderKeywordsForSelectedCompany(); }
        async function renderKeywordsForSelectedCompany() { try { const keywordsRef = collection(db, "companies", selectedCompanyForManagement.id, "keywords"); const querySnapshot = await getDocs(keywordsRef); const keywords = querySnapshot.docs.map(doc => ({id: doc.id, ...doc.data()})); adminKeywordList.innerHTML = ''; keywords.forEach(kw => { const li = document.createElement('li'); li.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-md'; li.innerHTML = `<span>${kw.word}</span><div><button data-id="${kw.id}" class="edit-keyword-btn text-blue-500 hover:text-blue-700 mr-2">Editar</button><button data-id="${kw.id}" class="delete-keyword-btn text-red-500 hover:text-red-700">Excluir</button></div>`; adminKeywordList.appendChild(li); }); } catch (error) { console.error("Error rendering keywords:", error); } }
        async function handleKeywordSubmit(e) { e.preventDefault(); const word = keywordInput.value.trim(), id = keywordIdInput.value; if (!word || !selectedCompanyForManagement) return; try { const keywordsRef = collection(db, "companies", selectedCompanyForManagement.id, "keywords"); if (id) { await updateDoc(doc(db, "companies", selectedCompanyForManagement.id, "keywords", id), { word }); } else { await addDoc(keywordsRef, { word }); } keywordInput.value = ''; keywordIdInput.value = ''; renderKeywordsForSelectedCompany(); } catch (error) { console.error("Error saving keyword:", error); } }
        async function handleKeywordActions(e) { if (!selectedCompanyForManagement) return; const id = e.target.dataset.id; if (!id) return; try { if (e.target.classList.contains('edit-keyword-btn')) { const kwDoc = await getDoc(doc(db, "companies", selectedCompanyForManagement.id, "keywords", id)); if (kwDoc.exists()) { const kw = kwDoc.data(); keywordInput.value = kw.word; keywordIdInput.value = id; keywordInput.focus(); } } if (e.target.classList.contains('delete-keyword-btn')) { await deleteDoc(doc(db, "companies", selectedCompanyForManagement.id, "keywords", id)); renderKeywordsForSelectedCompany(); } } catch (error) { console.error("Error handling keyword action:", error); } }
        
        // --- Settings Management ---
        async function renderCompanySettingsAdminPage() { if (!selectedCompanyForManagement) return; companySettingsAdminTitle.textContent = `Configurações para: ${selectedCompanyForManagement.name}`; try { const settingsRef = doc(db, "settings", selectedCompanyForManagement.id); const docSnap = await getDoc(settingsRef); if (docSnap.exists()) { const settings = docSnap.data(); apiKeyInput.value = settings.apiKey || ''; reportAccessToggle.checked = settings.reportAccess !== false; document.querySelector(`input[name="news-scope"][value="${settings.newsScope || 'br'}"]`).checked = true; } else { apiKeyInput.value = ''; reportAccessToggle.checked = true; document.querySelector('input[name="news-scope"][value="br"]').checked = true; } } catch (error) { console.error("Error rendering settings:", error); } }
        async function handleSettingsChange(e) { if (!selectedCompanyForManagement) return; const settingsRef = doc(db, "settings", selectedCompanyForManagement.id); const key = e.target.id === 'report-access-toggle' ? 'reportAccess' : e.target.name === 'news-scope' ? 'newsScope' : 'apiKey'; const value = e.target.type === 'checkbox' ? e.target.checked : e.target.value; try { await setDoc(settingsRef, { [key]: value }, { merge: true }); } catch (error) { console.error("Error saving setting:", error); } }

        // --- News Alerts & Notifications ---
        async function checkNotificationStatus() { if (!currentUser || currentUser.isSuperAdmin) return; try { const settingsRef = doc(db, "settings", currentUser.companyId); const docSnap = await getDoc(settingsRef); const newAlerts = docSnap.exists() ? docSnap.data().newAlerts : null; const total = newAlerts ? newAlerts.total : 0; if (total > 0) { notificationBadge.textContent = total; notificationBadge.classList.remove('hidden'); } else { notificationBadge.classList.add('hidden'); } } catch (error) { console.error("Error checking notifications:", error); } }
        function displayNewsAlert(article, container) { const pubDate = new Date(article.publishedAt.seconds ? article.publishedAt.toDate() : article.publishedAt); const formattedDate = pubDate.toLocaleDateString('pt-BR'); const dateForFilter = pubDate.toISOString().split('T')[0]; const alertEl = document.createElement('div'); alertEl.className = 'bg-white p-4 rounded-lg shadow-md border-l-4 border-indigo-500 fade-in'; alertEl.dataset.date = dateForFilter; alertEl.dataset.keyword = article.keyword; alertEl.dataset.title = article.title.toLowerCase(); alertEl.dataset.description = article.description ? article.description.toLowerCase() : ''; alertEl.innerHTML = `<div class="flex justify-between items-start"><h4 class="text-lg font-bold text-gray-800 pr-2">${article.title}</h4><span class="flex-shrink-0 text-xs font-semibold bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full">${article.keyword}</span></div><p class="text-sm text-gray-600 mt-2">${article.description || 'Descrição não disponível.'}</p><div class="text-xs text-gray-500 mt-3 flex justify-between items-center"><span>Fonte: ${article.source.name} | Publicado: ${formattedDate}</span><a href="${article.url}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline font-semibold">Ler mais &rarr;</a></div>`; container.appendChild(alertEl); }
        async function populateInitialAlerts() { if (!currentUser || currentUser.isSuperAdmin) return; newsAlerts.innerHTML = '<p class="text-gray-500">Carregando...</p>'; try { const q = query(collection(db, "companies", currentUser.companyId, "articles"), orderBy("publishedAt", "desc"), limit(100)); const articlesSnapshot = await getDocs(q); newsAlerts.innerHTML = ''; if (articlesSnapshot.empty) { newsAlerts.innerHTML = '<p class="text-gray-500">Nenhum alerta encontrado.</p>'; return; } articlesSnapshot.docs.forEach(d => displayNewsAlert(d.data(), newsAlerts)); filterAlerts(); } catch (error) { console.error("Error populating alerts:", error); newsAlerts.innerHTML = '<p class="text-red-500">Erro ao carregar alertas.</p>'; } }
        
        function handleKeywordFilterClick(e) {
            const target = e.target.closest('.keyword-filter');
            if (!target) return;

            document.querySelectorAll('.keyword-filter').forEach(el => el.classList.remove('active'));
            target.classList.add('active');
            filterAlerts();
        }

        function filterAlerts() { 
            const selectedDate = alertDateFilter.value; 
            const activeKeywordEl = document.querySelector('.keyword-filter.active');
            const selectedKeyword = activeKeywordEl ? activeKeywordEl.dataset.keyword : 'all';

            const allAlerts = newsAlerts.querySelectorAll('.fade-in'); 
            let visibleCount = 0; 
            allAlerts.forEach(alert => { 
                const dateMatch = !selectedDate || alert.dataset.date === selectedDate;
                const keywordMatch = selectedKeyword === 'all' || alert.dataset.keyword === selectedKeyword;
                const isVisible = dateMatch && keywordMatch;
                alert.style.display = isVisible ? 'block' : 'none'; 
                if(isVisible) visibleCount++; 
            }); 

            const noAlertsMsg = newsAlerts.querySelector('.no-alerts-msg');
            if (noAlertsMsg) noAlertsMsg.remove();

            if(visibleCount === 0) { 
                newsAlerts.insertAdjacentHTML('beforeend', `<p class="text-gray-500 no-alerts-msg">Nenhum alerta para os filtros selecionados.</p>`); 
            }
        }
        
        // --- Search Page ---
        async function setupSearchPage() { if (!currentUser || currentUser.isSuperAdmin) return; searchInput.value = ''; searchResults.innerHTML = '<p class="text-gray-500">Carregando artigos...</p>'; try { const q = query(collection(db, "companies", currentUser.companyId, "articles"), orderBy("publishedAt", "desc")); const articlesSnapshot = await getDocs(q); allCompanyArticles = articlesSnapshot.docs.map(d => d.data()); searchResults.innerHTML = `<p class="text-gray-500">Pronto para pesquisar em ${allCompanyArticles.length} artigos.</p>`; setupFilters(); } catch (error) { console.error("Error fetching articles for search:", error); searchResults.innerHTML = '<p class="text-red-500">Erro ao carregar artigos.</p>'; } }
        function setupFilters() { filterContainer.innerHTML = ''; const keywords = [...new Set(allCompanyArticles.map(a => a.keyword))]; if (keywords.length > 0) { let keywordButtons = keywords.map(kw => `<button class="filter-btn bg-gray-200 hover:bg-indigo-200 text-gray-800 text-sm font-medium px-3 py-1 rounded-full" data-keyword="${kw}">${kw}</button>`).join(''); filterContainer.innerHTML = `<div class="flex flex-wrap gap-2"><span class="font-semibold self-center">Filtar por Palavra-Chave:</span>${keywordButtons}</div>`; } }
        function handleSearch() { const searchTerm = searchInput.value.toLowerCase().trim(); const activeFilter = filterContainer.querySelector('.bg-indigo-500'); const keywordFilter = activeFilter ? activeFilter.dataset.keyword : null; if (!searchTerm && !keywordFilter) { searchResults.innerHTML = `<p class="text-gray-500">Digite ou use os filtros.</p>`; return; } let filteredArticles = allCompanyArticles; if (keywordFilter) { filteredArticles = filteredArticles.filter(a => a.keyword === keywordFilter); } if (searchTerm) { filteredArticles = filteredArticles.filter(a => a.title.toLowerCase().includes(searchTerm) || (a.description && a.description.toLowerCase().includes(searchTerm))); } renderSearchResults(filteredArticles); }
        function renderSearchResults(articles) { searchResults.innerHTML = ''; if (articles.length === 0) { searchResults.innerHTML = '<p class="text-gray-500">Nenhum resultado.</p>'; return; } articles.forEach(article => displayNewsAlert(article, searchResults)); }

        // --- Report Page ---
        async function renderReportPage() { if (!currentUser || currentUser.isSuperAdmin) return; const q = query(collection(db, "companies", currentUser.companyId, "articles"), orderBy("publishedAt", "desc")); const articlesSnapshot = await getDocs(q); const articles = articlesSnapshot.docs.map(doc => doc.data()); renderSourceChart(articles); renderDateChart(articles); startDateInput.addEventListener('change', () => renderDateChart(articles)); endDateInput.addEventListener('change', () => renderDateChart(articles)); }
        function renderSourceChart(articles) { const sourceCounts = articles.reduce((acc, article) => { const sourceName = article.source.name; acc[sourceName] = (acc[sourceName] || 0) + 1; return acc; }, {}); const topSources = Object.entries(sourceCounts).sort((a, b) => b[1] - a[1]).slice(0, 10); const labels = topSources.map(entry => entry[0]); const data = topSources.map(entry => entry[1]); const ctx = document.getElementById('source-chart').getContext('2d'); if (sourceChartInstance) sourceChartInstance.destroy(); sourceChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: labels, datasets: [{ label: 'Notícias por Veículo', data: data, backgroundColor: ['#4F46E5', '#6366F1', '#818CF8', '#A5B4FC', '#C7D2FE', '#E0E7FF', '#60A5FA', '#3B82F6', '#1D4ED8', '#1E3A8A'], hoverOffset: 4 }] } }); }
        function renderDateChart(articles) { const startDate = startDateInput.value ? new Date(startDateInput.value) : null; const endDate = endDateInput.value ? new Date(endDateInput.value) : null; if (startDate) startDate.setHours(0, 0, 0, 0); if (endDate) endDate.setHours(23, 59, 59, 999); const filteredArticles = articles.filter(article => { const pubDate = article.publishedAt.toDate(); if (startDate && pubDate < startDate) return false; if (endDate && pubDate > endDate) return false; return true; }); const dateCounts = filteredArticles.reduce((acc, article) => { const dateStr = article.publishedAt.toDate().toLocaleDateString('pt-BR'); acc[dateStr] = (acc[dateStr] || 0) + 1; return acc; }, {}); const sortedDates = Object.entries(dateCounts).sort((a, b) => new Date(a[0].split('/').reverse().join('-')) - new Date(b[0].split('/').reverse().join('-'))); const labels = sortedDates.map(entry => entry[0]); const data = sortedDates.map(entry => entry[1]); const ctx = document.getElementById('date-chart').getContext('2d'); if (dateChartInstance) dateChartInstance.destroy(); dateChartInstance = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Notícias por Dia', data: data, fill: false, borderColor: '#4F46E5', tension: 0.1 }] } }); }

        // --- Init & Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            loginForm.addEventListener('submit', handleLogin);
            navInicio.addEventListener('click', (e) => { e.preventDefault(); updateView('dashboard'); });
            navRelatorio.addEventListener('click', (e) => { e.preventDefault(); updateView('report'); });
            navPesquisa.addEventListener('click', (e) => { e.preventDefault(); updateView('search'); });
            navSuperAdmin.addEventListener('click', (e) => { e.preventDefault(); updateView('super-admin'); });
            navLogout.addEventListener('click', (e) => { e.preventDefault(); handleLogout(); });
            keywordForm.addEventListener('submit', handleKeywordSubmit);
            adminKeywordList.addEventListener('click', handleKeywordActions);
            reportAccessToggle.addEventListener('change', handleSettingsChange);
            apiKeyInput.addEventListener('change', handleSettingsChange);
            newsScopeContainer.addEventListener('change', handleSettingsChange);
            logoUploadInput.addEventListener('change', handleLogoUpload);
            companyForm.addEventListener('submit', handleCompanySubmit);
            companyList.addEventListener('click', handleCompanyActions);
            backToSuperAdminKwBtn.addEventListener('click', () => updateView('super-admin'));
            backToSuperAdminSettingsBtn.addEventListener('click', () => updateView('super-admin'));
            backToSuperAdminUsersBtn.addEventListener('click', () => updateView('super-admin'));
            alertDateFilter.addEventListener('change', filterAlerts);
            dashboardKeywordList.addEventListener('click', handleKeywordFilterClick);
            userForm.addEventListener('submit', handleUserSubmit);
            adminUserList.addEventListener('click', handleUserActions);
            searchInput.addEventListener('input', handleSearch);
            filterContainer.addEventListener('click', (e) => { if (e.target.classList.contains('filter-btn')) { document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('bg-indigo-500', 'text-white')); e.target.classList.add('bg-indigo-500', 'text-white'); handleSearch(); } });
            notificationBell.addEventListener('click', async () => { if (!currentUser) return; try { await setDoc(doc(db, "settings", currentUser.companyId), { newAlerts: { total: 0, byKeyword: {} } }, { merge: true }); checkNotificationStatus(); renderVerticalKeywordList(); } catch (error) { console.error("Error clearing notification:", error); } });
            cancelDeleteBtn.addEventListener('click', () => { deleteModal.classList.add('hidden'); companyIdToDelete = null; });
            confirmDeleteBtn.addEventListener('click', handleConfirmDelete);
            const savedUser = getStorage('clipping_currentUser', null);
            if (savedUser) { currentUser = savedUser; updateView('dashboard'); } else { updateView('login'); }
        });
    </script>
</body>
</html>
