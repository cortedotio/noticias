<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Correção de Artigos</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        .loading { color: blue; }
    </style>
</head>
<body>
    <h1>Teste de Correção de Artigos</h1>
    <p>Clique no botão abaixo para testar a correção de artigos:</p>
    <button id="test-fix-btn" onclick="testFixArticles()">Testar Correção de Artigos</button>
    <div id="result"></div>

    <script>
        // Configuração do Firebase (será preenchida dinamicamente)
        let functions;
        
        // Função para carregar configuração do Firebase
        async function loadFirebaseConfig() {
            try {
                const response = await fetch('/firebase-config.json');
                const config = await response.json();
                
                // Inicializar Firebase
                firebase.initializeApp(config);
                functions = firebase.functions();
                
                // Para desenvolvimento, usar emulador se disponível
                try {
                    functions.useFunctionsEmulator('http://localhost:5001');
                } catch (e) {
                    console.log('Emulador não disponível, usando produção');
                }
                
                return true;
            } catch (error) {
                console.error('Erro ao carregar configuração do Firebase:', error);
                document.getElementById('result').innerHTML = '<p class="error">Erro ao carregar configuração do Firebase</p>';
                return false;
            }
        }
        
        // Função de teste
        async function testFixArticles() {
            const btn = document.getElementById('test-fix-btn');
            const resultDiv = document.getElementById('result');
            
            if (!functions) {
                const configLoaded = await loadFirebaseConfig();
                if (!configLoaded) return;
            }
            
            if (!confirm('Tem certeza que deseja testar a correção de artigos?')) {
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Corrigindo...';
            resultDiv.innerHTML = '<p class="loading">Iniciando correção...</p>';
            
            try {
                const fixAllCompaniesArticles = functions.httpsCallable('fixAllCompaniesArticles');
                const result = await fixAllCompaniesArticles({ appId: 'test-app' });
                
                resultDiv.innerHTML = `<p class="success">Correção concluída com sucesso!</p>
                                     <p>Total de artigos corrigidos: ${result.data.totalFixed || 0}</p>
                                     <p>Mensagem: ${result.data.message || 'Sucesso'}</p>`;
            } catch (error) {
                console.error('Erro ao corrigir artigos:', error);
                resultDiv.innerHTML = `<p class="error">Erro ao corrigir artigos: ${error.message}</p>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Testar Correção de Artigos';
            }
        }
    </script>
</body>
</html>